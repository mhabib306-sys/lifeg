<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#FFFFFF">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Nucleus</title>
  <!-- Allow browser caching for better performance -->
  <meta http-equiv="Cache-Control" content="public, max-age=3600, must-revalidate">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%23E5533D'/><stop offset='100%25' stop-color='%23D4402E'/></linearGradient></defs><circle cx='50' cy='50' r='45' fill='url(%23g)'/><circle cx='50' cy='50' r='18' fill='white'/><circle cx='50' cy='50' r='8' fill='%23E5533D'/><circle cx='30' cy='35' r='6' fill='white' opacity='0.6'/><circle cx='70' cy='65' r='5' fill='white' opacity='0.5'/><circle cx='35' cy='68' r='4' fill='white' opacity='0.4'/></svg>">
  <!-- Inter font - closest match to SF Pro -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cream: 'var(--bg-primary)',
            warmgray: 'var(--bg-secondary)',
            charcoal: 'var(--text-primary)',
            coral: 'var(--accent)',
            coralDark: 'var(--accent-dark)',
            softborder: 'var(--border)'
          },
          fontFamily: {
            sans: ['var(--font-family)'],
          }
        }
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
  <style>
    /* Theme: SimpleBits (default) */
    :root, [data-theme="simplebits"] {
      --bg-primary: #F7F6F4;
      --bg-secondary: #EFEDE8;
      --bg-card: #EFEDE8;
      --bg-input: #FFFFFF;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --text-muted: #999999;
      --accent: #E5533D;
      --accent-dark: #C4432F;
      --accent-light: rgba(229, 83, 61, 0.1);
      --accent-hover: rgba(229, 83, 61, 0.08);
      --notes-accent: #8B5CF6;
      --border: #E5E3DE;
      --border-light: #F0EEE9;
      --success: #22C55E;
      --btn-bg: #1a1a1a;
      --btn-hover: #333333;
      --sidebar-bg: #EFEDE8;
      --sidebar-active: rgba(229, 83, 61, 0.12);
      --modal-bg: #FFFFFF;
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      --border-radius: 8px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    }

    /* Theme: Things 3 - Exact Match */
    [data-theme="things3"] {
      /* Backgrounds */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F7;
      --bg-card: #FFFFFF;
      --bg-input: #FFFFFF;
      --bg-hover: #F5F5F7;

      /* Typography */
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --text-muted: #AEAEB2;

      /* Things 3 Accent Blue */
      --accent: #147EFB;
      --accent-dark: #0066DC;
      --accent-light: rgba(20, 126, 251, 0.08);
      --accent-hover: rgba(0, 0, 0, 0.03);
      --notes-accent: #8B5CF6;

      /* Borders */
      --border: #E5E5EA;
      --border-light: #F2F2F7;

      /* Status colors */
      --success: #34C759;
      --warning: #FF9500;
      --danger: #FF3B30;

      /* Things 3 perspective colors */
      --inbox-color: #147EFB;
      --today-color: #FFCC00;
      --upcoming-color: #FF3B30;
      --anytime-color: #5AC8FA;
      --someday-color: #C69C6D;
      --logbook-color: #34C759;

      /* Buttons */
      --btn-bg: #147EFB;
      --btn-hover: #0066DC;

      /* Sidebar */
      --sidebar-bg: #F5F5F7;
      --sidebar-active: rgba(0, 0, 0, 0.05);
      --sidebar-hover: rgba(0, 0, 0, 0.03);

      /* Modal */
      --modal-bg: #FFFFFF;
      --modal-overlay: rgba(0, 0, 0, 0.3);

      /* Font */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', system-ui, sans-serif;

      /* Radius - Things 3 uses subtle rounding */
      --border-radius: 8px;
      --border-radius-lg: 12px;
      --border-radius-sm: 6px;

      /* Shadows - Things 3 uses very subtle shadows */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
      --shadow-modal: 0 20px 40px rgba(0,0,0,0.15);
    }

    body {
      font-feature-settings: 'kern' 1, 'liga' 1;
      font-family: var(--font-family);
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
    }
    .sb-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      transition: background 0.3s ease, border-color 0.3s ease;
    }
    .sb-btn {
      background: var(--btn-bg);
      color: white;
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      border-radius: var(--border-radius);
    }
    .sb-btn:hover {
      background: var(--btn-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    .sb-btn:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .sb-link { color: var(--accent); text-decoration: underline; text-underline-offset: 2px; }
    .sb-link:hover { color: var(--accent-dark); }
    .sb-section-title {
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    input[type="number"], input[type="text"], textarea, select {
      background: var(--bg-input);
      border: none;
      border-radius: calc(var(--border-radius) - 2px);
      color: var(--text-primary);
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }
    input[type="number"]:focus, input[type="text"]:focus, textarea:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent-light);
      background: var(--bg-input);
    }

    /* All text inputs - clean borders with focus states */
    input, textarea {
      border: none;
    }
    input:focus, textarea:focus {
      outline: 2px solid var(--accent);
      outline-offset: 1px;
    }

    /* Global accessible focus styles */
    button:focus-visible, a:focus-visible, [role="button"]:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      border-radius: 4px;
    }

    /* Sidebar items focus */
    .sidebar-item:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: -2px;
      border-radius: 8px;
    }

    /* Task item focus */
    .task-item:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: -2px;
    }

    /* Toggle switch */
    .toggle-switch {
      cursor: pointer;
    }
    .toggle-on {
      background-color: var(--accent);
    }
    .toggle-off {
      background-color: #d1d5db;
    }
    .toggle-switch:hover .toggle-on {
      background-color: var(--accent-dark);
    }
    .toggle-switch:hover .toggle-off {
      background-color: #c0c4cc;
    }

    /* Checkbox styling */
    input[type="checkbox"] {
      accent-color: var(--accent);
    }
    input[type="checkbox"]:focus {
      outline: 2px solid var(--accent-light);
      outline-offset: 2px;
    }

    /* Things 3 exact micro-interactions */

    /* Task item - Things 3 style (no left border, subtle hover) */
    .task-item {
      transition: background 0.15s ease, border-radius 0.15s ease;
      border-left: none;
      border-radius: 8px;
      margin: 0 4px;
    }
    .task-item:hover {
      background: var(--accent-hover);
    }
    .task-item:active {
      background: var(--accent-light);
    }

    /* Checkbox - Things 3 style (thin circle, smooth animations) */
    .task-checkbox {
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), border-color 0.2s ease, background 0.2s ease;
      cursor: pointer;
      border-radius: 9999px !important;
      -webkit-border-radius: 9999px !important;
    }
    .task-checkbox:hover {
      transform: scale(1.15);
      border-color: var(--accent) !important;
    }
    .task-checkbox:active {
      transform: scale(0.95);
    }
    .task-checkbox.completed {
      animation: checkPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      background: var(--accent) !important;
      border-color: var(--accent) !important;
    }
    @keyframes checkPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    /* Sidebar item interactions - Things 3 style */
    .sidebar-item {
      transition: background 0.1s ease-out, transform 0.1s ease-out;
      border-radius: 8px;
    }
    .sidebar-item:hover {
      background: rgba(0, 0, 0, 0.04);
    }
    .sidebar-item:active {
      background: rgba(0, 0, 0, 0.06);
      transform: scale(0.99);
    }
    .sidebar-item.active {
      background: rgba(0, 0, 0, 0.06);
    }

    /* Nav tab hover */
    .nav-tab {
      position: relative;
    }
    .nav-tab:hover {
      background: rgba(0, 0, 0, 0.04);
    }
    .nav-tab:active {
      background: rgba(0, 0, 0, 0.06);
    }
    .drag-handle {
      opacity: 0;
      cursor: grab;
      transition: opacity 0.12s ease;
      touch-action: none;
    }
    .sidebar-item:hover .drag-handle {
      opacity: 0.4;
    }
    .drag-handle:hover {
      opacity: 1 !important;
    }

    /* Category/Label pill interactions */
    .tag-pill {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }
    .tag-pill:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .tag-pill:active {
      transform: scale(0.98);
    }

    /* Button micro-interactions */
    .action-btn {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
    }
    .task-item:hover .action-btn {
      opacity: 1;
    }
    .action-btn:hover {
      transform: scale(1.1);
    }
    .action-btn:active {
      transform: scale(0.95);
    }

    /* Move dropdown */
    .move-dropdown {
      transition: all 0.15s ease;
      opacity: 0;
      transform: translateY(-2px);
    }
    .task-item:hover .move-dropdown {
      opacity: 1;
      transform: translateY(0);
    }

    /* Drag and drop - Things 3 style */
    .task-item {
      cursor: grab;
    }
    .task-item:active {
      cursor: grabbing;
    }
    .task-item.dragging {
      opacity: 0.4;
      transform: scale(1.02);
      box-shadow: var(--shadow-lg);
      background: var(--bg-card);
      z-index: 100;
    }
    .task-item.drag-over {
      position: relative;
    }
    .task-item.drag-over::before {
      content: '';
      position: absolute;
      top: -2px;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent);
      border-radius: 2px;
      box-shadow: 0 0 8px var(--accent);
      z-index: 10;
    }
    .task-item.drag-over-bottom {
      position: relative;
    }
    .task-item.drag-over-bottom::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent);
      border-radius: 2px;
      box-shadow: 0 0 8px var(--accent);
      z-index: 10;
    }
    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      opacity: 0.9;
      transform: rotate(2deg);
    }
    .drag-indicator {
      cursor: grab;
    }
    .drag-indicator:active {
      cursor: grabbing;
    }
    .task-list.is-dragging .task-item:not(.dragging) {
      transition: transform 0.2s ease;
    }
    .task-item.dragging .drag-indicator {
      background: var(--accent) !important;
    }

    /* Home widgets */
    .widget {
      transition: all 0.2s ease;
      position: relative;
    }
    .widget.dragging {
      opacity: 0.4;
      transform: scale(0.98);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .widget.drag-over {
      transform: scale(1.02);
    }
    .widget.drag-over::before {
      content: 'Drop here';
      position: absolute;
      inset: 0;
      background: rgba(229, 83, 61, 0.15);
      border: 3px dashed var(--accent);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--accent);
      font-size: 14px;
      z-index: 10;
      animation: dropZonePulse 0.8s ease infinite alternate;
    }
    @keyframes dropZonePulse {
      from { background: rgba(229, 83, 61, 0.1); }
      to { background: rgba(229, 83, 61, 0.2); }
    }
    .widget-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    /* Widget sizes */
    .widget.col-span-2 { grid-column: span 2; }
    .widget.col-span-1 { grid-column: span 1; }
    .widget-placeholder {
      background: var(--accent-light);
      border: 2px dashed var(--accent);
      border-radius: 12px;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      font-weight: 500;
    }
    /* Resize handle */
    .widget-resize-btn {
      transition: all 0.15s ease;
    }
    .widget-resize-btn:hover {
      background: var(--accent-light);
      color: var(--accent);
    }
    .widget-size-badge {
      font-size: 9px;
      padding: 2px 6px;
      background: var(--bg-secondary);
      border-radius: 4px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Outliner Notes Styles */
    .note-item {
      position: relative;
      transition: all 0.15s ease;
    }
    .note-item:hover {
      background: rgba(139, 92, 246, 0.04);
    }
    .note-item.editing {
      background: rgba(139, 92, 246, 0.08);
    }
    .note-indent-line {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(139, 92, 246, 0.15);
    }
    .note-bullet {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #8B5CF6;
      flex-shrink: 0;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .note-bullet:hover {
      transform: scale(1.3);
      background: #7C3AED;
    }
    .note-bullet.has-children {
      background: transparent;
      border: 2px solid #8B5CF6;
    }
    .note-bullet.collapsed {
      background: #8B5CF6;
      border: none;
    }
    .note-input {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      background: transparent !important;
      width: 100%;
      font-size: 15px;
      color: var(--text-primary);
      padding: 0;
    }
    .note-input:focus {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
    }
    .note-input::placeholder {
      color: var(--text-secondary);
      opacity: 0.5;
    }
    .note-children {
      margin-left: 24px;
      border-left: 1px solid rgba(139, 92, 246, 0.2);
    }
    .note-collapsed .note-children {
      display: none;
    }

    /* Sidebar draggable items */
    .draggable-item {
      cursor: grab;
      transition: all 0.15s ease;
      -webkit-user-select: none;
      user-select: none;
      position: relative;
      touch-action: none;
    }
    .draggable-item:active {
      cursor: grabbing;
    }
    .draggable-item.dragging {
      opacity: 0.5;
      background: rgba(0, 0, 0, 0.08) !important;
    }
    .draggable-item.drag-over {
      position: relative;
    }
    .draggable-item.drag-over::before {
      content: '';
      position: absolute;
      top: -1px;
      left: 8px;
      right: 8px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
      z-index: 10;
    }
    .draggable-item.drag-over-bottom {
      position: relative;
    }
    .draggable-item.drag-over-bottom::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 8px;
      right: 8px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
      z-index: 10;
    }

    /* Modal animations */
    .modal-overlay {
      animation: fadeIn 0.2s ease-out;
    }
    .modal-content {
      animation: slideUp 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Input focus animations */
    .task-input {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .task-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
      transform: scale(1.01);
    }

    /* Label checkbox interactions */
    .label-checkbox {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .label-checkbox:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .label-checkbox:has(input:checked) {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Add button pulse */
    .add-task-btn {
      position: relative;
      overflow: hidden;
    }
    .add-task-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: translateX(-100%);
      transition: transform 0.5s;
    }
    .add-task-btn:hover::after {
      transform: translateX(100%);
    }

    /* Empty state animation */
    .empty-state {
      animation: fadeInUp 0.4s ease-out;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Perspective count badge */
    .count-badge {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .sidebar-item:hover .count-badge {
      transform: scale(1.1);
    }

    /* Smooth scrollbar */
    .task-list::-webkit-scrollbar {
      width: 6px;
    }
    .task-list::-webkit-scrollbar-track {
      background: transparent;
    }
    .task-list::-webkit-scrollbar-thumb {
      background: rgba(26, 26, 26, 0.2);
      border-radius: 3px;
    }
    .task-list::-webkit-scrollbar-thumb:hover {
      background: rgba(26, 26, 26, 0.3);
    }

    /* Prayer input specific styling */
    .prayer-input {
      min-width: 50px;
    }

    /* ========== MOBILE RESPONSIVE - SILICON VALLEY STANDARDS ========== */

    /* Mobile Bottom Navigation */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--modal-bg);
      border-top: 1px solid var(--border);
      padding: 8px 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .mobile-bottom-nav-inner {
      display: flex;
      justify-content: space-around;
      max-width: 500px;
      margin: 0 auto;
    }

    .mobile-nav-item {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      min-height: 44px;
      border-radius: 12px;
      color: var(--text-muted);
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .mobile-nav-item svg {
      width: 24px;
      height: 24px;
    }

    .mobile-nav-item.active {
      color: var(--accent);
    }

    /* Mobile Header Compact */
    .mobile-header-compact {
      display: none;
    }

    @media (max-width: 768px) {
      /* Show bottom nav, hide top nav */
      .mobile-bottom-nav {
        display: block;
      }

      .desktop-nav {
        display: none !important;
      }

      /* Compact header for mobile */
      .desktop-header-content {
        display: none !important;
      }

      .mobile-header-compact {
        display: flex !important;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
      }

      /* Header adjustments */
      header {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }

      header .max-w-6xl {
        padding: 0;
      }

      /* Main content padding for bottom nav */
      main, .main-content {
        padding-bottom: 80px !important;
      }

      /* Sidebar becomes full-screen overlay on mobile */
      .mobile-sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 200;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .mobile-sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .mobile-sidebar-drawer {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 85%;
        max-width: 320px;
        background: var(--bg-primary);
        z-index: 201;
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .mobile-sidebar-overlay.show .mobile-sidebar-drawer {
        transform: translateX(0);
      }

      /* Task list fullscreen */
      .task-list-container {
        border-radius: 0 !important;
        border-left: none !important;
        border-right: none !important;
      }

      /* Things 3 flat task items on mobile */
      [data-theme="things3"] .task-item {
        border-radius: 0;
        margin: 0;
        border-bottom: 1px solid var(--border-light);
      }
      [data-theme="things3"] .task-item:last-child {
        border-bottom: none;
      }

      /* Task items - larger touch targets */
      .task-item {
        padding: 14px 16px;
        min-height: 56px;
      }

      /* Checkbox - force perfect circle */
      .task-checkbox,
      .task-item .task-checkbox,
      button.task-checkbox {
        width: 22px !important;
        height: 22px !important;
        min-width: 22px !important;
        min-height: 22px !important;
        max-width: 22px !important;
        max-height: 22px !important;
        border-radius: 50% !important;
        -webkit-border-radius: 50% !important;
        flex-shrink: 0 !important;
        flex-grow: 0 !important;
        aspect-ratio: 1 / 1 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
        align-self: center !important;
      }

      /* Quick Stats - ensure touch works */
      .quick-stat-item {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        user-select: none;
        cursor: pointer;
      }

      /* Widget cards */
      .widget {
        border-radius: 16px;
        margin: 0 16px 12px;
      }

      /* Modal - fullscreen on mobile */
      .modal-overlay {
        align-items: flex-end !important;
      }

      .modal-content, .modal-enhanced {
        margin: 0 !important;
        max-height: 90vh !important;
        width: 100% !important;
        max-width: 100% !important;
        border-radius: 20px 20px 0 0 !important;
        animation: slideUpModal 0.3s ease;
      }

      @keyframes slideUpModal {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }

      /* Form inputs */
      input[type="text"],
      input[type="date"],
      input[type="number"],
      textarea,
      select {
        font-size: 16px !important; /* Prevents iOS zoom */
        padding: 14px 16px !important;
        border-radius: 12px !important;
      }

      /* Weather widget compact */
      .weather-widget-mobile {
        padding: 8px 12px !important;
        border-radius: 10px !important;
      }

      .weather-widget-mobile .text-3xl {
        font-size: 1.5rem !important;
      }

      .weather-widget-mobile .text-2xl {
        font-size: 1.25rem !important;
      }

      /* Quick add input */
      #home-quick-add-input,
      #quick-add-input {
        font-size: 16px !important;
      }

      /* Hide some elements on mobile */
      .hide-mobile {
        display: none !important;
      }

      /* Home view header - stack on mobile */
      .home-greeting-row {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 4px !important;
      }

      .home-greeting-row h1 {
        font-size: 1.375rem !important;
      }

      /* Widget grid - single column on small screens */
      .widget-grid {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
        padding: 0 16px !important;
      }

      /* Score grid */
      .score-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      /* Area hero - compact */
      .area-hero {
        padding: 16px !important;
      }

      .area-hero h2 {
        font-size: 1.5rem !important;
      }

      /* Progress ring smaller */
      .progress-ring {
        width: 48px !important;
        height: 48px !important;
      }

      /* Sidebar sections stack */
      .sidebar-section {
        margin-bottom: 8px;
      }

      /* Remove hover effects on touch */
      .task-item:hover {
        background: transparent;
      }

      /* Charts responsive */
      .chart-container {
        height: 180px !important;
      }

      /* Settings */
      .settings-grid {
        grid-template-columns: 1fr;
      }

      /* Mobile text size fixes - ensure readability */
      .modal-section-label {
        font-size: 12px !important;
      }

      .autocomplete-option,
      .autocomplete-create {
        font-size: 14px !important;
        min-height: 44px !important;
        padding: 12px !important;
      }

      /* Status pills - proper touch targets */
      .status-pill {
        min-height: 44px !important;
        padding: 10px 16px !important;
        font-size: 14px !important;
      }

      /* Sidebar items - touch friendly */
      .sidebar-item {
        min-height: 44px !important;
        padding: 10px 12px !important;
      }

      /* Section labels */
      .section-label {
        font-size: 13px !important;
      }

      /* Action buttons visible on mobile (no hover) */
      .task-item .absolute.right-3 {
        opacity: 1 !important;
      }
    }

    /* Small phones (iPhone SE, older devices) */
    @media (max-width: 375px) {
      .mobile-header-compact {
        padding: 10px 12px;
      }

      .widget {
        margin: 0 12px 10px;
      }

      .task-item {
        padding: 12px;
      }

      .score-grid {
        grid-template-columns: 1fr;
      }

      .mobile-nav-item {
        padding: 6px 10px;
        min-height: 48px;
      }

      .mobile-nav-item span {
        font-size: 10px;
      }
    }

    /* Large phones (iPhone Pro Max, iPhone 17 Pro Max - 430px+ width) */
    @media (min-width: 390px) and (max-width: 768px) {
      /* Generous spacing for large screens */
      .widget {
        margin: 0 20px 16px;
        border-radius: 20px;
      }

      /* Widget grid - allow 2 columns on larger phones */
      .grid-cols-2 {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      /* Today/Next widgets side by side */
      .widget.col-span-1 {
        min-height: 140px;
      }

      /* Header with more breathing room */
      .home-greeting-row h1 {
        font-size: 1.5rem !important;
      }

      /* Weather inline on larger phones */
      .weather-inline {
        flex-direction: row !important;
        gap: 8px !important;
      }

      /* Larger touch targets */
      .quick-stat-item {
        padding: 14px 8px !important;
        border-radius: 14px !important;
      }

      .quick-stat-item .text-xl {
        font-size: 1.5rem !important;
      }

      /* Task items more spacious */
      .task-item {
        padding: 16px 20px;
        min-height: 60px;
      }

      /* Bottom nav larger icons */
      .mobile-nav-item svg {
        width: 26px;
        height: 26px;
      }

      .mobile-nav-item span {
        font-size: 11px;
      }

      /* Daily Entry sections more spacious */
      .daily-entry-section {
        padding: 16px !important;
        border-radius: 16px !important;
      }

      .score-grid {
        gap: 12px;
      }
    }

    /* Tablet portrait */
    @media (min-width: 768px) and (max-width: 1024px) {
      .sidebar-container {
        width: 240px !important;
      }
    }

    /* Touch-friendly tap targets */
    @media (hover: none) and (pointer: coarse) {
      /* All interactive elements get larger touch targets */
      .sidebar-item {
        min-height: 48px;
        padding-top: 12px;
        padding-bottom: 12px;
      }

      .action-btn {
        opacity: 1;
        min-width: 44px;
        min-height: 44px;
      }

      button, .sb-btn {
        min-height: 44px;
      }

      input[type="checkbox"] {
        min-width: 20px;
        min-height: 20px;
      }

      /* Icon buttons need larger hit areas */
      button.p-1, button.p-1\\.5 {
        min-width: 44px !important;
        min-height: 44px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      /* Modal close buttons */
      .modal-enhanced button[onclick*="Modal=false"],
      .modal-enhanced button[onclick*="editingHome"] {
        min-width: 44px !important;
        min-height: 44px !important;
      }

      /* Widget action buttons */
      .widget-actions button {
        min-width: 44px !important;
        min-height: 44px !important;
      }

      /* Bottom nav items */
      .mobile-nav-item {
        min-height: 48px !important;
        padding: 10px 16px !important;
      }

      /* Quick stat items */
      .quick-stat-item {
        min-height: 48px !important;
      }

      /* MOBILE TASK LIST - Clean Things 3 style */
      /* Hide ALL task actions on touch devices - tap row to edit */
      .task-item .absolute,
      .task-item [class*="group-hover"],
      .task-item select,
      .task-item .opacity-0 {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
      }

      /* Task items: cleaner layout on mobile */
      .task-item {
        cursor: pointer !important;
        -webkit-tap-highlight-color: transparent;
      }

      .task-item:active {
        background: var(--bg-secondary) !important;
      }

      /* Full width task titles on mobile */
      .task-item .flex-1 {
        width: 100% !important;
        max-width: none !important;
        padding-right: 8px !important;
      }

      /* Task title text - ensure full width display */
      .task-item .flex-1 span {
        display: block !important;
        white-space: normal !important;
        word-wrap: break-word !important;
      }

      /* Larger touch target for task checkbox */
      .task-item .task-checkbox {
        min-width: 24px !important;
        min-height: 24px !important;
        width: 24px !important;
        height: 24px !important;
      }

      /* Task metadata on mobile - smaller but readable */
      .task-item .text-\\[12px\\] {
        font-size: 11px !important;
      }

      /* Task row padding for mobile */
      .task-item > div {
        padding: 12px 16px !important;
      }
    }

    /* iOS safe areas */
    @supports (padding: max(0px)) {
      body {
        padding-left: max(0px, env(safe-area-inset-left));
        padding-right: max(0px, env(safe-area-inset-right));
        padding-bottom: max(0px, env(safe-area-inset-bottom));
      }
    }

    /* ========== AUTOCOMPLETE STYLES ========== */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }
    .autocomplete-input {
      width: 100%;
      padding: 12px 36px 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 16px;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }
    .autocomplete-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    .autocomplete-input::placeholder {
      color: var(--text-muted);
    }
    .autocomplete-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }
    .autocomplete-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--modal-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--shadow-lg);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.15s ease;
    }
    .autocomplete-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .autocomplete-option {
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.15s ease;
    }
    .autocomplete-option:first-child {
      border-radius: 10px 10px 0 0;
    }
    .autocomplete-option:last-child {
      border-radius: 0 0 10px 10px;
    }
    .autocomplete-option:only-child {
      border-radius: 10px;
    }
    .autocomplete-option:hover, .autocomplete-option.highlighted {
      background: var(--accent-light);
    }
    .autocomplete-option.selected {
      background: var(--accent-light);
      font-weight: 500;
    }
    .autocomplete-option-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .autocomplete-empty {
      padding: 16px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }
    .autocomplete-create {
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--accent);
      font-weight: 500;
      font-size: 13px;
    }
    .autocomplete-create:hover {
      background: var(--accent-light);
    }

    /* Multi-select tags */
    .tag-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg-input);
      min-height: 44px;
      cursor: text;
      transition: all 0.2s ease;
    }
    .tag-input-container:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    .tag-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      background: var(--bg-secondary);
      color: var(--text-primary);
      animation: tagPop 0.2s ease;
    }
    @keyframes tagPop {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .tag-pill-remove {
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.15s;
      display: flex;
      align-items: center;
    }
    .tag-pill-remove:hover {
      opacity: 1;
    }
    .tag-input-field {
      flex: 1;
      min-width: 100px;
      border: none;
      outline: none;
      background: transparent;
      font-size: 14px;
      padding: 2px 0;
    }

    /* Enhanced modal styles */
    .modal-enhanced {
      background: var(--modal-bg);
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    .modal-header-enhanced {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--modal-bg);
    }
    .modal-body-enhanced {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer-enhanced {
      padding: 16px 24px;
      border-top: 1px solid var(--border-light);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: var(--bg-secondary);
    }
    .modal-section {
      margin-bottom: 20px;
    }
    .modal-section:last-child {
      margin-bottom: 0;
    }
    .modal-section-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .modal-input-enhanced {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }
    .modal-input-enhanced:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    .modal-input-enhanced.title-input {
      font-size: 18px;
      font-weight: 500;
      padding: 14px 16px;
    }
    .modal-textarea-enhanced {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      background: var(--bg-input);
      color: var(--text-primary);
      resize: none;
      min-height: 80px;
      transition: all 0.2s ease;
    }
    .modal-textarea-enhanced:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    /* Type switcher pill */
    .type-switcher {
      display: inline-flex;
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 4px;
      gap: 4px;
    }
    .type-option {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
    }
    .type-option.active {
      background: var(--modal-bg);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }
    .type-option:hover:not(.active) {
      color: var(--text-primary);
    }

    /* Quick status pills */
    .status-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .status-pill {
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text-secondary);
    }
    .status-pill:hover {
      border-color: var(--text-muted);
    }
    .status-pill.selected {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .status-pill .status-icon {
      margin-right: 6px;
    }

    /* Date input styling */
    .date-input-wrapper {
      position: relative;
    }
    .date-input-wrapper input {
      padding-right: 36px;
    }
    .date-input-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }

    /* Repeat section */
    .repeat-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: 10px;
      background: var(--bg-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .repeat-toggle:hover {
      background: var(--border);
    }
    .repeat-toggle.active {
      background: var(--accent-light);
    }
    .repeat-config {
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      background: var(--bg-secondary);
      display: none;
    }
    .repeat-config.show {
      display: block;
      animation: slideDown 0.2s ease;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen" style="background: var(--bg-primary); color: var(--text-primary);">
  <div id="app"></div>

  <script>
    /**
     * ============================================================================
     * NUCLEUS - Life Gamification & Task Management App
     * ============================================================================
     *
     * A single-file web application combining:
     * - Things 3/OmniFocus-style task management with perspectives
     * - Daily habit tracking with gamification scoring
     * - Health metrics tracking (prayers, glucose, WHOOP integration)
     * - Outliner notes with hierarchical structure
     *
     * ARCHITECTURE OVERVIEW:
     * ----------------------
     * - Single HTML file with embedded CSS and JavaScript
     * - Reactive rendering via full DOM replacement on state change
     * - localStorage for persistence, GitHub API for cloud sync
     * - No framework dependencies (vanilla JS)
     *
     * MAIN SECTIONS:
     * --------------
     * 1. CONFIGURATION & CONSTANTS (Lines ~1608-2200)
     *    - App version, storage keys, themes, weights
     * 2. WEATHER SYSTEM (Lines ~1716-1870)
     *    - Open-Meteo API integration with caching
     * 3. GITHUB SYNC (Lines ~1870-2080)
     *    - Cloud backup/restore with conflict resolution
     * 4. DATA INITIALIZATION (Lines ~2080-2400)
     *    - Load from localStorage, defaults, migrations
     * 5. TASK SYSTEM (Lines ~2400-4100)
     *    - CRUD, perspectives, drag-drop, repeating tasks
     * 6. OUTLINER NOTES (Lines ~3450-3800)
     *    - Hierarchical notes with indent/outdent
     * 7. SCORING ENGINE (Lines ~4500-4700)
     *    - Multi-category scoring with memoization
     * 8. RENDERING (Lines ~4800-7600)
     *    - Home, Tasks, Track, Bulk, Dashboard tabs
     *
     * @author Muhammad Habib
     * @version 3.2.3
     * @license MIT
     */

    // ============================================================================
    // SECTION 1: CONFIGURATION & CONSTANTS
    // ============================================================================

    // App Version (MAJOR.MINOR.PATCH)
    // MAJOR: New major features (Home view, Next perspective, etc.)
    // MINOR: Enhancements and improvements
    // PATCH: Bug fixes and small tweaks
    const APP_VERSION = '3.2.3';

    const STORAGE_KEY = 'lifeGamificationData_v3';
    const WEIGHTS_KEY = 'lifeGamificationWeights_v1';
    const GITHUB_TOKEN_KEY = 'lifeGamificationGithubToken';
    const THEME_KEY = 'lifeGamificationTheme';
    const DATA_URL = 'data.json';

    // Available themes
    const THEMES = {
      simplebits: { name: 'SimpleBits', description: 'Warm cream tones with coral accents' },
      things3: { name: 'Things 3', description: 'Clean white with blue accents' }
    };

    // GitHub repo config
    const GITHUB_OWNER = 'mhabib306-sys';
    const GITHUB_REPO = 'lifeg';
    const GITHUB_FILE_PATH = 'data.json';

    // Sync status
    let syncStatus = 'idle'; // 'idle', 'syncing', 'success', 'error'
    let lastSyncTime = null;
    let syncDebounceTimer = null;

    // Weather state
    let weatherData = null;
    let weatherLocation = { lat: 30.0291, lon: 31.4975, city: 'New Cairo' }; // Default to New Cairo
    const WEATHER_CACHE_KEY = 'nucleusWeatherCache';
    const WEATHER_LOCATION_KEY = 'nucleusWeatherLocation';

    // Weather icons (Things 3 style - minimal, clean)
    const WEATHER_ICONS = {
      0: '‚òÄÔ∏è',  // Clear sky
      1: 'üå§Ô∏è',  // Mainly clear
      2: '‚õÖ',  // Partly cloudy
      3: '‚òÅÔ∏è',  // Overcast
      45: 'üå´Ô∏è', // Fog
      48: 'üå´Ô∏è', // Depositing rime fog
      51: 'üåßÔ∏è', // Light drizzle
      53: 'üåßÔ∏è', // Moderate drizzle
      55: 'üåßÔ∏è', // Dense drizzle
      61: 'üåßÔ∏è', // Slight rain
      63: 'üåßÔ∏è', // Moderate rain
      65: 'üåßÔ∏è', // Heavy rain
      71: 'üå®Ô∏è', // Slight snow
      73: 'üå®Ô∏è', // Moderate snow
      75: '‚ùÑÔ∏è',  // Heavy snow
      77: 'üå®Ô∏è', // Snow grains
      80: 'üå¶Ô∏è', // Slight rain showers
      81: 'üå¶Ô∏è', // Moderate rain showers
      82: '‚õàÔ∏è',  // Violent rain showers
      85: 'üå®Ô∏è', // Slight snow showers
      86: 'üå®Ô∏è', // Heavy snow showers
      95: '‚õàÔ∏è',  // Thunderstorm
      96: '‚õàÔ∏è',  // Thunderstorm with hail
      99: '‚õàÔ∏è',  // Thunderstorm with heavy hail
    };

    const WEATHER_DESCRIPTIONS = {
      0: 'Clear',
      1: 'Mostly Clear',
      2: 'Partly Cloudy',
      3: 'Cloudy',
      45: 'Foggy',
      48: 'Foggy',
      51: 'Light Drizzle',
      53: 'Drizzle',
      55: 'Heavy Drizzle',
      61: 'Light Rain',
      63: 'Rain',
      65: 'Heavy Rain',
      71: 'Light Snow',
      73: 'Snow',
      75: 'Heavy Snow',
      77: 'Snow Grains',
      80: 'Light Showers',
      81: 'Showers',
      82: 'Heavy Showers',
      85: 'Light Snow Showers',
      86: 'Snow Showers',
      95: 'Thunderstorm',
      96: 'Thunderstorm',
      99: 'Severe Storm',
    };

    // ============================================================================
    // SECTION 2: WEATHER SYSTEM
    // ============================================================================
    // Uses Open-Meteo API (free, no key needed) for weather data
    // Implements 30-minute caching to reduce API calls
    // Supports geolocation with fallback to default location (New Cairo)

    /**
     * Load cached weather location from localStorage
     * Uses try-catch to handle corrupted cache gracefully
     */
    function loadWeatherLocation() {
      try {
        const cached = localStorage.getItem(WEATHER_LOCATION_KEY);
        if (cached) {
          weatherLocation = JSON.parse(cached);
        }
      } catch (e) {
        console.error('Error loading weather location:', e);
      }
    }

    // Save weather location
    function saveWeatherLocation() {
      localStorage.setItem(WEATHER_LOCATION_KEY, JSON.stringify(weatherLocation));
    }

    /**
     * Fetch weather from Open-Meteo API
     * CACHING: 30-minute cache stored in localStorage
     * FALLBACK: Returns stale cached data if API fails
     *
     * API returns: current conditions, daily min/max, hourly temps
     * We calculate the time of day when max/min temps occur
     *
     * @async
     * @returns {void} Updates global weatherData object
     */
    async function fetchWeather() {
      try {
        // Check cache first (cache for 30 minutes)
        const cached = localStorage.getItem(WEATHER_CACHE_KEY);
        if (cached) {
          try {
            const { data, timestamp } = JSON.parse(cached);
            if (data && timestamp && Date.now() - timestamp < 30 * 60 * 1000) {
              weatherData = data;
              return;
            }
          } catch (cacheError) {
            console.warn('Corrupted weather cache, clearing:', cacheError);
            localStorage.removeItem(WEATHER_CACHE_KEY);
          }
        }

        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${weatherLocation.lat}&longitude=${weatherLocation.lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min&hourly=temperature_2m&timezone=auto&forecast_days=1`
        );

        if (!response.ok) throw new Error('Weather fetch failed');

        const data = await response.json();

        // Find hours for max and min temps from hourly data
        const hourlyTemps = data.hourly.temperature_2m;
        const hourlyTimes = data.hourly.time;
        let maxIdx = 0, minIdx = 0;
        for (let i = 0; i < hourlyTemps.length; i++) {
          if (hourlyTemps[i] > hourlyTemps[maxIdx]) maxIdx = i;
          if (hourlyTemps[i] < hourlyTemps[minIdx]) minIdx = i;
        }
        const maxHour = new Date(hourlyTimes[maxIdx]).getHours();
        const minHour = new Date(hourlyTimes[minIdx]).getHours();
        const formatHour = (h) => h === 0 ? '12am' : h < 12 ? h + 'am' : h === 12 ? '12pm' : (h - 12) + 'pm';

        weatherData = {
          temp: Math.round(data.current.temperature_2m),
          humidity: data.current.relative_humidity_2m,
          weatherCode: data.current.weather_code,
          windSpeed: Math.round(data.current.wind_speed_10m),
          tempMax: Math.round(data.daily.temperature_2m_max[0]),
          tempMin: Math.round(data.daily.temperature_2m_min[0]),
          maxHour: formatHour(maxHour),
          minHour: formatHour(minHour),
          city: weatherLocation.city
        };

        // Cache the result
        localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify({
          data: weatherData,
          timestamp: Date.now()
        }));

        render();
      } catch (error) {
        console.error('Weather fetch error:', error);
        // Still render even if fetch fails - show stale data or empty state
        render();
      }
    }

    // Get user's location
    function detectUserLocation() {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const { latitude, longitude } = position.coords;

            // Reverse geocode to get city name
            try {
              const response = await fetch(
                `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m&timezone=auto`
              );
              const data = await response.json();

              // Use timezone as city approximation or keep coordinates
              const cityName = data.timezone ? data.timezone.split('/').pop().replace(/_/g, ' ') : 'Your Location';

              weatherLocation = {
                lat: latitude,
                lon: longitude,
                city: cityName
              };
              saveWeatherLocation();
              fetchWeather();
            } catch (e) {
              console.error('Geocode error:', e);
            }
          },
          (error) => {
            console.log('Geolocation denied, using default location');
            fetchWeather();
          },
          { timeout: 5000 }
        );
      } else {
        fetchWeather();
      }
    }

    // Initialize weather
    function initWeather() {
      loadWeatherLocation();
      detectUserLocation();
    }

    // ============================================================================
    // SECTION 3: GITHUB SYNC & SETTINGS
    // ============================================================================
    // Cloud backup via GitHub API using Personal Access Token
    // Syncs: daily data, tasks, categories, labels, perspectives
    // Implements debounced auto-sync (2-second delay after changes)

    /**
     * Get stored GitHub Personal Access Token
     * @returns {string} Token or empty string if not set
     */
    function getGithubToken() {
      return localStorage.getItem(GITHUB_TOKEN_KEY) || '';
    }

    /**
     * Store GitHub PAT and trigger re-render to update UI
     * @param {string} token - GitHub Personal Access Token
     */
    function setGithubToken(token) {
      localStorage.setItem(GITHUB_TOKEN_KEY, token);
      render();
    }

    /**
     * Get current theme name from localStorage
     * @returns {string} Theme name ('simplebits' or 'things3')
     */
    function getTheme() {
      return localStorage.getItem(THEME_KEY) || 'things3';
    }

    // Set theme
    function setTheme(themeName) {
      localStorage.setItem(THEME_KEY, themeName);
      document.documentElement.setAttribute('data-theme', themeName);
      render();
    }

    // Apply theme on load
    function applyStoredTheme() {
      const theme = getTheme();
      document.documentElement.setAttribute('data-theme', theme);
    }
    applyStoredTheme();

    // Get current accent color from theme
    function getAccentColor() {
      return getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    }

    // Get theme colors object
    function getThemeColors() {
      const style = getComputedStyle(document.documentElement);
      return {
        accent: style.getPropertyValue('--accent').trim(),
        accentDark: style.getPropertyValue('--accent-dark').trim(),
        accentLight: style.getPropertyValue('--accent-light').trim(),
        bgPrimary: style.getPropertyValue('--bg-primary').trim(),
        bgSecondary: style.getPropertyValue('--bg-secondary').trim(),
        textPrimary: style.getPropertyValue('--text-primary').trim()
      };
    }

    // Update sync status in UI
    function updateSyncStatus(status, message = '') {
      syncStatus = status;
      const indicator = document.getElementById('sync-indicator');
      if (indicator) {
        const colors = {
          idle: 'bg-charcoal/30',
          syncing: 'bg-amber-400 animate-pulse',
          success: 'bg-green-500',
          error: 'bg-red-500'
        };
        const icons = {
          idle: '‚òÅÔ∏è',
          syncing: 'üîÑ',
          success: '‚úì',
          error: '‚úó'
        };
        indicator.className = `w-2 h-2 rounded-full ${colors[status]}`;
        indicator.title = message || status;
      }
      if (status === 'success') {
        lastSyncTime = new Date();
        setTimeout(() => {
          if (syncStatus === 'success') updateSyncStatus('idle');
        }, 3000);
      }
    }

    // Save data to GitHub
    async function saveToGithub() {
      const token = getGithubToken();
      if (!token) {
        console.log('‚ö†Ô∏è No GitHub token configured');
        return false;
      }

      updateSyncStatus('syncing', 'Saving to GitHub...');

      try {
        // Get current file SHA (needed for updates)
        const getResponse = await fetch(
          `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
          { headers: { 'Authorization': `token ${token}` } }
        );

        let sha = null;
        if (getResponse.ok) {
          const fileData = await getResponse.json();
          sha = fileData.sha;
        }

        // Prepare data payload
        const payload = {
          lastUpdated: new Date().toISOString(),
          data: allData,
          weights: WEIGHTS,
          maxScores: MAX_SCORES,
          tasks: tasksData,
          taskCategories: taskCategories,
          taskLabels: taskLabels,
          customPerspectives: customPerspectives
        };

        // Modern UTF-8 safe base64 encoding (replaces deprecated unescape)
        const jsonString = JSON.stringify(payload, null, 2);
        const bytes = new TextEncoder().encode(jsonString);
        const binString = Array.from(bytes, byte => String.fromCodePoint(byte)).join('');
        const content = btoa(binString);

        // Update file via GitHub API
        const updateResponse = await fetch(
          `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `token ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Auto-save: ${new Date().toLocaleString()}`,
              content: content,
              sha: sha
            })
          }
        );

        if (updateResponse.ok) {
          updateSyncStatus('success', 'Saved to GitHub');
          console.log('‚úÖ Saved to GitHub');
          return true;
        } else {
          const error = await updateResponse.json();
          throw new Error(error.message || 'Failed to save');
        }
      } catch (e) {
        updateSyncStatus('error', `Sync failed: ${e.message}`);
        console.error('‚ùå GitHub save failed:', e);
        return false;
      }
    }

    // Debounced save (waits 2 seconds after last change)
    function debouncedSaveToGithub() {
      if (syncDebounceTimer) clearTimeout(syncDebounceTimer);
      syncDebounceTimer = setTimeout(() => {
        saveToGithub();
      }, 2000);
    }

    // Load cloud data on startup
    async function loadCloudData() {
      const token = getGithubToken();

      try {
        // Try GitHub API first if token exists
        if (token) {
          const response = await fetch(
            `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
            { headers: { 'Authorization': `token ${token}` } }
          );

          if (response.ok) {
            const fileData = await response.json();
            // Modern UTF-8 safe base64 decoding (replaces deprecated escape)
            const binString = atob(fileData.content);
            const bytes = Uint8Array.from(binString, char => char.codePointAt(0));
            const jsonString = new TextDecoder().decode(bytes);
            let cloudData;
            try {
              cloudData = JSON.parse(jsonString);
            } catch (parseError) {
              console.error('Failed to parse cloud data:', parseError);
              updateSyncStatus('error', 'Corrupted cloud data');
              return;
            }

            if (cloudData.data) {
              // Merge cloud data with local
              const localData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
              Object.keys(cloudData.data).forEach(date => {
                if (!localData[date]) {
                  localData[date] = cloudData.data[date];
                }
              });
              localStorage.setItem(STORAGE_KEY, JSON.stringify(localData));
              allData = localData;
            }
            if (cloudData.weights) {
              WEIGHTS = cloudData.weights;
              localStorage.setItem(WEIGHTS_KEY, JSON.stringify(WEIGHTS));
            }
            if (cloudData.maxScores) {
              MAX_SCORES = cloudData.maxScores;
              localStorage.setItem('maxScores', JSON.stringify(MAX_SCORES));
            }
            if (cloudData.tasks) {
              tasksData = cloudData.tasks;
              localStorage.setItem(TASKS_KEY, JSON.stringify(tasksData));
            }
            if (cloudData.taskCategories) {
              taskCategories = cloudData.taskCategories;
              localStorage.setItem(TASK_CATEGORIES_KEY, JSON.stringify(taskCategories));
            }
            if (cloudData.taskLabels) {
              taskLabels = cloudData.taskLabels;
              localStorage.setItem(TASK_LABELS_KEY, JSON.stringify(taskLabels));
            }
            if (cloudData.customPerspectives) {
              customPerspectives = cloudData.customPerspectives;
              localStorage.setItem(PERSPECTIVES_KEY, JSON.stringify(customPerspectives));
            }
            console.log('‚úÖ Loaded from GitHub');
            updateSyncStatus('success', 'Loaded from GitHub');
            return;
          }
        }

        // Fallback to static file fetch
        const response = await fetch(DATA_URL + '?t=' + Date.now());
        if (response.ok) {
          const cloudData = await response.json();
          const localData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

          if (cloudData.data) {
            Object.keys(cloudData.data).forEach(date => {
              if (!localData[date]) {
                localData[date] = cloudData.data[date];
              }
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localData));
            allData = localData;
          }
          if (cloudData.weights) {
            WEIGHTS = cloudData.weights;
            localStorage.setItem(WEIGHTS_KEY, JSON.stringify(WEIGHTS));
          }
          console.log('‚úÖ Cloud data synced (static file)');
        }
      } catch (e) {
        console.log('üì¥ Offline mode - using local data');
      }
    }

    const defaultDayData = {
      prayers: { fajr: '', dhuhr: '', asr: '', maghrib: '', isha: '', quran: 0 },
      glucose: { avg: '', tir: '', insulin: '' },
      whoop: {
        sleepPerf: '', recovery: '', strain: '', whoopAge: ''
      },
      family: { mom: false, dad: false, jana: false, tia: false, ahmed: false, eman: false },
      habits: { exercise: 0, reading: 0, meditation: 0, water: '', vitamins: false, brushTeeth: 0, nop: '' }
    };

    // ============================================================================
    // SECTION 4: SCORING WEIGHTS CONFIGURATION
    // ============================================================================
    // Configurable point values for each tracking category
    // Users can adjust these in Settings to customize their scoring
    //
    // DESIGN PHILOSOPHY:
    // - Target ~100 points for a "perfect" day
    // - Base unit = 5 points (makes math intuitive)
    // - Categories weighted by importance to user
    //
    // Consistent scoring framework - base unit = 5 pts
    // Target daily max ~100 pts: Prayer 30, Diabetes 25, Whoop 25, Habits 15, Family 5
    const DEFAULT_WEIGHTS = {
      // PRAYER (max 30): 5 prayers √ó 5 pts + quran bonus
      prayer: { onTime: 5, late: 2, quran: 5 },

      // DIABETES (max 25): avg 10 + tir 10 + insulin 5
      glucose: { avgMax: 10, tirPerPoint: 0.1, insulinBase: 5, insulinPenalty: -5, insulinThreshold: 40 },

      // FAMILY (max 5): 6 members, ~1 pt each, cap at 5
      family: { mom: 1, dad: 1, jana: 1, tia: 1, ahmed: 1, eman: 1 },

      // HABITS (max 15): distributed across daily habits
      habits: { exercise: 3, reading: 2, meditation: 2, water: 1, vitamins: 2, brushTeeth: 1, nopYes: 2, nopNo: -2 },

      // WHOOP (max 14): Sleep Perf + Recovery + Strain
      whoop: {
        sleepPerfHigh: 7, sleepPerfMid: 4, sleepPerfLow: 2,
        recoveryHigh: 2, recoveryMid: 1, recoveryLow: 0,
        strainMatch: 3, strainHigh: 2
      }
    };

    // Load weights and merge with defaults to ensure new keys are always present
    function loadWeights() {
      try {
        const stored = localStorage.getItem(WEIGHTS_KEY);
        if (!stored) return JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
        const saved = JSON.parse(stored);
        if (!saved || typeof saved !== 'object') return JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
        // Deep merge: ensure all default keys exist
        const merged = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
        Object.keys(merged).forEach(category => {
          if (saved[category]) {
            Object.keys(merged[category]).forEach(key => {
              if (saved[category][key] !== undefined) merged[category][key] = saved[category][key];
            });
          }
        });
        return merged;
      } catch (e) {
        console.error('Error loading weights:', e);
        return JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
      }
    }
    let WEIGHTS = loadWeights();

    // Max scores for progress bars (what a perfect day looks like)
    // These are configurable in settings
    const DEFAULT_MAX_SCORES = {
      prayer: 35,    // 5 prayers on-time (25) + 2 quran pages (10)
      diabetes: 25,  // avg 105 (10) + TIR 100% (10) + insulin ‚â§40 (5)
      whoop: 14,     // sleepPerf(7)+recovery(2)+strain(5)
      family: 6,     // all 6 family members checked
      habits: 16,    // exercise(3)+reading(2)+meditation(2)+water 2.5L(2.5)+vitamins(2)+brush 2x(2)+nop(2)
      total: 96      // sum of all maxes
    };
    const MAX_SCORES_KEY = 'lifeGamificationMaxScores';

    function loadMaxScores() {
      try {
        const stored = localStorage.getItem(MAX_SCORES_KEY);
        if (!stored) return JSON.parse(JSON.stringify(DEFAULT_MAX_SCORES));
        const saved = JSON.parse(stored);
        if (!saved || typeof saved !== 'object') return JSON.parse(JSON.stringify(DEFAULT_MAX_SCORES));
        return { ...DEFAULT_MAX_SCORES, ...saved };
      } catch (e) {
        console.error('Error loading max scores:', e);
        return JSON.parse(JSON.stringify(DEFAULT_MAX_SCORES));
      }
    }
    let MAX_SCORES = loadMaxScores();

    function saveMaxScores() {
      localStorage.setItem(MAX_SCORES_KEY, JSON.stringify(MAX_SCORES));
    }

    function saveWeights() {
      localStorage.setItem(WEIGHTS_KEY, JSON.stringify(WEIGHTS));
    }

    function updateWeight(category, field, value) {
      if (field) {
        WEIGHTS[category][field] = parseFloat(value) || 0;
      } else {
        WEIGHTS[category] = parseFloat(value) || 0;
      }
      saveWeights();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function resetWeights() {
      WEIGHTS = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
      saveWeights();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function updateMaxScore(category, value) {
      MAX_SCORES[category] = parseFloat(value) || 0;
      saveMaxScores();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function resetMaxScores() {
      MAX_SCORES = JSON.parse(JSON.stringify(DEFAULT_MAX_SCORES));
      saveMaxScores();
      render();
    }

    // Format numbers with commas for 4+ digits
    function fmt(num) {
      if (num === null || num === undefined || num === '') return '‚Äî';
      const n = typeof num === 'string' ? parseFloat(num) : num;
      if (isNaN(n)) return '‚Äî';
      return n.toLocaleString('en-US');
    }

    // Pre-populated January 2026 data from habits tracking sheet
    const JANUARY_DATA = {"2026-01-01":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":false,"dad":false,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-02":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-03":{"prayers":{"fajr":"1.1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-04":{"prayers":{"fajr":"1.2","dhuhr":"0.1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-05":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"0.1","isha":"1","quran":0},"family":{"mom":false,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-06":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-07":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"1","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":true,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-08":{"prayers":{"fajr":"0.1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-09":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-10":{"prayers":{"fajr":"0.1","dhuhr":"1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-11":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-12":{"prayers":{"fajr":"0.1","dhuhr":"","asr":"0.1","maghrib":"0.1","isha":"1","quran":0},"family":{"mom":false,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-13":{"prayers":{"fajr":"0.1","dhuhr":"","asr":"","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-14":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-15":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-16":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-17":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-18":{"prayers":{"fajr":"1","dhuhr":"1","asr":"0.1","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-19":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-20":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-21":{"prayers":{"fajr":"0.1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-22":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}}};

    // Merge pre-populated data with any existing localStorage data
    let storedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    let allData = { ...JANUARY_DATA, ...storedData };

    // Migration: move NoP from glucose to habits if exists
    let migrated = false;
    Object.keys(allData).forEach(date => {
      const day = allData[date];
      if (day.glucose && day.glucose.nop !== undefined && day.glucose.nop !== '') {
        if (!day.habits) day.habits = {};
        if (day.habits.nop === undefined || day.habits.nop === '') {
          day.habits.nop = day.glucose.nop;
          migrated = true;
        }
        delete day.glucose.nop;
      }
    });
    if (migrated) console.log('‚úÖ Migrated NoP data from glucose to habits');

    // Save merged data
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));

    // Helper function for timezone-safe local date (YYYY-MM-DD format)
    function getLocalDateString(date = new Date()) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    let currentDate = getLocalDateString();
    let weekChart = null;
    let breakdownChart = null;

    // View state persistence
    const VIEW_STATE_KEY = 'lifeGamificationViewState';
    const savedViewState = JSON.parse(localStorage.getItem(VIEW_STATE_KEY) || '{}');

    // Migrate old tab values to new structure
    let activeTab = savedViewState.activeTab || 'home';
    let activeSubTab = savedViewState.activeSubTab || 'daily';

    // Handle migration from old tab structure
    if (activeTab === 'track' || activeTab === 'bulk' || activeTab === 'dashboard') {
      activeSubTab = activeTab === 'track' ? 'daily' : activeTab;
      activeTab = 'life';
    }
    // Ensure valid tab values
    if (!['home', 'life', 'tasks', 'settings'].includes(activeTab)) {
      activeTab = 'home';
    }

    function saveViewState() {
      localStorage.setItem(VIEW_STATE_KEY, JSON.stringify({
        activeTab,
        activeSubTab,
        activePerspective,
        activeFilterType,
        activeCategoryFilter,
        activeLabelFilter,
        activePersonFilter
      }));
    }

    function switchSubTab(subTab) {
      activeSubTab = subTab;
      saveViewState();
      render();
    }

    // Bulk entry state - default to January 2026 where we have data
    let bulkMonth = 0; // January
    let bulkYear = 2026;
    let bulkCategory = 'prayers';

    // ============ TASKS SYSTEM (Things 3 + OmniFocus style) ============
    const TASKS_KEY = 'lifeGamificationTasks';
    const PERSPECTIVES_KEY = 'lifeGamificationPerspectives';
    const TASK_CATEGORIES_KEY = 'lifeGamificationTaskCategories';
    const TASK_LABELS_KEY = 'lifeGamificationTaskLabels';
    const TASK_PEOPLE_KEY = 'lifeGamificationTaskPeople';
    const HOME_WIDGETS_KEY = 'lifeGamificationHomeWidgets';

    // Default home widgets configuration
    const DEFAULT_HOME_WIDGETS = [
      { id: 'quick-stats', type: 'stats', title: 'Quick Stats', size: 'full', order: 0, visible: true },
      { id: 'quick-add', type: 'quick-add', title: 'Quick Add Task', size: 'full', order: 1, visible: true },
      { id: 'today-tasks', type: 'today-tasks', title: 'Today', size: 'half', order: 2, visible: true },
      { id: 'next-tasks', type: 'next-tasks', title: 'Next', size: 'half', order: 3, visible: true },
      { id: 'daily-entry', type: 'daily-entry', title: 'Daily Entry', size: 'full', order: 4, visible: true }
    ];

    // Default categories (Areas)
    const DEFAULT_TASK_CATEGORIES = [
      { id: 'personal', name: 'Personal', color: '#4A90A4' },
      { id: 'work', name: 'Work', color: '#6B8E5A' },
      { id: 'health', name: 'Health', color: '#E5533D' },
      { id: 'family', name: 'Family', color: '#C4943D' },
      { id: 'learning', name: 'Learning', color: '#7C6B8E' }
    ];

    // Default labels (Tags)
    const DEFAULT_TASK_LABELS = [
      { id: 'urgent', name: 'Urgent', color: '#DC2626' },
      { id: 'quick', name: 'Quick Win', color: '#16A34A' },
      { id: 'waiting', name: 'Waiting', color: '#CA8A04' },
      { id: 'blocked', name: 'Blocked', color: '#6B7280' }
    ];

    // Default people
    const DEFAULT_TASK_PEOPLE = [
      { id: 'self', name: 'Self', color: '#4A90A4' }
    ];

    // Things 3 exact SVG icons (filled style matching the app)
    const THINGS3_ICONS = {
      // Home - house icon for homepage
      home: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`,
      // Inbox - Things 3 style: document tray with curved bottom
      inbox: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm0 10v4h16v-4h-4a4 4 0 01-8 0H4z"/></svg>`,
      // Today - Things 3 style: filled 5-point star
      today: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l2.94 5.95 6.57.96-4.76 4.63 1.12 6.56L12 17.27l-5.87 3.09 1.12-6.56-4.76-4.63 6.57-.96z"/></svg>`,
      // Upcoming - Things 3 style: calendar with date marker
      upcoming: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6 2v2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2h-1V2h-2v2H8V2H6zm13 18H5V9h14v11z"/><rect x="7" y="11" width="3" height="3" rx="0.5"/></svg>`,
      // Anytime - Things 3 style: 3 horizontal bars stacked
      anytime: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="4" width="18" height="4" rx="2"/><rect x="3" y="10" width="18" height="4" rx="2"/><rect x="3" y="16" width="18" height="4" rx="2"/></svg>`,
      // Someday - Things 3 style: archive box
      someday: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v4H3V3zm1 5h16v13a1 1 0 01-1 1H5a1 1 0 01-1-1V8zm5 3v2h6v-2H9z"/></svg>`,
      // Logbook - Things 3 style: square with checkmark
      logbook: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4a2 2 0 012-2h12a2 2 0 012 2v16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm6.7 11.3l-3-3 1.4-1.4 1.6 1.6 4.6-4.6 1.4 1.4-6 6z"/></svg>`,
      // Trash - gray trash can
      trash: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`,
      // Area - Things 3 style: simple bordered square (more minimal)
      area: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="3"/></svg>`,
      // Next - Things 3/OmniFocus style: play button in circle
      next: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><path d="M10 8l6 4-6 4V8z" fill="white"/></svg>`,
      // Notes - Things 3 style: clean bullet list
      notes: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="6" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="5" cy="18" r="2"/><rect x="10" y="5" width="11" height="2" rx="1"/><rect x="10" y="11" width="11" height="2" rx="1"/><rect x="10" y="17" width="11" height="2" rx="1"/></svg>`,
      // Tab icons - Things 3 style
      lifeScore: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h2v8H3v-8zm4-4h2v12H7V9zm4-4h2v16h-2V5zm4 8h2v8h-2v-8zm4-4h2v12h-2V9z"/></svg>`,
      workspace: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4a2 2 0 012-2h12a2 2 0 012 2v16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v16h12V4H6zm2 3h8v2H8V7zm0 4h8v2H8v-2zm0 4h5v2H8v-2z"/></svg>`,
      settings: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.5A3.5 3.5 0 1112 8.5a3.5 3.5 0 010 7zm7.43-2.53c.04-.32.07-.64.07-.97s-.03-.66-.07-.98l2.11-1.65a.5.5 0 00.12-.64l-2-3.46a.5.5 0 00-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65A.5.5 0 0014 2h-4a.5.5 0 00-.49.42l-.38 2.65c-.61.25-1.17.58-1.69.98l-2.49-1a.5.5 0 00-.61.22l-2 3.46a.5.5 0 00.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65a.5.5 0 00-.12.64l2 3.46a.5.5 0 00.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65a.5.5 0 00.49.42h4a.5.5 0 00.49-.42l.38-2.65c.61-.25 1.17-.58 1.69-.98l2.49 1a.5.5 0 00.61-.22l2-3.46a.5.5 0 00-.12-.64l-2.11-1.65z"/></svg>`
    };

    /**
     * BUILTIN PERSPECTIVES - Things 3 style task views
     *
     * PERSPECTIVE OBJECT STRUCTURE:
     * @typedef {Object} Perspective
     * @property {string} id - Unique identifier
     * @property {string} name - Display name
     * @property {string} icon - SVG icon markup
     * @property {string} color - Brand color (hex)
     * @property {Object} filter - Filter rules for getFilteredTasks()
     * @property {boolean} builtin - True = cannot be deleted
     *
     * FILTER LOGIC (implemented in getFilteredTasks):
     * - inbox: status='inbox' AND no categoryId (unprocessed items)
     * - today: status='today' OR dueToday OR overdue OR scheduled for today
     * - upcoming: has future dueDate
     * - anytime: status='anytime' (no deadline, available now)
     * - someday: status='someday' (on hold for later)
     * - logbook: completed=true (all completed items)
     */
    const BUILTIN_PERSPECTIVES = [
      { id: 'inbox', name: 'Inbox', icon: THINGS3_ICONS.inbox, color: '#5598FE', filter: { status: 'inbox' }, builtin: true },
      { id: 'today', name: 'Today', icon: THINGS3_ICONS.today, color: '#FFCA28', filter: { status: 'today' }, builtin: true },
      { id: 'upcoming', name: 'Upcoming', icon: THINGS3_ICONS.upcoming, color: '#EF5350', filter: { upcoming: true }, builtin: true },
      { id: 'anytime', name: 'Anytime', icon: THINGS3_ICONS.anytime, color: '#26A69A', filter: { status: 'anytime' }, builtin: true },
      { id: 'someday', name: 'Someday', icon: THINGS3_ICONS.someday, color: '#D4A24C', filter: { status: 'someday' }, builtin: true },
      { id: 'logbook', name: 'Logbook', icon: THINGS3_ICONS.logbook, color: '#66BB6A', filter: { completed: true }, builtin: true }
    ];

    // Notes perspective (separate from task perspectives - uses outline/bullet style)
    const NOTES_PERSPECTIVE = { id: 'notes', name: 'Notes', icon: THINGS3_ICONS.notes, color: '#8B5CF6', filter: { notes: true }, builtin: true };

    // ============================================================================
    // SECTION 5: TASK DATA INITIALIZATION
    // ============================================================================
    // Load tasks data with error handling for corrupted localStorage
    // Uses try-catch to prevent app crash from malformed JSON

    /**
     * Safe JSON parse helper for localStorage reads
     * @param {string} key - localStorage key
     * @param {*} defaultValue - Fallback value if parse fails
     * @returns {*} Parsed value or default
     */
    function safeJsonParse(key, defaultValue) {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
      } catch (e) {
        console.error(`Failed to parse localStorage key "${key}":`, e);
        return defaultValue;
      }
    }

    let tasksData = safeJsonParse(TASKS_KEY, []);
    let taskCategories = safeJsonParse(TASK_CATEGORIES_KEY, null) || DEFAULT_TASK_CATEGORIES;
    let taskLabels = safeJsonParse(TASK_LABELS_KEY, null) || DEFAULT_TASK_LABELS;
    let taskPeople = safeJsonParse(TASK_PEOPLE_KEY, null) || DEFAULT_TASK_PEOPLE;
    let customPerspectives = safeJsonParse(PERSPECTIVES_KEY, []);
    let homeWidgets = safeJsonParse(HOME_WIDGETS_KEY, null) || DEFAULT_HOME_WIDGETS;
    let editingHomeWidgets = false;
    let draggingWidgetId = null;
    let activePerspective = savedViewState.activePerspective || 'inbox';
    // Migrate old 'home' perspective to 'inbox' since Home is now a separate tab
    if (activePerspective === 'home') activePerspective = 'inbox';
    let activeFilterType = savedViewState.activeFilterType || 'perspective';
    let activeCategoryFilter = savedViewState.activeCategoryFilter || null;
    let activeLabelFilter = savedViewState.activeLabelFilter || null;
    let activePersonFilter = savedViewState.activePersonFilter || null;
    let editingTaskId = null;
    let inlineEditingTaskId = null; // For inline title editing
    let newTaskContext = { categoryId: null, labelId: null, personId: null, status: 'inbox' }; // Context for new task
    let mobileDrawerOpen = false;
    let showTaskModal = false;
    let showPerspectiveModal = false;
    let showCategoryModal = false;
    let showLabelModal = false;
    let showPersonModal = false;
    let editingCategoryId = null;
    let editingLabelId = null;
    let editingPersonId = null;

    // Mobile drawer functions
    function openMobileDrawer() { mobileDrawerOpen = true; renderMobileDrawer(); }
    function closeMobileDrawer() { mobileDrawerOpen = false; renderMobileDrawer(); }
    function renderMobileDrawer() {
      const overlay = document.getElementById('mobile-sidebar-overlay');
      if (!overlay) return;
      if (mobileDrawerOpen) {
        overlay.classList.add('show');
      } else {
        overlay.classList.remove('show');
      }
    }

    // Inline task title editing
    function startInlineEdit(taskId) {
      inlineEditingTaskId = taskId;
      render();
      // Focus the input after render - use 100ms for reliable iOS keyboard appearance
      setTimeout(() => {
        const input = document.getElementById('inline-edit-input');
        if (input) {
          input.focus();
          input.select();
        }
      }, 100);
    }

    function saveInlineEdit(taskId) {
      const input = document.getElementById('inline-edit-input');
      if (input) {
        const newTitle = input.value.trim();
        if (newTitle) {
          updateTask(taskId, { title: newTitle });
        }
      }
      inlineEditingTaskId = null;
      render();
    }

    function cancelInlineEdit() {
      inlineEditingTaskId = null;
      render();
    }

    function handleInlineEditKeydown(event, taskId) {
      if (event.key === 'Enter') {
        event.preventDefault();
        saveInlineEdit(taskId);
      } else if (event.key === 'Escape') {
        event.preventDefault();
        cancelInlineEdit();
      }
    }

    // Switch to category view
    function showCategoryTasks(categoryId) {
      activeFilterType = 'category';
      activeCategoryFilter = categoryId;
      activeLabelFilter = null;
      mobileDrawerOpen = false;
      // Switch to tasks tab when navigating from Quick Stats or other widgets
      if (activeTab !== 'tasks') {
        activeTab = 'tasks';
      }
      saveViewState();
      render();
      scrollToContent();
    }

    // Switch to label view
    function showLabelTasks(labelId) {
      activeFilterType = 'label';
      activeLabelFilter = labelId;
      activeCategoryFilter = null;
      mobileDrawerOpen = false;
      // Switch to tasks tab when navigating from Quick Stats or other widgets
      if (activeTab !== 'tasks') {
        activeTab = 'tasks';
      }
      saveViewState();
      render();
      scrollToContent();
    }

    // Open new task modal with context
    function openNewTaskModal() {
      editingTaskId = null;
      // Set context based on current view
      if (activeFilterType === 'category' && activeCategoryFilter) {
        newTaskContext = { categoryId: activeCategoryFilter, labelId: null, labelIds: null, personId: null, status: 'inbox' };
      } else if (activeFilterType === 'label' && activeLabelFilter) {
        newTaskContext = { categoryId: null, labelId: activeLabelFilter, labelIds: null, personId: null, status: 'inbox' };
      } else if (activeFilterType === 'person' && activePersonFilter) {
        newTaskContext = { categoryId: null, labelId: null, labelIds: null, personId: activePersonFilter, status: 'inbox' };
      } else if (activeFilterType === 'perspective') {
        // Check if it's a custom perspective
        const customPerspective = customPerspectives.find(p => p.id === activePerspective);
        if (customPerspective && customPerspective.filter) {
          // Apply custom perspective filter rules
          newTaskContext = {
            categoryId: customPerspective.filter.categoryId || null,
            labelId: null,
            labelIds: customPerspective.filter.labelIds || null,
            personId: null,
            status: customPerspective.filter.status || 'inbox'
          };
        } else {
          // Built-in perspective - set status based on perspective
          const statusMap = { inbox: 'inbox', today: 'today', anytime: 'anytime', someday: 'someday' };
          newTaskContext = { categoryId: null, labelId: null, labelIds: null, personId: null, status: statusMap[activePerspective] || 'inbox' };
        }
      } else {
        newTaskContext = { categoryId: null, labelId: null, labelIds: null, personId: null, status: 'inbox' };
      }
      showTaskModal = true;
      render();
      // Auto-focus title input after render
      setTimeout(() => {
        const titleInput = document.getElementById('task-title');
        if (titleInput) titleInput.focus();
      }, 50);
    }

    // Quick add task - auto-links to current context (category, label, person, or perspective status)
    function quickAddTask(inputElement) {
      const title = inputElement.value.trim();
      if (!title) return;

      // Build options based on current context
      const options = { status: 'inbox' };

      // If in Notes perspective, always create a note (even when filtering by category/label/person)
      if (activePerspective === 'notes') {
        options.isNote = true;
        options.status = 'anytime'; // Notes go to anytime by default
      }

      // Apply category/label/person context
      if (activeFilterType === 'category' && activeCategoryFilter) {
        options.categoryId = activeCategoryFilter;
      } else if (activeFilterType === 'label' && activeLabelFilter) {
        options.labels = [activeLabelFilter];
      } else if (activeFilterType === 'person' && activePersonFilter) {
        options.people = [activePersonFilter];
      } else if (activeFilterType === 'perspective' && activePerspective && activePerspective !== 'notes') {
        // Handle custom and built-in perspectives (notes already handled above)
        const customPerspective = customPerspectives.find(p => p.id === activePerspective);
        if (customPerspective && customPerspective.filter) {
          // Apply custom perspective filter rules
          if (customPerspective.filter.status) options.status = customPerspective.filter.status;
          if (customPerspective.filter.categoryId) options.categoryId = customPerspective.filter.categoryId;
          if (customPerspective.filter.labelIds && customPerspective.filter.labelIds.length > 0) {
            options.labels = customPerspective.filter.labelIds;
          }
        } else {
          // Built-in perspective - set status based on perspective
          const statusMap = { inbox: 'inbox', today: 'today', anytime: 'anytime', someday: 'someday' };
          if (statusMap[activePerspective]) {
            options.status = statusMap[activePerspective];
          }
        }
      }

      createTask(title, options);
      inputElement.value = '';
      render();

      // Re-focus the quick-add input after render
      setTimeout(() => {
        const quickInput = document.getElementById('quick-add-input');
        if (quickInput) quickInput.focus();
      }, 50);
    }

    // Handle Enter key in quick-add input
    function handleQuickAddKeydown(event, inputElement) {
      if (event.key === 'Enter') {
        event.preventDefault();
        quickAddTask(inputElement);
      }
    }

    // Switch to perspective view
    function showPerspectiveTasks(perspectiveId) {
      activeFilterType = 'perspective';
      activePerspective = perspectiveId;
      activeCategoryFilter = null;
      activeLabelFilter = null;
      mobileDrawerOpen = false;
      // Switch to tasks tab when navigating from Quick Stats or other widgets
      if (activeTab !== 'tasks') {
        activeTab = 'tasks';
      }
      saveViewState();
      render();
      scrollToContent();
    }

    // Auto-scroll to content on mobile after navigation
    function scrollToContent() {
      if (window.matchMedia('(hover: none)').matches || window.innerWidth <= 768) {
        setTimeout(() => {
          const mainContent = document.querySelector('.main-content') || document.querySelector('main');
          if (mainContent) {
            mainContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
          } else {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        }, 50);
      }
    }

    // ============ HOME WIDGET MANAGEMENT ============
    function saveHomeWidgets() {
      localStorage.setItem(HOME_WIDGETS_KEY, JSON.stringify(homeWidgets));
    }

    function toggleWidgetVisibility(widgetId) {
      const widget = homeWidgets.find(w => w.id === widgetId);
      if (widget) {
        widget.visible = !widget.visible;
        saveHomeWidgets();
        render();
      }
    }

    function toggleWidgetSize(widgetId) {
      const widget = homeWidgets.find(w => w.id === widgetId);
      if (widget) {
        // Toggle between full and half width
        widget.size = widget.size === 'full' ? 'half' : 'full';
        saveHomeWidgets();
        render();
      }
    }

    function moveWidgetUp(widgetId) {
      const idx = homeWidgets.findIndex(w => w.id === widgetId);
      if (idx > 0) {
        [homeWidgets[idx], homeWidgets[idx - 1]] = [homeWidgets[idx - 1], homeWidgets[idx]];
        // Update order numbers
        homeWidgets.forEach((w, i) => w.order = i);
        saveHomeWidgets();
        render();
      }
    }

    function moveWidgetDown(widgetId) {
      const idx = homeWidgets.findIndex(w => w.id === widgetId);
      if (idx < homeWidgets.length - 1) {
        [homeWidgets[idx], homeWidgets[idx + 1]] = [homeWidgets[idx + 1], homeWidgets[idx]];
        // Update order numbers
        homeWidgets.forEach((w, i) => w.order = i);
        saveHomeWidgets();
        render();
      }
    }

    function handleWidgetDragStart(event, widgetId) {
      draggingWidgetId = widgetId;
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', widgetId);
      event.target.classList.add('dragging');
    }

    function handleWidgetDragEnd(event) {
      event.target.classList.remove('dragging');
      document.querySelectorAll('.widget').forEach(el => el.classList.remove('drag-over'));
      draggingWidgetId = null;
    }

    function handleWidgetDragOver(event, targetWidgetId) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';

      if (!draggingWidgetId || draggingWidgetId === targetWidgetId) return;

      // Clear all drag-over states first
      document.querySelectorAll('.widget').forEach(el => el.classList.remove('drag-over'));
      // Add to current target
      event.currentTarget.classList.add('drag-over');
    }

    function handleWidgetDragLeave(event) {
      if (!event.currentTarget.contains(event.relatedTarget)) {
        event.currentTarget.classList.remove('drag-over');
      }
    }

    function handleWidgetDrop(event, targetWidgetId) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');

      if (!draggingWidgetId || draggingWidgetId === targetWidgetId) {
        draggingWidgetId = null;
        return;
      }

      const dragIdx = homeWidgets.findIndex(w => w.id === draggingWidgetId);
      const targetIdx = homeWidgets.findIndex(w => w.id === targetWidgetId);

      if (dragIdx !== -1 && targetIdx !== -1) {
        // Swap positions
        const [draggedWidget] = homeWidgets.splice(dragIdx, 1);
        homeWidgets.splice(targetIdx, 0, draggedWidget);
        homeWidgets.forEach((w, i) => w.order = i);
        saveHomeWidgets();
        render();
      }

      draggingWidgetId = null;
    }

    function resetHomeWidgets() {
      // Reset to default without confirmation for better UX
      homeWidgets = JSON.parse(JSON.stringify(DEFAULT_HOME_WIDGETS));
      localStorage.removeItem(HOME_WIDGETS_KEY);
      saveHomeWidgets();
      render();
    }

    function toggleEditHomeWidgets() {
      editingHomeWidgets = !editingHomeWidgets;
      render();
    }

    // Render a single widget based on its type
    function renderHomeWidget(widget, isEditing) {
      const today = getLocalDateString();
      const nextLabel = taskLabels.find(l => l.name.toLowerCase() === 'next');

      // Size class mapping
      const sizeClass = widget.size === 'full' ? 'col-span-2' : widget.size === 'half' ? 'col-span-1' : 'col-span-1';

      // Size labels for display
      const sizeLabels = { full: 'Full', half: 'Half', third: 'Third' };
      const nextSize = { full: 'half', half: 'full' }; // Simplified to just full/half

      // Edit controls shown in edit mode
      const editControls = isEditing ? `
        <div class="flex items-center gap-1 ml-auto">
          <button onclick="event.stopPropagation(); toggleWidgetSize('${widget.id}')"
            class="widget-resize-btn flex items-center gap-1.5 px-2 py-1 text-charcoal/60 hover:text-coral rounded transition border border-charcoal/10 hover:border-coral/30"
            title="Click to resize">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              ${widget.size === 'full'
                ? '<rect x="3" y="3" width="18" height="18" rx="2"/>'
                : '<rect x="3" y="3" width="8" height="18" rx="2"/><rect x="13" y="3" width="8" height="18" rx="2" opacity="0.3"/>'}
            </svg>
            <span class="text-[11px] font-medium uppercase">${sizeLabels[widget.size] || 'Half'}</span>
          </button>
          <button onclick="event.stopPropagation(); toggleWidgetVisibility('${widget.id}')" class="p-1.5 text-charcoal/40 hover:text-red-500 hover:bg-red-50 rounded transition" title="Hide widget">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
      ` : '';

      let content = '';

      switch (widget.type) {
        case 'stats': {
          const todayTasksCount = tasksData.filter(t => {
            if (t.completed || t.isNote) return false;
            const isDueToday = t.dueDate === today;
            const isOverdue = t.dueDate && t.dueDate < today;
            const isScheduledForToday = t.deferDate && t.deferDate <= today;
            return t.status === 'today' || isDueToday || isOverdue || isScheduledForToday;
          }).length;
          const nextTasksCount = nextLabel ? tasksData.filter(t => {
            if (t.completed || t.isNote) return false;
            return (t.labels || []).includes(nextLabel.id);
          }).length : 0;
          const completedToday = tasksData.filter(t => t.completed && t.completedAt && t.completedAt.startsWith(today)).length;
          const inboxCount = tasksData.filter(t => !t.completed && !t.isNote && t.status === 'inbox' && !t.categoryId).length;

          content = `
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">
              <button type="button" class="quick-stat-item bg-warmgray/30 rounded-xl p-3 text-center active:bg-warmgray/60 transition-all" onclick="showPerspectiveTasks('today')">
                <div class="text-xl sm:text-2xl font-bold text-charcoal">${todayTasksCount}</div>
                <div class="text-xs text-charcoal/50 mt-1">Due Today</div>
              </button>
              <button type="button" class="quick-stat-item bg-warmgray/30 rounded-xl p-3 text-center active:bg-warmgray/60 transition-all" onclick="${nextLabel ? `showLabelTasks('${nextLabel.id}')` : 'void(0)'}">
                <div class="text-xl sm:text-2xl font-bold text-[#8B5CF6]">${nextTasksCount}</div>
                <div class="text-xs text-charcoal/50 mt-1">Tagged Next</div>
              </button>
              <button type="button" class="quick-stat-item bg-warmgray/30 rounded-xl p-3 text-center active:bg-warmgray/60 transition-all" onclick="showPerspectiveTasks('logbook')">
                <div class="text-xl sm:text-2xl font-bold text-green-600">${completedToday}</div>
                <div class="text-xs text-charcoal/50 mt-1">Done Today</div>
              </button>
              <button type="button" class="quick-stat-item bg-warmgray/30 rounded-xl p-3 text-center active:bg-warmgray/60 transition-all" onclick="showPerspectiveTasks('inbox')">
                <div class="text-xl sm:text-2xl font-bold ${inboxCount > 0 ? 'text-blue-500' : 'text-charcoal'}">${inboxCount}</div>
                <div class="text-xs text-charcoal/50 mt-1">In Inbox</div>
              </button>
            </div>
          `;
          break;
        }

        case 'quick-add':
          content = `
            <div class="flex items-center gap-3">
              <div class="w-5 h-5 rounded-full border-2 border-dashed border-charcoal/20 flex-shrink-0"></div>
              <input type="text" id="home-quick-add-input"
                placeholder="Quick add task... (press Enter)"
                onkeydown="if(event.key==='Enter'){event.preventDefault();homeQuickAddTask(this);}"
                class="flex-1 text-[15px] text-charcoal placeholder-charcoal/30 bg-transparent border-0 outline-none focus:ring-0">
              <button onclick="homeQuickAddTask(document.getElementById('home-quick-add-input'))"
                class="text-charcoal/30 hover:text-coral transition p-1" title="Add task">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
              </button>
            </div>
          `;
          break;

        case 'today-tasks': {
          const todayTasks = tasksData.filter(t => {
            if (t.completed || t.isNote) return false;
            const isDueToday = t.dueDate === today;
            const isOverdue = t.dueDate && t.dueDate < today;
            const isScheduledForToday = t.deferDate && t.deferDate <= today;
            return t.status === 'today' || isDueToday || isOverdue || isScheduledForToday;
          }).sort((a, b) => {
            if (a.dueDate && !b.dueDate) return -1;
            if (!a.dueDate && b.dueDate) return 1;
            if (a.dueDate && b.dueDate) return a.dueDate.localeCompare(b.dueDate);
            return 0;
          });

          content = todayTasks.length === 0 ? `
            <div class="py-8 text-center text-[var(--text-muted)] text-sm">No tasks due today</div>
          ` : `
            <div class="space-y-0.5 max-h-[300px] overflow-y-auto px-1">
              ${todayTasks.slice(0, 8).map(task => renderTaskItem(task, false, true)).join('')}
              ${todayTasks.length > 8 ? '<div class="px-3 py-3 text-center"><button onclick="showPerspectiveTasks(\'today\')" class="text-sm text-[var(--accent)] hover:underline font-medium">View all ' + todayTasks.length + ' tasks ‚Üí</button></div>' : ''}
            </div>
          `;
          break;
        }

        case 'next-tasks': {
          const nextTasks = nextLabel ? tasksData.filter(t => {
            if (t.completed || t.isNote) return false;
            const isNextTagged = (t.labels || []).includes(nextLabel.id);
            if (!isNextTagged) return false;
            const isDatedTask = t.status === 'today' || t.dueDate === today || (t.dueDate && t.dueDate < today);
            return !isDatedTask;
          }) : [];

          content = nextTasks.length === 0 ? `
            <div class="py-8 text-center text-[var(--text-muted)] text-sm">No tasks tagged "Next"</div>
          ` : `
            <div class="space-y-0.5 max-h-[300px] overflow-y-auto px-1">
              ${nextTasks.slice(0, 8).map(task => renderTaskItem(task, false, true)).join('')}
              ${nextTasks.length > 8 ? '<div class="px-3 py-3 text-center"><button onclick="showLabelTasks(\'' + nextLabel.id + '\')" class="text-sm text-[var(--accent)] hover:underline font-medium">View all ' + nextTasks.length + ' tasks ‚Üí</button></div>' : ''}
            </div>
          `;
          break;
        }

        case 'daily-entry': {
          const todayData = allData[today] || JSON.parse(JSON.stringify(defaultDayData));
          const prayerData = todayData.prayers || {};
          const glucoseData = todayData.glucose || {};
          const whoopData = todayData.whoop || {};
          const habitsData = todayData.habits || {};

          // Calculate completion for progress indicators
          const prayerFields = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
          const prayersDone = prayerFields.filter(f => prayerData[f] && parseFloat(prayerData[f]) > 0).length;
          const habitFields = ['exercise', 'reading', 'meditation', 'water', 'vitamins'];
          const habitsDone = habitFields.filter(f => habitsData[f]).length;

          content = `
            <div class="space-y-4">
              <!-- Prayers Section -->
              <div class="bg-[var(--bg-secondary)] rounded-xl p-4 border border-[var(--border-light)]">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wide">üïå Prayers</span>
                  <span class="text-xs text-[var(--text-muted)] font-medium">${prayersDone}/5</span>
                </div>
                <div class="grid grid-cols-6 gap-2">
                  ${['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].map((p, i) => {
                    const labels = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                    const shortLabels = ['F', 'D', 'A', 'M', 'I'];
                    return '<div class="text-center">' +
                      '<label class="text-[10px] text-[var(--text-muted)] font-medium block mb-1">' + shortLabels[i] + '</label>' +
                      '<input type="number" step="0.1" min="0" max="1" value="' + (prayerData[p] || '') + '" placeholder="0"' +
                      ' onchange="updateDailyField(\'prayers\', \'' + p + '\', this.value)"' +
                      ' class="w-full px-2 py-2 text-center text-sm font-medium bg-[var(--bg-input)] border border-[var(--border)] rounded-lg focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent-light)]">' +
                      '</div>';
                  }).join('')}
                  <div class="text-center">
                    <label class="text-[10px] text-[var(--text-muted)] font-medium block mb-1">üìñ</label>
                    <input type="number" step="0.1" value="${prayerData.quran || ''}" placeholder="0"
                      onchange="updateDailyField('prayers', 'quran', this.value)"
                      class="w-full px-2 py-2 text-center text-sm font-medium bg-[var(--bg-input)] border border-[var(--border)] rounded-lg focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent-light)]">
                  </div>
                </div>
              </div>

              <!-- Glucose Section -->
              <div class="bg-[var(--bg-secondary)] rounded-xl p-4 border border-[var(--border-light)]">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wide">üíâ Glucose</span>
                </div>
                <div class="grid grid-cols-3 gap-3">
                  <div class="text-center">
                    <label class="text-[10px] text-[var(--text-muted)] font-medium block mb-1">Avg</label>
                    <input type="number" value="${glucoseData.avg || ''}" placeholder="--"
                      onchange="updateDailyField('glucose', 'avg', this.value)"
                      class="w-full px-3 py-2 text-center text-sm font-medium bg-[var(--bg-input)] border border-[var(--border)] rounded-lg focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent-light)]">
                  </div>
                  <div class="text-center">
                    <label class="text-[10px] text-[var(--text-muted)] font-medium block mb-1">TIR %</label>
                    <input type="number" value="${glucoseData.tir || ''}" placeholder="--"
                      onchange="updateDailyField('glucose', 'tir', this.value)"
                      class="w-full px-3 py-2 text-center text-sm font-medium bg-[var(--bg-input)] border border-[var(--border)] rounded-lg focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent-light)]">
                  </div>
                  <div class="text-center">
                    <label class="text-[10px] text-[var(--text-muted)] font-medium block mb-1">Insulin</label>
                    <input type="number" value="${glucoseData.insulin || ''}" placeholder="--"
                      onchange="updateDailyField('glucose', 'insulin', this.value)"
                      class="w-full px-3 py-2 text-center text-sm font-medium bg-[var(--bg-input)] border border-[var(--border)] rounded-lg focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent-light)]">
                  </div>
                </div>
              </div>

              <!-- Whoop Section -->
              <div class="bg-[var(--bg-secondary)] rounded-xl p-4 border border-[var(--border-light)]">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wide">‚è±Ô∏è Whoop</span>
                </div>
                <div class="grid grid-cols-3 gap-3">
                  <div class="text-center">
                    <label class="text-[10px] text-[var(--text-muted)] font-medium block mb-1">Sleep %</label>
                    <input type="number" value="${whoopData.sleepPerf || ''}" placeholder="--"
                      onchange="updateDailyField('whoop', 'sleepPerf', this.value)"
                      class="w-full px-3 py-2 text-center text-sm font-medium bg-[var(--bg-input)] border border-[var(--border)] rounded-lg focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent-light)]">
                  </div>
                  <div class="text-center">
                    <label class="text-[10px] text-[var(--text-muted)] font-medium block mb-1">Recovery</label>
                    <input type="number" value="${whoopData.recovery || ''}" placeholder="--"
                      onchange="updateDailyField('whoop', 'recovery', this.value)"
                      class="w-full px-3 py-2 text-center text-sm font-medium bg-[var(--bg-input)] border border-[var(--border)] rounded-lg focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent-light)]">
                  </div>
                  <div class="text-center">
                    <label class="text-[10px] text-[var(--text-muted)] font-medium block mb-1">Strain</label>
                    <input type="number" value="${whoopData.strain || ''}" placeholder="--"
                      onchange="updateDailyField('whoop', 'strain', this.value)"
                      class="w-full px-3 py-2 text-center text-sm font-medium bg-[var(--bg-input)] border border-[var(--border)] rounded-lg focus:outline-none focus:border-[var(--accent)] focus:ring-1 focus:ring-[var(--accent-light)]">
                  </div>
                </div>
              </div>

              <!-- Habits Section -->
              <div class="bg-[var(--bg-secondary)] rounded-xl p-4 border border-[var(--border-light)]">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wide">‚ú® Habits</span>
                  <span class="text-xs text-[var(--text-muted)] font-medium">${habitsDone}/5</span>
                </div>
                <div class="grid grid-cols-5 gap-2">
                  ${[
                    { field: 'exercise', icon: 'üèãÔ∏è', label: 'Exercise' },
                    { field: 'reading', icon: 'üìö', label: 'Read' },
                    { field: 'meditation', icon: 'üßò', label: 'Meditate' },
                    { field: 'water', icon: 'üíß', label: 'Water' },
                    { field: 'vitamins', icon: 'üíä', label: 'Vitamins' }
                  ].map(h => {
                    const isChecked = habitsData[h.field];
                    return '<label class="flex flex-col items-center cursor-pointer">' +
                      '<span class="text-lg mb-1">' + h.icon + '</span>' +
                      '<input type="checkbox" ' + (isChecked ? 'checked' : '') +
                      ' onchange="toggleDailyField(\'habits\', \'' + h.field + '\')"' +
                      ' class="w-5 h-5 rounded border-2 border-purple-300 text-purple-500 focus:ring-purple-300 focus:ring-offset-0 cursor-pointer">' +
                      '</label>';
                  }).join('')}
                </div>
              </div>
            </div>
          `;
          break;
        }

        default:
          content = '<div class="py-4 text-center text-charcoal/30">Unknown widget type</div>';
      }

      // Widget icon based on type
      const widgetIcons = {
        'stats': '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>',
        'quick-add': '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>',
        'today-tasks': THINGS3_ICONS.today,
        'next-tasks': THINGS3_ICONS.next,
        'daily-entry': '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>'
      };

      const widgetColors = {
        'stats': '#6B7280',
        'quick-add': '#147EFB',
        'today-tasks': '#FFCA28',
        'next-tasks': '#8B5CF6',
        'daily-entry': '#F97316'
      };

      // Quick-add widget has minimal styling (no border, no background, no header)
      if (widget.type === 'quick-add' && !isEditing) {
        return `
          <div class="widget ${sizeClass} widget-drop-target">
            <div class="py-2">
              ${content}
            </div>
          </div>
        `;
      }

      return `
        <div class="widget ${sizeClass} bg-[var(--bg-card)] rounded-xl border border-[var(--border-light)] overflow-hidden widget-drop-target ${isEditing ? 'cursor-grab' : ''}"
          ${isEditing ? `draggable="true" ondragstart="handleWidgetDragStart(event, '${widget.id}')" ondragend="handleWidgetDragEnd(event)" ondragover="handleWidgetDragOver(event, '${widget.id}')" ondragleave="handleWidgetDragLeave(event)" ondrop="handleWidgetDrop(event, '${widget.id}')"` : ''}>
          <div class="px-4 py-2 border-b border-[var(--border-light)] flex items-center gap-2">
            ${isEditing ? '<div class="text-[var(--text-muted)]/30 cursor-grab"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><circle cx="9" cy="5" r="1.5"/><circle cx="15" cy="5" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="19" r="1.5"/><circle cx="15" cy="19" r="1.5"/></svg></div>' : ''}
            <span style="color: ${widgetColors[widget.type] || '#6B7280'}">${widgetIcons[widget.type] || ''}</span>
            <h3 class="text-sm font-medium text-[var(--text-primary)]">${widget.title}</h3>
            ${editControls}
          </div>
          <div class="p-4">
            ${content}
          </div>
        </div>
      `;
    }

    // Home quick add task function
    function homeQuickAddTask(inputElement) {
      if (!inputElement) return;
      const title = inputElement.value.trim();
      if (!title) return;
      createTask(title, { status: 'inbox' });
      inputElement.value = '';
      render();
      setTimeout(() => {
        const input = document.getElementById('home-quick-add-input');
        if (input) input.focus();
      }, 50);
    }

    // Toggle daily field (checkbox style)
    function toggleDailyField(category, field) {
      const today = getLocalDateString();
      if (!allData[today]) allData[today] = {};
      if (!allData[today][category]) allData[today][category] = {};
      allData[today][category][field] = !allData[today][category][field];
      saveData();
      debouncedSaveToGithub();
      render();
    }

    // Update daily field (numeric)
    function updateDailyField(category, field, value) {
      const today = getLocalDateString();
      if (!allData[today]) allData[today] = {};
      if (!allData[today][category]) allData[today][category] = {};
      allData[today][category][field] = value === '' ? null : parseFloat(value) || value;
      saveData();
      debouncedSaveToGithub();
      render(); // Update UI to reflect score changes
    }

    // Security: HTML escape function to prevent XSS
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Safe localStorage wrapper with error handling
    function safeLocalStorageSet(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          console.error('Storage quota exceeded for key:', key);
        }
        return false;
      }
    }

    function safeLocalStorageGet(key, defaultValue = null) {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
      } catch (e) {
        console.error('Error reading localStorage key:', key, e);
        return defaultValue;
      }
    }

    // ============================================================================
    // SECTION 6: TASK HELPER FUNCTIONS & CRUD OPERATIONS
    // ============================================================================

    /**
     * Generate unique task ID using timestamp + random string
     * Format: task_{timestamp}_{random9chars}
     * @returns {string} Unique task identifier
     */
    function generateTaskId() {
      // Note: Using .slice() instead of deprecated .substr()
      return 'task_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);
    }

    function saveTasksData() {
      safeLocalStorageSet(TASKS_KEY, tasksData);
      safeLocalStorageSet(TASK_CATEGORIES_KEY, taskCategories);
      safeLocalStorageSet(TASK_LABELS_KEY, taskLabels);
      safeLocalStorageSet(TASK_PEOPLE_KEY, taskPeople);
      safeLocalStorageSet(PERSPECTIVES_KEY, customPerspectives);
      debouncedSaveToGithub();
    }

    // Category CRUD
    function createCategory(name) {
      const category = {
        id: 'cat_' + Date.now(),
        name: name
      };
      taskCategories.push(category);
      saveTasksData();
      return category;
    }

    function updateCategory(categoryId, updates) {
      const idx = taskCategories.findIndex(c => c.id === categoryId);
      if (idx !== -1) {
        taskCategories[idx] = { ...taskCategories[idx], ...updates };
        saveTasksData();
      }
    }

    function deleteCategory(categoryId) {
      taskCategories = taskCategories.filter(c => c.id !== categoryId);
      // Remove category from tasks that use it
      tasksData.forEach(task => {
        if (task.categoryId === categoryId) task.categoryId = null;
      });
      saveTasksData();
    }

    // Label CRUD
    function createLabel(name, color) {
      const label = {
        id: 'label_' + Date.now(),
        name: name,
        color: color || '#6B7280'
      };
      taskLabels.push(label);
      saveTasksData();
      return label;
    }

    function updateLabel(labelId, updates) {
      const idx = taskLabels.findIndex(l => l.id === labelId);
      if (idx !== -1) {
        taskLabels[idx] = { ...taskLabels[idx], ...updates };
        saveTasksData();
      }
    }

    function deleteLabel(labelId) {
      taskLabels = taskLabels.filter(l => l.id !== labelId);
      // Remove label from tasks that use it
      tasksData.forEach(task => {
        if (task.labels) {
          task.labels = task.labels.filter(l => l !== labelId);
        }
      });
      saveTasksData();
    }

    function getLabelById(labelId) {
      return taskLabels.find(l => l.id === labelId);
    }

    // ============ PEOPLE CRUD ============
    function createPerson(name) {
      const person = {
        id: 'person_' + Date.now(),
        name: name
      };
      taskPeople.push(person);
      saveTasksData();
      return person;
    }

    function updatePerson(personId, updates) {
      const idx = taskPeople.findIndex(p => p.id === personId);
      if (idx !== -1) {
        taskPeople[idx] = { ...taskPeople[idx], ...updates };
        saveTasksData();
      }
    }

    function deletePerson(personId) {
      taskPeople = taskPeople.filter(p => p.id !== personId);
      // Remove person from tasks that use it
      tasksData.forEach(task => {
        if (task.people) {
          task.people = task.people.filter(p => p !== personId);
        }
      });
      saveTasksData();
    }

    function getPersonById(personId) {
      return taskPeople.find(p => p.id === personId);
    }

    // ============ SIDEBAR DRAG AND DROP REORDER ============
    let draggedSidebarItem = null;
    let draggedSidebarType = null;
    let sidebarDragPosition = null; // 'top' or 'bottom'

    // Setup sidebar drag and drop using event delegation (called after render)
    function setupSidebarDragDrop() {
      document.querySelectorAll('.draggable-item').forEach(item => {
        // Skip if already initialized to prevent duplicate event listeners
        if (item.dataset.dragInitialized) return;
        item.dataset.dragInitialized = 'true';

        item.addEventListener('dragstart', function(e) {
          const id = this.dataset.id;
          const type = this.dataset.type;
          draggedSidebarItem = id;
          draggedSidebarType = type;
          this.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', id);
        });

        item.addEventListener('dragend', function(e) {
          this.classList.remove('dragging');
          document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
            el.classList.remove('drag-over', 'drag-over-bottom');
          });
          draggedSidebarItem = null;
          draggedSidebarType = null;
          sidebarDragPosition = null;
        });

        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          if (this.classList.contains('dragging')) return;

          // Determine if cursor is in top or bottom half
          const rect = this.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          const position = e.clientY < midpoint ? 'top' : 'bottom';

          // Clear previous indicators
          document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
            el.classList.remove('drag-over', 'drag-over-bottom');
          });

          // Add appropriate class
          if (position === 'top') {
            this.classList.add('drag-over');
          } else {
            this.classList.add('drag-over-bottom');
          }
          sidebarDragPosition = position;
        });

        item.addEventListener('dragleave', function(e) {
          this.classList.remove('drag-over', 'drag-over-bottom');
        });

        item.addEventListener('drop', function(e) {
          e.preventDefault();
          const targetId = this.dataset.id;
          const type = this.dataset.type;
          document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
            el.classList.remove('drag-over', 'drag-over-bottom');
          });

          if (!draggedSidebarItem || draggedSidebarType !== type || draggedSidebarItem === targetId) {
            return;
          }

          let arr;
          if (type === 'category') arr = taskCategories;
          else if (type === 'label') arr = taskLabels;
          else if (type === 'person') arr = taskPeople;
          else if (type === 'perspective') arr = customPerspectives;
          else return;

          const fromIdx = arr.findIndex(item => item.id === draggedSidebarItem);
          let toIdx = arr.findIndex(item => item.id === targetId);

          if (fromIdx === -1 || toIdx === -1) return;

          // Adjust target index based on drop position
          if (sidebarDragPosition === 'bottom' && fromIdx < toIdx) {
            // No adjustment needed
          } else if (sidebarDragPosition === 'bottom' && fromIdx > toIdx) {
            toIdx += 1;
          } else if (sidebarDragPosition === 'top' && fromIdx > toIdx) {
            // No adjustment needed
          } else if (sidebarDragPosition === 'top' && fromIdx < toIdx) {
            toIdx -= 1;
          }

          // Remove from old position and insert at new position
          const [removed] = arr.splice(fromIdx, 1);
          arr.splice(toIdx, 0, removed);

          saveTasksData();
          render();
        });
      });
    }

    function getTasksByPerson(personId) {
      const today = getLocalDateString();
      return tasksData.filter(task => {
        if (!task.people || !task.people.includes(personId)) return false;
        if (task.completed) return false;
        // Hide deferred tasks (deferDate in the future)
        if (task.deferDate && task.deferDate > today) return false;
        return true;
      });
    }

    function showPersonTasks(personId) {
      activeFilterType = 'person';
      activePersonFilter = personId;
      activePerspective = null;
      activeCategoryFilter = null;
      activeLabelFilter = null;
      mobileDrawerOpen = false;
      // Switch to tasks tab when navigating from Quick Stats or other widgets
      if (activeTab !== 'tasks') {
        activeTab = 'tasks';
      }
      saveViewState();
      render();
      scrollToContent();
    }

    // Inline Tag creation in modal
    let showInlineTagInput = false;
    let showInlinePersonInput = false;

    function toggleInlineTagInput() {
      showInlineTagInput = !showInlineTagInput;
      const container = document.getElementById('inline-tag-form');
      if (container) {
        if (showInlineTagInput) {
          container.innerHTML = `
            <div class="flex items-center gap-2 mt-2 p-2 bg-warmgray/30 rounded-lg">
              <input type="text" id="inline-tag-name" placeholder="Tag name"
                class="flex-1 px-2 py-1.5 text-sm border border-softborder rounded focus:border-coral focus:outline-none"
                onkeydown="if(event.key==='Enter'){event.preventDefault();addInlineTag();}">
              <input type="color" id="inline-tag-color" value="#6B7280" class="w-8 h-8 rounded cursor-pointer border-0">
              <button onclick="addInlineTag()" class="px-3 py-1.5 text-sm bg-coral text-white rounded hover:bg-coralDark">Add</button>
              <button onclick="toggleInlineTagInput()" class="px-2 py-1.5 text-sm text-charcoal/50 hover:text-charcoal">&times;</button>
            </div>
          `;
          setTimeout(() => document.getElementById('inline-tag-name')?.focus(), 50);
        } else {
          container.innerHTML = '';
        }
      }
    }

    function addInlineTag() {
      const name = document.getElementById('inline-tag-name')?.value?.trim();
      const color = document.getElementById('inline-tag-color')?.value || '#6B7280';
      if (name) {
        const newTag = createLabel(name, color);
        showInlineTagInput = false;
        // Re-render the tags section and pre-select the new tag
        const labelsContainer = document.getElementById('task-labels-container');
        if (labelsContainer) {
          // Get currently selected tags
          const selectedTags = Array.from(document.querySelectorAll('.task-label-checkbox:checked')).map(cb => cb.value);
          selectedTags.push(newTag.id); // Add the new tag as selected

          // Re-render tags
          labelsContainer.innerHTML = taskLabels.map(label => {
            const isSelected = selectedTags.includes(label.id);
            return `
              <label class="label-checkbox flex items-center gap-1.5 px-2 py-1 rounded border cursor-pointer transition ${isSelected ? 'bg-warmgray' : 'hover:bg-warmgray/50'}" style="border-color: ${label.color}">
                <input type="checkbox" value="${label.id}" ${isSelected ? 'checked' : ''} class="task-label-checkbox rounded" style="accent-color: ${label.color}">
                <span class="text-sm" style="color: ${label.color}">${escapeHtml(label.name)}</span>
              </label>
            `;
          }).join('') + `
            <button onclick="toggleInlineTagInput()" class="flex items-center gap-1 px-2 py-1 text-sm text-charcoal/50 hover:text-charcoal hover:bg-warmgray/50 rounded border border-dashed border-charcoal/20">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              New
            </button>
          `;
        }
        document.getElementById('inline-tag-form').innerHTML = '';
      }
    }

    function toggleInlinePersonInput() {
      showInlinePersonInput = !showInlinePersonInput;
      const container = document.getElementById('inline-person-form');
      if (container) {
        if (showInlinePersonInput) {
          container.innerHTML = `
            <div class="flex items-center gap-2 mt-2 p-2 bg-warmgray/30 rounded-lg">
              <input type="text" id="inline-person-name" placeholder="Person name"
                class="flex-1 px-2 py-1.5 text-sm border border-softborder rounded focus:border-coral focus:outline-none"
                onkeydown="if(event.key==='Enter'){event.preventDefault();addInlinePerson();}">
              <button onclick="addInlinePerson()" class="px-3 py-1.5 text-sm bg-coral text-white rounded hover:bg-coralDark">Add</button>
              <button onclick="toggleInlinePersonInput()" class="px-2 py-1.5 text-sm text-charcoal/50 hover:text-charcoal">&times;</button>
            </div>
          `;
          setTimeout(() => document.getElementById('inline-person-name')?.focus(), 50);
        } else {
          container.innerHTML = '';
        }
      }
    }

    function addInlinePerson() {
      const name = document.getElementById('inline-person-name')?.value?.trim();
      if (name) {
        const newPerson = createPerson(name);
        showInlinePersonInput = false;
        // Re-render the people section and pre-select the new person
        const peopleContainer = document.getElementById('task-people-container');
        if (peopleContainer) {
          // Get currently selected people
          const selectedPeople = Array.from(document.querySelectorAll('.task-person-checkbox:checked')).map(cb => cb.value);
          selectedPeople.push(newPerson.id); // Add the new person as selected

          // Re-render people
          peopleContainer.innerHTML = taskPeople.map(person => {
            const isSelected = selectedPeople.includes(person.id);
            return `
              <label class="label-checkbox flex items-center gap-1.5 px-2 py-1 rounded border border-charcoal/20 cursor-pointer transition ${isSelected ? 'bg-warmgray border-charcoal/40' : 'hover:bg-warmgray/50'}">
                <input type="checkbox" value="${person.id}" ${isSelected ? 'checked' : ''} class="task-person-checkbox rounded">
                <span class="text-sm text-charcoal/70">${escapeHtml(person.name)}</span>
              </label>
            `;
          }).join('') + `
            <button onclick="toggleInlinePersonInput()" class="flex items-center gap-1 px-2 py-1 text-sm text-charcoal/50 hover:text-charcoal hover:bg-warmgray/50 rounded border border-dashed border-charcoal/20">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              New
            </button>
          `;
        }
        document.getElementById('inline-person-form').innerHTML = '';
      }
    }

    /**
     * Create a new task with full configuration options
     *
     * TASK OBJECT STRUCTURE:
     * @typedef {Object} Task
     * @property {string} id - Unique ID (task_{timestamp}_{random})
     * @property {string} title - Task name/description
     * @property {string} notes - Additional details/context
     * @property {string} status - 'inbox'|'today'|'anytime'|'someday'
     * @property {boolean} completed - Completion state
     * @property {string|null} completedAt - ISO timestamp when completed
     * @property {string|null} categoryId - Area/category assignment
     * @property {string[]} labels - Array of label IDs (tags)
     * @property {string[]} people - Array of person IDs (delegation)
     * @property {string|null} deferDate - Start date (YYYY-MM-DD)
     * @property {string|null} dueDate - Deadline (YYYY-MM-DD)
     * @property {Object|null} repeat - Repeating config {type, interval, from}
     * @property {boolean} isNote - True = outline note, False = task
     * @property {string|null} parentId - Parent note ID for hierarchy
     * @property {number} indent - Nesting level (0 = root)
     * @property {string} createdAt - ISO creation timestamp
     * @property {string} updatedAt - ISO last modified timestamp
     *
     * THINGS 3 BEHAVIOR:
     * - Inbox tasks have no category
     * - Assigning a category moves Inbox ‚Üí Anytime
     * - "Today" status means task is available now (defer date ‚â§ today)
     * - "Someday" hides task from active views
     *
     * @param {string} title - Task title
     * @param {Object} options - Optional properties (see typedef)
     * @returns {Task} Created task object
     */
    function createTask(title, options = {}) {
      const task = {
        id: generateTaskId(),
        title: title,
        notes: options.notes || '',
        status: options.status || 'inbox', // inbox, today, anytime, someday
        completed: false,
        completedAt: null,
        categoryId: options.categoryId || null,
        labels: options.labels || [],
        people: options.people || [],       // Array of person IDs
        deferDate: options.deferDate || null, // When task becomes available
        dueDate: options.dueDate || null,     // Deadline
        repeat: options.repeat || null,       // { type: 'daily'|'weekly'|'monthly'|'yearly', interval: 1, from: 'completion'|'due' }
        isNote: options.isNote || false,      // If true, displays as note (bullet) instead of task (checkbox)
        parentId: options.parentId || null,   // For nested notes - parent note ID
        indent: options.indent || 0,          // Nesting level (0 = root, 1 = first child, etc.)
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      tasksData.push(task);
      saveTasksData();
      return task;
    }

    // ============================================================================
    // SECTION 8: OUTLINER NOTES SYSTEM
    // ============================================================================
    // Hierarchical notes structure similar to Workflowy/Roam/Logseq
    // - Notes are tasks with isNote=true
    // - Support parent-child relationships via parentId
    // - Indent levels for visual hierarchy (max 5 levels)
    // - Collapse/expand functionality
    // - Fractional timestamps for insertion ordering
    let editingNoteId = null;
    let collapsedNotes = (function() {
      try {
        const stored = localStorage.getItem('collapsedNotes');
        return new Set(stored ? JSON.parse(stored) : []);
      } catch (e) {
        console.error('Error loading collapsed notes:', e);
        localStorage.removeItem('collapsedNotes');
        return new Set();
      }
    })();

    function saveCollapsedNotes() {
      localStorage.setItem('collapsedNotes', JSON.stringify([...collapsedNotes]));
    }

    function toggleNoteCollapse(noteId) {
      if (collapsedNotes.has(noteId)) {
        collapsedNotes.delete(noteId);
      } else {
        collapsedNotes.add(noteId);
      }
      saveCollapsedNotes();
      render();
    }

    // Get notes in hierarchical order for display
    function getNotesHierarchy(categoryId = null) {
      let notes = tasksData.filter(t => t.isNote && !t.completed);
      if (categoryId) {
        notes = notes.filter(n => n.categoryId === categoryId);
      }
      // Sort by creation date, maintaining parent-child relationships
      return notes.sort((a, b) => {
        if (a.indent !== b.indent) return a.indent - b.indent;
        return new Date(a.createdAt) - new Date(b.createdAt);
      });
    }

    // Check if a note has children
    function noteHasChildren(noteId) {
      return tasksData.some(t => t.isNote && t.parentId === noteId && !t.completed);
    }

    // Get direct children of a note
    function getNoteChildren(noteId) {
      return tasksData.filter(t => t.isNote && t.parentId === noteId && !t.completed);
    }

    // Indent a note (Tab key)
    function indentNote(noteId) {
      const notes = tasksData.filter(t => t.isNote && !t.completed);
      const noteIdx = notes.findIndex(t => t.id === noteId);
      if (noteIdx <= 0) return;

      const note = notes[noteIdx];
      const maxIndent = 5; // Maximum nesting level
      if ((note.indent || 0) >= maxIndent) return;

      // Find previous note that could be the parent
      for (let i = noteIdx - 1; i >= 0; i--) {
        const prev = notes[i];
        if (prev.categoryId === note.categoryId && (prev.indent || 0) <= (note.indent || 0)) {
          note.parentId = prev.id;
          note.indent = (note.indent || 0) + 1;
          note.updatedAt = new Date().toISOString();
          saveTasksData();
          render();
          // Refocus the note after render
          setTimeout(() => focusNote(noteId), 50);
          return;
        }
      }
    }

    // Outdent a note (Shift+Tab key)
    function outdentNote(noteId) {
      const note = tasksData.find(t => t.id === noteId);
      if (!note || !note.isNote || (note.indent || 0) <= 0) return;

      // Move children up with the note
      const children = getNoteChildren(noteId);
      children.forEach(child => {
        child.parentId = note.parentId;
      });

      note.indent = (note.indent || 0) - 1;
      if (note.indent === 0) note.parentId = null;
      note.updatedAt = new Date().toISOString();
      saveTasksData();
      render();
      setTimeout(() => focusNote(noteId), 50);
    }

    // Create a new note at the same level as current (right after it)
    function createNoteAfter(noteId) {
      const note = tasksData.find(t => t.id === noteId);
      if (!note) return;

      // Find the next sibling note at same level (to insert between current and next)
      const siblings = tasksData.filter(t =>
        t.isNote && !t.completed &&
        t.parentId === note.parentId &&
        t.categoryId === note.categoryId
      );
      const siblingIdx = siblings.findIndex(s => s.id === noteId);
      const nextSibling = siblings[siblingIdx + 1];

      // Calculate a createdAt timestamp between current note and next sibling
      const currentTime = new Date(note.createdAt).getTime();
      const nextTime = nextSibling ? new Date(nextSibling.createdAt).getTime() : Date.now() + 1000;
      const newTime = currentTime + Math.floor((nextTime - currentTime) / 2);

      // Create the new note with the calculated timestamp
      const newNote = {
        id: generateTaskId(),
        title: '',
        notes: '',
        status: 'anytime',
        completed: false,
        completedAt: null,
        categoryId: note.categoryId,
        labels: [],
        people: [],
        deferDate: null,
        dueDate: null,
        repeat: null,
        isNote: true,
        parentId: note.parentId,
        indent: note.indent || 0,
        createdAt: new Date(newTime).toISOString(),
        updatedAt: new Date().toISOString()
      };

      tasksData.push(newNote);
      saveTasksData();
      render();
      setTimeout(() => focusNote(newNote.id), 50);
    }

    // Create a child note under current (as first child)
    function createChildNote(noteId) {
      const note = tasksData.find(t => t.id === noteId);
      if (!note) return;

      // Get existing children to determine timestamp
      const existingChildren = tasksData.filter(t =>
        t.isNote && !t.completed && t.parentId === noteId
      ).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

      // Set timestamp before first child (or current time if no children)
      let newTime;
      if (existingChildren.length > 0) {
        const firstChildTime = new Date(existingChildren[0].createdAt).getTime();
        newTime = firstChildTime - 1000; // 1 second before first child
      } else {
        newTime = Date.now();
      }

      const newNote = {
        id: generateTaskId(),
        title: '',
        notes: '',
        status: 'anytime',
        completed: false,
        completedAt: null,
        categoryId: note.categoryId,
        labels: [],
        people: [],
        deferDate: null,
        dueDate: null,
        repeat: null,
        isNote: true,
        parentId: noteId,
        indent: (note.indent || 0) + 1,
        createdAt: new Date(newTime).toISOString(),
        updatedAt: new Date().toISOString()
      };

      tasksData.push(newNote);
      saveTasksData();
      render();
      setTimeout(() => focusNote(newNote.id), 50);
    }

    // Delete note and optionally its children
    function deleteNote(noteId, deleteChildren = false) {
      const note = tasksData.find(t => t.id === noteId);
      if (!note) return;

      if (deleteChildren) {
        // Recursively delete children
        const toDelete = [noteId];
        const findChildren = (parentId) => {
          tasksData.filter(t => t.parentId === parentId).forEach(child => {
            toDelete.push(child.id);
            findChildren(child.id);
          });
        };
        findChildren(noteId);
        tasksData = tasksData.filter(t => !toDelete.includes(t.id));
      } else {
        // Move children up to parent level
        const children = getNoteChildren(noteId);
        children.forEach(child => {
          child.parentId = note.parentId;
          child.indent = note.indent || 0;
        });
        tasksData = tasksData.filter(t => t.id !== noteId);
      }

      saveTasksData();
      render();
    }

    // Focus a note's input field
    function focusNote(noteId) {
      const input = document.querySelector(`[data-note-id="${noteId}"] .note-input`);
      if (input) {
        input.focus();
        // Move cursor to end
        input.selectionStart = input.selectionEnd = input.value.length;
      }
    }

    // Handle note keydown events
    function handleNoteKeydown(event, noteId) {
      const note = tasksData.find(t => t.id === noteId);
      if (!note) return;

      if (event.key === 'Tab') {
        event.preventDefault();
        if (event.shiftKey) {
          outdentNote(noteId);
        } else {
          indentNote(noteId);
        }
      } else if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        // Save current note first
        const input = event.target;
        if (input.value.trim() !== note.title) {
          note.title = input.value.trim();
          note.updatedAt = new Date().toISOString();
          saveTasksData();
        }
        // Create new note
        createNoteAfter(noteId);
      } else if (event.key === 'Backspace' && event.target.value === '' && event.target.selectionStart === 0) {
        event.preventDefault();
        // Delete empty note and focus previous
        const notes = tasksData.filter(t => t.isNote && !t.completed && t.categoryId === note.categoryId);
        const noteIdx = notes.findIndex(t => t.id === noteId);
        if (noteIdx > 0) {
          const prevNote = notes[noteIdx - 1];
          deleteNote(noteId);
          setTimeout(() => focusNote(prevNote.id), 50);
        } else if (notes.length === 1) {
          deleteNote(noteId);
        }
      } else if (event.key === 'ArrowUp' && event.target.selectionStart === 0) {
        event.preventDefault();
        const notes = tasksData.filter(t => t.isNote && !t.completed && t.categoryId === note.categoryId);
        const noteIdx = notes.findIndex(t => t.id === noteId);
        if (noteIdx > 0) {
          focusNote(notes[noteIdx - 1].id);
        }
      } else if (event.key === 'ArrowDown' && event.target.selectionStart === event.target.value.length) {
        event.preventDefault();
        const notes = tasksData.filter(t => t.isNote && !t.completed && t.categoryId === note.categoryId);
        const noteIdx = notes.findIndex(t => t.id === noteId);
        if (noteIdx < notes.length - 1) {
          focusNote(notes[noteIdx + 1].id);
        }
      }
    }

    // Update note title on blur
    function handleNoteBlur(event, noteId) {
      const note = tasksData.find(t => t.id === noteId);
      if (!note) return;

      const newTitle = event.target.value.trim();
      if (newTitle !== note.title) {
        if (newTitle === '' && note.title === '') {
          // Delete empty notes
          deleteNote(noteId);
        } else {
          note.title = newTitle;
          note.updatedAt = new Date().toISOString();
          saveTasksData();
        }
      }
    }

    // Render a note item in outliner style
    function renderNoteItem(note, allNotes) {
      const hasChildren = noteHasChildren(note.id);
      const isCollapsed = collapsedNotes.has(note.id);
      const indentPx = (note.indent || 0) * 24;

      return `
        <div class="note-item ${isCollapsed ? 'note-collapsed' : ''}" data-note-id="${note.id}" style="padding-left: ${indentPx}px;">
          <div class="flex items-start gap-2 py-1.5 px-3 group">
            <button onclick="event.stopPropagation(); ${hasChildren ? `toggleNoteCollapse('${note.id}')` : `createChildNote('${note.id}')`}"
              class="note-bullet mt-1.5 ${hasChildren ? (isCollapsed ? 'collapsed' : 'has-children') : ''}"
              title="${hasChildren ? (isCollapsed ? 'Expand' : 'Collapse') : 'Add child note'}">
            </button>
            <input type="text"
              class="note-input flex-1"
              value="${(note.title || '').replace(/"/g, '&quot;')}"
              placeholder="Type something..."
              onkeydown="handleNoteKeydown(event, '${note.id}')"
              onblur="handleNoteBlur(event, '${note.id}')"
              onfocus="editingNoteId='${note.id}'">
            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
              <button onclick="event.stopPropagation(); createNoteAfter('${note.id}')"
                class="p-1 text-charcoal/30 hover:text-purple-500 rounded" title="Add note below (Enter)">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
              </button>
              <button onclick="event.stopPropagation(); deleteNote('${note.id}')"
                class="p-1 text-charcoal/30 hover:text-red-500 rounded" title="Delete note">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Render notes in outliner format
    function renderNotesOutliner(categoryId = null) {
      const notes = tasksData.filter(t => t.isNote && !t.completed);
      const filteredNotes = categoryId ? notes.filter(n => n.categoryId === categoryId) : notes;

      // Build hierarchy - only show root notes and non-collapsed children
      const visibleNotes = [];
      const addVisibleNotes = (parentId, parentCollapsed) => {
        filteredNotes
          .filter(n => n.parentId === parentId)
          .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
          .forEach(note => {
            if (!parentCollapsed) {
              visibleNotes.push(note);
            }
            addVisibleNotes(note.id, parentCollapsed || collapsedNotes.has(note.id));
          });
      };

      // Start with root notes (no parent or parent is null)
      filteredNotes
        .filter(n => !n.parentId)
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
        .forEach(note => {
          visibleNotes.push(note);
          addVisibleNotes(note.id, collapsedNotes.has(note.id));
        });

      if (visibleNotes.length === 0) {
        return `
          <div class="text-center py-12 text-charcoal/40">
            <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-purple-50 flex items-center justify-center">
              <svg class="w-6 h-6 text-purple-300" fill="currentColor" viewBox="0 0 24 24">
                <circle cx="4" cy="6" r="2"/><circle cx="4" cy="12" r="2"/><circle cx="4" cy="18" r="2"/>
                <rect x="8" y="5" width="14" height="2" rx="1"/><rect x="8" y="11" width="14" height="2" rx="1"/><rect x="8" y="17" width="14" height="2" rx="1"/>
              </svg>
            </div>
            <p class="text-sm font-medium mb-1">No notes yet</p>
            <p class="text-xs text-charcoal/30 mb-3">Start typing to capture your thoughts</p>
          </div>
        `;
      }

      return visibleNotes.map(note => renderNoteItem(note, filteredNotes)).join('');
    }

    function updateTask(taskId, updates) {
      const idx = tasksData.findIndex(t => t.id === taskId);
      if (idx !== -1) {
        const task = tasksData[idx];
        // Things 3 logic: Assigning Area to Inbox task moves it to Anytime
        if (task.status === 'inbox' && updates.categoryId && !task.categoryId) {
          updates.status = 'anytime';
        }
        tasksData[idx] = { ...task, ...updates, updatedAt: new Date().toISOString() };
        saveTasksData();
      }
    }

    function deleteTask(taskId) {
      tasksData = tasksData.filter(t => t.id !== taskId);
      saveTasksData();
    }

    // Delete task with confirmation
    function confirmDeleteTask(taskId) {
      // Cancel any inline editing first
      inlineEditingTaskId = null;
      if (confirm('Delete this task?')) {
        deleteTask(taskId);
        render();
      }
    }

    function toggleTaskComplete(taskId) {
      const task = tasksData.find(t => t.id === taskId);
      if (task) {
        const wasCompleted = task.completed;
        task.completed = !task.completed;
        task.completedAt = task.completed ? new Date().toISOString() : null;
        task.updatedAt = new Date().toISOString();

        // Handle repeating tasks - create next occurrence when completed
        if (task.completed && task.repeat && task.repeat.type !== 'none') {
          createNextRepeatOccurrence(task);
        }

        saveTasksData();
        render();
      }
    }

    // Calculate next date based on repeat settings
    function calculateNextRepeatDate(baseDate, repeat) {
      const date = new Date(baseDate);
      const interval = repeat.interval || 1;

      switch (repeat.type) {
        case 'daily':
          date.setDate(date.getDate() + interval);
          break;
        case 'weekly':
          date.setDate(date.getDate() + (7 * interval));
          break;
        case 'monthly':
          date.setMonth(date.getMonth() + interval);
          break;
        case 'yearly':
          date.setFullYear(date.getFullYear() + interval);
          break;
      }
      return date.toISOString().split('T')[0];
    }

    /**
     * Create the next occurrence of a repeating task
     * Called when a repeating task is completed
     *
     * BUG FIX: Now properly copies people array (was missing before)
     *
     * @param {Task} completedTask - The task that was just completed
     */
    function createNextRepeatOccurrence(completedTask) {
      const today = getLocalDateString();
      const baseDate = completedTask.repeat.from === 'due' && completedTask.dueDate
        ? completedTask.dueDate
        : today;

      // Calculate new defer and due dates based on repeat.from setting
      // 'due' = calculate from original due date (fixed schedule)
      // 'completion' = calculate from today (flexible schedule)
      let newDeferDate = null;
      let newDueDate = null;

      if (completedTask.deferDate) {
        const deferBase = completedTask.repeat.from === 'due' && completedTask.deferDate
          ? completedTask.deferDate
          : today;
        newDeferDate = calculateNextRepeatDate(deferBase, completedTask.repeat);
      }

      if (completedTask.dueDate) {
        newDueDate = calculateNextRepeatDate(baseDate, completedTask.repeat);
      }

      // Create new task with ALL same properties (including people!)
      // Keep the same status (Today tasks stay in Today with new date)
      createTask(completedTask.title, {
        notes: completedTask.notes,
        status: completedTask.status,
        categoryId: completedTask.categoryId,
        labels: [...(completedTask.labels || [])],
        people: [...(completedTask.people || [])], // BUG FIX: Was missing - people now preserved
        deferDate: newDeferDate,
        dueDate: newDueDate,
        repeat: { ...completedTask.repeat }
      });
    }

    // Get the unit label for repeat type
    function getRepeatUnitLabel(type) {
      const units = { daily: 'day(s)', weekly: 'week(s)', monthly: 'month(s)', yearly: 'year(s)' };
      return units[type] || 'day(s)';
    }

    // Update repeat UI when type changes
    function updateRepeatUI(type) {
      const details = document.getElementById('repeat-details');
      const fromContainer = document.getElementById('repeat-from-container');
      const unitLabel = document.getElementById('repeat-unit-label');

      if (type === 'none') {
        details.style.display = 'none';
        fromContainer.style.display = 'none';
      } else {
        details.style.display = 'flex';
        fromContainer.style.display = 'block';
        unitLabel.textContent = getRepeatUnitLabel(type);
      }
    }

    function moveTaskTo(taskId, status) {
      updateTask(taskId, { status: status });
      render();
    }

    // Drag and drop state
    let draggedTaskId = null;
    let dragOverTaskId = null;
    let dragPosition = null; // 'top' or 'bottom'

    function handleDragStart(e, taskId) {
      draggedTaskId = taskId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', taskId);

      // Add is-dragging class to task list
      const taskList = e.target.closest('.task-list');
      if (taskList) taskList.classList.add('is-dragging');
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');

      // Remove all drag indicators
      document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
        el.classList.remove('drag-over', 'drag-over-bottom');
      });

      const taskList = document.querySelector('.task-list.is-dragging');
      if (taskList) taskList.classList.remove('is-dragging');

      // Perform reorder if valid
      if (draggedTaskId && dragOverTaskId && draggedTaskId !== dragOverTaskId) {
        reorderTasks(draggedTaskId, dragOverTaskId, dragPosition);
      }

      draggedTaskId = null;
      dragOverTaskId = null;
      dragPosition = null;
    }

    function handleDragOver(e, taskId) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';

      if (taskId === draggedTaskId) return;

      const rect = e.target.closest('.task-item').getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      const position = e.clientY < midpoint ? 'top' : 'bottom';

      // Remove previous indicators
      document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
        el.classList.remove('drag-over', 'drag-over-bottom');
      });

      // Add indicator to current target
      const taskItem = e.target.closest('.task-item');
      if (position === 'top') {
        taskItem.classList.add('drag-over');
      } else {
        taskItem.classList.add('drag-over-bottom');
      }

      dragOverTaskId = taskId;
      dragPosition = position;
    }

    function handleDragLeave(e) {
      // Only remove if leaving the task item entirely
      if (!e.target.closest('.task-item')?.contains(e.relatedTarget)) {
        e.target.closest('.task-item')?.classList.remove('drag-over', 'drag-over-bottom');
      }
    }

    function handleDrop(e, taskId) {
      e.preventDefault();
      // Reorder is handled in dragEnd
    }

    function reorderTasks(draggedId, targetId, position) {
      const draggedTask = tasksData.find(t => t.id === draggedId);
      const targetTask = tasksData.find(t => t.id === targetId);
      if (!draggedTask || !targetTask) return;

      // Get all tasks in current view
      const filteredTasks = getCurrentFilteredTasks();
      const taskIds = filteredTasks.map(t => t.id);

      // Find indices
      const draggedIndex = taskIds.indexOf(draggedId);
      const targetIndex = taskIds.indexOf(targetId);
      if (draggedIndex === -1 || targetIndex === -1) return;

      // Calculate new order values
      let newOrder;
      if (position === 'top') {
        const prevTask = targetIndex > 0 ? filteredTasks[targetIndex - 1] : null;
        const prevOrder = prevTask?.order ?? targetTask.order - 1000;
        newOrder = (prevOrder + targetTask.order) / 2;
      } else {
        const nextTask = targetIndex < filteredTasks.length - 1 ? filteredTasks[targetIndex + 1] : null;
        const nextOrder = nextTask?.order ?? targetTask.order + 1000;
        newOrder = (targetTask.order + nextOrder) / 2;
      }

      // Update dragged task order
      draggedTask.order = newOrder;
      draggedTask.updatedAt = new Date().toISOString();

      // Normalize orders if they get too close (rebalance)
      normalizeTaskOrders();

      saveTasksData();
      render();
    }

    function normalizeTaskOrders() {
      // Group tasks by status and rebalance order values
      const statuses = ['inbox', 'today', 'anytime', 'someday'];
      statuses.forEach(status => {
        const statusTasks = tasksData
          .filter(t => t.status === status && !t.completed)
          .sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

        statusTasks.forEach((task, index) => {
          task.order = (index + 1) * 1000;
        });
      });
    }

    // ============================================================================
    // SECTION 9: TASK FILTERING & PERSPECTIVES
    // ============================================================================
    // Things 3-style perspective system with smart filtering
    // BUILTIN PERSPECTIVES:
    //   - Inbox: Unprocessed tasks (no area)
    //   - Today: Due today + overdue + scheduled for today + "Next" tagged
    //   - Upcoming: Future due dates
    //   - Anytime: Available tasks without deadlines
    //   - Someday: Deferred for later consideration
    //   - Logbook: Completed tasks
    // CUSTOM PERSPECTIVES: User-defined filters

    /**
     * Initialize task order values for drag-drop sorting
     * Uses 1000-increment spacing to allow fractional insertions
     * (e.g., inserting between 1000 and 2000 = 1500)
     */
    function initializeTaskOrders() {
      let needsSave = false;
      tasksData.forEach((task, index) => {
        if (task.order === undefined) {
          task.order = (index + 1) * 1000;
          needsSave = true;
        }
      });
      if (needsSave) saveTasksData();
    }
    initializeTaskOrders();

    /**
     * Get tasks filtered by perspective rules
     * CRITICAL: This is the main filtering function for all task views
     *
     * PERSPECTIVE RULES:
     * - inbox: status='inbox' AND no categoryId
     * - today: status='today' OR dueDate=today OR overdue OR deferDate<=today
     * - upcoming: has future dueDate
     * - anytime: status='anytime' AND no future dueDate
     * - someday: status='someday'
     * - logbook: completed=true
     *
     * @param {string} perspectiveId - Perspective to filter by
     * @returns {Task[]} Filtered and sorted task array
     */
    function getFilteredTasks(perspectiveId) {
      // Notes perspective shows tasks marked as notes
      if (perspectiveId === 'notes') {
        return tasksData.filter(task => task.isNote && !task.completed)
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      }

      const allPerspectives = [...BUILTIN_PERSPECTIVES, ...customPerspectives];
      const perspective = allPerspectives.find(p => p.id === perspectiveId);
      if (!perspective) return [];

      const today = getLocalDateString();

      return tasksData.filter(task => {
        // Notes don't appear in regular task perspectives (except logbook which shows all completed)
        if (task.isNote && !perspective.filter.completed) return false;

        // Logbook (completed) shows all completed tasks (including notes)
        if (perspective.filter.completed) {
          return task.completed;
        }
        // Other perspectives show only non-completed tasks
        if (task.completed) return false;

        // Things 3 logic for Today:
        // - Tasks explicitly marked as 'today'
        // - Tasks with today's due date
        // - Overdue tasks (due date in the past)
        // - Tasks scheduled for today or earlier (deferDate)
        // - "Next" tasks: tasks tagged with a "next" label
        if (perspectiveId === 'today') {
          const isDueToday = task.dueDate === today;
          const isOverdue = task.dueDate && task.dueDate < today;
          const isScheduledForToday = task.deferDate && task.deferDate <= today;
          const isTodayTask = task.status === 'today' || isDueToday || isOverdue || isScheduledForToday;

          // Include tasks tagged with "next" label
          const nextLabel = taskLabels.find(l => l.name.toLowerCase() === 'next');
          const isNextTask = nextLabel && (task.labels || []).includes(nextLabel.id);

          return isTodayTask || isNextTask;
        }

        // Upcoming: Tasks with future due dates (not today, not overdue)
        // Shows tasks from Anytime or Someday that have scheduled due dates
        if (perspectiveId === 'upcoming') {
          if (!task.dueDate) return false;
          return task.dueDate > today;
        }

        // Anytime: Tasks available to do anytime (no specific schedule)
        // Excludes tasks that are in Today or have a future due date
        if (perspectiveId === 'anytime') {
          if (task.status !== 'anytime') return false;
          // If it has a due date in the future, it shows in Upcoming instead
          if (task.dueDate && task.dueDate > today) return false;
          return true;
        }

        // Someday: Tasks for later consideration
        if (perspectiveId === 'someday') {
          return task.status === 'someday';
        }

        // Next: Available tasks without deadlines (OmniFocus-style)
        // Shows tasks you can work on right now with no time pressure
        if (perspectiveId === 'next') {
          // Must be in anytime status (not inbox, someday, or today)
          if (task.status !== 'anytime') return false;
          // Must NOT have a due date (no deadline pressure)
          if (task.dueDate) return false;
          // Must be available now (not deferred to future)
          if (task.deferDate && task.deferDate > today) return false;
          return true;
        }

        // Inbox: Unprocessed tasks (no area assigned)
        // Things 3 logic: Inbox and Areas are mutually exclusive
        if (perspectiveId === 'inbox') {
          return task.status === 'inbox' && !task.categoryId;
        }

        // Custom perspectives
        if (perspective.filter.status && task.status !== perspective.filter.status) return false;
        if (perspective.filter.categoryId && task.categoryId !== perspective.filter.categoryId) return false;
        if (perspective.filter.hasLabel && !(task.labels || []).some(l => l === perspective.filter.hasLabel)) return false;
        if (perspective.filter.labelIds && perspective.filter.labelIds.length > 0) {
          // Task must have at least one of the selected tags
          if (!(task.labels || []).some(l => perspective.filter.labelIds.includes(l))) return false;
        }
        if (perspective.filter.hasDueDate && !task.dueDate) return false;
        if (perspective.filter.dueSoon) {
          if (!task.dueDate) return false;
          const due = new Date(task.dueDate);
          const now = new Date();
          const diffDays = (due - now) / (1000 * 60 * 60 * 24);
          if (diffDays > 7 || diffDays < 0) return false;
        }
        return true;
      }).sort((a, b) => {
        // Sort by manual order first if available
        if (a.order !== undefined && b.order !== undefined) {
          return a.order - b.order;
        }
        // Then by due date
        if (a.dueDate && !b.dueDate) return -1;
        if (!a.dueDate && b.dueDate) return 1;
        if (a.dueDate && b.dueDate && a.dueDate !== b.dueDate) {
          return new Date(a.dueDate) - new Date(b.dueDate);
        }
        // Inbox shows newest first
        if (perspectiveId === 'inbox') return new Date(b.createdAt) - new Date(a.createdAt);
        return new Date(a.createdAt) - new Date(b.createdAt);
      });
    }

    // Group tasks by due date (for Upcoming view)
    function groupTasksByDate(tasks) {
      const groups = {};
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      tasks.forEach(task => {
        if (!task.dueDate) return;
        const date = task.dueDate;
        if (!groups[date]) {
          groups[date] = [];
        }
        groups[date].push(task);
      });

      // Sort dates and return as array of { date, label, tasks }
      return Object.keys(groups).sort().map(date => {
        const d = new Date(date + 'T00:00:00');
        const diffDays = Math.floor((d - today) / (1000 * 60 * 60 * 24));
        let label;
        if (diffDays === 0) label = 'Today';
        else if (diffDays === 1) label = 'Tomorrow';
        else if (diffDays < 7) label = d.toLocaleDateString('en-US', { weekday: 'long' });
        else label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

        return { date, label, tasks: groups[date] };
      });
    }

    // Group tasks by completion date (for Logbook view)
    function groupTasksByCompletionDate(tasks) {
      const groups = {};
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      tasks.forEach(task => {
        if (!task.completedAt) return;
        const date = task.completedAt.split('T')[0];
        if (!groups[date]) {
          groups[date] = [];
        }
        groups[date].push(task);
      });

      // Sort dates descending (most recent first) and return as array of { date, label, tasks }
      return Object.keys(groups).sort().reverse().map(date => {
        const d = new Date(date + 'T00:00:00');
        const diffDays = Math.floor((today - d) / (1000 * 60 * 60 * 24));
        let label;
        if (diffDays === 0) label = 'Today';
        else if (diffDays === 1) label = 'Yesterday';
        else if (diffDays < 7) label = d.toLocaleDateString('en-US', { weekday: 'long' });
        else label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

        return { date, label, tasks: groups[date] };
      });
    }

    // Get tasks by category
    function getTasksByCategory(categoryId) {
      const today = getLocalDateString();
      return tasksData.filter(task => {
        if (task.categoryId !== categoryId) return false;
        if (task.completed) return false;
        // Hide deferred tasks (deferDate in the future)
        if (task.deferDate && task.deferDate > today) return false;
        return true;
      }).sort((a, b) => {
          if (a.dueDate && !b.dueDate) return -1;
          if (!a.dueDate && b.dueDate) return 1;
          if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
          return new Date(a.createdAt) - new Date(b.createdAt);
        });
    }

    // Get tasks by label
    function getTasksByLabel(labelId) {
      const today = getLocalDateString();
      return tasksData.filter(task => {
        if (!(task.labels || []).includes(labelId)) return false;
        if (task.completed) return false;
        // Hide deferred tasks (deferDate in the future)
        if (task.deferDate && task.deferDate > today) return false;
        return true;
      }).sort((a, b) => {
          if (a.dueDate && !b.dueDate) return -1;
          if (!a.dueDate && b.dueDate) return 1;
          if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
          return new Date(a.createdAt) - new Date(b.createdAt);
        });
    }

    // Get current filtered tasks based on active filter type
    function getCurrentFilteredTasks() {
      if (activeFilterType === 'category' && activeCategoryFilter) {
        return getTasksByCategory(activeCategoryFilter);
      } else if (activeFilterType === 'label' && activeLabelFilter) {
        return getTasksByLabel(activeLabelFilter);
      } else if (activeFilterType === 'person' && activePersonFilter) {
        return getTasksByPerson(activePersonFilter);
      } else {
        return getFilteredTasks(activePerspective);
      }
    }

    // Get current view info
    function getCurrentViewInfo() {
      if (activeFilterType === 'category' && activeCategoryFilter) {
        const cat = getCategoryById(activeCategoryFilter);
        return { icon: 'üìÅ', name: cat?.name || 'Category', color: cat?.color };
      } else if (activeFilterType === 'label' && activeLabelFilter) {
        const label = getLabelById(activeLabelFilter);
        return { icon: 'üè∑Ô∏è', name: label?.name || 'Tag', color: label?.color };
      } else if (activeFilterType === 'person' && activePersonFilter) {
        const person = getPersonById(activePersonFilter);
        return { icon: 'üë§', name: person?.name || 'Person', color: person?.color };
      } else {
        const allPerspectives = [...BUILTIN_PERSPECTIVES, ...customPerspectives];
        const p = allPerspectives.find(p => p.id === activePerspective) || BUILTIN_PERSPECTIVES[0];
        return { icon: p.icon, name: p.name };
      }
    }

    function createPerspective(name, icon, filter) {
      const perspective = {
        id: 'custom_' + Date.now(),
        name: name,
        icon: icon || 'üìå',
        filter: filter,
        builtin: false
      };
      customPerspectives.push(perspective);
      saveTasksData();
      return perspective;
    }

    function deletePerspective(perspectiveId) {
      customPerspectives = customPerspectives.filter(p => p.id !== perspectiveId);
      if (activePerspective === perspectiveId) activePerspective = 'inbox';
      saveTasksData();
    }

    let editingPerspectiveId = null;

    function editCustomPerspective(perspectiveId) {
      editingPerspectiveId = perspectiveId;
      showPerspectiveModal = true;
      render();
      // Pre-fill the form after render
      setTimeout(() => {
        const p = customPerspectives.find(cp => cp.id === perspectiveId);
        if (p) {
          document.getElementById('perspective-name').value = p.name;
          document.getElementById('perspective-icon').value = p.icon;
          if (p.filter.categoryId) document.getElementById('perspective-category').value = p.filter.categoryId;
          if (p.filter.status) document.getElementById('perspective-status').value = p.filter.status;
          if (p.filter.hasDueDate) document.getElementById('perspective-due').checked = true;
          if (p.filter.labelIds) {
            p.filter.labelIds.forEach(lid => {
              const cb = document.querySelector(`.perspective-tag-checkbox[value="${lid}"]`);
              if (cb) cb.checked = true;
            });
          }
        }
      }, 10);
    }

    function getCategoryById(categoryId) {
      return taskCategories.find(c => c.id === categoryId);
    }

    // Personal Bests tracking
    function getPersonalBests() {
      const dates = Object.keys(allData).sort();
      if (dates.length === 0) return null;

      let bests = {
        highestDayScore: { value: 0, date: null },
        highestWeekScore: { value: 0, weekStart: null },
        longestStreak: { value: 0, endDate: null },
        currentStreak: 0,
        bestPrayerDay: { value: 0, date: null },
        bestWhoopDay: { value: 0, date: null },
        mostQuranPages: { value: 0, date: null },
        perfectPrayerDays: 0,
        totalDaysLogged: dates.length
      };

      // Single iteration for all calculations (optimized from double iteration)
      let currentStreakCount = 0;
      let lastDate = null;
      const weekScores = {};

      dates.forEach(date => {
        const dayData = allData[date] || {};
        const prayers = dayData.prayers || {};
        const scores = calculateScores(dayData);

        // Highest day score
        if (scores.total > bests.highestDayScore.value) {
          bests.highestDayScore = { value: scores.total, date };
        }

        // Best prayer day
        if (scores.prayer > bests.bestPrayerDay.value) {
          bests.bestPrayerDay = { value: scores.prayer, date };
        }

        // Best whoop day
        if (scores.whoop > bests.bestWhoopDay.value) {
          bests.bestWhoopDay = { value: scores.whoop, date };
        }

        // Most Quran pages
        const quranPages = parseInt(prayers.quran) || 0;
        if (quranPages > bests.mostQuranPages.value) {
          bests.mostQuranPages = { value: quranPages, date };
        }

        // Perfect prayer days (5 on-time prayers)
        let onTimePrayers = 0;
        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => {
          const { onTime } = parsePrayer(prayers[p]);
          if (onTime >= 1) onTimePrayers++;
        });
        if (onTimePrayers === 5) bests.perfectPrayerDays++;

        // Streak calculation
        if (lastDate) {
          const lastD = new Date(lastDate);
          const currD = new Date(date);
          const diffDays = Math.round((currD - lastD) / (1000 * 60 * 60 * 24));
          if (diffDays === 1) {
            currentStreakCount++;
          } else {
            currentStreakCount = 1;
          }
        } else {
          currentStreakCount = 1;
        }

        if (currentStreakCount > bests.longestStreak.value) {
          bests.longestStreak = { value: currentStreakCount, endDate: date };
        }

        lastDate = date;

        // Weekly scores (combined into single iteration - reuse scores.total)
        const d = new Date(date);
        const weekStart = new Date(d.setDate(d.getDate() - d.getDay())).toISOString().split('T')[0];
        if (!weekScores[weekStart]) weekScores[weekStart] = 0;
        weekScores[weekStart] += scores.total;
      });

      // Check if current streak is active (last entry was today or yesterday)
      const today = getLocalDateString();
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
      if (lastDate === today || lastDate === yesterday) {
        bests.currentStreak = currentStreakCount;
      }

      // Find highest week score
      Object.entries(weekScores).forEach(([weekStart, score]) => {
        if (score > bests.highestWeekScore.value) {
          bests.highestWeekScore = { value: Math.round(score), weekStart };
        }
      });

      return bests;
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
      localStorage.setItem('lastUpdated', Date.now().toString());
    }

    function getTodayData() {
      return allData[currentDate] || JSON.parse(JSON.stringify(defaultDayData));
    }

    function updateData(category, field, value) {
      const todayData = getTodayData();
      // Ensure category object exists before setting field
      if (!todayData[category]) {
        todayData[category] = {};
      }
      todayData[category][field] = value;
      allData[currentDate] = todayData;
      invalidateScoresCache(); // Clear memoization cache when data changes
      saveData();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    // ============================================================================
    // SECTION 7: SCORING CALCULATION ENGINE
    // ============================================================================
    // Multi-category gamification scoring system
    // Target: ~100 points daily from 5 categories:
    //   - Prayer: 30 pts (5 prayers + Quran)
    //   - Diabetes: 25 pts (glucose avg + TIR + insulin)
    //   - WHOOP: 25 pts (sleep + recovery + strain)
    //   - Family: 5 pts (contact with family members)
    //   - Habits: 15 pts (exercise, reading, vitamins, etc.)
    //
    // Uses memoization cache for performance (cleared on data changes)

    /**
     * Parse prayer value from X.Y format
     * X = on-time prayers (0-1), Y = late prayers (0-9 in decimal)
     * Example: 1.3 = 1 on-time + 3 late prayers
     * @param {string|number} value - Prayer value in X.Y format
     * @returns {{onTime: number, late: number}} Parsed prayer counts
     */
    function parsePrayer(value) {
      if (!value && value !== 0) return { onTime: 0, late: 0 };
      const num = parseFloat(value) || 0;
      const onTime = Math.floor(num);
      const late = Math.round((num - onTime) * 10);
      return { onTime, late };
    }

    /**
     * Calculate score for a single prayer
     * @param {string|number} value - Prayer value in X.Y format
     * @returns {number} Score for this prayer
     */
    function calcPrayerScore(value) {
      const { onTime, late } = parsePrayer(value);
      return onTime * WEIGHTS.prayer.onTime + late * WEIGHTS.prayer.late;
    }

    // Memoization cache for calculateScores - MAJOR PERFORMANCE OPTIMIZATION
    // Prevents recalculation when same data is passed multiple times
    // Cache cleared when data changes via invalidateScoresCache()
    const scoresCache = new Map();
    let scoresCacheVersion = 0;

    /**
     * Clear the scores cache (call after any data change)
     */
    function invalidateScoresCache() {
      scoresCache.clear();
      scoresCacheVersion++;
    }

    /**
     * Generate cache key from data object
     * Uses JSON.stringify for simple but effective hashing
     */
    function getCacheKey(data) {
      return JSON.stringify(data);
    }

    /**
     * Calculate daily scores across all categories
     * PERFORMANCE: Uses memoization to avoid redundant calculations
     * CACHE LIMIT: Clears when > 500 entries (~100KB memory)
     *
     * @param {Object} data - Daily data object with prayers, glucose, whoop, family, habits
     * @returns {Object} Scores: { prayer, diabetes, whoop, family, habit, total,
     *                           details: { totalOnTime, totalLate, quranPages } }
     *
     * SCORING ALGORITHMS (see DEFAULT_WEIGHTS for exact values):
     * - PRAYER: 5 √ó (onTime √ó 5pts + late √ó 2pts) + quranPages √ó 5pts
     * - GLUCOSE: avg (progressive 0-10 scaled from 105 target) +
     *            TIR (tirPerPoint √ó %) + insulin (base or penalty)
     * - WHOOP: sleep thresholds (high:7, mid:4, low:2) +
     *          recovery thresholds + strain matching bonus
     * - FAMILY: sum of individual weights (6 members, 1pt each)
     * - HABITS: sum of enabled habits with individual weights
     */
    function calculateScores(data) {
      // Check cache first
      const cacheKey = getCacheKey(data);
      if (scoresCache.has(cacheKey)) {
        return scoresCache.get(cacheKey);
      }
      // Ensure data has required structure with safe defaults
      if (!data || typeof data !== 'object') {
        data = JSON.parse(JSON.stringify(defaultDayData));
      }
      const prayers = data.prayers || {};
      const glucose = data.glucose || {};
      const whoop = data.whoop || {};
      const family = data.family || {};
      const habits = data.habits || {};

      // Prayer Score
      let prayerScore = 0;
      let totalOnTime = 0, totalLate = 0;
      ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => {
        const { onTime, late } = parsePrayer(prayers[p]);
        totalOnTime += onTime;
        totalLate += late;
        prayerScore += onTime * WEIGHTS.prayer.onTime + late * WEIGHTS.prayer.late;
      });
      // Quran pages
      const quranPages = parseInt(prayers.quran) || 0;
      prayerScore += quranPages * WEIGHTS.prayer.quran;

      // Diabetes/Glucose Score
      let diabetesScore = 0;
      const avg = parseFloat(glucose.avg) || 0;
      const tir = parseFloat(glucose.tir) || 0;
      const insulin = parseFloat(glucose.insulin) || 0;

      // Avg glucose scoring - progressive: closer to 105 (midpoint of 70-140) = more points
      // Scale: 105 = max points, decreases as you move away from 105
      if (glucose.avg !== '' && glucose.avg !== undefined) {
        const target = 105; // ideal midpoint
        const maxPts = WEIGHTS.glucose.avgMax || 20;
        if (avg >= 70 && avg <= 140) {
          // Perfect range: scale from target (full points) to edges (half points)
          const distFromTarget = Math.abs(avg - target);
          const maxDist = 35; // distance from 105 to 70 or 140
          diabetesScore += maxPts * (1 - (distFromTarget / maxDist) * 0.5);
        } else if (avg > 140 && avg <= 180) {
          // Acceptable range: scale down from edge
          const ptsAt140 = maxPts * 0.5;
          const penalty = (avg - 140) * (ptsAt140 / 40); // lose all by 180
          diabetesScore += Math.max(0, ptsAt140 - penalty);
        }
        // Below 70 or above 180 = 0 points
      }

      // TIR scoring - progressive: each % point matters
      // Scale: 0.3 pts per % (so 70% = 21 pts, 100% = 30 pts)
      if (glucose.tir !== '' && glucose.tir !== undefined && tir > 0) {
        const ptsPerPercent = WEIGHTS.glucose.tirPerPoint || 0.3;
        diabetesScore += tir * ptsPerPercent;
      }

      // Insulin scoring: base points if ‚â§threshold, flat penalty if >threshold
      const insulinThreshold = WEIGHTS.glucose.insulinThreshold || 40;
      if (glucose.insulin !== '' && glucose.insulin !== undefined && insulin > 0) {
        if (insulin <= insulinThreshold) {
          diabetesScore += WEIGHTS.glucose.insulinBase;
        } else {
          diabetesScore += WEIGHTS.glucose.insulinPenalty;
        }
      }

      // Whoop Age Score - Based on age-reducing metrics
      let whoopScore = 0;
      const w = whoop;
      const ww = WEIGHTS.whoop;

      // Sleep Performance: ‚â•90% optimal
      const sleepPerf = parseFloat(w.sleepPerf) || 0;
      if (w.sleepPerf !== '' && w.sleepPerf !== undefined) {
        if (sleepPerf >= 90) whoopScore += ww.sleepPerfHigh;
        else if (sleepPerf >= 70) whoopScore += ww.sleepPerfMid;
        else if (sleepPerf >= 50) whoopScore += ww.sleepPerfLow;
      }

      // Recovery
      const recovery = parseFloat(w.recovery) || 0;
      if (w.recovery !== '' && w.recovery !== undefined) {
        if (recovery >= 66) whoopScore += ww.recoveryHigh;
        else if (recovery >= 50) whoopScore += ww.recoveryMid;
        else if (recovery >= 33) whoopScore += ww.recoveryLow;
      }

      // Strain - recovery-matched scoring
      // High recovery (‚â•66%) ‚Üí reward high strain (14-21)
      // Medium recovery (33-65%) ‚Üí reward moderate strain (10-14)
      // Low recovery (<33%) ‚Üí reward rest/light strain (0-10)
      const strain = parseFloat(w.strain) || 0;
      if (w.strain !== '' && w.strain !== undefined && w.recovery !== '' && w.recovery !== undefined) {
        let strainMatch = false;
        if (recovery >= 66 && strain >= 14) strainMatch = true;
        else if (recovery >= 33 && recovery < 66 && strain >= 10 && strain < 14) strainMatch = true;
        else if (recovery < 33 && strain < 10) strainMatch = true;

        if (strainMatch) whoopScore += (ww.strainMatch || 10);
        // Bonus for high strain on high recovery days
        if (recovery >= 66 && strain >= 18) whoopScore += (ww.strainHigh || 5);
      }

      // Family Score - individual weights per member
      let familyScore = 0;
      Object.entries(family).forEach(([member, checked]) => {
        if (checked) familyScore += WEIGHTS.family[member] || 0;
      });

      // Habit Score
      let habitScore = 0;
      habitScore += (parseInt(habits.exercise) || 0) * WEIGHTS.habits.exercise;
      habitScore += (parseInt(habits.reading) || 0) * WEIGHTS.habits.reading;
      habitScore += (parseInt(habits.meditation) || 0) * WEIGHTS.habits.meditation;
      habitScore += (parseFloat(habits.water) || 0) * WEIGHTS.habits.water;
      habitScore += habits.vitamins ? WEIGHTS.habits.vitamins : 0;
      habitScore += (parseInt(habits.brushTeeth) || 0) * WEIGHTS.habits.brushTeeth;
      // NoP scoring: points if 1, penalty if 0
      const nop = habits.nop;
      if (nop !== '' && nop !== null && nop !== undefined) {
        if (parseInt(nop) === 1) habitScore += (WEIGHTS.habits.nopYes || 5);
        else if (parseInt(nop) === 0) habitScore += (WEIGHTS.habits.nopNo || -3);
      }

      const result = {
        prayer: prayerScore,
        prayerOnTime: totalOnTime,
        prayerLate: totalLate,
        diabetes: Math.round(diabetesScore * 10) / 10,
        whoop: Math.round(whoopScore * 10) / 10,
        family: familyScore,
        habit: habitScore,
        total: Math.round((prayerScore + diabetesScore + whoopScore + familyScore + habitScore) * 10) / 10
      };

      // Cache the result (limit cache size to prevent memory issues)
      if (scoresCache.size > 500) scoresCache.clear();
      scoresCache.set(cacheKey, result);

      return result;
    }

    function getLast30DaysData() {
      const days = [];
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const dayData = allData[dateStr] || defaultDayData;
        const dayScores = calculateScores(dayData);
        days.push({
          date: dateStr,
          day: date.getDate(),
          month: date.toLocaleDateString('en-US', { month: 'short' }),
          label: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          ...dayScores
        });
      }
      return days;
    }

    function getLast30DaysStats() {
      let stats = { totalScore: 0, daysLogged: 0, totalOnTimePrayers: 0, totalLatePrayers: 0, totalFamilyCheckins: 0, avgRHR: 0, avgSleep: 0, rhrCount: 0, sleepCount: 0 };

      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        if (allData[dateStr]) {
          stats.daysLogged++;
          const d = allData[dateStr];
          const dayScores = calculateScores(d);
          stats.totalScore += dayScores.total;
          stats.totalOnTimePrayers += dayScores.prayerOnTime;
          stats.totalLatePrayers += dayScores.prayerLate;
          stats.totalFamilyCheckins += Object.values(d.family).filter(Boolean).length;
          if (d.whoop.rhr) { stats.avgRHR += parseFloat(d.whoop.rhr); stats.rhrCount++; }
          if (d.whoop.sleepHours) { stats.avgSleep += parseFloat(d.whoop.sleepHours); stats.sleepCount++; }
        }
      }
      stats.totalScore = Math.round(stats.totalScore);
      stats.avgRHR = stats.rhrCount ? Math.round(stats.avgRHR / stats.rhrCount) : 0;
      stats.avgSleep = stats.sleepCount ? (stats.avgSleep / stats.sleepCount).toFixed(1) : 0;
      stats.avgDaily = stats.daysLogged ? Math.round(stats.totalScore / stats.daysLogged) : 0;
      return stats;
    }

    function createPrayerInput(prayer, label, value) {
      const { onTime, late } = parsePrayer(value);
      const pts = calcPrayerScore(value);
      return `
        <div class="flex-1 text-center">
          <input type="text" value="${value}" placeholder="X.Y"
            class="prayer-input w-full px-3 py-2 border border-softborder rounded text-center font-mono text-lg bg-white mb-1"
            onchange="updateData('prayers', '${prayer}', this.value)">
          <div class="text-xs font-medium text-charcoal/70">${label}</div>
          <div class="text-xs text-charcoal/50 mt-0.5">
            <span class="text-green-600">${onTime}‚úì</span> <span class="text-amber-500">${late}‚óê</span>
          </div>
          <div class="text-xs font-semibold text-coral mt-0.5">${pts} pts</div>
        </div>
      `;
    }

    function createToggle(label, checked, category, field) {
      return `
        <label class="flex items-center justify-between cursor-pointer py-2 px-1 hover:bg-warmgray rounded transition">
          <span class="text-sm text-charcoal">${label}</span>
          <div class="relative toggle-switch" onclick="updateData('${category}', '${field}', !${checked})">
            <div class="w-10 h-5 rounded-full transition ${checked ? 'toggle-on' : 'toggle-off'}"></div>
            <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow transition" style="transform: translateX(${checked ? '20px' : '0'})"></div>
          </div>
        </label>
      `;
    }

    function createNumberInput(label, value, category, field, placeholder, unit, hint = '', tooltip = '', tooltipPos = 'center') {
      // tooltipPos: 'left', 'center', 'right' to control horizontal alignment
      const posClass = tooltipPos === 'left' ? 'left-0' : tooltipPos === 'right' ? 'right-0' : 'left-1/2 -translate-x-1/2';
      return `
        <div class="flex-1 text-center group relative">
          <input type="number" step="any" value="${value}" placeholder="${placeholder}"
            class="w-full px-2 py-2 border border-softborder rounded text-center text-sm bg-white mb-1"
            onchange="updateData('${category}', '${field}', this.value)">
          <div class="text-xs font-medium text-charcoal/70 flex items-center justify-center gap-1">
            ${label}
            ${tooltip ? `<span class="cursor-help text-charcoal/30 hover:text-coral">‚ìò</span>` : ''}
          </div>
          <div class="text-xs text-charcoal/40">${unit}${hint ? ` ¬∑ ${hint}` : ''}</div>
          ${tooltip ? `<div class="absolute ${posClass} top-full mt-1 z-50 hidden group-hover:block bg-charcoal text-white text-xs rounded p-3 w-48 shadow-lg text-left">${tooltip}</div>` : ''}
        </div>
      `;
    }

    function createCounter(label, value, category, field, max = 10) {
      return `
        <div class="flex items-center justify-between py-2">
          <span class="text-sm text-charcoal">${label}</span>
          <div class="flex items-center gap-2">
            <button onclick="updateData('${category}', '${field}', Math.max(0, ${value} - 1))"
              class="w-7 h-7 rounded-full bg-warmgray hover:bg-softborder flex items-center justify-center font-bold text-charcoal/60 transition">‚àí</button>
            <span class="w-8 text-center font-semibold text-lg text-charcoal">${value}</span>
            <button onclick="updateData('${category}', '${field}', Math.min(${max}, ${value} + 1))"
              class="w-7 h-7 rounded-full bg-coral hover:bg-coralDark text-white flex items-center justify-center font-bold transition">+</button>
          </div>
        </div>
      `;
    }

    function createScoreCard(label, score, max, colorClass) {
      const pct = max ? Math.min((score / max) * 100, 100) : 0;
      // Map old color classes to muted category colors (work with both themes)
      const accentMap = {
        'bg-blue-500': '#4A90A4',
        'bg-green-500': '#6B8E5A',
        'bg-purple-500': '#7C6B8E',
        'bg-amber-500': '#C4943D',
        'bg-slate-500': '#6B7280'
      };
      const accent = accentMap[colorClass] || getAccentColor();
      const pctDisplay = Math.round(pct);
      return `
        <div class="sb-card rounded-lg p-4">
          <div class="flex justify-between items-center mb-1">
            <span class="sb-section-title text-charcoal/60">${label}</span>
            <span class="text-xs text-charcoal/40">${pctDisplay}%</span>
          </div>
          <div class="font-bold text-2xl text-charcoal mb-2">${fmt(score)}</div>
          <div class="h-1.5 bg-charcoal/10 rounded-full overflow-hidden">
            <div class="h-full rounded-full transition-all duration-500" style="width: ${pct}%; background: ${accent}"></div>
          </div>
        </div>
      `;
    }

    function createCard(title, icon, accentColor, content, extraHeader = '') {
      const accent = accentColor || '#6B7280';
      return `
        <div class="sb-card rounded-lg overflow-hidden border border-[var(--border-light)]">
          <div class="px-5 py-3 flex items-center justify-between bg-[var(--bg-secondary)]" style="border-bottom: 2px solid ${accent}">
            <div class="flex items-center gap-2">
              <span class="text-lg">${icon}</span>
              <h3 class="font-semibold text-[var(--text-primary)]">${title}</h3>
            </div>
            ${extraHeader ? `<span class="text-[var(--text-muted)] text-xs">${extraHeader}</span>` : ''}
          </div>
          <div class="p-5 bg-[var(--bg-card)]">${content}</div>
        </div>
      `;
    }

    // ============ HOME TAB (Customizable Widget Dashboard) ============
    function renderHomeTab() {
      const today = getLocalDateString();
      const todayData = allData[today] || JSON.parse(JSON.stringify(defaultDayData));
      const rawScores = calculateScores(todayData);
      // Safe defaults for all score properties
      const scores = {
        total: rawScores?.total ?? 0,
        prayer: rawScores?.prayer ?? 0,
        diabetes: rawScores?.diabetes ?? 0,
        whoop: rawScores?.whoop ?? 0,
        family: rawScores?.family ?? 0,
        habit: rawScores?.habit ?? 0,
        prayerOnTime: rawScores?.prayerOnTime ?? 0,
        prayerLate: rawScores?.prayerLate ?? 0
      };

      // Get visible widgets sorted by order
      const visibleWidgets = homeWidgets.filter(w => w.visible).sort((a, b) => a.order - b.order);
      const hiddenWidgets = homeWidgets.filter(w => !w.visible);

      return `
        <div class="space-y-6">
          <!-- Header -->
          <div class="flex items-start justify-between flex-wrap gap-4">
            <div>
              <div class="home-greeting-row flex items-center gap-3">
                <h1 class="text-2xl font-bold text-charcoal">Good ${new Date().getHours() < 12 ? 'morning' : new Date().getHours() < 18 ? 'afternoon' : 'evening'}, Muhammad</h1>
                ${weatherData ? `
                  <div class="weather-inline flex items-center gap-2 text-charcoal/70" title="${weatherData.city}">
                    <span class="text-base">${WEATHER_ICONS[weatherData.weatherCode] || 'üå°Ô∏è'}</span>
                    <span class="text-sm font-semibold">${weatherData.temp}¬∞</span>
                    <span class="text-[11px] text-charcoal/40 font-medium">‚Üë${weatherData.tempMax}¬∞ <span class="opacity-60">${weatherData.maxHour || ''}</span></span>
                    <span class="text-[11px] text-charcoal/40 font-medium">‚Üì${weatherData.tempMin}¬∞ <span class="opacity-60">${weatherData.minHour || ''}</span></span>
                  </div>
                ` : ''}
              </div>
              <div class="flex items-center gap-3 mt-1">
                <p class="text-charcoal/50 text-sm">${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                <span class="text-charcoal/30">‚Ä¢</span>
                <p class="text-charcoal/40 text-xs">Press <kbd class="px-1.5 py-0.5 bg-charcoal/10 rounded text-[11px] font-mono">‚åòK</kbd> to quick add</p>
              </div>
            </div>
            <div class="flex items-center gap-3">
              ${editingHomeWidgets ? `
                <button onclick="resetHomeWidgets()" class="text-sm text-charcoal/50 hover:text-charcoal px-3 py-1.5 rounded-lg hover:bg-charcoal/5 transition">
                  Reset Layout
                </button>
              ` : ''}
              <button onclick="toggleEditHomeWidgets()" class="text-sm px-3 py-1.5 rounded-lg transition ${editingHomeWidgets ? 'bg-coral text-white' : 'text-charcoal/50 hover:text-charcoal hover:bg-charcoal/5'}">
                ${editingHomeWidgets ? '‚úì Done' : '<span class="inline-flex items-center gap-1">' + THINGS3_ICONS.settings + ' Customize</span>'}
              </button>
            </div>
          </div>

          ${editingHomeWidgets && hiddenWidgets.length > 0 ? `
            <!-- Hidden Widgets -->
            <div class="bg-warmgray/30 rounded-xl p-4">
              <div class="flex items-center gap-2 mb-3">
                <svg class="w-4 h-4 text-charcoal/40" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                <span class="text-sm font-medium text-charcoal/50">Hidden Widgets</span>
              </div>
              <div class="flex flex-wrap gap-2">
                ${hiddenWidgets.map(w => `
                  <button onclick="toggleWidgetVisibility('${w.id}')" class="text-sm px-3 py-1.5 rounded-lg border border-dashed border-charcoal/20 text-charcoal/60 hover:border-coral hover:text-coral transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    ${w.title}
                  </button>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Widget Grid -->
          <div class="grid grid-cols-2 gap-4">
            ${visibleWidgets.map(widget => renderHomeWidget(widget, editingHomeWidgets)).join('')}
          </div>

          <!-- Today's Score Summary -->
          <div class="bg-[var(--bg-card)] rounded-xl p-6 border border-[var(--border-light)]">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold text-[var(--text-primary)]">Today's Score</h3>
                <p class="text-4xl font-bold mt-1 text-[var(--accent)]">${scores.total.toFixed(0)} <span class="text-lg font-normal text-[var(--text-muted)]">/ ${MAX_SCORES.total}</span></p>
              </div>
              <div class="text-right">
                <div class="text-sm text-[var(--text-muted)]">Progress</div>
                <div class="text-2xl font-bold text-[var(--text-primary)]">${Math.round((scores.total / MAX_SCORES.total) * 100)}%</div>
              </div>
            </div>
            <div class="h-2 bg-[var(--bg-secondary)] rounded-full mt-4 overflow-hidden">
              <div class="h-full bg-[var(--accent)] rounded-full transition-all duration-500" style="width: ${Math.min((scores.total / MAX_SCORES.total) * 100, 100)}%"></div>
            </div>
            <div class="grid grid-cols-5 gap-2 mt-4">
              <div class="text-center">
                <div class="text-xs text-[var(--text-muted)]">Prayers</div>
                <div class="font-semibold text-[var(--text-primary)]">${scores.prayer.toFixed(0)}</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-[var(--text-muted)]">Glucose</div>
                <div class="font-semibold text-[var(--text-primary)]">${scores.diabetes.toFixed(0)}</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-[var(--text-muted)]">Whoop</div>
                <div class="font-semibold text-[var(--text-primary)]">${scores.whoop.toFixed(0)}</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-[var(--text-muted)]">Family</div>
                <div class="font-semibold text-[var(--text-primary)]">${scores.family.toFixed(0)}</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-[var(--text-muted)]">Habits</div>
                <div class="font-semibold text-[var(--text-primary)]">${scores.habit.toFixed(0)}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderTrackingTab() {
      const data = getTodayData();
      const rawScores = calculateScores(data);
      const scores = {
        total: rawScores?.total ?? 0,
        prayer: rawScores?.prayer ?? 0,
        diabetes: rawScores?.diabetes ?? 0,
        whoop: rawScores?.whoop ?? 0,
        family: rawScores?.family ?? 0,
        habit: rawScores?.habit ?? 0,
        prayerOnTime: rawScores?.prayerOnTime ?? 0,
        prayerLate: rawScores?.prayerLate ?? 0
      };

      const prayerHelp = `<span class="text-xs text-charcoal/50">X.Y = X on-time + Y late</span>`;
      const prayersContent = `
        <div class="flex gap-2 mb-4">
          ${['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].map(p =>
            createPrayerInput(p, p.charAt(0).toUpperCase() + p.slice(1), data.prayers[p])
          ).join('')}
        </div>
        <div class="border-t border-softborder pt-4">
          <div class="flex items-center justify-center gap-3">
            <span class="text-sm text-charcoal/70">üìñ Quran</span>
            <button onclick="updateData('prayers', 'quran', Math.max(0, ${parseInt(data.prayers.quran) || 0} - 1))"
              class="w-7 h-7 rounded-full bg-warmgray hover:bg-softborder flex items-center justify-center font-bold text-charcoal/60">‚àí</button>
            <span class="w-8 text-center font-semibold text-lg">${parseInt(data.prayers.quran) || 0}</span>
            <button onclick="updateData('prayers', 'quran', ${parseInt(data.prayers.quran) || 0} + 1)"
              class="w-7 h-7 rounded-full bg-coral hover:bg-coralDark text-white flex items-center justify-center font-bold">+</button>
            <span class="text-xs text-charcoal/50">pages ¬∑ ${(parseInt(data.prayers.quran) || 0) * 5} pts</span>
          </div>
        </div>
      `;

      const insulinThreshold = WEIGHTS.glucose.insulinThreshold || 40;
      const glucoseContent = `
        <div class="flex gap-3">
          ${createNumberInput('Avg Glucose', data.glucose.avg, 'glucose', 'avg', '105', 'mg/dL', '105=10pts')}
          ${createNumberInput('TIR', data.glucose.tir, 'glucose', 'tir', '70+', '%', '0.1pts/%')}
          ${createNumberInput('Insulin', data.glucose.insulin, 'glucose', 'insulin', '‚â§' + insulinThreshold, 'units', '‚â§' + insulinThreshold + '=+5')}
        </div>
      `;

      const whoopHelp = `<span class="text-xs text-charcoal/50">Hover ‚ìò for tips</span>`;
      const whoopContent = `
        <div class="grid grid-cols-3 gap-3">
          ${createNumberInput('Sleep Perf', data.whoop.sleepPerf, 'whoop', 'sleepPerf', '‚â•90', '%', '‚â•90%', '<b>How to improve:</b><br>‚Ä¢ Consistent bedtime/wake time<br>‚Ä¢ Cool room (65-68¬∞F)<br>‚Ä¢ No screens 1h before bed', 'left')}
          ${createNumberInput('Recovery', data.whoop.recovery, 'whoop', 'recovery', '‚â•66', '%', '‚â•66%', '<b>How to improve recovery:</b><br>‚Ä¢ Prioritize sleep quality<br>‚Ä¢ Hydrate well<br>‚Ä¢ Eat nutritious foods', 'center')}
          ${createNumberInput('Strain', data.whoop.strain, 'whoop', 'strain', '10-14', '/21', 'match', '<b>Recovery-matched:</b><br>‚Ä¢ Green (‚â•66%) ‚Üí 14+ strain<br>‚Ä¢ Yellow (33-65%) ‚Üí 10-14 strain<br>‚Ä¢ Red (<33%) ‚Üí rest', 'right')}
        </div>
      `;

      const familyContent = ['mom', 'dad', 'jana', 'tia', 'ahmed', 'eman'].map(p =>
        createToggle(p.charAt(0).toUpperCase() + p.slice(1), data.family[p], 'family', p)
      ).join('');

      const habitsContent = `
        <div class="space-y-2">
          ${createCounter('üèãÔ∏è Exercise', data.habits.exercise || 0, 'habits', 'exercise', 5)}
          ${createCounter('üìö Reading', data.habits.reading || 0, 'habits', 'reading', 5)}
          ${createCounter('üßò Meditation', data.habits.meditation || 0, 'habits', 'meditation', 5)}
          ${createCounter('ü¶∑ Brush Teeth', data.habits.brushTeeth || 0, 'habits', 'brushTeeth', 3)}
          ${createToggle('üíä Vitamins taken', data.habits.vitamins, 'habits', 'vitamins')}
        </div>
        <div class="flex gap-3 mt-3 pt-3 border-t border-softborder">
          <div class="flex-1 text-center">
            <input type="number" step="any" value="${data.habits.water}" placeholder="2.5"
              class="w-full px-2 py-2 border border-softborder rounded text-center text-sm bg-white mb-1"
              onchange="updateData('habits', 'water', this.value)">
            <div class="text-xs font-medium text-charcoal/70">üíß Water</div>
            <div class="text-xs text-charcoal/40">L ¬∑ 1pt/L</div>
          </div>
          <div class="flex-1 text-center">
            <input type="number" step="1" value="${data.habits.nop}" placeholder="0-1"
              class="w-full px-2 py-2 border border-softborder rounded text-center text-sm bg-white mb-1"
              onchange="updateData('habits', 'nop', this.value)">
            <div class="text-xs font-medium text-charcoal/70">üí§ NoP</div>
            <div class="text-xs text-charcoal/40">1=+2, 0=-2</div>
          </div>
        </div>
      `;

      const summaryContent = `
        <div class="space-y-3">
          <div class="p-3 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border-light)]">
            <div class="flex justify-between items-center">
              <span class="font-medium text-[var(--text-primary)]">Whoop Age</span>
              <div class="flex items-center gap-2">
                <input type="number" step="0.1" value="${data.whoop.whoopAge || ''}" placeholder="‚Äî"
                  class="w-16 px-2 py-1 border border-[var(--border)] rounded text-center text-sm bg-[var(--bg-input)] font-bold text-[var(--accent)]"
                  onchange="updateData('whoop', 'whoopAge', this.value)">
                <span class="text-xs text-[var(--text-muted)]">yrs</span>
              </div>
            </div>
          </div>
          <div class="p-3 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border-light)]">
            <div class="flex justify-between items-center">
              <span class="font-medium text-[var(--text-primary)]">Prayers</span>
              <span class="font-bold text-[var(--accent)]">${scores.prayer} pts</span>
            </div>
            <div class="text-xs mt-1">
              <span class="inline-block bg-green-100 text-green-700 px-2 py-0.5 rounded mr-1">${scores.prayerOnTime} on-time</span>
              <span class="inline-block bg-amber-100 text-amber-700 px-2 py-0.5 rounded">${scores.prayerLate} late</span>
            </div>
          </div>
          <div class="flex justify-between items-center p-3 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border-light)]">
            <span class="font-medium text-[var(--text-primary)]">Family</span>
            <span class="font-bold text-[var(--accent)]">${Object.values(data.family).filter(Boolean).length}/6</span>
          </div>
        </div>
      `;

      return `
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
          ${createScoreCard('Prayer', scores.prayer, MAX_SCORES.prayer, 'bg-blue-500')}
          ${createScoreCard('Diabetes', scores.diabetes, MAX_SCORES.diabetes, 'bg-green-500')}
          ${createScoreCard('Whoop', scores.whoop, MAX_SCORES.whoop, 'bg-purple-500')}
          ${createScoreCard('Family', scores.family, MAX_SCORES.family, 'bg-amber-500')}
          ${createScoreCard('Habits', scores.habit, MAX_SCORES.habits, 'bg-slate-500')}
          <div class="sb-card rounded-lg p-4 bg-[var(--bg-card)] border border-[var(--border-light)]">
            <div class="sb-section-title text-[var(--text-muted)] flex justify-between">
              <span>Total</span>
              <span>${Math.round((scores.total / MAX_SCORES.total) * 100)}%</span>
            </div>
            <div class="text-3xl font-bold mt-1 text-[var(--accent)]">${fmt(scores.total)}</div>
            <div class="h-1.5 bg-[var(--bg-secondary)] rounded-full mt-2 overflow-hidden">
              <div class="h-full bg-[var(--accent)] rounded-full" style="width: ${Math.min((scores.total / MAX_SCORES.total) * 100, 100)}%"></div>
            </div>
          </div>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5">
          ${createCard('Prayers', 'üïå', '#4A90A4', prayersContent, prayerHelp)}
          ${createCard('Glucose (Libre)', 'üíâ', '#6B8E5A', glucoseContent)}
          ${createCard('Whoop Age Metrics', '‚è±Ô∏è', '#7C6B8E', whoopContent, whoopHelp)}
          ${createCard('Family Check-ins', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', '#C4943D', familyContent)}
          ${createCard('Habits', '‚ú®', '#6B7280', habitsContent)}
          ${createCard("Today's Summary", 'üìà', getAccentColor(), summaryContent)}
        </div>
      `;
    }

    function renderDashboardTab() {
      const stats = getLast30DaysStats();
      const last30Data = getLast30DaysData();
      const bests = getPersonalBests();

      setTimeout(() => {
        const weekCtx = document.getElementById('weekChart');
        if (weekCtx) {
          if (weekChart) weekChart.destroy();
          weekChart = new Chart(weekCtx, {
            type: 'bar',
            data: {
              labels: last30Data.map(d => d.label),
              datasets: [{ label: 'Total Score', data: last30Data.map(d => d.total), backgroundColor: getAccentColor(), borderRadius: 4 }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true },
                x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } }
              }
            }
          });
        }

        const breakdownCtx = document.getElementById('breakdownChart');
        if (breakdownCtx) {
          if (breakdownChart) breakdownChart.destroy();
          breakdownChart = new Chart(breakdownCtx, {
            type: 'line',
            data: {
              labels: last30Data.map(d => d.label),
              datasets: [
                { label: 'Prayer', data: last30Data.map(d => d.prayer), borderColor: '#4A90A4', tension: 0.3, pointRadius: 2 },
                { label: 'Whoop', data: last30Data.map(d => d.whoop), borderColor: '#7C6B8E', tension: 0.3, pointRadius: 2 },
                { label: 'Family', data: last30Data.map(d => d.family), borderColor: '#C4943D', tension: 0.3, pointRadius: 2 },
                { label: 'Habit', data: last30Data.map(d => d.habit), borderColor: '#6B7280', tension: 0.3, pointRadius: 2 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom' } },
              scales: {
                y: { beginAtZero: true },
                x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } }
              }
            }
          });
        }
      }, 100);

      return `
        <div class="space-y-8">
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="sb-card rounded-lg p-5 bg-[var(--bg-card)] border border-[var(--border-light)]">
              <div class="sb-section-title text-[var(--text-muted)]">30-Day Score</div>
              <div class="text-3xl font-bold mt-1 text-[var(--accent)]">${fmt(stats.totalScore)}</div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Days Logged</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${stats.daysLogged}/30</div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Avg RHR</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${fmt(stats.avgRHR)} <span class="text-base font-normal text-charcoal/50">bpm</span></div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Avg Sleep</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${stats.avgSleep} <span class="text-base font-normal text-charcoal/50">hrs</span></div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Family Check-ins</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${fmt(stats.totalFamilyCheckins)}</div>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Last 30 Days <span class="text-coral">‚Üí</span></h3>
            <div class="h-72"><canvas id="weekChart"></canvas></div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Score Breakdown <span class="text-coral">‚Üí</span></h3>
            <div class="h-72"><canvas id="breakdownChart"></canvas></div>
          </div>

          <!-- Personal Bests Section -->
          ${bests ? `
          <div class="sb-card rounded-lg p-6 bg-warmgray border-2 border-coral/20">
            <h3 class="font-semibold text-charcoal mb-4">Personal Bests <span class="text-coral">‚Üí</span></h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral">${fmt(bests.highestDayScore.value)}</div>
                <div class="text-sm text-charcoal/70 mt-1">Best Day Score</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.highestDayScore.date ? new Date(bests.highestDayScore.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '‚Äî'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral">${fmt(bests.highestWeekScore.value)}</div>
                <div class="text-sm text-charcoal/70 mt-1">Best Week Score</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.highestWeekScore.weekStart ? 'Week of ' + new Date(bests.highestWeekScore.weekStart).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '‚Äî'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral">${fmt(bests.longestStreak.value)}</div>
                <div class="text-sm text-charcoal/70 mt-1">Longest Streak</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.longestStreak.value > 0 ? 'days in a row' : '‚Äî'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral flex items-center gap-2">${fmt(bests.currentStreak)} ${bests.currentStreak > 0 ? 'üî•' : ''}</div>
                <div class="text-sm text-charcoal/70 mt-1">Current Streak</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.currentStreak > 0 ? 'Keep it going!' : 'Log today to start!'}</div>
              </div>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="sb-card rounded-lg p-6 bg-white">
              <h3 class="font-semibold text-charcoal mb-4">Category Records <span class="text-coral">‚Üí</span></h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div>
                    <div class="text-sm font-medium text-charcoal">üïå Best Prayer Day</div>
                    <div class="text-xs text-charcoal/50">${bests.bestPrayerDay.date ? new Date(bests.bestPrayerDay.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî'}</div>
                  </div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.bestPrayerDay.value)} pts</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div>
                    <div class="text-sm font-medium text-charcoal">‚è±Ô∏è Best Whoop Day</div>
                    <div class="text-xs text-charcoal/50">${bests.bestWhoopDay.date ? new Date(bests.bestWhoopDay.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî'}</div>
                  </div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.bestWhoopDay.value)} pts</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div>
                    <div class="text-sm font-medium text-charcoal">üìñ Most Quran Pages</div>
                    <div class="text-xs text-charcoal/50">${bests.mostQuranPages.date ? new Date(bests.mostQuranPages.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî'}</div>
                  </div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.mostQuranPages.value)} pages</div>
                </div>
              </div>
            </div>

            <div class="sb-card rounded-lg p-6 bg-white">
              <h3 class="font-semibold text-charcoal mb-4">Lifetime Stats <span class="text-coral">‚Üí</span></h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div class="text-sm font-medium text-charcoal">Total Days Logged</div>
                  <div class="text-xl font-bold text-charcoal">${fmt(bests.totalDaysLogged)}</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div class="text-sm font-medium text-charcoal">Perfect Prayer Days</div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.perfectPrayerDays)} üåü</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div class="text-sm font-medium text-charcoal">Perfect Prayer Rate</div>
                  <div class="text-xl font-bold text-coral">${bests.totalDaysLogged > 0 ? Math.round((bests.perfectPrayerDays / bests.totalDaysLogged) * 100) : 0}%</div>
                </div>
              </div>
            </div>
          </div>
          ` : `
          <div class="sb-card rounded-lg p-8 bg-white text-center">
            <div class="text-4xl mb-4">üéÆ</div>
            <h3 class="font-semibold text-charcoal mb-2">Start Your Journey!</h3>
            <p class="text-charcoal/50 text-sm">Log your first day to start tracking personal bests.</p>
          </div>
          `}
        </div>
      `;
    }

    // Helper function to render a single task item
    function renderTaskItem(task, showDueDate = true, compact = false) {
      const category = getCategoryById(task.categoryId);
      const labels = (task.labels || []).map(lid => getLabelById(lid)).filter(Boolean);
      const today = getLocalDateString();
      const isOverdue = task.dueDate && task.dueDate < today && !task.completed;
      const hasMetadata = !compact && (category || labels.length > 0 || (showDueDate && task.dueDate) || task.deferDate || (task.repeat && task.repeat.type !== 'none') || task.notes);
      const isInlineEditing = inlineEditingTaskId === task.id;
      const indentLevel = task.indent || 0;
      const indentPx = indentLevel * 24;

      // Compact mode for widgets - clean single line Things 3 style
      if (compact) {
        return `
          <div class="task-item group relative hover:bg-[var(--bg-secondary)]/50 rounded-lg transition cursor-pointer"
            onclick="showPerspectiveTasks('${task.status || 'anytime'}')">
            <div class="flex items-center h-11 px-3">
              ${task.isNote ? `
                <div class="w-5 h-5 flex items-center justify-center flex-shrink-0">
                  <div class="w-2 h-2 rounded-full bg-[var(--notes-accent)]"></div>
                </div>
              ` : `
                <button onclick="event.stopPropagation(); toggleTaskComplete('${task.id}')"
                  aria-label="${task.completed ? 'Mark task as incomplete' : 'Mark task as complete'}: ${escapeHtml(task.title)}"
                  class="task-checkbox w-5 h-5 rounded-full border-2 flex-shrink-0 flex items-center justify-center transition-all ${task.completed ? 'completed bg-[var(--accent)] border-[var(--accent)] text-white' : 'border-charcoal/25 hover:border-[var(--accent)]'}">
                  ${task.completed ? '<svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>' : ''}
                </button>
              `}
              <span class="flex-1 ml-3 text-[14px] leading-tight ${task.completed ? 'line-through text-[var(--text-muted)]' : 'text-[var(--text-primary)]'} truncate">${escapeHtml(task.title)}</span>
              ${task.repeat && task.repeat.type !== 'none' ? `
                <span class="ml-1 text-[var(--accent)]" title="Repeats ${task.repeat.interval > 1 ? 'every ' + task.repeat.interval + ' ' : ''}${task.repeat.type}">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                </span>
              ` : ''}
              ${labels.length > 0 ? `
                <span class="ml-2 text-[11px] text-charcoal/40 flex-shrink-0">${labels[0].name}</span>
              ` : ''}
            </div>
          </div>
        `;
      }

      return `
        <div class="task-item group relative"
          draggable="${isInlineEditing ? 'false' : 'true'}"
          ondragstart="handleDragStart(event, '${task.id}')"
          ondragend="handleDragEnd(event)"
          ondragover="handleDragOver(event, '${task.id}')"
          ondragleave="handleDragLeave(event)"
          ondrop="handleDrop(event, '${task.id}')" onclick="if(window.matchMedia('(hover: none)').matches && !event.target.closest('.task-checkbox')) { editingTaskId='${task.id}'; showTaskModal=true; render(); }">
          <div class="flex items-start gap-3 px-4 py-2.5" style="${indentLevel > 0 ? `padding-left: ${16 + indentPx}px` : ''}">
            ${task.isNote ? `
              <div class="mt-1.5 w-2 h-2 rounded-full ${indentLevel > 0 ? 'bg-[var(--notes-accent)]/50' : 'bg-[var(--notes-accent)]'} flex-shrink-0"></div>
            ` : `
              <button onclick="event.stopPropagation(); toggleTaskComplete('${task.id}')"
                aria-label="${task.completed ? 'Mark task as incomplete' : 'Mark task as complete'}: ${escapeHtml(task.title)}"
                class="task-checkbox mt-0.5 w-5 h-5 rounded-full border-[1.5px] flex-shrink-0 flex items-center justify-center transition-all ${task.completed ? 'completed bg-[var(--accent)] border-[var(--accent)] text-white' : 'border-[var(--text-muted)] hover:border-[var(--accent)]'}">
                ${task.completed ? '<svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>' : ''}
              </button>
            `}
            <div class="flex-1 min-w-0">
              ${isInlineEditing ? `
                <input type="text" id="inline-edit-input" value="${task.title.replace(/"/g, '&quot;')}"
                  onkeydown="handleInlineEditKeydown(event, '${task.id}')"
                  onblur="saveInlineEdit('${task.id}')"
                  class="w-full text-[16px] text-[var(--text-primary)] bg-white border border-[var(--accent)] rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-[var(--accent-light)]">
              ` : `
                <span ondblclick="event.stopPropagation(); startInlineEdit('${task.id}')"
                  class="text-[15px] ${task.completed ? 'line-through text-[var(--text-muted)]' : 'text-[var(--text-primary)]'} leading-snug transition cursor-text">${escapeHtml(task.title)}</span>
              `}
              ${hasMetadata ? `
                <div class="flex items-center gap-2 mt-1.5 flex-wrap text-[12px]">
                  ${category ? `<span onclick="event.stopPropagation(); showCategoryTasks('${category.id}')" class="px-2 py-0.5 rounded-md cursor-pointer bg-[var(--bg-secondary)] text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition">${escapeHtml(category.name)}</span>` : ''}
                  ${labels.map(l => `<span onclick="event.stopPropagation(); showLabelTasks('${l.id}')" class="px-2 py-0.5 rounded-md cursor-pointer bg-[var(--bg-secondary)] text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition">${escapeHtml(l.name)}</span>`).join('')}
                  ${task.deferDate ? `<span class="flex items-center gap-1 text-amber-600"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>${new Date(task.deferDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>` : ''}
                  ${showDueDate && task.dueDate ? `<span class="flex items-center gap-1 ${isOverdue ? 'text-red-500 font-medium' : 'text-[var(--text-muted)]'}"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>${new Date(task.dueDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>` : ''}
                  ${task.repeat && task.repeat.type !== 'none' ? `<span class="flex items-center gap-0.5 text-[var(--accent)]"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>${task.repeat.interval > 1 ? task.repeat.interval : ''}${task.repeat.type.charAt(0).toUpperCase()}</span>` : ''}
                  ${task.notes ? `<span class="text-[var(--text-muted)] truncate max-w-[150px]">${escapeHtml(task.notes)}</span>` : ''}
                </div>
              ` : ''}
            </div>
            <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-[var(--modal-bg)]/95 backdrop-blur-sm rounded-lg px-1.5 py-1 shadow-sm" onclick="event.stopPropagation()">
              ${task.isNote && !task.completed ? `
                <button onclick="event.stopPropagation(); createChildNote('${task.id}')"
                  class="p-1 text-purple-400 hover:text-purple-600 hover:bg-purple-50 rounded-md transition" title="Add child note">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                </button>
                <button onclick="event.stopPropagation(); outdentNote('${task.id}')"
                  class="p-1 text-[var(--text-muted)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] rounded-md transition ${indentLevel === 0 ? 'opacity-30 cursor-not-allowed' : ''}" title="Outdent (Shift+Tab)">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 17l-5-5 5-5M18 7v10"/></svg>
                </button>
                <button onclick="event.stopPropagation(); indentNote('${task.id}')"
                  class="p-1 text-[var(--text-muted)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] rounded-md transition" title="Indent (Tab)">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 7l5 5-5 5M6 7v10"/></svg>
                </button>
              ` : ''}
              ${!task.completed && !task.isNote ? `
                <select onchange="inlineEditingTaskId=null; moveTaskTo('${task.id}', this.value); this.value=''"
                  onclick="event.stopPropagation()"
                  class="text-[11px] px-2 py-1 border border-[var(--border)] rounded-md bg-[var(--bg-input)] text-[var(--text-secondary)] cursor-pointer hover:border-[var(--text-muted)] transition">
                  <option value="">Move</option>
                  <option value="inbox">Inbox</option>
                  <option value="today">Today</option>
                  <option value="anytime">Anytime</option>
                  <option value="someday">Someday</option>
                </select>
              ` : ''}
              <button onclick="event.stopPropagation(); inlineEditingTaskId=null; editingTaskId='${task.id}'; showTaskModal=true; render()"
                aria-label="Edit task: ${escapeHtml(task.title)}"
                class="p-1 text-[var(--text-muted)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] rounded-md transition" title="Edit">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </button>
              <button onclick="event.stopPropagation(); confirmDeleteTask('${task.id}')"
                aria-label="Delete task: ${escapeHtml(task.title)}"
                class="p-1 text-[var(--text-muted)] hover:text-red-500 hover:bg-red-50 rounded-md transition" title="Delete">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================================================
    // SECTION 10: MAIN RENDER FUNCTION
    // ============================================================================
    // Full DOM replacement rendering (no virtual DOM)
    // This function rebuilds the entire UI on every state change
    //
    // PERFORMANCE NOTE: While full DOM replacement is simpler, it can be slow.
    // For optimization, consider:
    // - Memoizing expensive calculations (done for scores)
    // - Using requestAnimationFrame for animations
    // - Debouncing rapid state changes
    //
    // TAB STRUCTURE:
    // - Home: Dashboard widgets (weather, quick stats, today tasks)
    // - Tasks (Workspace): Things 3-style task management
    // - Life: Daily tracking + bulk entry + statistics
    // - Settings: Theme, sync, scoring weights

    /**
     * Main render function - rebuilds entire UI
     * Called on every state change (tab switch, data update, etc.)
     *
     * ARCHITECTURE: Full DOM replacement via innerHTML
     * - Simple to reason about
     * - No need to track DOM state
     * - Trade-off: Slower than incremental updates
     */
    function render() {
      try {
      const app = document.getElementById('app');
      const dateDisplay = new Date(currentDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      app.innerHTML = `
        <!-- Mobile Header - Things 3 style -->
        <header class="mobile-header-compact border-b border-[var(--border-light)] bg-[var(--bg-card)] sticky top-0 z-50" style="display: none;">
          <div class="flex items-center gap-3">
            ${activeTab === 'tasks' ? `
              <button onclick="openMobileDrawer()" class="w-8 h-8 flex items-center justify-center rounded-lg text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)] transition" aria-label="Open sidebar">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
              </button>
            ` : ''}
          </div>
          <h1 class="text-[17px] font-bold text-[var(--text-primary)]">${activeTab === 'home' ? 'Home' : activeTab === 'tasks' ? (function(){ const vi = getCurrentViewInfo(); return vi.name; })() : activeTab === 'life' ? 'Life Score' : 'Settings'}</h1>
          <div class="flex items-center gap-2">
            ${activeTab === 'tasks' ? `
              <button onclick="openNewTaskModal()" class="w-8 h-8 rounded-full bg-[#147EFB] text-white flex items-center justify-center shadow-sm" aria-label="New task">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            ` : `
              <button onclick="setToday()" class="text-xs font-semibold px-3 py-1.5 text-[var(--accent)] rounded-lg">Today</button>
            `}
          </div>
        </header>

        <!-- Desktop Header - hidden on mobile -->
        <header class="border-b border-softborder desktop-header-content" style="background: var(--bg-primary);">
          <div class="max-w-6xl mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <svg class="w-12 h-12 app-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                  <defs>
                    <linearGradient id="nucleusGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color: var(--accent)"/>
                      <stop offset="100%" style="stop-color: #D4402E"/>
                    </linearGradient>
                  </defs>
                  <circle cx="50" cy="50" r="45" fill="url(#nucleusGrad)"/>
                  <circle cx="50" cy="50" r="18" fill="var(--bg-primary)"/>
                  <circle cx="50" cy="50" r="8" fill="var(--accent)"/>
                  <circle cx="30" cy="35" r="6" fill="var(--bg-primary)" opacity="0.7"/>
                  <circle cx="70" cy="65" r="5" fill="var(--bg-primary)" opacity="0.6"/>
                  <circle cx="35" cy="68" r="4" fill="var(--bg-primary)" opacity="0.5"/>
                </svg>
                <div>
                  <div class="flex items-center gap-2">
                    <h1 class="text-2xl font-bold tracking-tight text-charcoal">Nucleus</h1>
                    <span class="text-[11px] font-medium text-charcoal/40 bg-charcoal/5 px-1.5 py-0.5 rounded">v${APP_VERSION}</span>
                  </div>
                  <p class="text-sm text-charcoal/60 mt-0.5">The core of your life <span class="text-coral">‚Ä¢</span> habits, health, productivity</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-warmgray border border-softborder" title="Cloud sync status">
                  <div id="sync-indicator" class="w-2 h-2 rounded-full ${getGithubToken() ? 'bg-green-500' : 'bg-charcoal/30'}"></div>
                  <span class="text-xs text-charcoal/50">${getGithubToken() ? 'Synced' : 'Local'}</span>
                </div>
                <input type="date" id="dateInput" value="${currentDate}"
                  onclick="this.showPicker()"
                  class="px-3 py-2 rounded-lg text-sm border border-softborder bg-white focus:border-coral focus:outline-none">
                <button onclick="setToday()" class="sb-btn px-4 py-2 rounded-lg text-sm font-medium">Today</button>
              </div>
            </div>
            <p class="text-charcoal/50 text-sm mt-2">${dateDisplay}</p>
          </div>
        </header>

        <!-- Main Navigation - Desktop only -->
        <nav class="desktop-nav border-b border-[var(--border-light)] bg-[var(--bg-card)]">
          <div class="max-w-6xl mx-auto px-6">
            <div class="flex gap-0">
              <button onclick="switchTab('home')" class="nav-tab py-3 px-5 text-sm font-medium transition-all border-b-2 flex items-center gap-2 ${activeTab === 'home' ? 'border-[var(--accent)] text-[var(--text-primary)]' : 'border-transparent text-charcoal/50 hover:text-charcoal hover:bg-black/[0.04]'}">
                ${THINGS3_ICONS.home.replace('w-5 h-5', 'w-4 h-4')} Home
              </button>
              <button onclick="switchTab('tasks')" class="nav-tab py-3 px-5 text-sm font-medium transition-all border-b-2 flex items-center gap-2 ${activeTab === 'tasks' ? 'border-[var(--accent)] text-[var(--text-primary)]' : 'border-transparent text-charcoal/50 hover:text-charcoal hover:bg-black/[0.04]'}">
                ${THINGS3_ICONS.workspace} Workspace
              </button>
              <button onclick="switchTab('life')" class="nav-tab py-3 px-5 text-sm font-medium transition-all border-b-2 flex items-center gap-2 ${activeTab === 'life' ? 'border-[var(--accent)] text-[var(--text-primary)]' : 'border-transparent text-charcoal/50 hover:text-charcoal hover:bg-black/[0.04]'}">
                ${THINGS3_ICONS.lifeScore} Life Score
              </button>
              <button onclick="switchTab('settings')" class="nav-tab py-3 px-5 text-sm font-medium transition-all border-b-2 flex items-center gap-2 ${activeTab === 'settings' ? 'border-[var(--accent)] text-[var(--text-primary)]' : 'border-transparent text-charcoal/50 hover:text-charcoal hover:bg-black/[0.04]'}">
                ${THINGS3_ICONS.settings} Settings
              </button>
            </div>
          </div>
        </nav>

        ${activeTab === 'life' ? `
        <!-- Sub Navigation for Life Score -->
        <div class="bg-warmgray/30 border-b border-charcoal/5">
          <div class="max-w-6xl mx-auto px-6">
            <div class="flex gap-1 py-2">
              <button onclick="switchSubTab('daily')" class="px-4 py-1.5 text-sm rounded-lg transition ${activeSubTab === 'daily' ? 'bg-white shadow-sm text-charcoal font-medium' : 'text-charcoal/60 hover:text-charcoal hover:bg-white/50'}">
                Daily Entry
              </button>
              <button onclick="switchSubTab('bulk')" class="px-4 py-1.5 text-sm rounded-lg transition ${activeSubTab === 'bulk' ? 'bg-white shadow-sm text-charcoal font-medium' : 'text-charcoal/60 hover:text-charcoal hover:bg-white/50'}">
                Bulk Entry
              </button>
              <button onclick="switchSubTab('dashboard')" class="px-4 py-1.5 text-sm rounded-lg transition ${activeSubTab === 'dashboard' ? 'bg-white shadow-sm text-charcoal font-medium' : 'text-charcoal/60 hover:text-charcoal hover:bg-white/50'}">
                Dashboard
              </button>
            </div>
          </div>
        </div>
        ` : ''}

        <main class="max-w-6xl mx-auto px-6 py-8">
          ${activeTab === 'home' ? renderHomeTab() :
            activeTab === 'life' ? (activeSubTab === 'daily' ? renderTrackingTab() : activeSubTab === 'bulk' ? renderBulkEntryTab() : renderDashboardTab()) :
            activeTab === 'tasks' ? renderTasksTab() :
            renderSettingsTab()}
        </main>

        <footer class="border-t border-softborder py-8 mt-12">
          <p class="text-center text-charcoal/40 text-sm">${getGithubToken() ? 'Data synced to GitHub' : 'Data saved locally'} <span class="text-coral">‚Ä¢</span> Nucleus</p>
        </footer>

        <!-- Mobile Bottom Navigation (all tabs) -->
        <nav class="mobile-bottom-nav" aria-label="Main navigation">
          <div class="mobile-bottom-nav-inner" role="tablist">
            <button onclick="switchTab('home')" class="mobile-nav-item ${activeTab === 'home' ? 'active' : ''}" role="tab" aria-selected="${activeTab === 'home'}">
              ${THINGS3_ICONS.home}
            </button>
            <button onclick="switchTab('tasks')" class="mobile-nav-item ${activeTab === 'tasks' ? 'active' : ''}" role="tab" aria-selected="${activeTab === 'tasks'}">
              ${THINGS3_ICONS.workspace}
            </button>
            <button onclick="switchTab('life')" class="mobile-nav-item ${activeTab === 'life' ? 'active' : ''}" role="tab" aria-selected="${activeTab === 'life'}">
              ${THINGS3_ICONS.lifeScore}
            </button>
            <button onclick="switchTab('settings')" class="mobile-nav-item ${activeTab === 'settings' ? 'active' : ''}" role="tab" aria-selected="${activeTab === 'settings'}">
              ${THINGS3_ICONS.settings}
            </button>
          </div>
        </nav>
      `;

      // Setup date input handler (with cleanup to prevent memory leak)
      const dateInput = document.getElementById('dateInput');
      if (dateInput && !dateInput._hasChangeHandler) {
        dateInput._hasChangeHandler = true;
        dateInput.addEventListener('change', (e) => { currentDate = e.target.value; render(); });
      }

      // Setup sidebar drag and drop after DOM is updated
      if (activeTab === 'tasks') {
        setupSidebarDragDrop();
      }

      // Initialize autocomplete for task modal if it's open
      if (showTaskModal) {
        initModalAutocomplete();
      }
      } catch (err) {
        console.error('Render error:', err);
        document.getElementById('app').innerHTML = '<div style="padding:20px;color:red;font-family:monospace;">Render error: ' + err.message + '<br><br>Stack: ' + err.stack + '</div>';
      }
    }

    function switchTab(tab) { activeTab = tab; saveViewState(); render(); scrollToContent(); }
    function setToday() { currentDate = getLocalDateString(); render(); }

    function setBulkMonth(month, year) {
      bulkMonth = parseInt(month);
      bulkYear = parseInt(year);
      render();
    }

    function setBulkCategory(cat) {
      bulkCategory = cat;
      render();
    }

    function updateBulkData(dateStr, category, field, value) {
      if (!allData[dateStr]) {
        allData[dateStr] = JSON.parse(JSON.stringify(defaultDayData));
      }
      if (category === 'family') {
        allData[dateStr][category][field] = value === '1' || value === true;
      } else {
        allData[dateStr][category][field] = value;
      }
      saveData();
      debouncedSaveToGithub(); // Auto-save to GitHub
      // Update score cell live
      const scoreCell = document.getElementById('score-' + dateStr);
      if (scoreCell) {
        const newScore = calculateScores(allData[dateStr]).total;
        scoreCell.textContent = fmt(newScore);
      }
      // Update summary stats
      updateBulkSummary();
    }

    function updateBulkSummary() {
      const daysInMonth = getDaysInMonth(bulkMonth, bulkYear);
      let totalScore = 0, daysWithData = 0;
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = bulkYear + '-' + String(bulkMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        if (allData[dateStr]) {
          daysWithData++;
          totalScore += calculateScores(allData[dateStr]).total;
        }
      }
      const avgScore = daysWithData > 0 ? Math.round(totalScore / daysWithData) : 0;
      const completionRate = Math.round((daysWithData / daysInMonth) * 100);

      const daysEl = document.getElementById('bulk-days-logged');
      const totalEl = document.getElementById('bulk-total-score');
      const avgEl = document.getElementById('bulk-avg-score');
      const compEl = document.getElementById('bulk-completion');
      if (daysEl) daysEl.textContent = fmt(daysWithData);
      if (totalEl) totalEl.textContent = fmt(totalScore);
      if (avgEl) avgEl.textContent = fmt(avgScore);
      if (compEl) compEl.textContent = completionRate + '%';
    }

    function getDaysInMonth(month, year) {
      return new Date(year, month + 1, 0).getDate();
    }

    function renderBulkEntryTab() {
      const daysInMonth = getDaysInMonth(bulkMonth, bulkYear);
      const monthName = new Date(bulkYear, bulkMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      // Category colors matching Daily tab
      const categoryColors = {
        prayers: '#4A90A4',  // teal
        glucose: '#6B8E5A', // green
        whoop: '#7C6B8E',   // purple
        family: '#C4943D',  // amber
        habits: '#6B7280'   // slate
      };

      const categories = {
        prayers: { label: 'üïå Prayers', fields: ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha', 'quran'], headers: ['F', 'D', 'A', 'M', 'I', 'Q'] },
        glucose: { label: 'üíâ Glucose', fields: ['avg', 'tir', 'insulin'], headers: ['Avg', 'TIR', 'Insulin'] },
        whoop: { label: '‚è±Ô∏è Whoop', fields: ['sleepPerf', 'recovery', 'strain'], headers: ['Sleep%', 'Rec', 'Strain'] },
        family: { label: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family', fields: ['mom', 'dad', 'jana', 'tia', 'ahmed', 'eman'], headers: ['Mom', 'Dad', 'Jana', 'Tia', 'Ahmed', 'Eman'] },
        habits: { label: '‚ú® Habits', fields: ['exercise', 'reading', 'meditation', 'water', 'vitamins', 'brushTeeth', 'nop'], headers: ['üèãÔ∏è', 'üìö', 'üßò', 'üíß', 'üíä', 'ü¶∑', 'üí§'] }
      };

      const cat = categories[bulkCategory];

      // Generate month options (2026 and 2027)
      let monthOptions = '';
      [2026, 2027].forEach(function(year) {
        for (let m = 0; m < 12; m++) {
          const label = new Date(year, m).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          const selected = m === bulkMonth && year === bulkYear ? 'selected' : '';
          monthOptions += '<option value="' + m + '-' + year + '" ' + selected + '>' + label + '</option>';
        }
      });

      // Build the table rows
      let tableRows = '';
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = bulkYear + '-' + String(bulkMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        const dayData = allData[dateStr] || JSON.parse(JSON.stringify(defaultDayData));
        const dayOfWeek = new Date(bulkYear, bulkMonth, day).toLocaleDateString('en-US', { weekday: 'short' });
        const isWeekend = [0, 6].includes(new Date(bulkYear, bulkMonth, day).getDay());
        const isToday = dateStr === getLocalDateString();
        const scores = calculateScores(dayData);

        let cells = '';
        cat.fields.forEach(field => {
          const value = dayData[bulkCategory][field];

          if (bulkCategory === 'family' || (bulkCategory === 'habits' && field === 'vitamins')) {
            const checked = value ? 'checked' : '';
            cells += '<td class="border border-softborder px-1 py-1 text-center">' +
              '<input type="checkbox" ' + checked +
              ' class="w-5 h-5 rounded border-softborder text-coral focus:ring-coral cursor-pointer"' +
              ' onchange="updateBulkData(\'' + dateStr + '\', \'' + bulkCategory + '\', \'' + field + '\', this.checked ? \'1\' : \'\')">' +
              '</td>';
          } else if (bulkCategory === 'prayers' && field !== 'quran') {
            cells += '<td class="border border-softborder px-1 py-1">' +
              '<input type="text" value="' + (value || '') + '" placeholder="X.Y"' +
              ' class="w-full px-1 py-1 text-center text-sm font-mono border-0 focus:ring-2 focus:ring-coral rounded bg-white"' +
              ' onchange="updateBulkData(\'' + dateStr + '\', \'' + bulkCategory + '\', \'' + field + '\', this.value)">' +
              '</td>';
          } else {
            cells += '<td class="border border-softborder px-1 py-1">' +
              '<input type="number" step="any" value="' + (value || '') + '"' +
              ' class="w-full px-1 py-1 text-center text-sm border-0 focus:ring-2 focus:ring-coral rounded bg-white"' +
              ' onchange="updateBulkData(\'' + dateStr + '\', \'' + bulkCategory + '\', \'' + field + '\', this.value)">' +
              '</td>';
          }
        });

        const rowClass = (isWeekend ? 'bg-warmgray/50 ' : '') + (isToday ? 'bg-coral/10 ' : '') + 'hover:bg-warmgray';
        const dayCellClass = 'border border-softborder px-2 py-1 font-medium text-center text-charcoal sticky left-0 z-10 ' + (isToday ? 'bg-coral/20' : 'bg-white');
        const weekdayCellClass = 'border border-softborder px-2 py-1 text-xs text-charcoal/50 text-center sticky left-10 z-10 ' + (isToday ? 'bg-coral/20' : 'bg-white');

        tableRows += '<tr class="' + rowClass + '">' +
          '<td class="' + dayCellClass + '">' + day + '</td>' +
          '<td class="' + weekdayCellClass + '">' + dayOfWeek + '</td>' +
          cells +
          '<td id="score-' + dateStr + '" class="border border-softborder px-2 py-1 text-center font-semibold text-coral">' + fmt(scores.total) + '</td>' +
          '</tr>';
      }

      // Category buttons with section colors
      let catButtons = '';
      Object.entries(categories).forEach(function([key, val]) {
        const color = categoryColors[key];
        const btnClass = bulkCategory === key
          ? 'text-white'
          : 'bg-warmgray hover:bg-softborder text-charcoal';
        const btnStyle = bulkCategory === key ? 'background-color: ' + color : '';
        catButtons += '<button onclick="setBulkCategory(\'' + key + '\')" class="px-3 py-2 rounded-lg text-sm font-medium transition ' + btnClass + '" style="' + btnStyle + '">' + val.label + '</button>';
      });

      // Header cells with category color
      const catColor = categoryColors[bulkCategory];
      let headerCells = '';
      cat.headers.forEach(function(h) {
        headerCells += '<th class="border px-3 py-3 font-medium" style="border-color: ' + catColor + '">' + h + '</th>';
      });

      // Calculate summary stats
      let totalScore = 0, daysWithData = 0;
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = bulkYear + '-' + String(bulkMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        if (allData[dateStr]) {
          daysWithData++;
          totalScore += calculateScores(allData[dateStr]).total;
        }
      }
      const avgScore = daysWithData > 0 ? Math.round(totalScore / daysWithData) : 0;
      const completionRate = Math.round((daysWithData / daysInMonth) * 100);

      const prayerHint = bulkCategory === 'prayers' ? '<span class="ml-2 text-charcoal/70">‚Ä¢ Use X.Y format: e.g., 1 = on-time, 0.1 = late, 1.2 = 1 on-time + 2 late</span>' : '';
      const familyHint = bulkCategory === 'family' ? '<span class="ml-2 text-charcoal/70">‚Ä¢ Check box if you connected with that person</span>' : '';

      return '<div class="space-y-4">' +
        // Controls card
        '<div class="sb-card rounded-lg overflow-hidden">' +
          '<div class="px-5 py-3 bg-warmgray" style="border-bottom: 3px solid ' + getAccentColor() + '">' +
            '<h3 class="font-semibold text-charcoal">üìÖ Bulk Entry</h3>' +
          '</div>' +
          '<div class="p-5 bg-white">' +
            '<div class="flex flex-wrap items-center gap-4">' +
              '<div>' +
                '<label class="text-sm text-charcoal/60 block mb-1">Month</label>' +
                '<select onchange="const [m,y] = this.value.split(\'-\'); setBulkMonth(m, y)" class="px-3 py-2 border border-softborder rounded-lg focus:ring-2 focus:ring-coral outline-none bg-white text-charcoal">' +
                  monthOptions +
                '</select>' +
              '</div>' +
              '<div>' +
                '<label class="text-sm text-charcoal/60 block mb-1">Area</label>' +
                '<div class="flex gap-1 flex-wrap">' + catButtons + '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        // Info hint
        '<div class="rounded-lg p-3 text-sm" style="background-color: ' + catColor + '15; border-left: 3px solid ' + catColor + '">' +
          '<strong class="text-charcoal">' + monthName + '</strong> <span class="text-charcoal/70">' + cat.label + '</span>' + prayerHint + familyHint +
        '</div>' +
        // Data table
        '<div class="sb-card rounded-lg overflow-hidden">' +
          '<div class="overflow-x-auto">' +
            '<table class="w-full text-sm">' +
              '<thead>' +
                '<tr class="text-white" style="background-color: ' + catColor + '">' +
                  '<th class="border px-2 py-3 sticky left-0 z-20" style="border-color: ' + catColor + '; background-color: ' + catColor + '">Day</th>' +
                  '<th class="border px-2 py-3 sticky left-10 z-20" style="border-color: ' + catColor + '; background-color: ' + catColor + '"></th>' +
                  headerCells +
                  '<th class="border px-3 py-3 font-medium" style="border-color: ' + catColor + '">Score</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' + tableRows + '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>' +
        // Summary card
        '<div class="sb-card rounded-lg overflow-hidden">' +
          '<div class="px-5 py-3 bg-warmgray" style="border-bottom: 3px solid ' + getAccentColor() + '">' +
            '<h3 class="font-semibold text-charcoal flex items-center gap-2">' + THINGS3_ICONS.lifeScore + ' ' + monthName + ' Summary</h3>' +
          '</div>' +
          '<div class="p-5 bg-white">' +
            '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-days-logged" class="text-2xl font-bold text-charcoal">' + fmt(daysWithData) + '</div>' +
                '<div class="text-xs text-charcoal/60">Days Logged</div>' +
              '</div>' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-total-score" class="text-2xl font-bold text-coral">' + fmt(totalScore) + '</div>' +
                '<div class="text-xs text-charcoal/60">Total Score</div>' +
              '</div>' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-avg-score" class="text-2xl font-bold text-charcoal">' + fmt(avgScore) + '</div>' +
                '<div class="text-xs text-charcoal/60">Avg Daily Score</div>' +
              '</div>' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-completion" class="text-2xl font-bold text-charcoal">' + completionRate + '%</div>' +
                '<div class="text-xs text-charcoal/60">Completion Rate</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function createWeightInput(label, value, category, field = null) {
      return `
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <span class="text-sm text-gray-700">${label}</span>
          <input type="number" step="1" value="${value}"
            class="w-20 px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-blue-500 outline-none"
            onchange="updateWeight('${category}', ${field ? `'${field}'` : 'null'}, this.value)">
        </div>
      `;
    }

    function renderSettingsTab() {
      return `
        <div class="space-y-8">
          <div class="sb-card rounded-lg p-6 bg-white">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold text-charcoal">Scoring Weights <span class="text-coral">‚Üí</span></h3>
              <button onclick="resetWeights()" class="px-4 py-2 bg-coral/10 text-coral rounded text-sm font-medium hover:bg-coral/20 transition">
                Reset to Defaults
              </button>
            </div>
            <p class="text-sm text-charcoal/50 mb-6">Adjust the point values for each activity. Changes apply immediately.</p>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- 1. Prayer Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">üïå Prayer</h4>
                ${createWeightInput('On-time prayer', WEIGHTS.prayer.onTime, 'prayer', 'onTime')}
                ${createWeightInput('Late prayer', WEIGHTS.prayer.late, 'prayer', 'late')}
                ${createWeightInput('Quran (per page)', WEIGHTS.prayer.quran, 'prayer', 'quran')}
              </div>

              <!-- 2. Diabetes Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">üíâ Glucose (Libre)</h4>
                ${createWeightInput('Avg Glucose max pts (at 105)', WEIGHTS.glucose.avgMax, 'glucose', 'avgMax')}
                ${createWeightInput('TIR pts per %', WEIGHTS.glucose.tirPerPoint, 'glucose', 'tirPerPoint')}
                ${createWeightInput('Insulin threshold (units)', WEIGHTS.glucose.insulinThreshold, 'glucose', 'insulinThreshold')}
                ${createWeightInput('Insulin ‚â§threshold bonus', WEIGHTS.glucose.insulinBase, 'glucose', 'insulinBase')}
                ${createWeightInput('Insulin >threshold penalty', WEIGHTS.glucose.insulinPenalty, 'glucose', 'insulinPenalty')}
              </div>

              <!-- 3. Whoop Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">‚è±Ô∏è Whoop</h4>
                <div class="text-xs text-coral font-medium mb-2">Sleep Performance</div>
                ${createWeightInput('Sleep Perf ‚â•90%', WEIGHTS.whoop.sleepPerfHigh, 'whoop', 'sleepPerfHigh')}
                ${createWeightInput('Sleep Perf 70-90%', WEIGHTS.whoop.sleepPerfMid, 'whoop', 'sleepPerfMid')}
                ${createWeightInput('Sleep Perf 50-70%', WEIGHTS.whoop.sleepPerfLow, 'whoop', 'sleepPerfLow')}
                <div class="text-xs text-coral font-medium mb-2 mt-3">Recovery & Strain</div>
                ${createWeightInput('Recovery ‚â•66%', WEIGHTS.whoop.recoveryHigh, 'whoop', 'recoveryHigh')}
                ${createWeightInput('Recovery 50-66%', WEIGHTS.whoop.recoveryMid, 'whoop', 'recoveryMid')}
                ${createWeightInput('Recovery 33-50%', WEIGHTS.whoop.recoveryLow, 'whoop', 'recoveryLow')}
                ${createWeightInput('Strain matches recovery', WEIGHTS.whoop.strainMatch, 'whoop', 'strainMatch')}
                ${createWeightInput('High strain on green day', WEIGHTS.whoop.strainHigh, 'whoop', 'strainHigh')}
              </div>

              <!-- 4. Family Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</h4>
                ${createWeightInput('Mom', WEIGHTS.family.mom, 'family', 'mom')}
                ${createWeightInput('Dad', WEIGHTS.family.dad, 'family', 'dad')}
                ${createWeightInput('Jana', WEIGHTS.family.jana, 'family', 'jana')}
                ${createWeightInput('Tia', WEIGHTS.family.tia, 'family', 'tia')}
                ${createWeightInput('Ahmed', WEIGHTS.family.ahmed, 'family', 'ahmed')}
                ${createWeightInput('Eman', WEIGHTS.family.eman, 'family', 'eman')}
              </div>

              <!-- 5. Habits Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">‚ú® Habits</h4>
                ${createWeightInput('Exercise', WEIGHTS.habits.exercise, 'habits', 'exercise')}
                ${createWeightInput('Reading', WEIGHTS.habits.reading, 'habits', 'reading')}
                ${createWeightInput('Meditation', WEIGHTS.habits.meditation, 'habits', 'meditation')}
                ${createWeightInput('Water (per L)', WEIGHTS.habits.water, 'habits', 'water')}
                ${createWeightInput('Vitamins', WEIGHTS.habits.vitamins, 'habits', 'vitamins')}
                ${createWeightInput('Brush Teeth', WEIGHTS.habits.brushTeeth, 'habits', 'brushTeeth')}
                ${createWeightInput('NoP = 1 (bonus)', WEIGHTS.habits.nopYes, 'habits', 'nopYes')}
                ${createWeightInput('NoP = 0 (penalty)', WEIGHTS.habits.nopNo, 'habits', 'nopNo')}
              </div>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold text-charcoal">Perfect Day Targets <span class="text-coral">‚Üí</span></h3>
              <button onclick="resetMaxScores()" class="px-4 py-2 bg-coral/10 text-coral rounded text-sm font-medium hover:bg-coral/20 transition">
                Reset to Defaults
              </button>
            </div>
            <p class="text-sm text-charcoal/50 mb-6">Define what a "perfect day" looks like for each category. Progress bars show % of these targets.</p>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.prayer}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('prayer', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Prayer</div>
                <div class="text-xs text-charcoal/40">5√ó5 + quran</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.diabetes}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('diabetes', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Diabetes</div>
                <div class="text-xs text-charcoal/40">avg+tir+ins</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.whoop}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('whoop', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Whoop</div>
                <div class="text-xs text-charcoal/40">all optimal</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.family}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('family', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Family</div>
                <div class="text-xs text-charcoal/40">all checked</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.habits}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('habits', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Habits</div>
                <div class="text-xs text-charcoal/40">all done</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.total}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1 border-coral"
                  onchange="updateMaxScore('total', this.value)">
                <div class="text-xs font-medium text-coral">Total</div>
                <div class="text-xs text-charcoal/40">sum of all</div>
              </div>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Theme <span class="text-coral">‚Üí</span></h3>
            <p class="text-sm text-charcoal/50 mb-4">Choose your preferred visual style. Changes apply immediately.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              ${Object.entries(THEMES).map(([key, theme]) => `
                <button onclick="setTheme('${key}')"
                  class="p-4 rounded-lg border-2 text-left transition-all ${getTheme() === key ? 'border-coral bg-coral/5' : 'border-softborder hover:border-coral/50'}">
                  <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold text-charcoal">${theme.name}</span>
                    ${getTheme() === key ? '<span class="text-xs bg-coral text-white px-2 py-0.5 rounded-full">Active</span>' : ''}
                  </div>
                  <p class="text-sm text-charcoal/50">${theme.description}</p>
                  <div class="flex gap-2 mt-3">
                    ${key === 'simplebits' ? `
                      <div class="w-6 h-6 rounded-full bg-[#F7F6F4] border border-gray-300" title="Background"></div>
                      <div class="w-6 h-6 rounded-full bg-[#EFEDE8] border border-gray-300" title="Card"></div>
                      <div class="w-6 h-6 rounded-full bg-[#E5533D]" title="Accent"></div>
                      <div class="w-6 h-6 rounded-full bg-[#1a1a1a]" title="Text"></div>
                    ` : `
                      <div class="w-6 h-6 rounded-full bg-[#FFFFFF] border border-gray-300" title="Background"></div>
                      <div class="w-6 h-6 rounded-full bg-[#F5F5F7] border border-gray-300" title="Card"></div>
                      <div class="w-6 h-6 rounded-full bg-[#4A90D9]" title="Accent"></div>
                      <div class="w-6 h-6 rounded-full bg-[#1D1D1F]" title="Text"></div>
                    `}
                  </div>
                </button>
              `).join('')}
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Cloud Sync <span class="text-coral">‚Üí</span></h3>
            <p class="text-sm text-charcoal/50 mb-4">Enable automatic sync to GitHub. Your data will be saved to the cloud on every change.</p>

            <div class="mb-4">
              <label class="text-sm text-charcoal/70 block mb-2">GitHub Personal Access Token</label>
              <div class="flex gap-2">
                <input type="password" id="github-token-input" value="${getGithubToken()}"
                  placeholder="ghp_xxxx or github_pat_xxxx"
                  class="flex-1 px-3 py-2 border border-softborder rounded text-sm bg-white focus:border-coral focus:outline-none">
                <button onclick="setGithubToken(document.getElementById('github-token-input').value)"
                  class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  Save Token
                </button>
              </div>
              <p class="text-xs text-charcoal/40 mt-2">
                Token needs <code class="bg-warmgray px-1 rounded">repo</code> scope. Create at
                <a href="https://github.com/settings/tokens" target="_blank" class="sb-link">github.com/settings/tokens</a>
              </p>
            </div>

            <div class="flex flex-wrap gap-3 pt-4 border-t border-softborder">
              <button onclick="saveToGithub()" class="px-4 py-2 bg-coral text-white rounded text-sm font-medium hover:bg-coralDark transition ${getGithubToken() ? '' : 'opacity-50 cursor-not-allowed'}" ${getGithubToken() ? '' : 'disabled'}>
                Sync Now
              </button>
              <button onclick="loadCloudData().then(() => render())" class="px-4 py-2 bg-warmgray text-charcoal rounded text-sm font-medium hover:bg-softborder transition">
                Pull from Cloud
              </button>
              <span class="flex items-center text-xs text-charcoal/50">
                ${getGithubToken() ? '<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Connected' : '<span class="w-2 h-2 rounded-full bg-charcoal/30 mr-2"></span> Not connected'}
              </span>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Data Management <span class="text-coral">‚Üí</span></h3>
            <div class="flex flex-wrap gap-3">
              <button onclick="exportData()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                Export All Data
              </button>
              <label class="sb-btn px-4 py-2 rounded text-sm font-medium cursor-pointer">
                Import Data
                <input type="file" accept=".json" class="hidden" onchange="importData(event)">
              </label>
            </div>
            <p class="text-xs text-charcoal/40 mt-3">
              Export creates a local backup JSON file. Import merges data from a backup file.
            </p>
          </div>

          <!-- Changelog -->
          <div class="sb-card rounded-xl p-6 bg-white">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h3 class="font-semibold text-charcoal">Changelog <span class="text-coral">‚Üí</span></h3>
                <p class="text-sm text-charcoal/50 mt-1">Version history and updates</p>
              </div>
              <span class="px-3 py-1 bg-coral text-white text-sm font-semibold rounded-full">v3.2.0</span>
            </div>

            <div class="space-y-6">
              <!-- v3.2.0 -->
              <div class="border-l-2 border-coral pl-4">
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-semibold text-charcoal">v3.2.0</span>
                  <span class="text-xs text-charcoal/40">February 2026</span>
                  <span class="px-2 py-0.5 bg-green-100 text-green-700 text-[11px] font-medium rounded">Latest</span>
                </div>
                <ul class="text-sm text-charcoal/70 space-y-1.5">
                  <li class="flex items-start gap-2"><span class="text-coral mt-0.5">‚Ä¢</span> Mobile-responsive design for iPhone Pro Max</li>
                  <li class="flex items-start gap-2"><span class="text-coral mt-0.5">‚Ä¢</span> Redesigned sidebar with improved alignment & spacing</li>
                  <li class="flex items-start gap-2"><span class="text-coral mt-0.5">‚Ä¢</span> Minimal drag indicator on right side of tasks</li>
                  <li class="flex items-start gap-2"><span class="text-coral mt-0.5">‚Ä¢</span> Cleaner task item design with icon-based actions</li>
                  <li class="flex items-start gap-2"><span class="text-coral mt-0.5">‚Ä¢</span> Header/nav/body width consistency across all tabs</li>
                </ul>
              </div>

              <!-- v3.1.0 -->
              <div class="border-l-2 border-charcoal/20 pl-4">
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-semibold text-charcoal">v3.1.0</span>
                  <span class="text-xs text-charcoal/40">January 2026</span>
                </div>
                <ul class="text-sm text-charcoal/70 space-y-1.5">
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Things 3 exact icons and colors</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Inter font (closest to SF Pro)</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> View state persistence (stays on same page after refresh)</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Renamed Categories to Areas (Things 3 terminology)</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Plus icon buttons instead of "Add" text</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Colored sidebar perspective icons</li>
                </ul>
              </div>

              <!-- v3.0.0 -->
              <div class="border-l-2 border-charcoal/20 pl-4">
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-semibold text-charcoal">v3.0.0</span>
                  <span class="text-xs text-charcoal/40">December 2025</span>
                </div>
                <ul class="text-sm text-charcoal/70 space-y-1.5">
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Complete UI overhaul with Things 3 theme</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Theme switcher (SimpleBits / Things 3)</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Tasks system with perspectives, areas, and labels</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Drag and drop task reordering</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> GitHub cloud sync</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Dashboard with charts and analytics</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Bulk entry tab for quick data input</li>
                </ul>
              </div>

              <!-- v2.0.0 -->
              <div class="border-l-2 border-charcoal/20 pl-4">
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-semibold text-charcoal">v2.0.0</span>
                  <span class="text-xs text-charcoal/40">November 2025</span>
                </div>
                <ul class="text-sm text-charcoal/70 space-y-1.5">
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Gamification system with points and scoring</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Customizable weight settings</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Prayer, glucose, whoop, family, habits tracking</li>
                </ul>
              </div>

              <!-- v1.0.0 -->
              <div class="border-l-2 border-charcoal/20 pl-4">
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-semibold text-charcoal">v1.0.0</span>
                  <span class="text-xs text-charcoal/40">October 2025</span>
                </div>
                <ul class="text-sm text-charcoal/70 space-y-1.5">
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Initial release</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Basic daily tracking interface</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">‚Ä¢</span> Local storage persistence</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ============ TASKS TAB RENDERING ============
    function renderTasksTab() {
      const allPerspectives = [...BUILTIN_PERSPECTIVES, ...customPerspectives];
      const filteredTasks = getCurrentFilteredTasks();
      const viewInfo = getCurrentViewInfo();

      // Count tasks per perspective
      const taskCounts = {};
      const todayDate = getLocalDateString();
      BUILTIN_PERSPECTIVES.forEach(p => {
        if (p.id === 'today') {
          // Today count shows only dated tasks (not Next-tagged tasks)
          taskCounts[p.id] = tasksData.filter(t => {
            if (t.completed) return false;
            const isDueToday = t.dueDate === todayDate;
            const isOverdue = t.dueDate && t.dueDate < todayDate;
            const isScheduledForToday = t.deferDate && t.deferDate <= todayDate;
            return t.status === 'today' || isDueToday || isOverdue || isScheduledForToday;
          }).length;
        } else {
          taskCounts[p.id] = getFilteredTasks(p.id).length;
        }
      });
      // Notes count (separate from task perspectives)
      taskCounts['notes'] = tasksData.filter(t => t.isNote && !t.completed).length;

      customPerspectives.forEach(p => {
        taskCounts[p.id] = getFilteredTasks(p.id).length;
      });

      // Count tasks per category
      const categoryCounts = {};
      taskCategories.forEach(cat => {
        categoryCounts[cat.id] = getTasksByCategory(cat.id).length;
      });

      // Count tasks per label
      const labelCounts = {};
      taskLabels.forEach(label => {
        labelCounts[label.id] = getTasksByLabel(label.id).length;
      });

      // Count tasks per person
      const peopleCounts = {};
      taskPeople.forEach(person => {
        peopleCounts[person.id] = getTasksByPerson(person.id).length;
      });

      // Check if perspective is active
      const isPerspectiveActive = (pId) => activeFilterType === 'perspective' && activePerspective === pId;
      const isCategoryActive = (cId) => activeFilterType === 'category' && activeCategoryFilter === cId;
      const isLabelActive = (lId) => activeFilterType === 'label' && activeLabelFilter === lId;
      const isPersonActive = (pId) => activeFilterType === 'person' && activePersonFilter === pId;

      // Build sidebar
      const sidebarHtml = `
        <div class="w-full md:w-64 flex-shrink-0 space-y-3">
          <!-- Tasks Section -->
          <div class="bg-[var(--modal-bg)] rounded-xl border border-[var(--border)]">
            <div class="px-4 py-2.5 border-b border-[var(--border-light)]">
              <h3 class="font-semibold text-[var(--text-muted)] text-[11px] uppercase tracking-wider">Tasks</h3>
            </div>
            <div class="py-2 px-2">
              ${BUILTIN_PERSPECTIVES.map(p => `
                <button onclick="showPerspectiveTasks('${p.id}')"
                  class="sidebar-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg transition-all ${isPerspectiveActive(p.id) ? 'active bg-[var(--accent-light)]' : 'hover:bg-[var(--bg-secondary)]'}">
                  <span class="w-6 h-6 flex items-center justify-center flex-shrink-0" style="color: ${p.color}">${p.icon}</span>
                  <span class="flex-1 text-[14px] ${isPerspectiveActive(p.id) ? 'font-medium text-[var(--text-primary)]' : 'text-[var(--text-secondary)]'}">${p.name}</span>
                  <span class="count-badge min-w-[20px] text-right text-[12px] ${isPerspectiveActive(p.id) ? 'text-[var(--text-secondary)]' : 'text-[var(--text-muted)]'}">${taskCounts[p.id] || ''}</span>
                </button>
              `).join('')}
            </div>
          </div>

          <!-- Notes Section -->
          <div class="bg-[var(--modal-bg)] rounded-xl border border-[var(--border)]">
            <div class="px-4 py-2.5 border-b border-[var(--border-light)]">
              <h3 class="font-semibold text-[var(--text-muted)] text-[11px] uppercase tracking-wider">Notes</h3>
            </div>
            <div class="py-2 px-2">
              <button onclick="showPerspectiveTasks('notes')"
                class="sidebar-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg transition-all ${isPerspectiveActive('notes') ? 'active bg-[var(--accent-light)]' : 'hover:bg-[var(--bg-secondary)]'}">
                <span class="w-6 h-6 flex items-center justify-center flex-shrink-0" style="color: ${NOTES_PERSPECTIVE.color}">${NOTES_PERSPECTIVE.icon}</span>
                <span class="flex-1 text-[14px] ${isPerspectiveActive('notes') ? 'font-medium text-[var(--text-primary)]' : 'text-[var(--text-secondary)]'}">All Notes</span>
                <span class="count-badge min-w-[20px] text-right text-[12px] ${isPerspectiveActive('notes') ? 'text-[var(--text-secondary)]' : 'text-[var(--text-muted)]'}">${taskCounts['notes'] || ''}</span>
              </button>
            </div>
          </div>

          <!-- Custom Perspectives -->
          <div class="bg-[var(--modal-bg)] rounded-xl border border-[var(--border)]">
            <div class="px-4 py-2.5 flex items-center justify-between border-b border-[var(--border-light)]">
              <h3 class="font-semibold text-[var(--text-muted)] text-[11px] uppercase tracking-wider">Custom Views</h3>
              <button onclick="showPerspectiveModal=true; render()" aria-label="Add new custom view" class="text-[var(--text-muted)] hover:text-[var(--text-primary)] transition p-1.5 -mr-1 rounded-lg hover:bg-[var(--bg-secondary)]">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>
            <div class="py-2 px-2">
              ${customPerspectives.length > 0 ? customPerspectives.map(p => `
                <button onclick="showPerspectiveTasks('${p.id}')"
                  class="sidebar-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg group relative transition-all ${isPerspectiveActive(p.id) ? 'active bg-[var(--accent-light)]' : 'hover:bg-[var(--bg-secondary)]'}">
                  <span class="w-6 h-6 flex items-center justify-center flex-shrink-0 text-lg text-[var(--text-muted)]">${p.icon}</span>
                  <span class="flex-1 text-[14px] ${isPerspectiveActive(p.id) ? 'font-medium text-[var(--text-primary)]' : 'text-[var(--text-secondary)]'}">${escapeHtml(p.name)}</span>
                  <span class="min-w-[20px] text-right text-[12px] group-hover:opacity-0 transition-opacity text-[var(--text-muted)]">${taskCounts[p.id] || ''}</span>
                  <span onclick="event.stopPropagation(); editCustomPerspective('${p.id}')"
                    class="absolute right-3 opacity-0 group-hover:opacity-100 transition-opacity text-[11px] text-[var(--text-muted)] hover:text-[var(--text-primary)] px-2 py-1 rounded-md hover:bg-[var(--bg-secondary)]">Edit</span>
                </button>
              `).join('') : `
                <div class="px-3 py-6 text-center text-[var(--text-muted)] text-[13px]">
                  No custom views yet
                </div>
              `}
            </div>
          </div>

          <!-- Areas -->
          <div class="bg-[var(--modal-bg)] rounded-xl border border-[var(--border)]">
            <div class="px-4 py-2.5 flex items-center justify-between border-b border-[var(--border-light)]">
              <h3 class="font-semibold text-[var(--text-muted)] text-[11px] uppercase tracking-wider">Areas</h3>
              <button onclick="editingCategoryId=null; showCategoryModal=true; render()" aria-label="Add new area" class="text-[var(--text-muted)] hover:text-[var(--text-primary)] transition p-1.5 -mr-1 rounded-lg hover:bg-[var(--bg-secondary)]">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>
            <div class="py-2 px-2">
              ${taskCategories.map(cat => `
                <div onclick="showCategoryTasks('${cat.id}')"
                  onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showCategoryTasks('${cat.id}');}"
                  tabindex="0"
                  role="button"
                  aria-label="View ${escapeHtml(cat.name)} area"
                  class="sidebar-item draggable-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg group relative cursor-pointer select-none transition-all ${isCategoryActive(cat.id) ? 'active bg-[var(--accent-light)]' : 'hover:bg-[var(--bg-secondary)]'}"
                  draggable="true"
                  data-id="${cat.id}"
                  data-type="category">
                  <span class="w-6 h-6 flex items-center justify-center flex-shrink-0 text-[var(--text-muted)]">${THINGS3_ICONS.area}</span>
                  <span class="flex-1 text-[14px] ${isCategoryActive(cat.id) ? 'font-medium text-[var(--text-primary)]' : 'text-[var(--text-secondary)]'}">${escapeHtml(cat.name)}</span>
                  <span class="min-w-[20px] text-right text-[12px] group-hover:opacity-0 transition-opacity text-[var(--text-muted)]">${categoryCounts[cat.id] || ''}</span>
                  <span onclick="event.stopPropagation(); editingCategoryId='${cat.id}'; showCategoryModal=true; render()"
                    class="absolute right-3 opacity-0 group-hover:opacity-100 transition-opacity text-[11px] text-[var(--text-muted)] hover:text-[var(--text-primary)] px-2 py-1 rounded-md hover:bg-[var(--bg-secondary)]">Edit</span>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Tags -->
          <div class="bg-[var(--modal-bg)] rounded-xl border border-[var(--border)]">
            <div class="px-4 py-2.5 flex items-center justify-between border-b border-[var(--border-light)]">
              <h3 class="font-semibold text-[var(--text-muted)] text-[11px] uppercase tracking-wider">Tags</h3>
              <button onclick="editingLabelId=null; showLabelModal=true; render()" aria-label="Add new tag" class="text-[var(--text-muted)] hover:text-[var(--text-primary)] transition p-1.5 -mr-1 rounded-lg hover:bg-[var(--bg-secondary)]">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>
            <div class="py-2 px-2">
              ${taskLabels.map(label => `
                <div onclick="showLabelTasks('${label.id}')"
                  onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showLabelTasks('${label.id}');}"
                  tabindex="0"
                  role="button"
                  aria-label="View ${escapeHtml(label.name)} tag"
                  class="sidebar-item draggable-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg group relative cursor-pointer select-none transition-all ${isLabelActive(label.id) ? 'active bg-[var(--accent-light)]' : 'hover:bg-[var(--bg-secondary)]'}"
                  draggable="true"
                  data-id="${label.id}"
                  data-type="label">
                  <span class="w-6 h-6 flex items-center justify-center flex-shrink-0">
                    <span class="w-3 h-3 rounded-full" style="background-color: ${label.color}"></span>
                  </span>
                  <span class="flex-1 text-[14px] ${isLabelActive(label.id) ? 'font-medium text-[var(--text-primary)]' : 'text-[var(--text-secondary)]'}">${escapeHtml(label.name)}</span>
                  <span class="min-w-[20px] text-right text-[12px] group-hover:opacity-0 transition-opacity text-[var(--text-muted)]">${labelCounts[label.id] || ''}</span>
                  <span onclick="event.stopPropagation(); editingLabelId='${label.id}'; showLabelModal=true; render()"
                    class="absolute right-3 opacity-0 group-hover:opacity-100 transition-opacity text-[11px] text-[var(--text-muted)] hover:text-[var(--text-primary)] px-2 py-1 rounded-md hover:bg-[var(--bg-secondary)]">Edit</span>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- People -->
          <div class="bg-[var(--modal-bg)] rounded-xl border border-[var(--border)]">
            <div class="px-4 py-2.5 flex items-center justify-between border-b border-[var(--border-light)]">
              <h3 class="font-semibold text-[var(--text-muted)] text-[11px] uppercase tracking-wider">People</h3>
              <button onclick="editingPersonId=null; showPersonModal=true; render()" aria-label="Add new person" class="text-[var(--text-muted)] hover:text-[var(--text-primary)] transition p-1.5 -mr-1 rounded-lg hover:bg-[var(--bg-secondary)]">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>
            <div class="py-2 px-2">
              ${taskPeople.map(person => `
                <div onclick="showPersonTasks('${person.id}')"
                  onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showPersonTasks('${person.id}');}"
                  tabindex="0"
                  role="button"
                  aria-label="View tasks for ${escapeHtml(person.name)}"
                  class="sidebar-item draggable-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg group relative cursor-pointer select-none transition-all ${isPersonActive(person.id) ? 'active bg-[var(--accent-light)]' : 'hover:bg-[var(--bg-secondary)]'}"
                  draggable="true"
                  data-id="${person.id}"
                  data-type="person">
                  <span class="w-6 h-6 flex items-center justify-center flex-shrink-0 text-[var(--text-muted)]">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                  </span>
                  <span class="flex-1 text-[14px] ${isPersonActive(person.id) ? 'font-medium text-[var(--text-primary)]' : 'text-[var(--text-secondary)]'}">${escapeHtml(person.name)}</span>
                  <span class="min-w-[20px] text-right text-[12px] group-hover:opacity-0 transition-opacity text-[var(--text-muted)]">${peopleCounts[person.id] || ''}</span>
                  <span onclick="event.stopPropagation(); editingPersonId='${person.id}'; showPersonModal=true; render()"
                    class="absolute right-3 opacity-0 group-hover:opacity-100 transition-opacity text-[11px] text-[var(--text-muted)] hover:text-[var(--text-primary)] px-2 py-1 rounded-md hover:bg-[var(--bg-secondary)]">Edit</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      // Check if viewing an area (category) - render special area view
      const isAreaView = activeFilterType === 'category' && activeCategoryFilter;
      const currentCategory = isAreaView ? getCategoryById(activeCategoryFilter) : null;

      // Build area-specific task list with world-class UI
      const buildAreaTaskListHtml = () => {
        if (!currentCategory) return '';

        const areaTasks = filteredTasks;
        const totalTasks = areaTasks.length;
        const completedTasks = tasksData.filter(t => t.categoryId === activeCategoryFilter && t.completed && !t.isNote).length;
        const activeTasks = areaTasks.filter(t => !t.isNote).length;
        const noteItems = areaTasks.filter(t => t.isNote);
        const taskItems = areaTasks.filter(t => !t.isNote);
        const overdueTasks = taskItems.filter(t => t.dueDate && t.dueDate < todayDate);
        const todayTasks = taskItems.filter(t => t.status === 'today' || t.dueDate === todayDate || (t.deferDate && t.deferDate <= todayDate));
        const upcomingTasks = taskItems.filter(t => t.dueDate && t.dueDate > todayDate && t.status !== 'today' && !(t.deferDate && t.deferDate <= todayDate));
        const anytimeTasks = taskItems.filter(t => t.status === 'anytime' && !t.dueDate && !(t.deferDate && t.deferDate <= todayDate));
        const somedayTasks = taskItems.filter(t => t.status === 'someday');
        const inboxTasks = taskItems.filter(t => t.status === 'inbox');

        const completionRate = activeTasks + completedTasks > 0 ? Math.round((completedTasks / (activeTasks + completedTasks)) * 100) : 0;
        const categoryColor = currentCategory.color || '#6366F1';

        return `
          <div class="flex-1 space-y-6">
            <!-- Area Hero Header -->
            <div class="bg-[var(--bg-card)] rounded-2xl overflow-hidden border border-[var(--border-light)]">
              <div class="relative h-32 flex items-end p-6" style="background: var(--bg-secondary);">
                <div class="absolute top-4 right-4 opacity-10" style="color: ${categoryColor}">
                  <svg class="w-24 h-24" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="18" height="18" rx="4"/></svg>
                </div>
                <div class="flex items-center gap-4 relative z-10">
                  <div class="w-14 h-14 rounded-xl flex items-center justify-center shadow-lg" style="background: ${categoryColor}">
                    <svg class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                  </div>
                  <div>
                    <h1 class="text-2xl font-bold text-charcoal">${currentCategory.name}</h1>
                    <p class="text-charcoal/50 text-sm mt-0.5">${totalTasks} item${totalTasks !== 1 ? 's' : ''} ¬∑ ${completedTasks} completed</p>
                  </div>
                </div>
              </div>

              <!-- Stats Bar -->
              <div class="px-6 py-4 border-t border-charcoal/[0.06] bg-warmgray/30">
                <div class="flex items-center gap-6">
                  <div class="flex items-center gap-3">
                    <div class="relative w-12 h-12">
                      <svg class="w-12 h-12 transform -rotate-90" viewBox="0 0 36 36">
                        <circle cx="18" cy="18" r="16" fill="none" stroke="#E5E7EB" stroke-width="3"/>
                        <circle cx="18" cy="18" r="16" fill="none" stroke="${categoryColor}" stroke-width="3"
                          stroke-dasharray="${completionRate} 100" stroke-linecap="round"/>
                      </svg>
                      <span class="absolute inset-0 flex items-center justify-center text-xs font-bold text-charcoal">${completionRate}%</span>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-charcoal">Progress</div>
                      <div class="text-xs text-charcoal/50">${completedTasks} of ${activeTasks + completedTasks} tasks</div>
                    </div>
                  </div>
                  ${overdueTasks.length > 0 ? `
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-red-50 border border-red-100">
                      <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                      <span class="text-sm font-medium text-red-600">${overdueTasks.length} overdue</span>
                    </div>
                  ` : ''}
                  ${todayTasks.length > 0 ? `
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-amber-50 border border-amber-100">
                      <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7-6.3-4.6-6.3 4.6 2.3-7-6-4.6h7.6z"/></svg>
                      <span class="text-sm font-medium text-amber-600">${todayTasks.length} today</span>
                    </div>
                  ` : ''}
                  <div class="flex-1"></div>
                  <button onclick="openNewTaskModal()"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg text-white text-sm font-medium shadow-sm hover:opacity-90 transition" style="background: ${categoryColor}">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
                    Add Task
                  </button>
                </div>
              </div>
            </div>

            <!-- Quick Add -->
            <div class="bg-[var(--bg-card)] rounded-xl border border-[var(--border-light)] px-4 py-3">
              <div class="flex items-center gap-3">
                <div class="w-5 h-5 rounded-full border-2 border-dashed flex-shrink-0" style="border-color: ${categoryColor}40"></div>
                <input type="text" id="quick-add-input"
                  placeholder="Quick add to ${currentCategory.name}... (press Enter)"
                  onkeydown="handleQuickAddKeydown(event, this)"
                  class="flex-1 text-[15px] text-charcoal placeholder-charcoal/30 bg-transparent border-0 outline-none focus:ring-0">
                <button onclick="quickAddTask(document.getElementById('quick-add-input'))"
                  class="text-charcoal/30 hover:opacity-70 transition p-1" style="color: ${categoryColor}">
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
              </div>
            </div>

            <!-- Task Sections -->
            <div class="space-y-4">
              ${overdueTasks.length > 0 ? `
                <div class="bg-white rounded-xl border border-red-100 overflow-hidden">
                  <div class="px-4 py-3 bg-red-50 border-b border-red-100 flex items-center gap-2">
                    <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <span class="text-sm font-semibold text-red-700">Overdue</span>
                    <span class="text-xs text-red-400 ml-1">${overdueTasks.length}</span>
                  </div>
                  <div class="task-list">${overdueTasks.map(task => renderTaskItem(task)).join('')}</div>
                </div>
              ` : ''}

              ${todayTasks.length > 0 ? `
                <div class="bg-white rounded-xl border border-charcoal/[0.06] overflow-hidden">
                  <div class="px-4 py-3 bg-amber-50/50 border-b border-charcoal/[0.06] flex items-center gap-2">
                    <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7-6.3-4.6-6.3 4.6 2.3-7-6-4.6h7.6z"/></svg>
                    <span class="text-sm font-semibold text-charcoal">Today</span>
                    <span class="text-xs text-charcoal/40 ml-1">${todayTasks.length}</span>
                  </div>
                  <div class="task-list">${todayTasks.map(task => renderTaskItem(task, false)).join('')}</div>
                  <div class="px-4 py-2 border-t border-charcoal/5">
                    <button onclick="createTask('', { status: 'today', categoryId: '${currentCategory.id}' }); setTimeout(() => { const tasks = tasksData.filter(t => !t.isNote && t.status === 'today' && t.categoryId === '${currentCategory.id}' && !t.completed); if (tasks.length) startInlineEdit(tasks[tasks.length-1].id); }, 100);"
                      class="flex items-center gap-2 px-3 py-2 w-full text-sm text-amber-500 hover:text-amber-600 hover:bg-amber-50/50 rounded-lg transition text-left">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                      Add to Today...
                    </button>
                  </div>
                </div>
              ` : ''}

              ${upcomingTasks.length > 0 ? `
                <div class="bg-white rounded-xl border border-charcoal/[0.06] overflow-hidden">
                  <div class="px-4 py-3 border-b border-charcoal/[0.06] flex items-center gap-2">
                    <svg class="w-4 h-4 text-red-400" fill="currentColor" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg>
                    <span class="text-sm font-semibold text-charcoal">Upcoming</span>
                    <span class="text-xs text-charcoal/40 ml-1">${upcomingTasks.length}</span>
                  </div>
                  <div class="task-list">${upcomingTasks.map(task => renderTaskItem(task)).join('')}</div>
                </div>
              ` : ''}

              ${inboxTasks.length > 0 ? `
                <div class="bg-white rounded-xl border border-charcoal/[0.06] overflow-hidden">
                  <div class="px-4 py-3 border-b border-charcoal/[0.06] flex items-center gap-2">
                    <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h4.18c.26 1.7 1.74 3 3.57 3h2.5c1.83 0 3.31-1.3 3.57-3H21v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6zm0-2l3-7h12l3 7h-4.18c-.26-1.7-1.74-3-3.57-3h-2.5c-1.83 0-3.31 1.3-3.57 3H3z"/></svg>
                    <span class="text-sm font-semibold text-charcoal">Inbox</span>
                    <span class="text-xs text-charcoal/40 ml-1">${inboxTasks.length}</span>
                  </div>
                  <div class="task-list">${inboxTasks.map(task => renderTaskItem(task)).join('')}</div>
                  <div class="px-4 py-2 border-t border-charcoal/5">
                    <button onclick="createTask('', { status: 'inbox', categoryId: '${currentCategory.id}' }); setTimeout(() => { const tasks = tasksData.filter(t => !t.isNote && t.status === 'inbox' && t.categoryId === '${currentCategory.id}' && !t.completed); if (tasks.length) startInlineEdit(tasks[tasks.length-1].id); }, 100);"
                      class="flex items-center gap-2 px-3 py-2 w-full text-sm text-blue-500 hover:text-blue-600 hover:bg-blue-50/50 rounded-lg transition text-left">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                      Add to Inbox...
                    </button>
                  </div>
                </div>
              ` : ''}

              ${anytimeTasks.length > 0 ? `
                <div class="bg-white rounded-xl border border-charcoal/[0.06] overflow-hidden">
                  <div class="px-4 py-3 border-b border-charcoal/[0.06] flex items-center gap-2">
                    <svg class="w-4 h-4 text-teal-500" fill="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="4" rx="2"/><rect x="3" y="10" width="18" height="4" rx="2"/><rect x="3" y="16" width="18" height="4" rx="2"/></svg>
                    <span class="text-sm font-semibold text-charcoal">Anytime</span>
                    <span class="text-xs text-charcoal/40 ml-1">${anytimeTasks.length}</span>
                  </div>
                  <div class="task-list">${anytimeTasks.map(task => renderTaskItem(task)).join('')}</div>
                  <div class="px-4 py-2 border-t border-charcoal/5">
                    <button onclick="createTask('', { status: 'anytime', categoryId: '${currentCategory.id}' }); setTimeout(() => { const tasks = tasksData.filter(t => !t.isNote && t.status === 'anytime' && t.categoryId === '${currentCategory.id}' && !t.completed); if (tasks.length) startInlineEdit(tasks[tasks.length-1].id); }, 100);"
                      class="flex items-center gap-2 px-3 py-2 w-full text-sm text-teal-500 hover:text-teal-600 hover:bg-teal-50/50 rounded-lg transition text-left">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                      Add to Anytime...
                    </button>
                  </div>
                </div>
              ` : ''}

              ${somedayTasks.length > 0 ? `
                <div class="bg-white rounded-xl border border-charcoal/[0.06] overflow-hidden">
                  <div class="px-4 py-3 border-b border-charcoal/[0.06] flex items-center gap-2">
                    <svg class="w-4 h-4 text-amber-600" fill="currentColor" viewBox="0 0 24 24"><path d="M3 3h18v4H3V3zm1 5h16v13a1 1 0 01-1 1H5a1 1 0 01-1-1V8zm5 3v2h6v-2H9z"/></svg>
                    <span class="text-sm font-semibold text-charcoal">Someday</span>
                    <span class="text-xs text-charcoal/40 ml-1">${somedayTasks.length}</span>
                  </div>
                  <div class="task-list">${somedayTasks.map(task => renderTaskItem(task)).join('')}</div>
                  <div class="px-4 py-2 border-t border-charcoal/5">
                    <button onclick="createTask('', { status: 'someday', categoryId: '${currentCategory.id}' }); setTimeout(() => { const tasks = tasksData.filter(t => !t.isNote && t.status === 'someday' && t.categoryId === '${currentCategory.id}' && !t.completed); if (tasks.length) startInlineEdit(tasks[tasks.length-1].id); }, 100);"
                      class="flex items-center gap-2 px-3 py-2 w-full text-sm text-amber-600 hover:text-amber-700 hover:bg-amber-50/50 rounded-lg transition text-left">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                      Add to Someday...
                    </button>
                  </div>
                </div>
              ` : ''}

              <!-- Notes Section (always show) -->
              <div class="bg-white rounded-xl border border-charcoal/[0.06] overflow-hidden">
                <div class="px-4 py-3 border-b border-charcoal/[0.06] flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 24 24"><circle cx="5" cy="6" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="5" cy="18" r="2"/><rect x="10" y="5" width="11" height="2" rx="1"/><rect x="10" y="11" width="11" height="2" rx="1"/><rect x="10" y="17" width="11" height="2" rx="1"/></svg>
                    <span class="text-sm font-semibold text-charcoal">Notes</span>
                    <span class="text-xs text-charcoal/40 ml-1">${noteItems.length}</span>
                  </div>
                  <button onclick="createTask('', { isNote: true, categoryId: '${currentCategory.id}', status: 'anytime' }); setTimeout(() => { const notes = tasksData.filter(t => t.isNote && t.categoryId === '${currentCategory.id}' && !t.completed); if (notes.length) { startInlineEdit(notes[notes.length-1].id); } }, 100);"
                    class="flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium text-purple-600 hover:bg-purple-50 rounded-lg transition">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                    Add Note
                  </button>
                </div>
                ${noteItems.length > 0 ? `
                  <div class="task-list">${noteItems.map(task => renderTaskItem(task)).join('')}</div>
                  <div class="px-4 py-2 border-t border-charcoal/5">
                    <button onclick="createTask('', { isNote: true, categoryId: '${currentCategory.id}', status: 'anytime' }); setTimeout(() => { const notes = tasksData.filter(t => t.isNote && t.categoryId === '${currentCategory.id}' && !t.completed); if (notes.length) { startInlineEdit(notes[notes.length-1].id); } }, 100);"
                      class="flex items-center gap-2 px-3 py-2 w-full text-sm text-purple-400 hover:text-purple-600 hover:bg-purple-50/50 rounded-lg transition text-left">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                      Add another note...
                    </button>
                  </div>
                ` : `
                  <div class="px-4 py-8 text-center">
                    <p class="text-sm text-charcoal/40 mb-3">No notes in this area yet</p>
                    <button onclick="createTask('', { isNote: true, categoryId: '${currentCategory.id}', status: 'anytime' }); setTimeout(() => { const notes = tasksData.filter(t => t.isNote && t.categoryId === '${currentCategory.id}' && !t.completed); if (notes.length) { startInlineEdit(notes[notes.length-1].id); } }, 100);"
                      class="inline-flex items-center gap-2 px-4 py-2 bg-purple-50 text-purple-600 text-sm font-medium rounded-lg hover:bg-purple-100 transition">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                      Create your first note
                    </button>
                  </div>
                `}
              </div>

              ${totalTasks === 0 ? `
                <div class="bg-white rounded-xl border border-charcoal/[0.06] py-16">
                  <div class="flex flex-col items-center justify-center text-charcoal/30">
                    <div class="w-20 h-20 rounded-2xl flex items-center justify-center mb-4" style="background: ${categoryColor}10">
                      <svg class="w-10 h-10" style="color: ${categoryColor}" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                    </div>
                    <p class="text-lg font-medium text-charcoal/50 mb-1">No items yet</p>
                    <p class="text-sm text-charcoal/30 mb-4">Add your first task or note to ${currentCategory.name}</p>
                    <button onclick="openNewTaskModal()"
                      class="flex items-center gap-2 px-4 py-2 rounded-lg text-white text-sm font-medium shadow-sm hover:opacity-90 transition" style="background: ${categoryColor}">
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
                      Add First Item
                    </button>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      };

      // Build task list (default view for non-area views)
      const taskListHtml = isAreaView ? buildAreaTaskListHtml() : `
        <div class="flex-1">
          <div class="bg-[var(--bg-card)] rounded-xl md:border md:border-[var(--border-light)]">
            <div class="px-5 py-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-2xl" ${viewInfo.color ? `style="color: ${viewInfo.color}"` : ''}>${viewInfo.icon}</span>
                <h2 class="text-xl font-semibold text-charcoal">${viewInfo.name}</h2>
              </div>
              <button onclick="openNewTaskModal()"
                class="w-8 h-8 rounded-full bg-[#147EFB] text-white flex items-center justify-center hover:bg-[#0E6AD8] transition shadow-sm" title="${activePerspective === 'notes' ? 'Add Note' : 'Add Task'}">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>

            ${activePerspective !== 'upcoming' ? `
            <!-- Quick Add Input -->
            <div class="px-4 py-3">
              <div class="flex items-center gap-3">
                ${activePerspective === 'notes' ? `
                  <div class="w-2 h-2 rounded-full border-2 border-dashed border-[#8B5CF6]/40 flex-shrink-0 ml-1.5"></div>
                ` : `
                  <div class="w-5 h-5 rounded-full border-2 border-dashed border-charcoal/20 flex-shrink-0"></div>
                `}
                <input type="text" id="quick-add-input"
                  placeholder="${activePerspective === 'notes' ? 'New Note' : 'New To-Do'}"
                  onkeydown="handleQuickAddKeydown(event, this)"
                  class="flex-1 text-[15px] text-charcoal placeholder-charcoal/30 bg-transparent border-0 outline-none focus:ring-0">
                <button onclick="quickAddTask(document.getElementById('quick-add-input'))"
                  class="text-charcoal/30 hover:text-coral transition p-1" title="${activePerspective === 'notes' ? 'Add Note' : 'Add to ' + viewInfo.name}">
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
              </div>
            </div>
            ` : ''}

            <div class="min-h-[400px] task-list">
              ${filteredTasks.length === 0 ? `
                <div class="empty-state flex flex-col items-center justify-center py-20 text-charcoal/30">
                  <div class="w-16 h-16 mb-4 flex items-center justify-center opacity-50">${viewInfo.icon}</div>
                  <p class="text-[15px] font-medium">No tasks in ${viewInfo.name}</p>
                  ${activePerspective === 'inbox' ? '<p class="text-[13px] mt-1 text-charcoal/25">Add a task to get started</p>' : ''}
                </div>
              ` : (activePerspective === 'upcoming' ? `
                <!-- Upcoming view grouped by date -->
                <div class="task-list">
                  ${groupTasksByDate(filteredTasks).map(group => `
                    <div class="date-group mb-6">
                      <div class="px-5 py-2 sticky top-0 bg-[var(--bg-card)]">
                        <span class="text-[13px] font-semibold text-charcoal/50">${group.label}</span>
                      </div>
                      <div>
                        ${group.tasks.map(task => renderTaskItem(task, false)).join('')}
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : (activePerspective === 'logbook' ? `
                <!-- Logbook view grouped by completion date -->
                <div class="task-list">
                  ${groupTasksByCompletionDate(filteredTasks).map(group => `
                    <div class="date-group mb-6">
                      <div class="px-5 py-2 sticky top-0 bg-[var(--bg-card)]">
                        <span class="text-[13px] font-semibold text-charcoal/50">${group.label}</span>
                      </div>
                      <div>
                        ${group.tasks.map(task => renderTaskItem(task, false)).join('')}
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : (activePerspective === 'today' ? (() => {
                // Today view: Split into dated tasks and Next-tagged tasks
                const today = getLocalDateString();
                const nextLabel = taskLabels.find(l => l.name.toLowerCase() === 'next');

                // Dated tasks: tasks with status 'today', due today, overdue, or scheduled for today
                const datedTasks = filteredTasks.filter(t => {
                  const isDueToday = t.dueDate === today;
                  const isOverdue = t.dueDate && t.dueDate < today;
                  const isScheduledForToday = t.deferDate && t.deferDate <= today;
                  return t.status === 'today' || isDueToday || isOverdue || isScheduledForToday;
                });

                // Next tasks: tasks tagged with "next" label (not already in dated)
                const nextTasks = nextLabel ? filteredTasks.filter(t => {
                  const isNextTagged = (t.labels || []).includes(nextLabel.id);
                  const isScheduledForToday = t.deferDate && t.deferDate <= today;
                  const isDatedTask = t.status === 'today' || t.dueDate === today || (t.dueDate && t.dueDate < today) || isScheduledForToday;
                  return isNextTagged && !isDatedTask;
                }) : [];

                return `
                <div class="task-list">
                  ${datedTasks.length > 0 ? `
                    <div class="dated-tasks-section">
                      ${datedTasks.map(task => renderTaskItem(task)).join('')}
                    </div>
                  ` : ''}
                  ${nextTasks.length > 0 ? `
                    <div class="next-tasks-section mt-4">
                      <div class="px-5 py-2 sticky top-0 bg-[var(--bg-card)]">
                        <div class="flex items-center gap-2">
                          <span class="text-[#8B5CF6]">${THINGS3_ICONS.next}</span>
                          <span class="text-[13px] font-semibold text-charcoal/50 uppercase tracking-wider">Next</span>
                          <span class="text-xs text-charcoal/30">${nextTasks.length}</span>
                        </div>
                      </div>
                      ${nextTasks.map(task => renderTaskItem(task)).join('')}
                    </div>
                  ` : ''}
                  ${datedTasks.length === 0 && nextTasks.length === 0 ? `
                    <div class="empty-state flex flex-col items-center justify-center py-20 text-charcoal/30">
                      <div class="w-16 h-16 mb-4 flex items-center justify-center opacity-50">${viewInfo.icon}</div>
                      <p class="text-[15px] font-medium">No tasks in ${viewInfo.name}</p>
                    </div>
                  ` : ''}
                </div>
              `;
              })() : (activePerspective === 'notes' ? `
                <!-- Notes Outliner View -->
                <div class="notes-outliner bg-[var(--bg-card)]">
                  <div class="px-4 py-3 border-b border-charcoal/5">
                    <div class="flex items-center gap-2 text-xs text-charcoal/40">
                      <span>Tab to indent</span>
                      <span>‚Ä¢</span>
                      <span>Shift+Tab to outdent</span>
                      <span>‚Ä¢</span>
                      <span>Enter for new note</span>
                      <span>‚Ä¢</span>
                      <span>Click bullet to collapse</span>
                    </div>
                  </div>
                  <div class="py-2">
                    ${renderNotesOutliner(activeCategoryFilter)}
                    <div class="px-3 py-2">
                      <button onclick="createTask('', { isNote: true, categoryId: activeCategoryFilter, status: 'anytime' }); setTimeout(() => { const notes = tasksData.filter(t => t.isNote && !t.completed); if (notes.length) focusNote(notes[notes.length-1].id); }, 100);"
                        class="flex items-center gap-2 px-3 py-2 w-full text-left text-sm text-purple-400 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                        Add new note
                      </button>
                    </div>
                  </div>
                </div>
              ` : `
                <!-- Regular task list -->
                <div class="task-list">
                  ${filteredTasks.map(task => renderTaskItem(task)).join('')}
                </div>
              `))))}
            </div>
          </div>
        </div>
      `;

      // Task Modal - Enhanced Design
      const editingTask = editingTaskId ? tasksData.find(t => t.id === editingTaskId) : null;
      if (showTaskModal) initModalState(editingTask);
      const taskModalHtml = showTaskModal ? `
        <div class="modal-overlay fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-[300]" onclick="if(event.target===this){showTaskModal=false; editingTaskId=null; render()}" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
          <div class="modal-enhanced w-full max-w-xl mx-4" onclick="event.stopPropagation()">
            <!-- Mobile drag handle -->
            <div class="flex justify-center pt-3 pb-1 md:hidden">
              <div class="w-10 h-1 rounded-full bg-[var(--text-muted)]/30"></div>
            </div>
            <!-- Header -->
            <div class="modal-header-enhanced">
              <div class="flex items-center gap-4">
                <h3 id="task-modal-title" class="text-lg font-semibold text-[var(--text-primary)]">${editingTask ? 'Edit' : 'New'}</h3>
                <div class="type-switcher">
                  <div class="type-option ${!modalIsNote ? 'active' : ''}" data-type="task" onclick="setModalType(false)">
                    <span class="mr-1.5">‚óã</span>Task
                  </div>
                  <div class="type-option ${modalIsNote ? 'active' : ''}" data-type="note" onclick="setModalType(true)">
                    <span class="mr-1.5">‚óâ</span>Note
                  </div>
                </div>
              </div>
              <button onclick="showTaskModal=false; editingTaskId=null; render()" aria-label="Close dialog" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-[var(--bg-secondary)] text-[var(--text-muted)] hover:text-[var(--text-primary)] transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>

            <!-- Body -->
            <div class="modal-body-enhanced">
              <!-- Title -->
              <div class="modal-section">
                <input type="text" id="task-title" value="${editingTask?.title || ''}"
                  placeholder="${modalIsNote ? 'What do you want to capture?' : 'What needs to be done?'}"
                  maxlength="500"
                  onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();saveTaskFromModal();}"
                  class="modal-input-enhanced title-input">
              </div>

              <!-- Notes/Details -->
              <div class="modal-section">
                <label class="modal-section-label">Notes</label>
                <textarea id="task-notes" placeholder="Add details, links, or context..."
                  class="modal-textarea-enhanced">${editingTask?.notes || ''}</textarea>
              </div>

              <!-- When (Status Pills) - Tasks only -->
              ${!modalIsNote ? `
              <div class="modal-section">
                <label class="modal-section-label">When</label>
                <div class="status-pills">
                  <div class="status-pill ${modalSelectedStatus === 'inbox' ? 'selected' : ''}" data-status="inbox" onclick="setModalStatus('inbox')">
                    <span class="status-icon">üì•</span>Inbox
                  </div>
                  <div class="status-pill ${modalSelectedStatus === 'today' ? 'selected' : ''}" data-status="today" onclick="setModalStatus('today')">
                    <span class="status-icon">‚≠ê</span>Today
                  </div>
                  <div class="status-pill ${modalSelectedStatus === 'anytime' ? 'selected' : ''}" data-status="anytime" onclick="setModalStatus('anytime')">
                    <span class="status-icon">üìã</span>Anytime
                  </div>
                  <div class="status-pill ${modalSelectedStatus === 'someday' ? 'selected' : ''}" data-status="someday" onclick="setModalStatus('someday')">
                    <span class="status-icon">üì¶</span>Someday
                  </div>
                </div>
              </div>
              ` : ''}

              <!-- Area (Autocomplete) -->
              <div class="modal-section">
                <label class="modal-section-label">Area</label>
                <div id="area-autocomplete-container"></div>
              </div>

              <!-- Dates - Tasks only -->
              ${!modalIsNote ? `
              <div class="modal-section">
                <label class="modal-section-label">Schedule</label>
                <div class="grid grid-cols-2 gap-4">
                  <div class="date-input-wrapper">
                    <input type="date" id="task-defer" value="${editingTask?.deferDate || ''}"
                      onclick="this.showPicker()" placeholder="Defer until..."
                      class="modal-input-enhanced text-sm">
                    <svg class="date-input-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    <span class="text-[11px] text-[var(--text-muted)] mt-1 block">Start date</span>
                  </div>
                  <div class="date-input-wrapper">
                    <input type="date" id="task-due" value="${editingTask?.dueDate || ''}"
                      onclick="this.showPicker()" placeholder="Due date..."
                      class="modal-input-enhanced text-sm">
                    <svg class="date-input-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span class="text-[11px] text-[var(--text-muted)] mt-1 block">Deadline</span>
                  </div>
                </div>
              </div>

              <!-- Repeat - Tasks only -->
              <div class="modal-section">
                <label class="modal-section-label">Repeat</label>
                <div class="repeat-toggle ${modalRepeatEnabled ? 'active' : ''}" onclick="toggleRepeat()">
                  <svg class="w-5 h-5 ${modalRepeatEnabled ? 'text-[var(--accent)]' : 'text-[var(--text-muted)]'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  <span class="text-sm font-medium ${modalRepeatEnabled ? 'text-[var(--accent)]' : 'text-[var(--text-secondary)]'}">${modalRepeatEnabled ? 'Repeating' : 'Does not repeat'}</span>
                </div>
                <div class="repeat-config ${modalRepeatEnabled ? 'show' : ''}">
                  <div class="flex items-center gap-3">
                    <span class="text-sm text-[var(--text-secondary)]">Every</span>
                    <input type="number" id="task-repeat-interval" min="1" value="${editingTask?.repeat?.interval || 1}"
                      class="w-16 px-3 py-2 border border-[var(--border)] rounded-lg text-sm text-center bg-[var(--bg-input)]">
                    <select id="task-repeat-type" class="px-3 py-2 border border-[var(--border)] rounded-lg text-sm bg-[var(--bg-input)]">
                      <option value="daily" ${editingTask?.repeat?.type === 'daily' ? 'selected' : ''}>days</option>
                      <option value="weekly" ${editingTask?.repeat?.type === 'weekly' ? 'selected' : ''}>weeks</option>
                      <option value="monthly" ${editingTask?.repeat?.type === 'monthly' ? 'selected' : ''}>months</option>
                      <option value="yearly" ${editingTask?.repeat?.type === 'yearly' ? 'selected' : ''}>years</option>
                    </select>
                  </div>
                  <div class="flex gap-4 mt-3">
                    <label class="flex items-center gap-2 cursor-pointer text-sm">
                      <input type="radio" name="repeat-from" value="completion" ${!editingTask?.repeat?.from || editingTask?.repeat?.from === 'completion' ? 'checked' : ''} class="accent-[var(--accent)]">
                      <span class="text-[var(--text-secondary)]">After completion</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-sm">
                      <input type="radio" name="repeat-from" value="due" ${editingTask?.repeat?.from === 'due' ? 'checked' : ''} class="accent-[var(--accent)]">
                      <span class="text-[var(--text-secondary)]">From due date</span>
                    </label>
                  </div>
                </div>
              </div>
              ` : ''}

              <!-- Tags (Autocomplete) -->
              <div class="modal-section">
                <label class="modal-section-label">Tags</label>
                <div id="tags-input-container"></div>
              </div>

              <!-- People (Autocomplete) -->
              <div class="modal-section">
                <label class="modal-section-label">People</label>
                <div id="people-input-container"></div>
              </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer-enhanced">
              <button onclick="showTaskModal=false; editingTaskId=null; render()"
                class="px-5 py-2.5 text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--border-light)] rounded-lg transition">
                Cancel
              </button>
              <button onclick="saveTaskFromModal()" class="sb-btn px-5 py-2.5 rounded-lg text-sm font-medium">
                ${editingTask ? 'Save Changes' : 'Create'}
              </button>
            </div>
          </div>
        </div>
      ` : '';

      // Perspective Modal
      const editingPerspective = editingPerspectiveId ? customPerspectives.find(p => p.id === editingPerspectiveId) : null;
      const perspectiveModalHtml = showPerspectiveModal ? `
        <div class="modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-[300]" onclick="if(event.target===this){showPerspectiveModal=false; editingPerspectiveId=null; render()}" onkeydown="if(event.key==='Escape'){showPerspectiveModal=false; editingPerspectiveId=null; render();}" role="dialog" aria-modal="true" aria-labelledby="perspective-modal-title">
          <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 id="perspective-modal-title" class="font-semibold text-charcoal">${editingPerspective ? 'Edit Custom View' : 'New Custom View'}</h3>
              <button onclick="showPerspectiveModal=false; editingPerspectiveId=null; render()" aria-label="Close dialog" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="perspective-name" placeholder="e.g., Work Projects" autofocus maxlength="100"
                  onkeydown="if(event.key==='Enter'){event.preventDefault();savePerspectiveFromModal();}"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Icon (emoji)</label>
                <input type="text" id="perspective-icon" value="üìå" maxlength="2"
                  class="w-20 px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none text-center text-xl">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Filter by Area</label>
                <select id="perspective-category" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
                  <option value="">Any category</option>
                  ${taskCategories.map(cat => `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Filter by Status</label>
                <select id="perspective-status" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
                  <option value="">Any status</option>
                  <option value="inbox">Inbox</option>
                  <option value="today">Today</option>
                  <option value="anytime">Anytime</option>
                  <option value="someday">Someday</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Filter by Tags</label>
                <div class="border border-softborder rounded p-2 max-h-32 overflow-y-auto space-y-1">
                  ${taskLabels.length > 0 ? taskLabels.map(label => `
                    <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-warmgray cursor-pointer">
                      <input type="checkbox" class="perspective-tag-checkbox rounded border-softborder" value="${label.id}">
                      <span class="w-2 h-2 rounded-full" style="background-color: ${label.color}"></span>
                      <span class="text-sm text-charcoal/80">${escapeHtml(label.name)}</span>
                    </label>
                  `).join('') : '<p class="text-sm text-charcoal/40 text-center py-2">No tags created yet</p>'}
                </div>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="perspective-due" class="rounded border-softborder">
                <label for="perspective-due" class="text-sm text-charcoal/70">Only show tasks with due dates</label>
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-between">
              ${editingPerspective ? `
                <button onclick="if(confirm('Delete this custom view?')){deletePerspective('${editingPerspective.id}'); showPerspectiveModal=false; editingPerspectiveId=null; render();}"
                  class="px-4 py-2 text-sm text-red-500 hover:text-red-700">Delete</button>
              ` : '<div></div>'}
              <div class="flex gap-3">
                <button onclick="showPerspectiveModal=false; editingPerspectiveId=null; render()"
                  class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
                <button onclick="savePerspectiveFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  ${editingPerspective ? 'Save' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      // Category Modal
      const editingCategory = editingCategoryId ? taskCategories.find(c => c.id === editingCategoryId) : null;
      const categoryModalHtml = showCategoryModal ? `
        <div class="modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-[300]" onclick="if(event.target===this){showCategoryModal=false; editingCategoryId=null; render()}" onkeydown="if(event.key==='Escape'){showCategoryModal=false; editingCategoryId=null; render();}" role="dialog" aria-modal="true" aria-labelledby="category-modal-title">
          <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 id="category-modal-title" class="font-semibold text-charcoal">${editingCategory ? 'Edit Area' : 'New Area'}</h3>
              <button onclick="showCategoryModal=false; editingCategoryId=null; render()" aria-label="Close dialog" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="category-name" value="${editingCategory?.name || ''}"
                  placeholder="e.g., Work, Personal, Health" autofocus maxlength="100"
                  onkeydown="if(event.key==='Enter'){event.preventDefault();saveCategoryFromModal();}"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-between">
              ${editingCategory ? `
                <button onclick="if(confirm('Delete this area?')){deleteCategory('${editingCategory.id}'); showCategoryModal=false; editingCategoryId=null; render();}"
                  class="px-4 py-2 text-sm text-red-500 hover:text-red-700">Delete</button>
              ` : '<div></div>'}
              <div class="flex gap-3">
                <button onclick="showCategoryModal=false; editingCategoryId=null; render()"
                  class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
                <button onclick="saveCategoryFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  ${editingCategory ? 'Save' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      // Tag Modal (formerly Label)
      const editingLabel = editingLabelId ? taskLabels.find(l => l.id === editingLabelId) : null;
      const labelModalHtml = showLabelModal ? `
        <div class="modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-[300]" onclick="if(event.target===this){showLabelModal=false; editingLabelId=null; render()}" onkeydown="if(event.key==='Escape'){showLabelModal=false; editingLabelId=null; render();}" role="dialog" aria-modal="true" aria-labelledby="label-modal-title">
          <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 id="label-modal-title" class="font-semibold text-charcoal">${editingLabel ? 'Edit Tag' : 'New Tag'}</h3>
              <button onclick="showLabelModal=false; editingLabelId=null; render()" aria-label="Close dialog" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="label-name" value="${editingLabel?.name || ''}"
                  placeholder="e.g., Important" autofocus maxlength="50"
                  onkeydown="if(event.key==='Enter'){event.preventDefault();saveLabelFromModal();}"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Color</label>
                <input type="color" id="label-color" value="${editingLabel?.color || '#6B7280'}"
                  class="w-full h-10 rounded border border-softborder cursor-pointer">
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-between">
              ${editingLabel ? `
                <button onclick="if(confirm('Delete this tag?')){deleteLabel('${editingLabel.id}'); showLabelModal=false; editingLabelId=null; render();}"
                  class="px-4 py-2 text-sm text-red-500 hover:text-red-700">Delete</button>
              ` : '<div></div>'}
              <div class="flex gap-3">
                <button onclick="showLabelModal=false; editingLabelId=null; render()"
                  class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
                <button onclick="saveLabelFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  ${editingLabel ? 'Save' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      // Person Modal
      const editingPerson = editingPersonId ? taskPeople.find(p => p.id === editingPersonId) : null;
      const personModalHtml = showPersonModal ? `
        <div class="modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-[300]" onclick="if(event.target===this){showPersonModal=false; editingPersonId=null; render()}" onkeydown="if(event.key==='Escape'){showPersonModal=false; editingPersonId=null; render();}" role="dialog" aria-modal="true" aria-labelledby="person-modal-title">
          <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 id="person-modal-title" class="font-semibold text-charcoal">${editingPerson ? 'Edit Person' : 'New Person'}</h3>
              <button onclick="showPersonModal=false; editingPersonId=null; render()" aria-label="Close dialog" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="person-name" value="${editingPerson?.name || ''}"
                  placeholder="e.g., John Doe" autofocus maxlength="100"
                  onkeydown="if(event.key==='Enter'){event.preventDefault();savePersonFromModal();}"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-between">
              ${editingPerson ? `
                <button onclick="if(confirm('Delete this person?')){deletePerson('${editingPerson.id}'); showPersonModal=false; editingPersonId=null; render();}"
                  class="px-4 py-2 text-sm text-red-500 hover:text-red-700">Delete</button>
              ` : '<div></div>'}
              <div class="flex gap-3">
                <button onclick="showPersonModal=false; editingPersonId=null; render()"
                  class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
                <button onclick="savePersonFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  ${editingPerson ? 'Save' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      return `
        <!-- Mobile Sidebar Drawer -->
        <div id="mobile-sidebar-overlay" class="mobile-sidebar-overlay ${mobileDrawerOpen ? 'show' : ''}" onclick="if(event.target===this) closeMobileDrawer()">
          <div class="mobile-sidebar-drawer">
            <div class="p-4 border-b border-[var(--border-light)]">
              <h2 class="text-lg font-bold text-[var(--text-primary)]">Workspace</h2>
            </div>
            ${sidebarHtml.replace('w-full md:w-64', 'w-full')}
          </div>
        </div>

        <div class="flex flex-col md:flex-row gap-6">
          <!-- Desktop sidebar - hidden on mobile -->
          <div class="hidden md:block">
            ${sidebarHtml}
          </div>
          ${taskListHtml}
        </div>
        ${taskModalHtml}
        ${perspectiveModalHtml}
        ${categoryModalHtml}
        ${labelModalHtml}
        ${personModalHtml}
      `;
    }

    // Save category from modal
    function saveCategoryFromModal() {
      const name = document.getElementById('category-name').value.trim();
      if (!name) {
        alert('Please enter an area name');
        return;
      }

      if (editingCategoryId) {
        updateCategory(editingCategoryId, { name });
      } else {
        createCategory(name);
      }
      showCategoryModal = false;
      editingCategoryId = null;
      render();
    }

    // Save label from modal
    function saveLabelFromModal() {
      const name = document.getElementById('label-name').value.trim();
      if (!name) {
        alert('Please enter a tag name');
        return;
      }
      const color = document.getElementById('label-color').value;

      if (editingLabelId) {
        updateLabel(editingLabelId, { name, color });
      } else {
        createLabel(name, color);
      }
      showLabelModal = false;
      editingLabelId = null;
      render();
    }

    // Save person from modal
    function savePersonFromModal() {
      const name = document.getElementById('person-name').value.trim();
      if (!name) {
        alert('Please enter a name');
        return;
      }

      if (editingPersonId) {
        updatePerson(editingPersonId, { name });
      } else {
        createPerson(name);
      }
      showPersonModal = false;
      editingPersonId = null;
      render();
    }

    // ============ AUTOCOMPLETE SYSTEM ============
    let modalSelectedArea = null;
    let modalSelectedStatus = 'inbox';
    let modalSelectedTags = [];
    let modalSelectedPeople = [];
    let modalIsNote = false;
    let modalRepeatEnabled = false;

    function initModalState(editingTask) {
      const today = getLocalDateString();
      if (editingTask) {
        modalSelectedArea = editingTask.categoryId || null;
        // Things 3 logic: If task has deferDate <= today, show as "Today"
        if (editingTask.deferDate && editingTask.deferDate <= today) {
          modalSelectedStatus = 'today';
        } else {
          modalSelectedStatus = editingTask.status || 'inbox';
        }
        modalSelectedTags = [...(editingTask.labels || [])];
        modalSelectedPeople = [...(editingTask.people || [])];
        modalIsNote = editingTask.isNote || false;
        modalRepeatEnabled = editingTask.repeat && editingTask.repeat.type !== 'none';
      } else {
        modalSelectedArea = newTaskContext.categoryId || null;
        modalSelectedStatus = newTaskContext.status || 'inbox';
        modalSelectedTags = newTaskContext.labelIds ? [...newTaskContext.labelIds] : (newTaskContext.labelId ? [newTaskContext.labelId] : []);
        modalSelectedPeople = newTaskContext.personId ? [newTaskContext.personId] : [];
        modalIsNote = activePerspective === 'notes';
        modalRepeatEnabled = false;
      }
    }

    function setupAutocomplete(inputId, dropdownId, items, onSelect, getDisplayFn, getIconFn, allowCreate = false, createFn = null, placeholder = 'Search...') {
      const input = document.getElementById(inputId);
      const dropdown = document.getElementById(dropdownId);
      if (!input || !dropdown) return;

      let highlightedIndex = -1;

      function renderOptions(filter = '') {
        const filtered = items.filter(item =>
          getDisplayFn(item).toLowerCase().includes(filter.toLowerCase())
        );

        if (filtered.length === 0 && !allowCreate) {
          dropdown.innerHTML = '<div class="autocomplete-empty">No matches found</div>';
        } else {
          dropdown.innerHTML = filtered.map((item, idx) => `
            <div class="autocomplete-option ${idx === highlightedIndex ? 'highlighted' : ''}"
                 data-id="${item.id}"
                 onmouseenter="this.classList.add('highlighted'); document.querySelectorAll('#${dropdownId} .autocomplete-option').forEach((o,i) => { if(o !== this) o.classList.remove('highlighted'); })">
              ${getIconFn ? getIconFn(item) : ''}
              <span>${getDisplayFn(item)}</span>
            </div>
          `).join('');

          if (allowCreate && filter.trim() && !filtered.some(i => getDisplayFn(i).toLowerCase() === filter.toLowerCase())) {
            dropdown.innerHTML += `
              <div class="autocomplete-create" data-create="true">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Create "${filter}"
              </div>
            `;
          }
        }

        // Add click handlers
        dropdown.querySelectorAll('.autocomplete-option').forEach(opt => {
          opt.addEventListener('click', () => {
            const item = items.find(i => i.id === opt.dataset.id);
            if (item) {
              onSelect(item);
              dropdown.classList.remove('show');
              input.value = '';
            }
          });
        });

        const createBtn = dropdown.querySelector('.autocomplete-create');
        if (createBtn) {
          createBtn.addEventListener('click', () => {
            if (createFn) {
              createFn(filter.trim());
              dropdown.classList.remove('show');
              input.value = '';
            }
          });
        }
      }

      input.addEventListener('focus', () => {
        renderOptions(input.value);
        dropdown.classList.add('show');
      });

      input.addEventListener('input', () => {
        highlightedIndex = -1;
        renderOptions(input.value);
      });

      input.addEventListener('keydown', (e) => {
        const options = dropdown.querySelectorAll('.autocomplete-option');
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          highlightedIndex = Math.min(highlightedIndex + 1, options.length - 1);
          options.forEach((o, i) => o.classList.toggle('highlighted', i === highlightedIndex));
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          highlightedIndex = Math.max(highlightedIndex - 1, 0);
          options.forEach((o, i) => o.classList.toggle('highlighted', i === highlightedIndex));
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (highlightedIndex >= 0 && options[highlightedIndex]) {
            options[highlightedIndex].click();
          } else if (allowCreate && input.value.trim() && createFn) {
            createFn(input.value.trim());
            dropdown.classList.remove('show');
            input.value = '';
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          e.stopPropagation();
          dropdown.classList.remove('show');
        }
      });

      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove('show');
        }
      });
    }

    function setModalType(isNote) {
      modalIsNote = isNote;
      document.querySelectorAll('.type-option').forEach(opt => {
        opt.classList.toggle('active', (opt.dataset.type === 'note') === isNote);
      });
      // Update title placeholder
      const titleInput = document.getElementById('task-title');
      if (titleInput) {
        titleInput.placeholder = isNote ? 'What do you want to capture?' : 'What needs to be done?';
      }
    }

    function setModalStatus(status) {
      modalSelectedStatus = status;
      document.querySelectorAll('.status-pill').forEach(pill => {
        pill.classList.toggle('selected', pill.dataset.status === status);
      });

      // Things 3 logic: When "Today" is selected, auto-set start date to today
      const deferInput = document.getElementById('task-defer');
      if (status === 'today' && deferInput && !deferInput.value) {
        deferInput.value = getLocalDateString();
      }
    }

    function selectArea(area) {
      modalSelectedArea = area ? area.id : null;
      const display = document.getElementById('area-display');
      if (display) {
        display.innerHTML = area
          ? `<span class="tag-pill" style="background: ${area.color}20; color: ${area.color}">
               ${area.icon || 'üìÅ'} ${escapeHtml(area.name)}
               <span class="tag-pill-remove" onclick="event.stopPropagation(); selectArea(null); renderAreaInput();">
                 <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
               </span>
             </span>`
          : '<span class="text-[var(--text-muted)] text-sm">No area selected</span>';
      }
    }

    function renderAreaInput() {
      const container = document.getElementById('area-autocomplete-container');
      if (!container) return;

      const area = taskCategories.find(c => c.id === modalSelectedArea);

      container.innerHTML = `
        <div id="area-display" class="mb-2" onclick="document.getElementById('area-search').focus()">
          ${area
            ? `<span class="tag-pill" style="background: ${area.color}20; color: ${area.color}">
                 ${area.icon || 'üìÅ'} ${escapeHtml(area.name)}
                 <span class="tag-pill-remove" onclick="event.stopPropagation(); selectArea(null); renderAreaInput();">
                   <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                 </span>
               </span>`
            : '<span class="text-[var(--text-muted)] text-sm">No area selected</span>'}
        </div>
        <div class="autocomplete-container">
          <input type="text" id="area-search" class="autocomplete-input" placeholder="Search areas...">
          <svg class="autocomplete-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <div id="area-dropdown" class="autocomplete-dropdown"></div>
        </div>
      `;

      setupAutocomplete(
        'area-search',
        'area-dropdown',
        taskCategories,
        (item) => { selectArea(item); renderAreaInput(); },
        (item) => item.name,
        (item) => `<div class="autocomplete-option-icon" style="background: ${item.color}20; color: ${item.color}">${item.icon || 'üìÅ'}</div>`,
        true,
        (name) => {
          const newCat = { id: 'cat-' + Date.now(), name, color: '#6366f1', icon: 'üìÅ' };
          taskCategories.push(newCat);
          localStorage.setItem(TASK_CATEGORIES_KEY, JSON.stringify(taskCategories));
          debouncedSaveToGithub();
          selectArea(newCat);
          renderAreaInput();
        }
      );
    }

    function addTag(tag) {
      if (!modalSelectedTags.includes(tag.id)) {
        modalSelectedTags.push(tag.id);
        renderTagsInput();
      }
    }

    function removeTag(tagId) {
      modalSelectedTags = modalSelectedTags.filter(id => id !== tagId);
      renderTagsInput();
    }

    function renderTagsInput() {
      const container = document.getElementById('tags-input-container');
      if (!container) return;

      const selectedTagObjects = modalSelectedTags.map(id => taskLabels.find(l => l.id === id)).filter(Boolean);

      container.innerHTML = `
        <div class="tag-input-container" onclick="document.getElementById('tags-search').focus()">
          ${selectedTagObjects.map(tag => `
            <span class="tag-pill" style="background: ${tag.color}20; color: ${tag.color}">
              ${escapeHtml(tag.name)}
              <span class="tag-pill-remove" onclick="event.stopPropagation(); removeTag('${tag.id}');">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </span>
            </span>
          `).join('')}
          <input type="text" id="tags-search" class="tag-input-field" placeholder="${selectedTagObjects.length ? '' : 'Add tags...'}">
        </div>
        <div id="tags-dropdown" class="autocomplete-dropdown"></div>
      `;

      setupAutocomplete(
        'tags-search',
        'tags-dropdown',
        taskLabels.filter(l => !modalSelectedTags.includes(l.id)),
        (item) => addTag(item),
        (item) => item.name,
        (item) => `<div class="w-3 h-3 rounded-full" style="background: ${item.color}"></div>`,
        true,
        (name) => {
          const colors = ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899'];
          const newTag = { id: 'label-' + Date.now(), name, color: colors[Math.floor(Math.random() * colors.length)] };
          taskLabels.push(newTag);
          localStorage.setItem(TASK_LABELS_KEY, JSON.stringify(taskLabels));
          debouncedSaveToGithub();
          addTag(newTag);
        }
      );
    }

    function addPerson(person) {
      if (!modalSelectedPeople.includes(person.id)) {
        modalSelectedPeople.push(person.id);
        renderPeopleInput();
      }
    }

    function removePerson(personId) {
      modalSelectedPeople = modalSelectedPeople.filter(id => id !== personId);
      renderPeopleInput();
    }

    function renderPeopleInput() {
      const container = document.getElementById('people-input-container');
      if (!container) return;

      const selectedPeopleObjects = modalSelectedPeople.map(id => taskPeople.find(p => p.id === id)).filter(Boolean);

      container.innerHTML = `
        <div class="tag-input-container" onclick="document.getElementById('people-search').focus()">
          ${selectedPeopleObjects.map(person => `
            <span class="tag-pill" style="background: var(--accent-light); color: var(--accent)">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              ${escapeHtml(person.name)}
              <span class="tag-pill-remove" onclick="event.stopPropagation(); removePerson('${person.id}');">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </span>
            </span>
          `).join('')}
          <input type="text" id="people-search" class="tag-input-field" placeholder="${selectedPeopleObjects.length ? '' : 'Add people...'}">
        </div>
        <div id="people-dropdown" class="autocomplete-dropdown"></div>
      `;

      setupAutocomplete(
        'people-search',
        'people-dropdown',
        taskPeople.filter(p => !modalSelectedPeople.includes(p.id)),
        (item) => addPerson(item),
        (item) => item.name,
        () => `<div class="autocomplete-option-icon bg-[var(--bg-secondary)]"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></div>`,
        true,
        (name) => {
          const newPerson = { id: 'person-' + Date.now(), name };
          taskPeople.push(newPerson);
          localStorage.setItem(TASK_PEOPLE_KEY, JSON.stringify(taskPeople));
          debouncedSaveToGithub();
          addPerson(newPerson);
        }
      );
    }

    function toggleRepeat() {
      modalRepeatEnabled = !modalRepeatEnabled;
      const toggle = document.querySelector('.repeat-toggle');
      const config = document.querySelector('.repeat-config');
      if (toggle) toggle.classList.toggle('active', modalRepeatEnabled);
      if (config) config.classList.toggle('show', modalRepeatEnabled);
    }

    function initModalAutocomplete() {
      setTimeout(() => {
        renderAreaInput();
        renderTagsInput();
        renderPeopleInput();

        // Set initial status
        document.querySelectorAll('.status-pill').forEach(pill => {
          pill.classList.toggle('selected', pill.dataset.status === modalSelectedStatus);
        });

        // Set initial type
        document.querySelectorAll('.type-option').forEach(opt => {
          opt.classList.toggle('active', (opt.dataset.type === 'note') === modalIsNote);
        });

        // Focus title
        const titleInput = document.getElementById('task-title');
        if (titleInput) titleInput.focus();
      }, 50);
    }

    // Save task from modal
    function saveTaskFromModal() {
      const title = document.getElementById('task-title').value.trim();
      if (!title) {
        alert('Please enter a title');
        return;
      }

      // Get repeat settings
      let repeat = null;
      if (modalRepeatEnabled) {
        const repeatType = document.getElementById('task-repeat-type')?.value || 'daily';
        const repeatFrom = document.querySelector('input[name="repeat-from"]:checked')?.value || 'completion';
        repeat = {
          type: repeatType,
          interval: parseInt(document.getElementById('task-repeat-interval')?.value) || 1,
          from: repeatFrom
        };
      }

      const today = getLocalDateString();
      let deferDateValue = document.getElementById('task-defer')?.value || null;

      // Things 3 logic: "Today" means task has start date of today
      // If user selected Today but didn't set a date, auto-set deferDate to today
      if (modalSelectedStatus === 'today' && !deferDateValue) {
        deferDateValue = today;
      }

      const taskData = {
        title: title,
        notes: document.getElementById('task-notes')?.value.trim() || '',
        status: modalSelectedStatus, // Keep the status as-is (today, inbox, anytime, someday)
        categoryId: modalSelectedArea,
        deferDate: deferDateValue,
        dueDate: document.getElementById('task-due')?.value || null,
        repeat: repeat,
        labels: modalSelectedTags,
        people: modalSelectedPeople,
        isNote: modalIsNote
      };

      // Things 3 logic: Assigning an Area to an Inbox task moves it to Anytime (not for notes)
      if (!modalIsNote && taskData.status === 'inbox' && taskData.categoryId) {
        taskData.status = 'anytime';
      }

      if (editingTaskId) {
        updateTask(editingTaskId, taskData);
      } else {
        createTask(title, taskData);
      }

      showTaskModal = false;
      editingTaskId = null;
      render();
    }

    // Save perspective from modal
    function savePerspectiveFromModal() {
      const name = document.getElementById('perspective-name').value.trim();
      if (!name) {
        alert('Please enter a perspective name');
        return;
      }

      const icon = document.getElementById('perspective-icon').value || 'üìå';
      const filter = {};

      const categoryId = document.getElementById('perspective-category').value;
      if (categoryId) filter.categoryId = categoryId;

      const status = document.getElementById('perspective-status').value;
      if (status) filter.status = status;

      // Collect selected tags
      const selectedTags = Array.from(document.querySelectorAll('.perspective-tag-checkbox:checked')).map(cb => cb.value);
      if (selectedTags.length > 0) filter.labelIds = selectedTags;

      if (document.getElementById('perspective-due').checked) {
        filter.hasDueDate = true;
      }

      if (editingPerspectiveId) {
        // Update existing perspective
        const idx = customPerspectives.findIndex(p => p.id === editingPerspectiveId);
        if (idx !== -1) {
          customPerspectives[idx] = { ...customPerspectives[idx], name, icon, filter };
          saveTasksData();
        }
        activePerspective = editingPerspectiveId;
      } else {
        createPerspective(name, icon, filter);
        activePerspective = customPerspectives[customPerspectives.length - 1].id;
      }
      showPerspectiveModal = false;
      editingPerspectiveId = null;
      render();
    }

    function exportData() {
      const exportObj = {
        data: allData,
        weights: WEIGHTS,
        tasks: tasksData,
        taskCategories: taskCategories,
        taskLabels: taskLabels,
        customPerspectives: customPerspectives,
        lastUpdated: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'life-gamification-backup-' + getLocalDateString() + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }


    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (imported.data) {
            allData = imported.data;
            saveData();
          }
          if (imported.weights) {
            WEIGHTS = imported.weights;
            saveWeights();
          }
          if (imported.tasks) {
            tasksData = imported.tasks;
            localStorage.setItem(TASKS_KEY, JSON.stringify(tasksData));
          }
          if (imported.taskCategories) {
            taskCategories = imported.taskCategories;
            localStorage.setItem(TASK_CATEGORIES_KEY, JSON.stringify(taskCategories));
          }
          if (imported.taskLabels) {
            taskLabels = imported.taskLabels;
            localStorage.setItem(TASK_LABELS_KEY, JSON.stringify(taskLabels));
          }
          if (imported.customPerspectives) {
            customPerspectives = imported.customPerspectives;
            localStorage.setItem(PERSPECTIVES_KEY, JSON.stringify(customPerspectives));
          }
          alert('Data imported successfully!');
          debouncedSaveToGithub();
          render();
        } catch (err) {
          alert('Error importing data: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // ============ KEYBOARD SHORTCUTS ============
    document.addEventListener('keydown', (e) => {
      // Don't trigger shortcuts when typing in inputs
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
      }

      // Cmd/Ctrl + K: Focus quick add input
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        const quickAddInput = document.getElementById('home-quick-add-input') || document.getElementById('quick-add-input');
        if (quickAddInput) {
          quickAddInput.focus();
        } else if (activeTab !== 'home') {
          switchTab('home');
          setTimeout(() => {
            const input = document.getElementById('home-quick-add-input');
            if (input) input.focus();
          }, 100);
        }
      }

      // Cmd/Ctrl + 1-4: Switch tabs
      if ((e.metaKey || e.ctrlKey) && e.key >= '1' && e.key <= '4') {
        e.preventDefault();
        const tabs = ['home', 'tasks', 'life', 'settings'];
        const tabIndex = parseInt(e.key) - 1;
        if (tabs[tabIndex]) {
          switchTab(tabs[tabIndex]);
        }
      }

      // Escape: Close any open modal (in priority order - most specific first)
      if (e.key === 'Escape') {
        e.preventDefault();
        let modalClosed = false;
        if (showTaskModal) { showTaskModal = false; editingTaskId = null; modalClosed = true; }
        else if (showPerspectiveModal) { showPerspectiveModal = false; editingPerspectiveId = null; modalClosed = true; }
        else if (showCategoryModal) { showCategoryModal = false; editingCategoryId = null; modalClosed = true; }
        else if (showLabelModal) { showLabelModal = false; editingLabelId = null; modalClosed = true; }
        else if (showPersonModal) { showPersonModal = false; editingPersonId = null; modalClosed = true; }
        else if (editingHomeWidgets) { editingHomeWidgets = false; modalClosed = true; }
        if (modalClosed) render();
      }
    });

    // Initialize: load cloud data then render
    loadCloudData().then(() => {
      render();
      initWeather(); // Initialize weather after first render
    }).catch(err => {
      console.error('Initialization error:', err);
      document.getElementById('app').innerHTML = '<div style="padding:20px;color:red;">Error loading app: ' + err.message + '</div>';
    });
  </script>
</body>
</html>
