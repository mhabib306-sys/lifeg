<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life Gamification v3.0</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='10' y='10' width='80' height='80' rx='12' fill='%231a1a1a'/><rect x='24' y='20' width='22' height='22' rx='4' fill='%23F7F6F4'/><rect x='24' y='46' width='22' height='22' rx='4' fill='%23F7F6F4'/><rect x='50' y='46' width='22' height='22' rx='4' fill='%23E5533D'/><rect x='24' y='72' width='22' height='10' rx='3' fill='%23F7F6F4' opacity='0.5'/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cream: '#F7F6F4',
            warmgray: '#EFEDE8',
            charcoal: '#1a1a1a',
            coral: '#E5533D',
            coralDark: '#C4432F',
            softborder: '#E5E3DE'
          },
          fontFamily: {
            sans: ['system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body { font-feature-settings: 'kern' 1, 'liga' 1; }
    .sb-card { background: #EFEDE8; border: 1px solid #E5E3DE; }
    .sb-btn { background: #1a1a1a; color: white; transition: all 0.15s ease; }
    .sb-btn:hover { background: #333; }
    .sb-link { color: #E5533D; text-decoration: underline; text-underline-offset: 2px; }
    .sb-link:hover { color: #C4432F; }
    .sb-section-title {
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 0.75rem;
    }
    input[type="number"], input[type="text"] {
      background: white;
      border: 1px solid #E5E3DE;
    }
    input[type="number"]:focus, input[type="text"]:focus {
      border-color: #E5533D;
      outline: none;
      box-shadow: 0 0 0 2px rgba(229, 83, 61, 0.1);
    }
  </style>
</head>
<body class="min-h-screen bg-cream text-charcoal">
  <div id="app"></div>

  <script>
    const STORAGE_KEY = 'lifeGamificationData_v3';
    const WEIGHTS_KEY = 'lifeGamificationWeights_v1';
    const GITHUB_TOKEN_KEY = 'lifeGamificationGithubToken';
    const DATA_URL = 'data.json';

    // GitHub repo config
    const GITHUB_OWNER = 'mhabib306-sys';
    const GITHUB_REPO = 'lifeg';
    const GITHUB_FILE_PATH = 'data.json';

    // Sync status
    let syncStatus = 'idle'; // 'idle', 'syncing', 'success', 'error'
    let lastSyncTime = null;
    let syncDebounceTimer = null;

    // Get stored GitHub token
    function getGithubToken() {
      return localStorage.getItem(GITHUB_TOKEN_KEY) || '';
    }

    // Save GitHub token
    function setGithubToken(token) {
      localStorage.setItem(GITHUB_TOKEN_KEY, token);
      render();
    }

    // Update sync status in UI
    function updateSyncStatus(status, message = '') {
      syncStatus = status;
      const indicator = document.getElementById('sync-indicator');
      if (indicator) {
        const colors = {
          idle: 'bg-charcoal/30',
          syncing: 'bg-amber-400 animate-pulse',
          success: 'bg-green-500',
          error: 'bg-red-500'
        };
        const icons = {
          idle: '‚òÅÔ∏è',
          syncing: 'üîÑ',
          success: '‚úì',
          error: '‚úó'
        };
        indicator.className = `w-2 h-2 rounded-full ${colors[status]}`;
        indicator.title = message || status;
      }
      if (status === 'success') {
        lastSyncTime = new Date();
        setTimeout(() => {
          if (syncStatus === 'success') updateSyncStatus('idle');
        }, 3000);
      }
    }

    // Save data to GitHub
    async function saveToGithub() {
      const token = getGithubToken();
      if (!token) {
        console.log('‚ö†Ô∏è No GitHub token configured');
        return false;
      }

      updateSyncStatus('syncing', 'Saving to GitHub...');

      try {
        // Get current file SHA (needed for updates)
        const getResponse = await fetch(
          `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
          { headers: { 'Authorization': `token ${token}` } }
        );

        let sha = null;
        if (getResponse.ok) {
          const fileData = await getResponse.json();
          sha = fileData.sha;
        }

        // Prepare data payload
        const payload = {
          lastUpdated: new Date().toISOString(),
          data: allData,
          weights: WEIGHTS,
          maxScores: MAX_SCORES,
          tasks: tasksData,
          taskCategories: taskCategories,
          taskLabels: taskLabels,
          customPerspectives: customPerspectives
        };

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2))));

        // Update file via GitHub API
        const updateResponse = await fetch(
          `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `token ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Auto-save: ${new Date().toLocaleString()}`,
              content: content,
              sha: sha
            })
          }
        );

        if (updateResponse.ok) {
          updateSyncStatus('success', 'Saved to GitHub');
          console.log('‚úÖ Saved to GitHub');
          return true;
        } else {
          const error = await updateResponse.json();
          throw new Error(error.message || 'Failed to save');
        }
      } catch (e) {
        updateSyncStatus('error', `Sync failed: ${e.message}`);
        console.error('‚ùå GitHub save failed:', e);
        return false;
      }
    }

    // Debounced save (waits 2 seconds after last change)
    function debouncedSaveToGithub() {
      if (syncDebounceTimer) clearTimeout(syncDebounceTimer);
      syncDebounceTimer = setTimeout(() => {
        saveToGithub();
      }, 2000);
    }

    // Load cloud data on startup
    async function loadCloudData() {
      const token = getGithubToken();

      try {
        // Try GitHub API first if token exists
        if (token) {
          const response = await fetch(
            `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
            { headers: { 'Authorization': `token ${token}` } }
          );

          if (response.ok) {
            const fileData = await response.json();
            const cloudData = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));

            if (cloudData.data) {
              // Merge cloud data with local
              const localData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
              Object.keys(cloudData.data).forEach(date => {
                if (!localData[date]) {
                  localData[date] = cloudData.data[date];
                }
              });
              localStorage.setItem(STORAGE_KEY, JSON.stringify(localData));
              allData = localData;
            }
            if (cloudData.weights) {
              WEIGHTS = cloudData.weights;
              localStorage.setItem(WEIGHTS_KEY, JSON.stringify(WEIGHTS));
            }
            if (cloudData.maxScores) {
              MAX_SCORES = cloudData.maxScores;
              localStorage.setItem('maxScores', JSON.stringify(MAX_SCORES));
            }
            if (cloudData.tasks) {
              tasksData = cloudData.tasks;
              localStorage.setItem(TASKS_KEY, JSON.stringify(tasksData));
            }
            if (cloudData.taskCategories) {
              taskCategories = cloudData.taskCategories;
              localStorage.setItem(TASK_CATEGORIES_KEY, JSON.stringify(taskCategories));
            }
            if (cloudData.taskLabels) {
              taskLabels = cloudData.taskLabels;
              localStorage.setItem(TASK_LABELS_KEY, JSON.stringify(taskLabels));
            }
            if (cloudData.customPerspectives) {
              customPerspectives = cloudData.customPerspectives;
              localStorage.setItem(PERSPECTIVES_KEY, JSON.stringify(customPerspectives));
            }
            console.log('‚úÖ Loaded from GitHub');
            updateSyncStatus('success', 'Loaded from GitHub');
            return;
          }
        }

        // Fallback to static file fetch
        const response = await fetch(DATA_URL + '?t=' + Date.now());
        if (response.ok) {
          const cloudData = await response.json();
          const localData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

          if (cloudData.data) {
            Object.keys(cloudData.data).forEach(date => {
              if (!localData[date]) {
                localData[date] = cloudData.data[date];
              }
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localData));
            allData = localData;
          }
          if (cloudData.weights) {
            WEIGHTS = cloudData.weights;
            localStorage.setItem(WEIGHTS_KEY, JSON.stringify(WEIGHTS));
          }
          console.log('‚úÖ Cloud data synced (static file)');
        }
      } catch (e) {
        console.log('üì¥ Offline mode - using local data');
      }
    }

    const defaultDayData = {
      prayers: { fajr: '', dhuhr: '', asr: '', maghrib: '', isha: '', quran: 0 },
      glucose: { avg: '', tir: '', insulin: '' },
      whoop: {
        sleepPerf: '', recovery: '', strain: '', whoopAge: ''
      },
      family: { mom: false, dad: false, jana: false, tia: false, ahmed: false, eman: false },
      habits: { exercise: 0, reading: 0, meditation: 0, water: '', vitamins: false, brushTeeth: 0, nop: '' }
    };

    // Consistent scoring framework - base unit = 5 pts
    // Target daily max ~100 pts: Prayer 30, Diabetes 25, Whoop 25, Habits 15, Family 5
    const DEFAULT_WEIGHTS = {
      // PRAYER (max 30): 5 prayers √ó 5 pts + quran bonus
      prayer: { onTime: 5, late: 2, quran: 5 },

      // DIABETES (max 25): avg 10 + tir 10 + insulin 5
      glucose: { avgMax: 10, tirPerPoint: 0.1, insulinBase: 5, insulinPenalty: -5, insulinThreshold: 40 },

      // FAMILY (max 5): 6 members, ~1 pt each, cap at 5
      family: { mom: 1, dad: 1, jana: 1, tia: 1, ahmed: 1, eman: 1 },

      // HABITS (max 15): distributed across daily habits
      habits: { exercise: 3, reading: 2, meditation: 2, water: 1, vitamins: 2, brushTeeth: 1, nopYes: 2, nopNo: -2 },

      // WHOOP (max 14): Sleep Perf + Recovery + Strain
      whoop: {
        sleepPerfHigh: 7, sleepPerfMid: 4, sleepPerfLow: 2,
        recoveryHigh: 2, recoveryMid: 1, recoveryLow: 0,
        strainMatch: 3, strainHigh: 2
      }
    };

    // Load weights and merge with defaults to ensure new keys are always present
    function loadWeights() {
      const saved = JSON.parse(localStorage.getItem(WEIGHTS_KEY));
      if (!saved) return JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
      // Deep merge: ensure all default keys exist
      const merged = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
      Object.keys(merged).forEach(category => {
        if (saved[category]) {
          Object.keys(merged[category]).forEach(key => {
            if (saved[category][key] !== undefined) merged[category][key] = saved[category][key];
          });
        }
      });
      return merged;
    }
    let WEIGHTS = loadWeights();

    // Max scores for progress bars (what a perfect day looks like)
    // These are configurable in settings
    const DEFAULT_MAX_SCORES = {
      prayer: 35,    // 5 prayers on-time (25) + 2 quran pages (10)
      diabetes: 25,  // avg 105 (10) + TIR 100% (10) + insulin ‚â§40 (5)
      whoop: 14,     // sleepPerf(7)+recovery(2)+strain(5)
      family: 6,     // all 6 family members checked
      habits: 16,    // exercise(3)+reading(2)+meditation(2)+water 2.5L(2.5)+vitamins(2)+brush 2x(2)+nop(2)
      total: 96      // sum of all maxes
    };
    const MAX_SCORES_KEY = 'lifeGamificationMaxScores';

    function loadMaxScores() {
      const saved = JSON.parse(localStorage.getItem(MAX_SCORES_KEY));
      if (!saved) return JSON.parse(JSON.stringify(DEFAULT_MAX_SCORES));
      return { ...DEFAULT_MAX_SCORES, ...saved };
    }
    let MAX_SCORES = loadMaxScores();

    function saveMaxScores() {
      localStorage.setItem(MAX_SCORES_KEY, JSON.stringify(MAX_SCORES));
    }

    function saveWeights() {
      localStorage.setItem(WEIGHTS_KEY, JSON.stringify(WEIGHTS));
    }

    function updateWeight(category, field, value) {
      if (field) {
        WEIGHTS[category][field] = parseFloat(value) || 0;
      } else {
        WEIGHTS[category] = parseFloat(value) || 0;
      }
      saveWeights();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function resetWeights() {
      WEIGHTS = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
      saveWeights();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function updateMaxScore(category, value) {
      MAX_SCORES[category] = parseFloat(value) || 0;
      saveMaxScores();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function resetMaxScores() {
      MAX_SCORES = JSON.parse(JSON.stringify(DEFAULT_MAX_SCORES));
      saveMaxScores();
      render();
    }

    // Format numbers with commas for 4+ digits
    function fmt(num) {
      if (num === null || num === undefined || num === '') return '‚Äî';
      const n = typeof num === 'string' ? parseFloat(num) : num;
      if (isNaN(n)) return '‚Äî';
      return n.toLocaleString('en-US');
    }

    // Pre-populated January 2026 data from habits tracking sheet
    const JANUARY_DATA = {"2026-01-01":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":false,"dad":false,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-02":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-03":{"prayers":{"fajr":"1.1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-04":{"prayers":{"fajr":"1.2","dhuhr":"0.1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-05":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"0.1","isha":"1","quran":0},"family":{"mom":false,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-06":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-07":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"1","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":true,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-08":{"prayers":{"fajr":"0.1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-09":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-10":{"prayers":{"fajr":"0.1","dhuhr":"1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-11":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-12":{"prayers":{"fajr":"0.1","dhuhr":"","asr":"0.1","maghrib":"0.1","isha":"1","quran":0},"family":{"mom":false,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-13":{"prayers":{"fajr":"0.1","dhuhr":"","asr":"","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-14":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-15":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-16":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-17":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-18":{"prayers":{"fajr":"1","dhuhr":"1","asr":"0.1","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-19":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-20":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-21":{"prayers":{"fajr":"0.1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-22":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}}};

    // Merge pre-populated data with any existing localStorage data
    let storedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    let allData = { ...JANUARY_DATA, ...storedData };

    // Migration: move NoP from glucose to habits if exists
    let migrated = false;
    Object.keys(allData).forEach(date => {
      const day = allData[date];
      if (day.glucose && day.glucose.nop !== undefined && day.glucose.nop !== '') {
        if (!day.habits) day.habits = {};
        if (day.habits.nop === undefined || day.habits.nop === '') {
          day.habits.nop = day.glucose.nop;
          migrated = true;
        }
        delete day.glucose.nop;
      }
    });
    if (migrated) console.log('‚úÖ Migrated NoP data from glucose to habits');

    // Save merged data
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));

    let currentDate = new Date().toISOString().split('T')[0];
    let activeTab = 'track';
    let weekChart = null;
    let breakdownChart = null;

    // Bulk entry state - default to January 2026 where we have data
    let bulkMonth = 0; // January
    let bulkYear = 2026;
    let bulkCategory = 'prayers';

    // ============ TASKS SYSTEM (Things 3 + OmniFocus style) ============
    const TASKS_KEY = 'lifeGamificationTasks';
    const PERSPECTIVES_KEY = 'lifeGamificationPerspectives';
    const TASK_CATEGORIES_KEY = 'lifeGamificationTaskCategories';
    const TASK_LABELS_KEY = 'lifeGamificationTaskLabels';

    // Default categories
    const DEFAULT_TASK_CATEGORIES = [
      { id: 'personal', name: 'Personal', color: '#4A90A4' },
      { id: 'work', name: 'Work', color: '#6B8E5A' },
      { id: 'health', name: 'Health', color: '#E5533D' },
      { id: 'family', name: 'Family', color: '#C4943D' },
      { id: 'learning', name: 'Learning', color: '#7C6B8E' }
    ];

    // Default labels
    const DEFAULT_TASK_LABELS = [
      { id: 'urgent', name: 'Urgent', color: '#DC2626' },
      { id: 'quick', name: 'Quick Win', color: '#16A34A' },
      { id: 'waiting', name: 'Waiting', color: '#CA8A04' },
      { id: 'blocked', name: 'Blocked', color: '#6B7280' }
    ];

    // Default perspectives (built-in)
    const BUILTIN_PERSPECTIVES = [
      { id: 'inbox', name: 'Inbox', icon: 'üì•', filter: { status: 'inbox' }, builtin: true },
      { id: 'today', name: 'Today', icon: '‚≠ê', filter: { status: 'today' }, builtin: true },
      { id: 'anytime', name: 'Anytime', icon: 'üìã', filter: { status: 'anytime' }, builtin: true },
      { id: 'someday', name: 'Someday', icon: 'üí≠', filter: { status: 'someday' }, builtin: true },
      { id: 'completed', name: 'Completed', icon: '‚úì', filter: { completed: true }, builtin: true }
    ];

    // Load tasks data
    let tasksData = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
    let taskCategories = JSON.parse(localStorage.getItem(TASK_CATEGORIES_KEY) || 'null') || DEFAULT_TASK_CATEGORIES;
    let taskLabels = JSON.parse(localStorage.getItem(TASK_LABELS_KEY) || 'null') || DEFAULT_TASK_LABELS;
    let customPerspectives = JSON.parse(localStorage.getItem(PERSPECTIVES_KEY) || '[]');
    let activePerspective = 'inbox';
    let editingTaskId = null;
    let showTaskModal = false;
    let showPerspectiveModal = false;
    let showCategoryModal = false;
    let showLabelModal = false;
    let editingCategoryId = null;
    let editingLabelId = null;

    // Task helper functions
    function generateTaskId() {
      return 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function saveTasksData() {
      localStorage.setItem(TASKS_KEY, JSON.stringify(tasksData));
      localStorage.setItem(TASK_CATEGORIES_KEY, JSON.stringify(taskCategories));
      localStorage.setItem(TASK_LABELS_KEY, JSON.stringify(taskLabels));
      localStorage.setItem(PERSPECTIVES_KEY, JSON.stringify(customPerspectives));
      debouncedSaveToGithub();
    }

    // Category CRUD
    function createCategory(name, color) {
      const category = {
        id: 'cat_' + Date.now(),
        name: name,
        color: color || '#6B7280'
      };
      taskCategories.push(category);
      saveTasksData();
      return category;
    }

    function updateCategory(categoryId, updates) {
      const idx = taskCategories.findIndex(c => c.id === categoryId);
      if (idx !== -1) {
        taskCategories[idx] = { ...taskCategories[idx], ...updates };
        saveTasksData();
      }
    }

    function deleteCategory(categoryId) {
      taskCategories = taskCategories.filter(c => c.id !== categoryId);
      // Remove category from tasks that use it
      tasksData.forEach(task => {
        if (task.categoryId === categoryId) task.categoryId = null;
      });
      saveTasksData();
    }

    // Label CRUD
    function createLabel(name, color) {
      const label = {
        id: 'label_' + Date.now(),
        name: name,
        color: color || '#6B7280'
      };
      taskLabels.push(label);
      saveTasksData();
      return label;
    }

    function updateLabel(labelId, updates) {
      const idx = taskLabels.findIndex(l => l.id === labelId);
      if (idx !== -1) {
        taskLabels[idx] = { ...taskLabels[idx], ...updates };
        saveTasksData();
      }
    }

    function deleteLabel(labelId) {
      taskLabels = taskLabels.filter(l => l.id !== labelId);
      // Remove label from tasks that use it
      tasksData.forEach(task => {
        task.labels = task.labels.filter(l => l !== labelId);
      });
      saveTasksData();
    }

    function getLabelById(labelId) {
      return taskLabels.find(l => l.id === labelId);
    }

    function createTask(title, options = {}) {
      const task = {
        id: generateTaskId(),
        title: title,
        notes: options.notes || '',
        status: options.status || 'inbox', // inbox, today, anytime, someday
        completed: false,
        completedAt: null,
        categoryId: options.categoryId || null,
        labels: options.labels || [],
        dueDate: options.dueDate || null,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      tasksData.push(task);
      saveTasksData();
      return task;
    }

    function updateTask(taskId, updates) {
      const idx = tasksData.findIndex(t => t.id === taskId);
      if (idx !== -1) {
        tasksData[idx] = { ...tasksData[idx], ...updates, updatedAt: new Date().toISOString() };
        saveTasksData();
      }
    }

    function deleteTask(taskId) {
      tasksData = tasksData.filter(t => t.id !== taskId);
      saveTasksData();
    }

    function toggleTaskComplete(taskId) {
      const task = tasksData.find(t => t.id === taskId);
      if (task) {
        task.completed = !task.completed;
        task.completedAt = task.completed ? new Date().toISOString() : null;
        task.updatedAt = new Date().toISOString();
        saveTasksData();
        render();
      }
    }

    function moveTaskTo(taskId, status) {
      updateTask(taskId, { status: status });
      render();
    }

    function getFilteredTasks(perspectiveId) {
      const allPerspectives = [...BUILTIN_PERSPECTIVES, ...customPerspectives];
      const perspective = allPerspectives.find(p => p.id === perspectiveId);
      if (!perspective) return [];

      const today = new Date().toISOString().split('T')[0];

      return tasksData.filter(task => {
        // Completed perspective shows all completed tasks
        if (perspective.filter.completed) {
          return task.completed;
        }
        // Other perspectives show only non-completed tasks matching the filter
        if (task.completed) return false;

        // Special handling for Today: show tasks with status 'today' OR due today OR overdue
        if (perspectiveId === 'today') {
          const isDueToday = task.dueDate === today;
          const isOverdue = task.dueDate && task.dueDate < today;
          return task.status === 'today' || isDueToday || isOverdue;
        }

        if (perspective.filter.status && task.status !== perspective.filter.status) return false;
        if (perspective.filter.categoryId && task.categoryId !== perspective.filter.categoryId) return false;
        if (perspective.filter.hasLabel && !task.labels.some(l => l === perspective.filter.hasLabel)) return false;
        if (perspective.filter.hasDueDate && !task.dueDate) return false;
        if (perspective.filter.dueSoon) {
          if (!task.dueDate) return false;
          const due = new Date(task.dueDate);
          const now = new Date();
          const diffDays = (due - now) / (1000 * 60 * 60 * 24);
          if (diffDays > 7 || diffDays < 0) return false;
        }
        return true;
      }).sort((a, b) => {
        // Sort by due date first (overdue/today at top), then by creation date
        if (a.dueDate && !b.dueDate) return -1;
        if (!a.dueDate && b.dueDate) return 1;
        if (a.dueDate && b.dueDate && a.dueDate !== b.dueDate) {
          return new Date(a.dueDate) - new Date(b.dueDate);
        }
        if (perspectiveId === 'inbox') return new Date(b.createdAt) - new Date(a.createdAt);
        return new Date(a.createdAt) - new Date(b.createdAt);
      });
    }

    function createPerspective(name, icon, filter) {
      const perspective = {
        id: 'custom_' + Date.now(),
        name: name,
        icon: icon || 'üìå',
        filter: filter,
        builtin: false
      };
      customPerspectives.push(perspective);
      saveTasksData();
      return perspective;
    }

    function deletePerspective(perspectiveId) {
      customPerspectives = customPerspectives.filter(p => p.id !== perspectiveId);
      if (activePerspective === perspectiveId) activePerspective = 'inbox';
      saveTasksData();
    }

    function getCategoryById(categoryId) {
      return taskCategories.find(c => c.id === categoryId);
    }

    // Personal Bests tracking
    function getPersonalBests() {
      const dates = Object.keys(allData).sort();
      if (dates.length === 0) return null;

      let bests = {
        highestDayScore: { value: 0, date: null },
        highestWeekScore: { value: 0, weekStart: null },
        longestStreak: { value: 0, endDate: null },
        currentStreak: 0,
        bestPrayerDay: { value: 0, date: null },
        bestWhoopDay: { value: 0, date: null },
        mostQuranPages: { value: 0, date: null },
        perfectPrayerDays: 0,
        totalDaysLogged: dates.length
      };

      // Calculate streaks and daily bests
      let currentStreakCount = 0;
      let lastDate = null;

      dates.forEach(date => {
        const dayData = allData[date];
        const scores = calculateScores(dayData);

        // Highest day score
        if (scores.total > bests.highestDayScore.value) {
          bests.highestDayScore = { value: scores.total, date };
        }

        // Best prayer day
        if (scores.prayer > bests.bestPrayerDay.value) {
          bests.bestPrayerDay = { value: scores.prayer, date };
        }

        // Best whoop day
        if (scores.whoop > bests.bestWhoopDay.value) {
          bests.bestWhoopDay = { value: scores.whoop, date };
        }

        // Most Quran pages
        const quranPages = parseInt(dayData.prayers.quran) || 0;
        if (quranPages > bests.mostQuranPages.value) {
          bests.mostQuranPages = { value: quranPages, date };
        }

        // Perfect prayer days (5 on-time prayers)
        let onTimePrayers = 0;
        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => {
          const { onTime } = parsePrayer(dayData.prayers[p]);
          if (onTime >= 1) onTimePrayers++;
        });
        if (onTimePrayers === 5) bests.perfectPrayerDays++;

        // Streak calculation
        if (lastDate) {
          const lastD = new Date(lastDate);
          const currD = new Date(date);
          const diffDays = Math.round((currD - lastD) / (1000 * 60 * 60 * 24));
          if (diffDays === 1) {
            currentStreakCount++;
          } else {
            currentStreakCount = 1;
          }
        } else {
          currentStreakCount = 1;
        }

        if (currentStreakCount > bests.longestStreak.value) {
          bests.longestStreak = { value: currentStreakCount, endDate: date };
        }

        lastDate = date;
      });

      // Check if current streak is active (last entry was today or yesterday)
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
      if (lastDate === today || lastDate === yesterday) {
        bests.currentStreak = currentStreakCount;
      }

      // Weekly scores
      const weekScores = {};
      dates.forEach(date => {
        const d = new Date(date);
        const weekStart = new Date(d.setDate(d.getDate() - d.getDay())).toISOString().split('T')[0];
        if (!weekScores[weekStart]) weekScores[weekStart] = 0;
        weekScores[weekStart] += calculateScores(allData[date]).total;
      });

      Object.entries(weekScores).forEach(([weekStart, score]) => {
        if (score > bests.highestWeekScore.value) {
          bests.highestWeekScore = { value: Math.round(score), weekStart };
        }
      });

      return bests;
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
      localStorage.setItem('lastUpdated', Date.now().toString());
    }

    function getTodayData() {
      return allData[currentDate] || JSON.parse(JSON.stringify(defaultDayData));
    }

    function updateData(category, field, value) {
      const todayData = getTodayData();
      todayData[category][field] = value;
      allData[currentDate] = todayData;
      saveData();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function parsePrayer(value) {
      if (!value && value !== 0) return { onTime: 0, late: 0 };
      const num = parseFloat(value) || 0;
      const onTime = Math.floor(num);
      const late = Math.round((num - onTime) * 10);
      return { onTime, late };
    }

    function calcPrayerScore(value) {
      const { onTime, late } = parsePrayer(value);
      return onTime * WEIGHTS.prayer.onTime + late * WEIGHTS.prayer.late;
    }

    function calculateScores(data) {
      // Prayer Score
      let prayerScore = 0;
      let totalOnTime = 0, totalLate = 0;
      ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => {
        const { onTime, late } = parsePrayer(data.prayers[p]);
        totalOnTime += onTime;
        totalLate += late;
        prayerScore += onTime * WEIGHTS.prayer.onTime + late * WEIGHTS.prayer.late;
      });
      // Quran pages
      const quranPages = parseInt(data.prayers.quran) || 0;
      prayerScore += quranPages * WEIGHTS.prayer.quran;

      // Diabetes/Glucose Score
      let diabetesScore = 0;
      const avg = parseFloat(data.glucose.avg) || 0;
      const tir = parseFloat(data.glucose.tir) || 0;
      const insulin = parseFloat(data.glucose.insulin) || 0;

      // Avg glucose scoring - progressive: closer to 105 (midpoint of 70-140) = more points
      // Scale: 105 = max points, decreases as you move away from 105
      if (data.glucose.avg !== '') {
        const target = 105; // ideal midpoint
        const maxPts = WEIGHTS.glucose.avgMax || 20;
        if (avg >= 70 && avg <= 140) {
          // Perfect range: scale from target (full points) to edges (half points)
          const distFromTarget = Math.abs(avg - target);
          const maxDist = 35; // distance from 105 to 70 or 140
          diabetesScore += maxPts * (1 - (distFromTarget / maxDist) * 0.5);
        } else if (avg > 140 && avg <= 180) {
          // Acceptable range: scale down from edge
          const ptsAt140 = maxPts * 0.5;
          const penalty = (avg - 140) * (ptsAt140 / 40); // lose all by 180
          diabetesScore += Math.max(0, ptsAt140 - penalty);
        }
        // Below 70 or above 180 = 0 points
      }

      // TIR scoring - progressive: each % point matters
      // Scale: 0.3 pts per % (so 70% = 21 pts, 100% = 30 pts)
      if (data.glucose.tir !== '' && tir > 0) {
        const ptsPerPercent = WEIGHTS.glucose.tirPerPoint || 0.3;
        diabetesScore += tir * ptsPerPercent;
      }

      // Insulin scoring: base points if ‚â§threshold, flat penalty if >threshold
      const insulinThreshold = WEIGHTS.glucose.insulinThreshold || 40;
      if (data.glucose.insulin !== '' && insulin > 0) {
        if (insulin <= insulinThreshold) {
          diabetesScore += WEIGHTS.glucose.insulinBase;
        } else {
          diabetesScore += WEIGHTS.glucose.insulinPenalty;
        }
      }

      // Whoop Age Score - Based on age-reducing metrics
      let whoopScore = 0;
      const w = data.whoop;
      const ww = WEIGHTS.whoop;

      // Sleep Performance: ‚â•90% optimal
      const sleepPerf = parseFloat(w.sleepPerf) || 0;
      if (w.sleepPerf !== '') {
        if (sleepPerf >= 90) whoopScore += ww.sleepPerfHigh;
        else if (sleepPerf >= 70) whoopScore += ww.sleepPerfMid;
        else if (sleepPerf >= 50) whoopScore += ww.sleepPerfLow;
      }

      // Recovery
      const recovery = parseFloat(w.recovery) || 0;
      if (w.recovery !== '') {
        if (recovery >= 66) whoopScore += ww.recoveryHigh;
        else if (recovery >= 50) whoopScore += ww.recoveryMid;
        else if (recovery >= 33) whoopScore += ww.recoveryLow;
      }

      // Strain - recovery-matched scoring
      // High recovery (‚â•66%) ‚Üí reward high strain (14-21)
      // Medium recovery (33-65%) ‚Üí reward moderate strain (10-14)
      // Low recovery (<33%) ‚Üí reward rest/light strain (0-10)
      const strain = parseFloat(w.strain) || 0;
      if (w.strain !== '' && w.recovery !== '') {
        let strainMatch = false;
        if (recovery >= 66 && strain >= 14) strainMatch = true;
        else if (recovery >= 33 && recovery < 66 && strain >= 10 && strain < 14) strainMatch = true;
        else if (recovery < 33 && strain < 10) strainMatch = true;

        if (strainMatch) whoopScore += (ww.strainMatch || 10);
        // Bonus for high strain on high recovery days
        if (recovery >= 66 && strain >= 18) whoopScore += (ww.strainHigh || 5);
      }

      // Family Score - individual weights per member
      let familyScore = 0;
      Object.entries(data.family).forEach(([member, checked]) => {
        if (checked) familyScore += WEIGHTS.family[member] || 0;
      });

      // Habit Score
      let habitScore = 0;
      habitScore += (parseInt(data.habits.exercise) || 0) * WEIGHTS.habits.exercise;
      habitScore += (parseInt(data.habits.reading) || 0) * WEIGHTS.habits.reading;
      habitScore += (parseInt(data.habits.meditation) || 0) * WEIGHTS.habits.meditation;
      habitScore += (parseFloat(data.habits.water) || 0) * WEIGHTS.habits.water;
      habitScore += data.habits.vitamins ? WEIGHTS.habits.vitamins : 0;
      habitScore += (parseInt(data.habits.brushTeeth) || 0) * WEIGHTS.habits.brushTeeth;
      // NoP scoring: points if 1, penalty if 0
      const nop = data.habits.nop;
      if (nop !== '' && nop !== null && nop !== undefined) {
        if (parseInt(nop) === 1) habitScore += (WEIGHTS.habits.nopYes || 5);
        else if (parseInt(nop) === 0) habitScore += (WEIGHTS.habits.nopNo || -3);
      }

      return {
        prayer: prayerScore,
        prayerOnTime: totalOnTime,
        prayerLate: totalLate,
        diabetes: Math.round(diabetesScore * 10) / 10,
        whoop: Math.round(whoopScore * 10) / 10,
        family: familyScore,
        habit: habitScore,
        total: Math.round((prayerScore + diabetesScore + whoopScore + familyScore + habitScore) * 10) / 10
      };
    }

    function getLast30DaysData() {
      const days = [];
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const dayData = allData[dateStr] || defaultDayData;
        const dayScores = calculateScores(dayData);
        days.push({
          date: dateStr,
          day: date.getDate(),
          month: date.toLocaleDateString('en-US', { month: 'short' }),
          label: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          ...dayScores
        });
      }
      return days;
    }

    function getLast30DaysStats() {
      let stats = { totalScore: 0, daysLogged: 0, totalOnTimePrayers: 0, totalLatePrayers: 0, totalFamilyCheckins: 0, avgRHR: 0, avgSleep: 0, rhrCount: 0, sleepCount: 0 };

      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        if (allData[dateStr]) {
          stats.daysLogged++;
          const d = allData[dateStr];
          const dayScores = calculateScores(d);
          stats.totalScore += dayScores.total;
          stats.totalOnTimePrayers += dayScores.prayerOnTime;
          stats.totalLatePrayers += dayScores.prayerLate;
          stats.totalFamilyCheckins += Object.values(d.family).filter(Boolean).length;
          if (d.whoop.rhr) { stats.avgRHR += parseFloat(d.whoop.rhr); stats.rhrCount++; }
          if (d.whoop.sleepHours) { stats.avgSleep += parseFloat(d.whoop.sleepHours); stats.sleepCount++; }
        }
      }
      stats.totalScore = Math.round(stats.totalScore);
      stats.avgRHR = stats.rhrCount ? Math.round(stats.avgRHR / stats.rhrCount) : 0;
      stats.avgSleep = stats.sleepCount ? (stats.avgSleep / stats.sleepCount).toFixed(1) : 0;
      stats.avgDaily = stats.daysLogged ? Math.round(stats.totalScore / stats.daysLogged) : 0;
      return stats;
    }

    function createPrayerInput(prayer, label, value) {
      const { onTime, late } = parsePrayer(value);
      const pts = calcPrayerScore(value);
      return `
        <div class="flex-1 text-center">
          <input type="text" value="${value}" placeholder="X.Y"
            class="w-full px-2 py-2 border border-softborder rounded text-center font-mono text-lg bg-white mb-1"
            onchange="updateData('prayers', '${prayer}', this.value)">
          <div class="text-xs font-medium text-charcoal/70">${label}</div>
          <div class="text-xs text-charcoal/50 mt-0.5">
            <span class="text-green-600">${onTime}‚úì</span> <span class="text-amber-500">${late}‚óê</span>
          </div>
          <div class="text-xs font-semibold text-coral mt-0.5">${pts} pts</div>
        </div>
      `;
    }

    function createToggle(label, checked, category, field) {
      return `
        <label class="flex items-center justify-between cursor-pointer py-2 px-1 hover:bg-warmgray rounded transition">
          <span class="text-sm text-charcoal">${label}</span>
          <div class="relative" onclick="updateData('${category}', '${field}', !${checked})">
            <div class="w-10 h-5 rounded-full transition" style="background-color: ${checked ? '#E5533D' : '#d1d5db'}"></div>
            <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow transition" style="transform: translateX(${checked ? '20px' : '0'})"></div>
          </div>
        </label>
      `;
    }

    function createNumberInput(label, value, category, field, placeholder, unit, hint = '', tooltip = '', tooltipPos = 'center') {
      // tooltipPos: 'left', 'center', 'right' to control horizontal alignment
      const posClass = tooltipPos === 'left' ? 'left-0' : tooltipPos === 'right' ? 'right-0' : 'left-1/2 -translate-x-1/2';
      return `
        <div class="flex-1 text-center group relative">
          <input type="number" step="any" value="${value}" placeholder="${placeholder}"
            class="w-full px-2 py-2 border border-softborder rounded text-center text-sm bg-white mb-1"
            onchange="updateData('${category}', '${field}', this.value)">
          <div class="text-xs font-medium text-charcoal/70 flex items-center justify-center gap-1">
            ${label}
            ${tooltip ? `<span class="cursor-help text-charcoal/30 hover:text-coral">‚ìò</span>` : ''}
          </div>
          <div class="text-xs text-charcoal/40">${unit}${hint ? ` ¬∑ ${hint}` : ''}</div>
          ${tooltip ? `<div class="absolute ${posClass} top-full mt-1 z-50 hidden group-hover:block bg-charcoal text-white text-xs rounded p-3 w-48 shadow-lg text-left">${tooltip}</div>` : ''}
        </div>
      `;
    }

    function createCounter(label, value, category, field, max = 10) {
      return `
        <div class="flex items-center justify-between py-2">
          <span class="text-sm text-charcoal">${label}</span>
          <div class="flex items-center gap-2">
            <button onclick="updateData('${category}', '${field}', Math.max(0, ${value} - 1))"
              class="w-7 h-7 rounded-full bg-warmgray hover:bg-softborder flex items-center justify-center font-bold text-charcoal/60 transition">‚àí</button>
            <span class="w-8 text-center font-semibold text-lg text-charcoal">${value}</span>
            <button onclick="updateData('${category}', '${field}', Math.min(${max}, ${value} + 1))"
              class="w-7 h-7 rounded-full bg-coral hover:bg-coralDark text-white flex items-center justify-center font-bold transition">+</button>
          </div>
        </div>
      `;
    }

    function createScoreCard(label, score, max, colorClass) {
      const pct = max ? Math.min((score / max) * 100, 100) : 0;
      // Map old color classes to SimpleBits-style accent colors
      const accentMap = {
        'bg-blue-500': '#4A90A4',
        'bg-green-500': '#6B8E5A',
        'bg-purple-500': '#7C6B8E',
        'bg-amber-500': '#C4943D',
        'bg-slate-500': '#6B7280'
      };
      const accent = accentMap[colorClass] || '#E5533D';
      const pctDisplay = Math.round(pct);
      return `
        <div class="sb-card rounded-lg p-4">
          <div class="flex justify-between items-center mb-1">
            <span class="sb-section-title text-charcoal/60">${label}</span>
            <span class="text-xs text-charcoal/40">${pctDisplay}%</span>
          </div>
          <div class="font-bold text-2xl text-charcoal mb-2">${fmt(score)}</div>
          <div class="h-1.5 bg-charcoal/10 rounded-full overflow-hidden">
            <div class="h-full rounded-full transition-all duration-500" style="width: ${pct}%; background: ${accent}"></div>
          </div>
        </div>
      `;
    }

    function createCard(title, icon, accentColor, content, extraHeader = '') {
      const accent = accentColor || '#6B7280';
      return `
        <div class="sb-card rounded-lg overflow-hidden">
          <div class="px-5 py-3 flex items-center justify-between bg-warmgray" style="border-bottom: 3px solid ${accent}">
            <div class="flex items-center gap-2">
              <span class="text-lg">${icon}</span>
              <h3 class="font-semibold text-charcoal">${title}</h3>
            </div>
            ${extraHeader ? `<span class="text-charcoal/50 text-xs">${extraHeader}</span>` : ''}
          </div>
          <div class="p-5 bg-white">${content}</div>
        </div>
      `;
    }

    function renderTrackingTab() {
      const data = getTodayData();
      const scores = calculateScores(data);

      const prayerHelp = `<span class="text-xs text-charcoal/50">X.Y = X on-time + Y late</span>`;
      const prayersContent = `
        <div class="flex gap-2 mb-4">
          ${['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].map(p =>
            createPrayerInput(p, p.charAt(0).toUpperCase() + p.slice(1), data.prayers[p])
          ).join('')}
        </div>
        <div class="border-t border-softborder pt-4">
          <div class="flex items-center justify-center gap-3">
            <span class="text-sm text-charcoal/70">üìñ Quran</span>
            <button onclick="updateData('prayers', 'quran', Math.max(0, ${parseInt(data.prayers.quran) || 0} - 1))"
              class="w-7 h-7 rounded-full bg-warmgray hover:bg-softborder flex items-center justify-center font-bold text-charcoal/60">‚àí</button>
            <span class="w-8 text-center font-semibold text-lg">${parseInt(data.prayers.quran) || 0}</span>
            <button onclick="updateData('prayers', 'quran', ${parseInt(data.prayers.quran) || 0} + 1)"
              class="w-7 h-7 rounded-full bg-coral hover:bg-coralDark text-white flex items-center justify-center font-bold">+</button>
            <span class="text-xs text-charcoal/50">pages ¬∑ ${(parseInt(data.prayers.quran) || 0) * 5} pts</span>
          </div>
        </div>
      `;

      const insulinThreshold = WEIGHTS.glucose.insulinThreshold || 40;
      const glucoseContent = `
        <div class="flex gap-3">
          ${createNumberInput('Avg Glucose', data.glucose.avg, 'glucose', 'avg', '105', 'mg/dL', '105=10pts')}
          ${createNumberInput('TIR', data.glucose.tir, 'glucose', 'tir', '70+', '%', '0.1pts/%')}
          ${createNumberInput('Insulin', data.glucose.insulin, 'glucose', 'insulin', '‚â§' + insulinThreshold, 'units', '‚â§' + insulinThreshold + '=+5')}
        </div>
      `;

      const whoopHelp = `<span class="text-xs text-charcoal/50">Hover ‚ìò for tips</span>`;
      const whoopContent = `
        <div class="grid grid-cols-3 gap-3">
          ${createNumberInput('Sleep Perf', data.whoop.sleepPerf, 'whoop', 'sleepPerf', '‚â•90', '%', '‚â•90%', '<b>How to improve:</b><br>‚Ä¢ Consistent bedtime/wake time<br>‚Ä¢ Cool room (65-68¬∞F)<br>‚Ä¢ No screens 1h before bed', 'left')}
          ${createNumberInput('Recovery', data.whoop.recovery, 'whoop', 'recovery', '‚â•66', '%', '‚â•66%', '<b>How to improve recovery:</b><br>‚Ä¢ Prioritize sleep quality<br>‚Ä¢ Hydrate well<br>‚Ä¢ Eat nutritious foods', 'center')}
          ${createNumberInput('Strain', data.whoop.strain, 'whoop', 'strain', '10-14', '/21', 'match', '<b>Recovery-matched:</b><br>‚Ä¢ Green (‚â•66%) ‚Üí 14+ strain<br>‚Ä¢ Yellow (33-65%) ‚Üí 10-14 strain<br>‚Ä¢ Red (<33%) ‚Üí rest', 'right')}
        </div>
      `;

      const familyContent = ['mom', 'dad', 'jana', 'tia', 'ahmed', 'eman'].map(p =>
        createToggle(p.charAt(0).toUpperCase() + p.slice(1), data.family[p], 'family', p)
      ).join('');

      const habitsContent = `
        <div class="space-y-2">
          ${createCounter('üèãÔ∏è Exercise', data.habits.exercise || 0, 'habits', 'exercise', 5)}
          ${createCounter('üìö Reading', data.habits.reading || 0, 'habits', 'reading', 5)}
          ${createCounter('üßò Meditation', data.habits.meditation || 0, 'habits', 'meditation', 5)}
          ${createCounter('ü¶∑ Brush Teeth', data.habits.brushTeeth || 0, 'habits', 'brushTeeth', 3)}
          ${createToggle('üíä Vitamins taken', data.habits.vitamins, 'habits', 'vitamins')}
        </div>
        <div class="flex gap-3 mt-3 pt-3 border-t border-softborder">
          <div class="flex-1 text-center">
            <input type="number" step="any" value="${data.habits.water}" placeholder="2.5"
              class="w-full px-2 py-2 border border-softborder rounded text-center text-sm bg-white mb-1"
              onchange="updateData('habits', 'water', this.value)">
            <div class="text-xs font-medium text-charcoal/70">üíß Water</div>
            <div class="text-xs text-charcoal/40">L ¬∑ 1pt/L</div>
          </div>
          <div class="flex-1 text-center">
            <input type="number" step="1" value="${data.habits.nop}" placeholder="0-1"
              class="w-full px-2 py-2 border border-softborder rounded text-center text-sm bg-white mb-1"
              onchange="updateData('habits', 'nop', this.value)">
            <div class="text-xs font-medium text-charcoal/70">üí§ NoP</div>
            <div class="text-xs text-charcoal/40">1=+2, 0=-2</div>
          </div>
        </div>
      `;

      const summaryContent = `
        <div class="space-y-3">
          <div class="p-3 bg-purple-50 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="font-medium">Whoop Age</span>
              <div class="flex items-center gap-2">
                <input type="number" step="0.1" value="${data.whoop.whoopAge || ''}" placeholder="‚Äî"
                  class="w-16 px-2 py-1 border border-purple-200 rounded text-center text-sm bg-white font-bold text-purple-600"
                  onchange="updateData('whoop', 'whoopAge', this.value)">
                <span class="text-xs text-purple-400">yrs</span>
              </div>
            </div>
          </div>
          <div class="p-3 bg-blue-50 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="font-medium">Prayers</span>
              <span class="font-bold text-blue-600">${scores.prayer} pts</span>
            </div>
            <div class="text-xs mt-1">
              <span class="inline-block bg-green-100 text-green-700 px-2 py-0.5 rounded mr-1">${scores.prayerOnTime} on-time</span>
              <span class="inline-block bg-amber-100 text-amber-700 px-2 py-0.5 rounded">${scores.prayerLate} late</span>
            </div>
          </div>
          <div class="flex justify-between items-center p-3 bg-amber-50 rounded-lg">
            <span class="font-medium">Family</span>
            <span class="font-bold text-amber-600">${Object.values(data.family).filter(Boolean).length}/6</span>
          </div>
        </div>
      `;

      return `
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
          ${createScoreCard('Prayer', scores.prayer, MAX_SCORES.prayer, 'bg-blue-500')}
          ${createScoreCard('Diabetes', scores.diabetes, MAX_SCORES.diabetes, 'bg-green-500')}
          ${createScoreCard('Whoop', scores.whoop, MAX_SCORES.whoop, 'bg-purple-500')}
          ${createScoreCard('Family', scores.family, MAX_SCORES.family, 'bg-amber-500')}
          ${createScoreCard('Habits', scores.habit, MAX_SCORES.habits, 'bg-slate-500')}
          <div class="sb-card rounded-lg p-4 bg-coral text-white">
            <div class="sb-section-title text-white/80 flex justify-between">
              <span>Total</span>
              <span>${Math.round((scores.total / MAX_SCORES.total) * 100)}%</span>
            </div>
            <div class="text-3xl font-bold mt-1">${fmt(scores.total)}</div>
            <div class="h-1.5 bg-white/30 rounded-full mt-2 overflow-hidden">
              <div class="h-full bg-white rounded-full" style="width: ${Math.min((scores.total / MAX_SCORES.total) * 100, 100)}%"></div>
            </div>
          </div>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5">
          ${createCard('Prayers', 'üïå', '#4A90A4', prayersContent, prayerHelp)}
          ${createCard('Glucose (Libre)', 'üíâ', '#6B8E5A', glucoseContent)}
          ${createCard('Whoop Age Metrics', '‚è±Ô∏è', '#7C6B8E', whoopContent, whoopHelp)}
          ${createCard('Family Check-ins', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', '#C4943D', familyContent)}
          ${createCard('Habits', '‚ú®', '#6B7280', habitsContent)}
          ${createCard("Today's Summary", 'üìà', '#E5533D', summaryContent)}
        </div>
      `;
    }

    function renderDashboardTab() {
      const stats = getLast30DaysStats();
      const last30Data = getLast30DaysData();
      const bests = getPersonalBests();

      setTimeout(() => {
        const weekCtx = document.getElementById('weekChart');
        if (weekCtx) {
          if (weekChart) weekChart.destroy();
          weekChart = new Chart(weekCtx, {
            type: 'bar',
            data: {
              labels: last30Data.map(d => d.label),
              datasets: [{ label: 'Total Score', data: last30Data.map(d => d.total), backgroundColor: '#E5533D', borderRadius: 4 }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true },
                x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } }
              }
            }
          });
        }

        const breakdownCtx = document.getElementById('breakdownChart');
        if (breakdownCtx) {
          if (breakdownChart) breakdownChart.destroy();
          breakdownChart = new Chart(breakdownCtx, {
            type: 'line',
            data: {
              labels: last30Data.map(d => d.label),
              datasets: [
                { label: 'Prayer', data: last30Data.map(d => d.prayer), borderColor: '#4A90A4', tension: 0.3, pointRadius: 2 },
                { label: 'Whoop', data: last30Data.map(d => d.whoop), borderColor: '#7C6B8E', tension: 0.3, pointRadius: 2 },
                { label: 'Family', data: last30Data.map(d => d.family), borderColor: '#C4943D', tension: 0.3, pointRadius: 2 },
                { label: 'Habit', data: last30Data.map(d => d.habit), borderColor: '#6B7280', tension: 0.3, pointRadius: 2 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom' } },
              scales: {
                y: { beginAtZero: true },
                x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } }
              }
            }
          });
        }
      }, 100);

      return `
        <div class="space-y-8">
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="sb-card rounded-lg p-5 bg-coral text-white">
              <div class="sb-section-title text-white/70">30-Day Score</div>
              <div class="text-3xl font-bold mt-1">${fmt(stats.totalScore)}</div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Days Logged</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${stats.daysLogged}/30</div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Avg RHR</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${fmt(stats.avgRHR)} <span class="text-base font-normal text-charcoal/50">bpm</span></div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Avg Sleep</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${stats.avgSleep} <span class="text-base font-normal text-charcoal/50">hrs</span></div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Family Check-ins</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${fmt(stats.totalFamilyCheckins)}</div>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Last 30 Days <span class="text-coral">‚Üí</span></h3>
            <div class="h-72"><canvas id="weekChart"></canvas></div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Score Breakdown <span class="text-coral">‚Üí</span></h3>
            <div class="h-72"><canvas id="breakdownChart"></canvas></div>
          </div>

          <!-- Personal Bests Section -->
          ${bests ? `
          <div class="sb-card rounded-lg p-6 bg-warmgray border-2 border-coral/20">
            <h3 class="font-semibold text-charcoal mb-4">Personal Bests <span class="text-coral">‚Üí</span></h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral">${fmt(bests.highestDayScore.value)}</div>
                <div class="text-sm text-charcoal/70 mt-1">Best Day Score</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.highestDayScore.date ? new Date(bests.highestDayScore.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '‚Äî'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral">${fmt(bests.highestWeekScore.value)}</div>
                <div class="text-sm text-charcoal/70 mt-1">Best Week Score</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.highestWeekScore.weekStart ? 'Week of ' + new Date(bests.highestWeekScore.weekStart).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '‚Äî'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral">${fmt(bests.longestStreak.value)}</div>
                <div class="text-sm text-charcoal/70 mt-1">Longest Streak</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.longestStreak.value > 0 ? 'days in a row' : '‚Äî'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral flex items-center gap-2">${fmt(bests.currentStreak)} ${bests.currentStreak > 0 ? 'üî•' : ''}</div>
                <div class="text-sm text-charcoal/70 mt-1">Current Streak</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.currentStreak > 0 ? 'Keep it going!' : 'Log today to start!'}</div>
              </div>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="sb-card rounded-lg p-6 bg-white">
              <h3 class="font-semibold text-charcoal mb-4">Category Records <span class="text-coral">‚Üí</span></h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div>
                    <div class="text-sm font-medium text-charcoal">üïå Best Prayer Day</div>
                    <div class="text-xs text-charcoal/50">${bests.bestPrayerDay.date ? new Date(bests.bestPrayerDay.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî'}</div>
                  </div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.bestPrayerDay.value)} pts</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div>
                    <div class="text-sm font-medium text-charcoal">‚è±Ô∏è Best Whoop Day</div>
                    <div class="text-xs text-charcoal/50">${bests.bestWhoopDay.date ? new Date(bests.bestWhoopDay.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî'}</div>
                  </div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.bestWhoopDay.value)} pts</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div>
                    <div class="text-sm font-medium text-charcoal">üìñ Most Quran Pages</div>
                    <div class="text-xs text-charcoal/50">${bests.mostQuranPages.date ? new Date(bests.mostQuranPages.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî'}</div>
                  </div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.mostQuranPages.value)} pages</div>
                </div>
              </div>
            </div>

            <div class="sb-card rounded-lg p-6 bg-white">
              <h3 class="font-semibold text-charcoal mb-4">Lifetime Stats <span class="text-coral">‚Üí</span></h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div class="text-sm font-medium text-charcoal">Total Days Logged</div>
                  <div class="text-xl font-bold text-charcoal">${fmt(bests.totalDaysLogged)}</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div class="text-sm font-medium text-charcoal">Perfect Prayer Days</div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.perfectPrayerDays)} üåü</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div class="text-sm font-medium text-charcoal">Perfect Prayer Rate</div>
                  <div class="text-xl font-bold text-coral">${bests.totalDaysLogged > 0 ? Math.round((bests.perfectPrayerDays / bests.totalDaysLogged) * 100) : 0}%</div>
                </div>
              </div>
            </div>
          </div>
          ` : `
          <div class="sb-card rounded-lg p-8 bg-white text-center">
            <div class="text-4xl mb-4">üéÆ</div>
            <h3 class="font-semibold text-charcoal mb-2">Start Your Journey!</h3>
            <p class="text-charcoal/50 text-sm">Log your first day to start tracking personal bests.</p>
          </div>
          `}
        </div>
      `;
    }

    function render() {
      const app = document.getElementById('app');
      const dateDisplay = new Date(currentDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      app.innerHTML = `
        <header class="border-b border-softborder bg-cream">
          <div class="max-w-5xl mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <svg class="w-12 h-12" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                  <rect x="10" y="10" width="80" height="80" rx="12" fill="#1a1a1a"/>
                  <rect x="24" y="20" width="22" height="22" rx="4" fill="#F7F6F4"/>
                  <rect x="24" y="46" width="22" height="22" rx="4" fill="#F7F6F4"/>
                  <rect x="50" y="46" width="22" height="22" rx="4" fill="#E5533D"/>
                  <rect x="24" y="72" width="22" height="10" rx="3" fill="#F7F6F4" opacity="0.5"/>
                </svg>
                <div>
                  <h1 class="text-2xl font-bold tracking-tight text-charcoal">Life Gamification</h1>
                  <p class="text-sm text-charcoal/60 mt-0.5">Track habits, diabetes <span class="text-coral">+</span> reduce your biological age</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-warmgray border border-softborder" title="Cloud sync status">
                  <div id="sync-indicator" class="w-2 h-2 rounded-full ${getGithubToken() ? 'bg-green-500' : 'bg-charcoal/30'}"></div>
                  <span class="text-xs text-charcoal/50">${getGithubToken() ? 'Synced' : 'Local'}</span>
                </div>
                <input type="date" id="dateInput" value="${currentDate}"
                  class="px-3 py-2 rounded-lg text-sm border border-softborder bg-white focus:border-coral focus:outline-none">
                <button onclick="setToday()" class="sb-btn px-4 py-2 rounded-lg text-sm font-medium">Today</button>
              </div>
            </div>
            <p class="text-charcoal/50 text-sm mt-2">${dateDisplay}</p>
          </div>
        </header>

        <nav class="border-b border-softborder bg-warmgray">
          <div class="max-w-5xl mx-auto px-6">
            <div class="flex gap-1">
              <button onclick="switchTab('track')" class="py-3 px-5 text-sm font-medium transition border-b-2 ${activeTab === 'track' ? 'border-coral text-charcoal' : 'border-transparent text-charcoal/50 hover:text-charcoal'}">
                Daily
              </button>
              <button onclick="switchTab('bulk')" class="py-3 px-5 text-sm font-medium transition border-b-2 ${activeTab === 'bulk' ? 'border-coral text-charcoal' : 'border-transparent text-charcoal/50 hover:text-charcoal'}">
                Bulk Entry
              </button>
              <button onclick="switchTab('dashboard')" class="py-3 px-5 text-sm font-medium transition border-b-2 ${activeTab === 'dashboard' ? 'border-coral text-charcoal' : 'border-transparent text-charcoal/50 hover:text-charcoal'}">
                Dashboard
              </button>
              <button onclick="switchTab('tasks')" class="py-3 px-5 text-sm font-medium transition border-b-2 ${activeTab === 'tasks' ? 'border-coral text-charcoal' : 'border-transparent text-charcoal/50 hover:text-charcoal'}">
                Tasks
              </button>
              <button onclick="switchTab('settings')" class="py-3 px-5 text-sm font-medium transition border-b-2 ${activeTab === 'settings' ? 'border-coral text-charcoal' : 'border-transparent text-charcoal/50 hover:text-charcoal'}">
                Settings
              </button>
            </div>
          </div>
        </nav>

        <main class="${activeTab === 'tasks' ? 'max-w-6xl' : 'max-w-5xl'} mx-auto px-6 py-8">
          ${activeTab === 'track' ? renderTrackingTab() : activeTab === 'bulk' ? renderBulkEntryTab() : activeTab === 'dashboard' ? renderDashboardTab() : activeTab === 'tasks' ? renderTasksTab() : renderSettingsTab()}
        </main>

        <footer class="border-t border-softborder py-8 mt-12">
          <p class="text-center text-charcoal/40 text-sm">${getGithubToken() ? 'Data synced to GitHub' : 'Data saved locally'} <span class="text-coral">‚Ä¢</span> Muhammad's Life Gamification System</p>
        </footer>
      `;

      document.getElementById('dateInput').addEventListener('change', (e) => { currentDate = e.target.value; render(); });
    }

    function switchTab(tab) { activeTab = tab; render(); }
    function setToday() { currentDate = new Date().toISOString().split('T')[0]; render(); }

    function setBulkMonth(month, year) {
      bulkMonth = parseInt(month);
      bulkYear = parseInt(year);
      render();
    }

    function setBulkCategory(cat) {
      bulkCategory = cat;
      render();
    }

    function updateBulkData(dateStr, category, field, value) {
      if (!allData[dateStr]) {
        allData[dateStr] = JSON.parse(JSON.stringify(defaultDayData));
      }
      if (category === 'family') {
        allData[dateStr][category][field] = value === '1' || value === true;
      } else {
        allData[dateStr][category][field] = value;
      }
      saveData();
      debouncedSaveToGithub(); // Auto-save to GitHub
      // Update score cell live
      const scoreCell = document.getElementById('score-' + dateStr);
      if (scoreCell) {
        const newScore = calculateScores(allData[dateStr]).total;
        scoreCell.textContent = fmt(newScore);
      }
      // Update summary stats
      updateBulkSummary();
    }

    function updateBulkSummary() {
      const daysInMonth = getDaysInMonth(bulkMonth, bulkYear);
      let totalScore = 0, daysWithData = 0;
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = bulkYear + '-' + String(bulkMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        if (allData[dateStr]) {
          daysWithData++;
          totalScore += calculateScores(allData[dateStr]).total;
        }
      }
      const avgScore = daysWithData > 0 ? Math.round(totalScore / daysWithData) : 0;
      const completionRate = Math.round((daysWithData / daysInMonth) * 100);

      const daysEl = document.getElementById('bulk-days-logged');
      const totalEl = document.getElementById('bulk-total-score');
      const avgEl = document.getElementById('bulk-avg-score');
      const compEl = document.getElementById('bulk-completion');
      if (daysEl) daysEl.textContent = fmt(daysWithData);
      if (totalEl) totalEl.textContent = fmt(totalScore);
      if (avgEl) avgEl.textContent = fmt(avgScore);
      if (compEl) compEl.textContent = completionRate + '%';
    }

    function getDaysInMonth(month, year) {
      return new Date(year, month + 1, 0).getDate();
    }

    function renderBulkEntryTab() {
      const daysInMonth = getDaysInMonth(bulkMonth, bulkYear);
      const monthName = new Date(bulkYear, bulkMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      // Category colors matching Daily tab
      const categoryColors = {
        prayers: '#4A90A4',  // teal
        glucose: '#6B8E5A', // green
        whoop: '#7C6B8E',   // purple
        family: '#C4943D',  // amber
        habits: '#6B7280'   // slate
      };

      const categories = {
        prayers: { label: 'üïå Prayers', fields: ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha', 'quran'], headers: ['F', 'D', 'A', 'M', 'I', 'Q'] },
        glucose: { label: 'üíâ Glucose', fields: ['avg', 'tir', 'insulin'], headers: ['Avg', 'TIR', 'Insulin'] },
        whoop: { label: '‚è±Ô∏è Whoop', fields: ['sleepPerf', 'recovery', 'strain'], headers: ['Sleep%', 'Rec', 'Strain'] },
        family: { label: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family', fields: ['mom', 'dad', 'jana', 'tia', 'ahmed', 'eman'], headers: ['Mom', 'Dad', 'Jana', 'Tia', 'Ahmed', 'Eman'] },
        habits: { label: '‚ú® Habits', fields: ['exercise', 'reading', 'meditation', 'water', 'vitamins', 'brushTeeth', 'nop'], headers: ['üèãÔ∏è', 'üìö', 'üßò', 'üíß', 'üíä', 'ü¶∑', 'üí§'] }
      };

      const cat = categories[bulkCategory];

      // Generate month options (2026 and 2027)
      let monthOptions = '';
      [2026, 2027].forEach(function(year) {
        for (let m = 0; m < 12; m++) {
          const label = new Date(year, m).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          const selected = m === bulkMonth && year === bulkYear ? 'selected' : '';
          monthOptions += '<option value="' + m + '-' + year + '" ' + selected + '>' + label + '</option>';
        }
      });

      // Build the table rows
      let tableRows = '';
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = bulkYear + '-' + String(bulkMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        const dayData = allData[dateStr] || JSON.parse(JSON.stringify(defaultDayData));
        const dayOfWeek = new Date(bulkYear, bulkMonth, day).toLocaleDateString('en-US', { weekday: 'short' });
        const isWeekend = [0, 6].includes(new Date(bulkYear, bulkMonth, day).getDay());
        const isToday = dateStr === new Date().toISOString().split('T')[0];
        const scores = calculateScores(dayData);

        let cells = '';
        cat.fields.forEach(field => {
          const value = dayData[bulkCategory][field];

          if (bulkCategory === 'family' || (bulkCategory === 'habits' && field === 'vitamins')) {
            const checked = value ? 'checked' : '';
            cells += '<td class="border border-softborder px-1 py-1 text-center">' +
              '<input type="checkbox" ' + checked +
              ' class="w-5 h-5 rounded border-softborder text-coral focus:ring-coral cursor-pointer"' +
              ' onchange="updateBulkData(\'' + dateStr + '\', \'' + bulkCategory + '\', \'' + field + '\', this.checked ? \'1\' : \'\')">' +
              '</td>';
          } else if (bulkCategory === 'prayers' && field !== 'quran') {
            cells += '<td class="border border-softborder px-1 py-1">' +
              '<input type="text" value="' + (value || '') + '" placeholder="X.Y"' +
              ' class="w-full px-1 py-1 text-center text-sm font-mono border-0 focus:ring-2 focus:ring-coral rounded bg-white"' +
              ' onchange="updateBulkData(\'' + dateStr + '\', \'' + bulkCategory + '\', \'' + field + '\', this.value)">' +
              '</td>';
          } else {
            cells += '<td class="border border-softborder px-1 py-1">' +
              '<input type="number" step="any" value="' + (value || '') + '"' +
              ' class="w-full px-1 py-1 text-center text-sm border-0 focus:ring-2 focus:ring-coral rounded bg-white"' +
              ' onchange="updateBulkData(\'' + dateStr + '\', \'' + bulkCategory + '\', \'' + field + '\', this.value)">' +
              '</td>';
          }
        });

        const rowClass = (isWeekend ? 'bg-warmgray/50 ' : '') + (isToday ? 'bg-coral/10 ' : '') + 'hover:bg-warmgray';
        const dayCellClass = 'border border-softborder px-2 py-1 font-medium text-center text-charcoal sticky left-0 z-10 ' + (isToday ? 'bg-coral/20' : 'bg-white');
        const weekdayCellClass = 'border border-softborder px-2 py-1 text-xs text-charcoal/50 text-center sticky left-10 z-10 ' + (isToday ? 'bg-coral/20' : 'bg-white');

        tableRows += '<tr class="' + rowClass + '">' +
          '<td class="' + dayCellClass + '">' + day + '</td>' +
          '<td class="' + weekdayCellClass + '">' + dayOfWeek + '</td>' +
          cells +
          '<td id="score-' + dateStr + '" class="border border-softborder px-2 py-1 text-center font-semibold text-coral">' + fmt(scores.total) + '</td>' +
          '</tr>';
      }

      // Category buttons with section colors
      let catButtons = '';
      Object.entries(categories).forEach(function([key, val]) {
        const color = categoryColors[key];
        const btnClass = bulkCategory === key
          ? 'text-white'
          : 'bg-warmgray hover:bg-softborder text-charcoal';
        const btnStyle = bulkCategory === key ? 'background-color: ' + color : '';
        catButtons += '<button onclick="setBulkCategory(\'' + key + '\')" class="px-3 py-2 rounded-lg text-sm font-medium transition ' + btnClass + '" style="' + btnStyle + '">' + val.label + '</button>';
      });

      // Header cells with category color
      const catColor = categoryColors[bulkCategory];
      let headerCells = '';
      cat.headers.forEach(function(h) {
        headerCells += '<th class="border px-3 py-3 font-medium" style="border-color: ' + catColor + '">' + h + '</th>';
      });

      // Calculate summary stats
      let totalScore = 0, daysWithData = 0;
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = bulkYear + '-' + String(bulkMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        if (allData[dateStr]) {
          daysWithData++;
          totalScore += calculateScores(allData[dateStr]).total;
        }
      }
      const avgScore = daysWithData > 0 ? Math.round(totalScore / daysWithData) : 0;
      const completionRate = Math.round((daysWithData / daysInMonth) * 100);

      const prayerHint = bulkCategory === 'prayers' ? '<span class="ml-2 text-charcoal/70">‚Ä¢ Use X.Y format: e.g., 1 = on-time, 0.1 = late, 1.2 = 1 on-time + 2 late</span>' : '';
      const familyHint = bulkCategory === 'family' ? '<span class="ml-2 text-charcoal/70">‚Ä¢ Check box if you connected with that person</span>' : '';

      return '<div class="space-y-4">' +
        // Controls card
        '<div class="sb-card rounded-lg overflow-hidden">' +
          '<div class="px-5 py-3 bg-warmgray" style="border-bottom: 3px solid #E5533D">' +
            '<h3 class="font-semibold text-charcoal">üìÖ Bulk Entry</h3>' +
          '</div>' +
          '<div class="p-5 bg-white">' +
            '<div class="flex flex-wrap items-center gap-4">' +
              '<div>' +
                '<label class="text-sm text-charcoal/60 block mb-1">Month</label>' +
                '<select onchange="const [m,y] = this.value.split(\'-\'); setBulkMonth(m, y)" class="px-3 py-2 border border-softborder rounded-lg focus:ring-2 focus:ring-coral outline-none bg-white text-charcoal">' +
                  monthOptions +
                '</select>' +
              '</div>' +
              '<div>' +
                '<label class="text-sm text-charcoal/60 block mb-1">Category</label>' +
                '<div class="flex gap-1 flex-wrap">' + catButtons + '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        // Info hint
        '<div class="rounded-lg p-3 text-sm" style="background-color: ' + catColor + '15; border-left: 3px solid ' + catColor + '">' +
          '<strong class="text-charcoal">' + monthName + '</strong> <span class="text-charcoal/70">' + cat.label + '</span>' + prayerHint + familyHint +
        '</div>' +
        // Data table
        '<div class="sb-card rounded-lg overflow-hidden">' +
          '<div class="overflow-x-auto">' +
            '<table class="w-full text-sm">' +
              '<thead>' +
                '<tr class="text-white" style="background-color: ' + catColor + '">' +
                  '<th class="border px-2 py-3 sticky left-0 z-20" style="border-color: ' + catColor + '; background-color: ' + catColor + '">Day</th>' +
                  '<th class="border px-2 py-3 sticky left-10 z-20" style="border-color: ' + catColor + '; background-color: ' + catColor + '"></th>' +
                  headerCells +
                  '<th class="border px-3 py-3 font-medium" style="border-color: ' + catColor + '">Score</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' + tableRows + '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>' +
        // Summary card
        '<div class="sb-card rounded-lg overflow-hidden">' +
          '<div class="px-5 py-3 bg-warmgray" style="border-bottom: 3px solid #E5533D">' +
            '<h3 class="font-semibold text-charcoal">üìä ' + monthName + ' Summary</h3>' +
          '</div>' +
          '<div class="p-5 bg-white">' +
            '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-days-logged" class="text-2xl font-bold text-charcoal">' + fmt(daysWithData) + '</div>' +
                '<div class="text-xs text-charcoal/60">Days Logged</div>' +
              '</div>' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-total-score" class="text-2xl font-bold text-coral">' + fmt(totalScore) + '</div>' +
                '<div class="text-xs text-charcoal/60">Total Score</div>' +
              '</div>' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-avg-score" class="text-2xl font-bold text-charcoal">' + fmt(avgScore) + '</div>' +
                '<div class="text-xs text-charcoal/60">Avg Daily Score</div>' +
              '</div>' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-completion" class="text-2xl font-bold text-charcoal">' + completionRate + '%</div>' +
                '<div class="text-xs text-charcoal/60">Completion Rate</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function createWeightInput(label, value, category, field = null) {
      return `
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <span class="text-sm text-gray-700">${label}</span>
          <input type="number" step="1" value="${value}"
            class="w-20 px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-blue-500 outline-none"
            onchange="updateWeight('${category}', ${field ? `'${field}'` : 'null'}, this.value)">
        </div>
      `;
    }

    function renderSettingsTab() {
      return `
        <div class="space-y-8">
          <div class="sb-card rounded-lg p-6 bg-white">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold text-charcoal">Scoring Weights <span class="text-coral">‚Üí</span></h3>
              <button onclick="resetWeights()" class="px-4 py-2 bg-coral/10 text-coral rounded text-sm font-medium hover:bg-coral/20 transition">
                Reset to Defaults
              </button>
            </div>
            <p class="text-sm text-charcoal/50 mb-6">Adjust the point values for each activity. Changes apply immediately.</p>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- 1. Prayer Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">üïå Prayer</h4>
                ${createWeightInput('On-time prayer', WEIGHTS.prayer.onTime, 'prayer', 'onTime')}
                ${createWeightInput('Late prayer', WEIGHTS.prayer.late, 'prayer', 'late')}
                ${createWeightInput('Quran (per page)', WEIGHTS.prayer.quran, 'prayer', 'quran')}
              </div>

              <!-- 2. Diabetes Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">üíâ Glucose (Libre)</h4>
                ${createWeightInput('Avg Glucose max pts (at 105)', WEIGHTS.glucose.avgMax, 'glucose', 'avgMax')}
                ${createWeightInput('TIR pts per %', WEIGHTS.glucose.tirPerPoint, 'glucose', 'tirPerPoint')}
                ${createWeightInput('Insulin threshold (units)', WEIGHTS.glucose.insulinThreshold, 'glucose', 'insulinThreshold')}
                ${createWeightInput('Insulin ‚â§threshold bonus', WEIGHTS.glucose.insulinBase, 'glucose', 'insulinBase')}
                ${createWeightInput('Insulin >threshold penalty', WEIGHTS.glucose.insulinPenalty, 'glucose', 'insulinPenalty')}
              </div>

              <!-- 3. Whoop Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">‚è±Ô∏è Whoop</h4>
                <div class="text-xs text-coral font-medium mb-2">Sleep Performance</div>
                ${createWeightInput('Sleep Perf ‚â•90%', WEIGHTS.whoop.sleepPerfHigh, 'whoop', 'sleepPerfHigh')}
                ${createWeightInput('Sleep Perf 70-90%', WEIGHTS.whoop.sleepPerfMid, 'whoop', 'sleepPerfMid')}
                ${createWeightInput('Sleep Perf 50-70%', WEIGHTS.whoop.sleepPerfLow, 'whoop', 'sleepPerfLow')}
                <div class="text-xs text-coral font-medium mb-2 mt-3">Recovery & Strain</div>
                ${createWeightInput('Recovery ‚â•66%', WEIGHTS.whoop.recoveryHigh, 'whoop', 'recoveryHigh')}
                ${createWeightInput('Recovery 50-66%', WEIGHTS.whoop.recoveryMid, 'whoop', 'recoveryMid')}
                ${createWeightInput('Recovery 33-50%', WEIGHTS.whoop.recoveryLow, 'whoop', 'recoveryLow')}
                ${createWeightInput('Strain matches recovery', WEIGHTS.whoop.strainMatch, 'whoop', 'strainMatch')}
                ${createWeightInput('High strain on green day', WEIGHTS.whoop.strainHigh, 'whoop', 'strainHigh')}
              </div>

              <!-- 4. Family Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</h4>
                ${createWeightInput('Mom', WEIGHTS.family.mom, 'family', 'mom')}
                ${createWeightInput('Dad', WEIGHTS.family.dad, 'family', 'dad')}
                ${createWeightInput('Jana', WEIGHTS.family.jana, 'family', 'jana')}
                ${createWeightInput('Tia', WEIGHTS.family.tia, 'family', 'tia')}
                ${createWeightInput('Ahmed', WEIGHTS.family.ahmed, 'family', 'ahmed')}
                ${createWeightInput('Eman', WEIGHTS.family.eman, 'family', 'eman')}
              </div>

              <!-- 5. Habits Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">‚ú® Habits</h4>
                ${createWeightInput('Exercise', WEIGHTS.habits.exercise, 'habits', 'exercise')}
                ${createWeightInput('Reading', WEIGHTS.habits.reading, 'habits', 'reading')}
                ${createWeightInput('Meditation', WEIGHTS.habits.meditation, 'habits', 'meditation')}
                ${createWeightInput('Water (per L)', WEIGHTS.habits.water, 'habits', 'water')}
                ${createWeightInput('Vitamins', WEIGHTS.habits.vitamins, 'habits', 'vitamins')}
                ${createWeightInput('Brush Teeth', WEIGHTS.habits.brushTeeth, 'habits', 'brushTeeth')}
                ${createWeightInput('NoP = 1 (bonus)', WEIGHTS.habits.nopYes, 'habits', 'nopYes')}
                ${createWeightInput('NoP = 0 (penalty)', WEIGHTS.habits.nopNo, 'habits', 'nopNo')}
              </div>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold text-charcoal">Perfect Day Targets <span class="text-coral">‚Üí</span></h3>
              <button onclick="resetMaxScores()" class="px-4 py-2 bg-coral/10 text-coral rounded text-sm font-medium hover:bg-coral/20 transition">
                Reset to Defaults
              </button>
            </div>
            <p class="text-sm text-charcoal/50 mb-6">Define what a "perfect day" looks like for each category. Progress bars show % of these targets.</p>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.prayer}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('prayer', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Prayer</div>
                <div class="text-xs text-charcoal/40">5√ó5 + quran</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.diabetes}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('diabetes', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Diabetes</div>
                <div class="text-xs text-charcoal/40">avg+tir+ins</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.whoop}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('whoop', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Whoop</div>
                <div class="text-xs text-charcoal/40">all optimal</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.family}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('family', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Family</div>
                <div class="text-xs text-charcoal/40">all checked</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.habits}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('habits', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Habits</div>
                <div class="text-xs text-charcoal/40">all done</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.total}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1 border-coral"
                  onchange="updateMaxScore('total', this.value)">
                <div class="text-xs font-medium text-coral">Total</div>
                <div class="text-xs text-charcoal/40">sum of all</div>
              </div>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Cloud Sync <span class="text-coral">‚Üí</span></h3>
            <p class="text-sm text-charcoal/50 mb-4">Enable automatic sync to GitHub. Your data will be saved to the cloud on every change.</p>

            <div class="mb-4">
              <label class="text-sm text-charcoal/70 block mb-2">GitHub Personal Access Token</label>
              <div class="flex gap-2">
                <input type="password" id="github-token-input" value="${getGithubToken()}"
                  placeholder="ghp_xxxx or github_pat_xxxx"
                  class="flex-1 px-3 py-2 border border-softborder rounded text-sm bg-white focus:border-coral focus:outline-none">
                <button onclick="setGithubToken(document.getElementById('github-token-input').value)"
                  class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  Save Token
                </button>
              </div>
              <p class="text-xs text-charcoal/40 mt-2">
                Token needs <code class="bg-warmgray px-1 rounded">repo</code> scope. Create at
                <a href="https://github.com/settings/tokens" target="_blank" class="sb-link">github.com/settings/tokens</a>
              </p>
            </div>

            <div class="flex flex-wrap gap-3 pt-4 border-t border-softborder">
              <button onclick="saveToGithub()" class="px-4 py-2 bg-coral text-white rounded text-sm font-medium hover:bg-coralDark transition ${getGithubToken() ? '' : 'opacity-50 cursor-not-allowed'}" ${getGithubToken() ? '' : 'disabled'}>
                Sync Now
              </button>
              <button onclick="loadCloudData().then(() => render())" class="px-4 py-2 bg-warmgray text-charcoal rounded text-sm font-medium hover:bg-softborder transition">
                Pull from Cloud
              </button>
              <span class="flex items-center text-xs text-charcoal/50">
                ${getGithubToken() ? '<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Connected' : '<span class="w-2 h-2 rounded-full bg-charcoal/30 mr-2"></span> Not connected'}
              </span>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Data Management <span class="text-coral">‚Üí</span></h3>
            <div class="flex flex-wrap gap-3">
              <button onclick="exportData()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                Export All Data
              </button>
              <label class="sb-btn px-4 py-2 rounded text-sm font-medium cursor-pointer">
                Import Data
                <input type="file" accept=".json" class="hidden" onchange="importData(event)">
              </label>
            </div>
            <p class="text-xs text-charcoal/40 mt-3">
              Export creates a local backup JSON file. Import merges data from a backup file.
            </p>
          </div>
        </div>
      `;
    }

    // ============ TASKS TAB RENDERING ============
    function renderTasksTab() {
      const allPerspectives = [...BUILTIN_PERSPECTIVES, ...customPerspectives];
      const currentPerspective = allPerspectives.find(p => p.id === activePerspective) || BUILTIN_PERSPECTIVES[0];
      const filteredTasks = getFilteredTasks(activePerspective);

      // Count tasks per perspective
      const taskCounts = {};
      BUILTIN_PERSPECTIVES.forEach(p => {
        taskCounts[p.id] = getFilteredTasks(p.id).length;
      });
      customPerspectives.forEach(p => {
        taskCounts[p.id] = getFilteredTasks(p.id).length;
      });

      // Build sidebar
      const sidebarHtml = `
        <div class="w-64 flex-shrink-0">
          <div class="sb-card rounded-lg overflow-hidden">
            <div class="px-4 py-3 bg-warmgray border-b border-softborder">
              <h3 class="font-semibold text-charcoal text-sm">Perspectives</h3>
            </div>
            <div class="bg-white">
              ${BUILTIN_PERSPECTIVES.map(p => `
                <button onclick="activePerspective='${p.id}'; render()"
                  class="w-full px-4 py-2.5 flex items-center justify-between hover:bg-warmgray transition text-left ${activePerspective === p.id ? 'bg-coral/10 border-r-2 border-coral' : ''}">
                  <span class="flex items-center gap-2">
                    <span>${p.icon}</span>
                    <span class="text-sm ${activePerspective === p.id ? 'font-medium text-charcoal' : 'text-charcoal/70'}">${p.name}</span>
                  </span>
                  <span class="text-xs ${activePerspective === p.id ? 'text-coral font-medium' : 'text-charcoal/40'}">${taskCounts[p.id] || ''}</span>
                </button>
              `).join('')}

              ${customPerspectives.length > 0 ? `
                <div class="px-4 py-2 border-t border-softborder">
                  <span class="text-xs font-medium text-charcoal/50 uppercase tracking-wide">Custom</span>
                </div>
                ${customPerspectives.map(p => `
                  <button onclick="activePerspective='${p.id}'; render()"
                    class="w-full px-4 py-2.5 flex items-center justify-between hover:bg-warmgray transition text-left ${activePerspective === p.id ? 'bg-coral/10 border-r-2 border-coral' : ''}">
                    <span class="flex items-center gap-2">
                      <span>${p.icon}</span>
                      <span class="text-sm ${activePerspective === p.id ? 'font-medium text-charcoal' : 'text-charcoal/70'}">${p.name}</span>
                    </span>
                    <span class="text-xs ${activePerspective === p.id ? 'text-coral font-medium' : 'text-charcoal/40'}">${taskCounts[p.id] || ''}</span>
                  </button>
                `).join('')}
              ` : ''}

              <div class="px-4 py-3 border-t border-softborder">
                <button onclick="showPerspectiveModal=true; render()"
                  class="w-full px-3 py-2 text-sm text-coral hover:bg-coral/10 rounded transition flex items-center justify-center gap-1">
                  <span>+</span> New Perspective
                </button>
              </div>
            </div>
          </div>

          <!-- Categories -->
          <div class="sb-card rounded-lg overflow-hidden mt-4">
            <div class="px-4 py-3 bg-warmgray border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal text-sm">Categories</h3>
              <button onclick="editingCategoryId=null; showCategoryModal=true; render()" class="text-coral text-xs hover:underline">+ Add</button>
            </div>
            <div class="bg-white p-2 space-y-0.5">
              ${taskCategories.map(cat => `
                <div class="flex items-center justify-between px-2 py-1.5 rounded hover:bg-warmgray group">
                  <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full" style="background-color: ${cat.color}"></span>
                    <span class="text-sm text-charcoal/70">${cat.name}</span>
                  </div>
                  <button onclick="editingCategoryId='${cat.id}'; showCategoryModal=true; render()"
                    class="text-xs text-charcoal/30 hover:text-charcoal opacity-0 group-hover:opacity-100">Edit</button>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Labels -->
          <div class="sb-card rounded-lg overflow-hidden mt-4">
            <div class="px-4 py-3 bg-warmgray border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal text-sm">Labels</h3>
              <button onclick="editingLabelId=null; showLabelModal=true; render()" class="text-coral text-xs hover:underline">+ Add</button>
            </div>
            <div class="bg-white p-2 space-y-0.5">
              ${taskLabels.map(label => `
                <div class="flex items-center justify-between px-2 py-1.5 rounded hover:bg-warmgray group">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded" style="background-color: ${label.color}"></span>
                    <span class="text-sm text-charcoal/70">${label.name}</span>
                  </div>
                  <button onclick="editingLabelId='${label.id}'; showLabelModal=true; render()"
                    class="text-xs text-charcoal/30 hover:text-charcoal opacity-0 group-hover:opacity-100">Edit</button>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      // Build task list
      const taskListHtml = `
        <div class="flex-1">
          <div class="sb-card rounded-lg overflow-hidden">
            <div class="px-5 py-4 bg-warmgray border-b border-softborder flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-xl">${currentPerspective.icon}</span>
                <h2 class="text-lg font-semibold text-charcoal">${currentPerspective.name}</h2>
                <span class="text-sm text-charcoal/50">${filteredTasks.length} task${filteredTasks.length !== 1 ? 's' : ''}</span>
              </div>
              <button onclick="showTaskModal=true; editingTaskId=null; render()"
                class="sb-btn px-4 py-2 rounded text-sm font-medium flex items-center gap-1">
                <span>+</span> Add Task
              </button>
            </div>

            <div class="bg-white min-h-[400px]">
              ${filteredTasks.length === 0 ? `
                <div class="flex flex-col items-center justify-center py-16 text-charcoal/40">
                  <span class="text-4xl mb-3">${currentPerspective.icon}</span>
                  <p class="text-sm">No tasks in ${currentPerspective.name}</p>
                  ${activePerspective === 'inbox' ? '<p class="text-xs mt-1">Add a task to get started!</p>' : ''}
                </div>
              ` : `
                <div class="divide-y divide-softborder">
                  ${filteredTasks.map(task => {
                    const category = getCategoryById(task.categoryId);
                    const labels = (task.labels || []).map(lid => getLabelById(lid)).filter(Boolean);
                    const today = new Date().toISOString().split('T')[0];
                    const isOverdue = task.dueDate && task.dueDate < today && !task.completed;
                    return `
                      <div class="px-5 py-3 flex items-start gap-3 hover:bg-warmgray/50 transition group">
                        <button onclick="toggleTaskComplete('${task.id}')"
                          class="mt-0.5 w-5 h-5 rounded-full border-2 flex items-center justify-center transition ${task.completed ? 'bg-coral border-coral text-white' : 'border-charcoal/30 hover:border-coral'}">
                          ${task.completed ? '<span class="text-xs">‚úì</span>' : ''}
                        </button>
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 flex-wrap">
                            <span class="${task.completed ? 'line-through text-charcoal/40' : 'text-charcoal'} font-medium">${task.title}</span>
                            ${category ? `<span class="px-2 py-0.5 text-xs rounded-full text-white" style="background-color: ${category.color}">${category.name}</span>` : ''}
                            ${labels.map(l => `<span class="px-1.5 py-0.5 text-xs rounded border" style="border-color: ${l.color}; color: ${l.color}">${l.name}</span>`).join('')}
                          </div>
                          ${task.notes ? `<p class="text-sm text-charcoal/50 mt-0.5 truncate">${task.notes}</p>` : ''}
                          ${task.dueDate ? `<p class="text-xs mt-1 ${isOverdue ? 'text-red-500 font-medium' : 'text-charcoal/40'}">${isOverdue ? '‚ö†Ô∏è Overdue: ' : 'üìÖ '}${new Date(task.dueDate).toLocaleDateString()}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                          ${!task.completed ? `
                            <select onchange="moveTaskTo('${task.id}', this.value); this.value=''"
                              class="text-xs px-2 py-1 border border-softborder rounded bg-white text-charcoal/70">
                              <option value="">Move to...</option>
                              <option value="inbox">üì• Inbox</option>
                              <option value="today">‚≠ê Today</option>
                              <option value="anytime">üìã Anytime</option>
                              <option value="someday">üí≠ Someday</option>
                            </select>
                          ` : ''}
                          <button onclick="editingTaskId='${task.id}'; showTaskModal=true; render()"
                            class="px-2 py-1 text-xs text-charcoal/50 hover:text-charcoal">Edit</button>
                          <button onclick="if(confirm('Delete this task?')) { deleteTask('${task.id}'); render(); }"
                            class="px-2 py-1 text-xs text-red-400 hover:text-red-600">Delete</button>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;

      // Task Modal
      const editingTask = editingTaskId ? tasksData.find(t => t.id === editingTaskId) : null;
      const taskModalHtml = showTaskModal ? `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target===this){showTaskModal=false; editingTaskId=null; render()}">
          <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal">${editingTask ? 'Edit Task' : 'New Task'}</h3>
              <button onclick="showTaskModal=false; editingTaskId=null; render()" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Title</label>
                <input type="text" id="task-title" value="${editingTask ? editingTask.title : ''}"
                  placeholder="What needs to be done?"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Notes</label>
                <textarea id="task-notes" rows="3" placeholder="Add details..."
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none resize-none">${editingTask ? editingTask.notes : ''}</textarea>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-charcoal/70 block mb-1">When</label>
                  <select id="task-status" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
                    <option value="inbox" ${editingTask?.status === 'inbox' ? 'selected' : ''}>üì• Inbox</option>
                    <option value="today" ${editingTask?.status === 'today' ? 'selected' : ''}>‚≠ê Today</option>
                    <option value="anytime" ${editingTask?.status === 'anytime' ? 'selected' : ''}>üìã Anytime</option>
                    <option value="someday" ${editingTask?.status === 'someday' ? 'selected' : ''}>üí≠ Someday</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm text-charcoal/70 block mb-1">Category</label>
                  <select id="task-category" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
                    <option value="">None</option>
                    ${taskCategories.map(cat => `
                      <option value="${cat.id}" ${editingTask?.categoryId === cat.id ? 'selected' : ''}>${cat.name}</option>
                    `).join('')}
                  </select>
                </div>
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Due Date</label>
                <input type="date" id="task-due" value="${editingTask?.dueDate || ''}"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Labels</label>
                <div class="flex flex-wrap gap-2" id="task-labels-container">
                  ${taskLabels.map(label => {
                    const isSelected = editingTask?.labels?.includes(label.id);
                    return `
                      <label class="flex items-center gap-1.5 px-2 py-1 rounded border cursor-pointer transition ${isSelected ? 'bg-warmgray' : 'hover:bg-warmgray/50'}" style="border-color: ${label.color}">
                        <input type="checkbox" value="${label.id}" ${isSelected ? 'checked' : ''} class="task-label-checkbox rounded" style="accent-color: ${label.color}">
                        <span class="text-sm" style="color: ${label.color}">${label.name}</span>
                      </label>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-end gap-3">
              <button onclick="showTaskModal=false; editingTaskId=null; render()"
                class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
              <button onclick="saveTaskFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                ${editingTask ? 'Save Changes' : 'Add Task'}
              </button>
            </div>
          </div>
        </div>
      ` : '';

      // Perspective Modal
      const perspectiveModalHtml = showPerspectiveModal ? `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target===this){showPerspectiveModal=false; render()}">
          <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal">New Perspective</h3>
              <button onclick="showPerspectiveModal=false; render()" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="perspective-name" placeholder="e.g., Work Projects"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Icon (emoji)</label>
                <input type="text" id="perspective-icon" value="üìå" maxlength="2"
                  class="w-20 px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none text-center text-xl">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Filter by Category</label>
                <select id="perspective-category" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
                  <option value="">Any category</option>
                  ${taskCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Filter by Status</label>
                <select id="perspective-status" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
                  <option value="">Any status</option>
                  <option value="inbox">Inbox</option>
                  <option value="today">Today</option>
                  <option value="anytime">Anytime</option>
                  <option value="someday">Someday</option>
                </select>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="perspective-due" class="rounded border-softborder">
                <label for="perspective-due" class="text-sm text-charcoal/70">Only show tasks with due dates</label>
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-end gap-3">
              <button onclick="showPerspectiveModal=false; render()"
                class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
              <button onclick="savePerspectiveFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                Create Perspective
              </button>
            </div>
          </div>
        </div>
      ` : '';

      // Category Modal
      const editingCategory = editingCategoryId ? taskCategories.find(c => c.id === editingCategoryId) : null;
      const categoryModalHtml = showCategoryModal ? `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target===this){showCategoryModal=false; editingCategoryId=null; render()}">
          <div class="bg-white rounded-xl shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal">${editingCategory ? 'Edit Category' : 'New Category'}</h3>
              <button onclick="showCategoryModal=false; editingCategoryId=null; render()" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="category-name" value="${editingCategory?.name || ''}"
                  placeholder="e.g., Projects"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Color</label>
                <input type="color" id="category-color" value="${editingCategory?.color || '#6B7280'}"
                  class="w-full h-10 rounded border border-softborder cursor-pointer">
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-between">
              ${editingCategory ? `
                <button onclick="if(confirm('Delete this category?')){deleteCategory('${editingCategory.id}'); showCategoryModal=false; editingCategoryId=null; render();}"
                  class="px-4 py-2 text-sm text-red-500 hover:text-red-700">Delete</button>
              ` : '<div></div>'}
              <div class="flex gap-3">
                <button onclick="showCategoryModal=false; editingCategoryId=null; render()"
                  class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
                <button onclick="saveCategoryFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  ${editingCategory ? 'Save' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      // Label Modal
      const editingLabel = editingLabelId ? taskLabels.find(l => l.id === editingLabelId) : null;
      const labelModalHtml = showLabelModal ? `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target===this){showLabelModal=false; editingLabelId=null; render()}">
          <div class="bg-white rounded-xl shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal">${editingLabel ? 'Edit Label' : 'New Label'}</h3>
              <button onclick="showLabelModal=false; editingLabelId=null; render()" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="label-name" value="${editingLabel?.name || ''}"
                  placeholder="e.g., Important"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Color</label>
                <input type="color" id="label-color" value="${editingLabel?.color || '#6B7280'}"
                  class="w-full h-10 rounded border border-softborder cursor-pointer">
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-between">
              ${editingLabel ? `
                <button onclick="if(confirm('Delete this label?')){deleteLabel('${editingLabel.id}'); showLabelModal=false; editingLabelId=null; render();}"
                  class="px-4 py-2 text-sm text-red-500 hover:text-red-700">Delete</button>
              ` : '<div></div>'}
              <div class="flex gap-3">
                <button onclick="showLabelModal=false; editingLabelId=null; render()"
                  class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
                <button onclick="saveLabelFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  ${editingLabel ? 'Save' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      return `
        <div class="flex gap-6">
          ${sidebarHtml}
          ${taskListHtml}
        </div>
        ${taskModalHtml}
        ${perspectiveModalHtml}
        ${categoryModalHtml}
        ${labelModalHtml}
      `;
    }

    // Save category from modal
    function saveCategoryFromModal() {
      const name = document.getElementById('category-name').value.trim();
      if (!name) {
        alert('Please enter a category name');
        return;
      }
      const color = document.getElementById('category-color').value;

      if (editingCategoryId) {
        updateCategory(editingCategoryId, { name, color });
      } else {
        createCategory(name, color);
      }
      showCategoryModal = false;
      editingCategoryId = null;
      render();
    }

    // Save label from modal
    function saveLabelFromModal() {
      const name = document.getElementById('label-name').value.trim();
      if (!name) {
        alert('Please enter a label name');
        return;
      }
      const color = document.getElementById('label-color').value;

      if (editingLabelId) {
        updateLabel(editingLabelId, { name, color });
      } else {
        createLabel(name, color);
      }
      showLabelModal = false;
      editingLabelId = null;
      render();
    }

    // Save task from modal
    function saveTaskFromModal() {
      const title = document.getElementById('task-title').value.trim();
      if (!title) {
        alert('Please enter a task title');
        return;
      }

      // Get selected labels
      const labelCheckboxes = document.querySelectorAll('.task-label-checkbox:checked');
      const selectedLabels = Array.from(labelCheckboxes).map(cb => cb.value);

      const taskData = {
        title: title,
        notes: document.getElementById('task-notes').value.trim(),
        status: document.getElementById('task-status').value,
        categoryId: document.getElementById('task-category').value || null,
        dueDate: document.getElementById('task-due').value || null,
        labels: selectedLabels
      };

      if (editingTaskId) {
        updateTask(editingTaskId, taskData);
      } else {
        createTask(title, taskData);
      }

      showTaskModal = false;
      editingTaskId = null;
      render();
    }

    // Save perspective from modal
    function savePerspectiveFromModal() {
      const name = document.getElementById('perspective-name').value.trim();
      if (!name) {
        alert('Please enter a perspective name');
        return;
      }

      const icon = document.getElementById('perspective-icon').value || 'üìå';
      const filter = {};

      const categoryId = document.getElementById('perspective-category').value;
      if (categoryId) filter.categoryId = categoryId;

      const status = document.getElementById('perspective-status').value;
      if (status) filter.status = status;

      if (document.getElementById('perspective-due').checked) {
        filter.hasDueDate = true;
      }

      createPerspective(name, icon, filter);
      showPerspectiveModal = false;
      activePerspective = customPerspectives[customPerspectives.length - 1].id;
      render();
    }

    function exportData() {
      const exportObj = {
        data: allData,
        weights: WEIGHTS,
        tasks: tasksData,
        taskCategories: taskCategories,
        taskLabels: taskLabels,
        customPerspectives: customPerspectives,
        lastUpdated: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'life-gamification-backup-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }


    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (imported.data) {
            allData = imported.data;
            saveData();
          }
          if (imported.weights) {
            WEIGHTS = imported.weights;
            saveWeights();
          }
          if (imported.tasks) {
            tasksData = imported.tasks;
            localStorage.setItem(TASKS_KEY, JSON.stringify(tasksData));
          }
          if (imported.taskCategories) {
            taskCategories = imported.taskCategories;
            localStorage.setItem(TASK_CATEGORIES_KEY, JSON.stringify(taskCategories));
          }
          if (imported.taskLabels) {
            taskLabels = imported.taskLabels;
            localStorage.setItem(TASK_LABELS_KEY, JSON.stringify(taskLabels));
          }
          if (imported.customPerspectives) {
            customPerspectives = imported.customPerspectives;
            localStorage.setItem(PERSPECTIVES_KEY, JSON.stringify(customPerspectives));
          }
          alert('Data imported successfully!');
          debouncedSaveToGithub();
          render();
        } catch (err) {
          alert('Error importing data: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // Initialize: load cloud data then render
    loadCloudData().then(() => render());
  </script>
</body>
</html>
