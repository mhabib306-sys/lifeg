<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life Gamification v3.0</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='10' y='10' width='80' height='80' rx='12' fill='%231a1a1a'/><rect x='24' y='20' width='22' height='22' rx='4' fill='%23F7F6F4'/><rect x='24' y='46' width='22' height='22' rx='4' fill='%23F7F6F4'/><rect x='50' y='46' width='22' height='22' rx='4' fill='%23E5533D'/><rect x='24' y='72' width='22' height='10' rx='3' fill='%23F7F6F4' opacity='0.5'/></svg>">
  <!-- Inter font - closest match to SF Pro -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cream: 'var(--bg-primary)',
            warmgray: 'var(--bg-secondary)',
            charcoal: 'var(--text-primary)',
            coral: 'var(--accent)',
            coralDark: 'var(--accent-dark)',
            softborder: 'var(--border)'
          },
          fontFamily: {
            sans: ['var(--font-family)'],
          }
        }
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* Theme: SimpleBits (default) */
    :root, [data-theme="simplebits"] {
      --bg-primary: #F7F6F4;
      --bg-secondary: #EFEDE8;
      --bg-card: #EFEDE8;
      --bg-input: #FFFFFF;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --text-muted: #999999;
      --accent: #E5533D;
      --accent-dark: #C4432F;
      --accent-light: rgba(229, 83, 61, 0.1);
      --accent-hover: rgba(229, 83, 61, 0.08);
      --border: #E5E3DE;
      --border-light: #F0EEE9;
      --success: #22C55E;
      --btn-bg: #1a1a1a;
      --btn-hover: #333333;
      --sidebar-bg: #EFEDE8;
      --sidebar-active: rgba(229, 83, 61, 0.12);
      --modal-bg: #FFFFFF;
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      --border-radius: 8px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    }

    /* Theme: Things 3 - Exact Match */
    [data-theme="things3"] {
      /* Backgrounds */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F7;
      --bg-card: #FFFFFF;
      --bg-input: #FFFFFF;
      --bg-hover: #F5F5F7;

      /* Typography */
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --text-muted: #AEAEB2;

      /* Things 3 Accent Blue */
      --accent: #147EFB;
      --accent-dark: #0066DC;
      --accent-light: rgba(20, 126, 251, 0.08);
      --accent-hover: rgba(0, 0, 0, 0.03);

      /* Borders */
      --border: #E5E5EA;
      --border-light: #F2F2F7;

      /* Status colors */
      --success: #34C759;
      --warning: #FF9500;
      --danger: #FF3B30;

      /* Things 3 perspective colors */
      --inbox-color: #147EFB;
      --today-color: #FFCC00;
      --upcoming-color: #FF3B30;
      --anytime-color: #5AC8FA;
      --someday-color: #C69C6D;
      --logbook-color: #34C759;

      /* Buttons */
      --btn-bg: #147EFB;
      --btn-hover: #0066DC;

      /* Sidebar */
      --sidebar-bg: #F5F5F7;
      --sidebar-active: rgba(0, 0, 0, 0.05);
      --sidebar-hover: rgba(0, 0, 0, 0.03);

      /* Modal */
      --modal-bg: #FFFFFF;
      --modal-overlay: rgba(0, 0, 0, 0.3);

      /* Font */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', system-ui, sans-serif;

      /* Radius - Things 3 uses subtle rounding */
      --border-radius: 8px;
      --border-radius-lg: 12px;
      --border-radius-sm: 6px;

      /* Shadows - Things 3 uses very subtle shadows */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
      --shadow-modal: 0 20px 40px rgba(0,0,0,0.15);
    }

    body {
      font-feature-settings: 'kern' 1, 'liga' 1;
      font-family: var(--font-family);
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
    }
    .sb-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      transition: background 0.3s ease, border-color 0.3s ease;
    }
    .sb-btn {
      background: var(--btn-bg);
      color: white;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: var(--border-radius);
    }
    .sb-btn:hover {
      background: var(--btn-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    .sb-btn:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .sb-link { color: var(--accent); text-decoration: underline; text-underline-offset: 2px; }
    .sb-link:hover { color: var(--accent-dark); }
    .sb-section-title {
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    input[type="number"], input[type="text"], textarea, select {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: calc(var(--border-radius) - 2px);
      color: var(--text-primary);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input[type="number"]:focus, input[type="text"]:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    /* Quick add input - no border */
    #quick-add-input {
      border: none !important;
      box-shadow: none !important;
      background: transparent !important;
    }
    #quick-add-input:focus {
      border: none !important;
      box-shadow: none !important;
    }

    /* Toggle switch */
    .toggle-switch {
      cursor: pointer;
    }
    .toggle-on {
      background-color: var(--accent);
    }
    .toggle-off {
      background-color: #d1d5db;
    }
    .toggle-switch:hover .toggle-on {
      background-color: var(--accent-dark);
    }
    .toggle-switch:hover .toggle-off {
      background-color: #c0c4cc;
    }

    /* Checkbox styling */
    input[type="checkbox"] {
      accent-color: var(--accent);
    }
    input[type="checkbox"]:focus {
      outline: 2px solid var(--accent-light);
      outline-offset: 2px;
    }

    /* Things 3 exact micro-interactions */

    /* Task item - Things 3 style (no left border, subtle hover) */
    .task-item {
      transition: background 0.15s ease, border-radius 0.15s ease;
      border-left: none;
      border-radius: 8px;
      margin: 0 4px;
    }
    .task-item:hover {
      background: var(--accent-hover);
    }
    .task-item:active {
      background: var(--accent-light);
    }

    /* Checkbox - Things 3 style (thin circle, smooth animations) */
    .task-checkbox {
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
    }
    .task-checkbox:hover {
      transform: scale(1.15);
      border-color: var(--accent) !important;
    }
    .task-checkbox:active {
      transform: scale(0.95);
    }
    .task-checkbox.completed {
      animation: checkPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      background: var(--accent) !important;
      border-color: var(--accent) !important;
    }
    @keyframes checkPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    /* Sidebar item interactions - Things 3 style */
    .sidebar-item {
      transition: all 0.1s ease-out;
      border-radius: 8px;
    }
    .sidebar-item:hover {
      background: rgba(0, 0, 0, 0.04);
    }
    .sidebar-item:active {
      background: rgba(0, 0, 0, 0.06);
      transform: scale(0.99);
    }
    .sidebar-item.active {
      background: rgba(0, 0, 0, 0.06);
    }

    /* Nav tab hover */
    .nav-tab {
      position: relative;
    }
    .nav-tab:hover {
      background: rgba(0, 0, 0, 0.04);
    }
    .nav-tab:active {
      background: rgba(0, 0, 0, 0.06);
    }
    .drag-handle {
      opacity: 0;
      cursor: grab;
      transition: opacity 0.12s ease;
    }
    .sidebar-item:hover .drag-handle {
      opacity: 0.4;
    }
    .drag-handle:hover {
      opacity: 1 !important;
    }

    /* Category/Label pill interactions */
    .tag-pill {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }
    .tag-pill:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .tag-pill:active {
      transform: scale(0.98);
    }

    /* Button micro-interactions */
    .action-btn {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
    }
    .task-item:hover .action-btn {
      opacity: 1;
    }
    .action-btn:hover {
      transform: scale(1.1);
    }
    .action-btn:active {
      transform: scale(0.95);
    }

    /* Move dropdown */
    .move-dropdown {
      transition: all 0.15s ease;
      opacity: 0;
      transform: translateY(-2px);
    }
    .task-item:hover .move-dropdown {
      opacity: 1;
      transform: translateY(0);
    }

    /* Drag and drop - Things 3 style */
    .task-item {
      cursor: grab;
    }
    .task-item:active {
      cursor: grabbing;
    }
    .task-item.dragging {
      opacity: 0.4;
      transform: scale(1.02);
      box-shadow: var(--shadow-lg);
      background: var(--bg-card);
      z-index: 100;
    }
    .task-item.drag-over {
      position: relative;
    }
    .task-item.drag-over::before {
      content: '';
      position: absolute;
      top: -2px;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent);
      border-radius: 2px;
      box-shadow: 0 0 8px var(--accent);
      z-index: 10;
    }
    .task-item.drag-over-bottom {
      position: relative;
    }
    .task-item.drag-over-bottom::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent);
      border-radius: 2px;
      box-shadow: 0 0 8px var(--accent);
      z-index: 10;
    }
    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      opacity: 0.9;
      transform: rotate(2deg);
    }
    .drag-indicator {
      cursor: grab;
    }
    .drag-indicator:active {
      cursor: grabbing;
    }
    .task-list.is-dragging .task-item:not(.dragging) {
      transition: transform 0.2s ease;
    }
    .task-item.dragging .drag-indicator {
      background: var(--accent) !important;
    }

    /* Home widgets */
    .widget {
      transition: all 0.2s ease;
    }
    .widget.dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }
    .widget-drop-target.drag-over {
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
    }

    /* Sidebar draggable items */
    .draggable-item {
      cursor: grab;
      transition: all 0.15s ease;
      -webkit-user-select: none;
      user-select: none;
      position: relative;
    }
    .draggable-item:active {
      cursor: grabbing;
    }
    .draggable-item.dragging {
      opacity: 0.5;
      background: rgba(0, 0, 0, 0.08) !important;
    }
    .draggable-item.drag-over {
      position: relative;
    }
    .draggable-item.drag-over::before {
      content: '';
      position: absolute;
      top: -1px;
      left: 8px;
      right: 8px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
      z-index: 10;
    }
    .draggable-item.drag-over-bottom {
      position: relative;
    }
    .draggable-item.drag-over-bottom::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 8px;
      right: 8px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
      z-index: 10;
    }

    /* Modal animations */
    .modal-overlay {
      animation: fadeIn 0.2s ease-out;
    }
    .modal-content {
      animation: slideUp 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Input focus animations */
    .task-input {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .task-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
      transform: scale(1.01);
    }

    /* Label checkbox interactions */
    .label-checkbox {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .label-checkbox:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .label-checkbox:has(input:checked) {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Add button pulse */
    .add-task-btn {
      position: relative;
      overflow: hidden;
    }
    .add-task-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: translateX(-100%);
      transition: transform 0.5s;
    }
    .add-task-btn:hover::after {
      transform: translateX(100%);
    }

    /* Empty state animation */
    .empty-state {
      animation: fadeInUp 0.4s ease-out;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Perspective count badge */
    .count-badge {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .sidebar-item:hover .count-badge {
      transform: scale(1.1);
    }

    /* Smooth scrollbar */
    .task-list::-webkit-scrollbar {
      width: 6px;
    }
    .task-list::-webkit-scrollbar-track {
      background: transparent;
    }
    .task-list::-webkit-scrollbar-thumb {
      background: rgba(26, 26, 26, 0.2);
      border-radius: 3px;
    }
    .task-list::-webkit-scrollbar-thumb:hover {
      background: rgba(26, 26, 26, 0.3);
    }

    /* Prayer input specific styling */
    .prayer-input {
      min-width: 50px;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      /* Header adjustments */
      header .max-w-5xl {
        padding-left: 1rem;
        padding-right: 1rem;
      }

      /* Tab buttons */
      header button {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
        font-size: 0.875rem;
      }

      /* Main content container */
      .max-w-5xl {
        padding-left: 1rem;
        padding-right: 1rem;
      }

      /* Sidebar and main layout - stack vertically on mobile */
      .mobile-layout {
        flex-direction: column;
      }

      .mobile-sidebar {
        width: 100% !important;
        flex-shrink: 1 !important;
      }

      .mobile-main {
        width: 100% !important;
      }

      /* Hide desktop sidebar on mobile, show mobile nav */
      .desktop-sidebar {
        display: none;
      }

      .mobile-nav {
        display: flex;
      }

      /* Prayer inputs on mobile */
      .prayer-input {
        font-size: 1rem;
        padding: 0.625rem 0.5rem;
      }

      /* Cards on mobile */
      .sb-card {
        border-radius: 0.5rem;
      }

      /* Task items spacing */
      .task-item {
        padding: 0.75rem;
      }

      /* Modal adjustments */
      .modal-content {
        margin: 1rem;
        max-height: calc(100vh - 2rem);
        width: calc(100% - 2rem);
      }

      /* Table scrolling for bulk edit */
      .bulk-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Score cards grid */
      .score-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      /* Charts container */
      .chart-container {
        height: 200px !important;
      }

      /* Settings sections */
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Small mobile (iPhone SE, etc.) */
    @media (max-width: 375px) {
      header .max-w-5xl {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }

      .prayer-input {
        font-size: 0.875rem;
        padding: 0.5rem 0.375rem;
      }

      .score-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Large phones (iPhone Pro Max, etc.) */
    @media (min-width: 390px) and (max-width: 768px) {
      .prayer-input {
        min-width: 55px;
      }
    }

    /* Touch-friendly tap targets */
    @media (hover: none) and (pointer: coarse) {
      .sidebar-item {
        min-height: 44px;
        padding-top: 0.625rem;
        padding-bottom: 0.625rem;
      }

      .action-btn {
        opacity: 1;
        min-width: 44px;
        min-height: 44px;
      }

      button, .sb-btn {
        min-height: 44px;
      }

      input[type="checkbox"] {
        min-width: 20px;
        min-height: 20px;
      }
    }

    /* iOS safe areas */
    @supports (padding: max(0px)) {
      body {
        padding-left: max(0px, env(safe-area-inset-left));
        padding-right: max(0px, env(safe-area-inset-right));
        padding-bottom: max(0px, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body class="min-h-screen" style="background: var(--bg-primary); color: var(--text-primary);">
  <div id="app"></div>

  <script>
    // App Version (MAJOR.MINOR.PATCH)
    // MAJOR: New major features (Home view, Next perspective, etc.)
    // MINOR: Enhancements and improvements
    // PATCH: Bug fixes and small tweaks
    const APP_VERSION = '3.2.0';

    const STORAGE_KEY = 'lifeGamificationData_v3';
    const WEIGHTS_KEY = 'lifeGamificationWeights_v1';
    const GITHUB_TOKEN_KEY = 'lifeGamificationGithubToken';
    const THEME_KEY = 'lifeGamificationTheme';
    const DATA_URL = 'data.json';

    // Available themes
    const THEMES = {
      simplebits: { name: 'SimpleBits', description: 'Warm cream tones with coral accents' },
      things3: { name: 'Things 3', description: 'Clean white with blue accents' }
    };

    // GitHub repo config
    const GITHUB_OWNER = 'mhabib306-sys';
    const GITHUB_REPO = 'lifeg';
    const GITHUB_FILE_PATH = 'data.json';

    // Sync status
    let syncStatus = 'idle'; // 'idle', 'syncing', 'success', 'error'
    let lastSyncTime = null;
    let syncDebounceTimer = null;

    // Get stored GitHub token
    function getGithubToken() {
      return localStorage.getItem(GITHUB_TOKEN_KEY) || '';
    }

    // Save GitHub token
    function setGithubToken(token) {
      localStorage.setItem(GITHUB_TOKEN_KEY, token);
      render();
    }

    // Get stored theme
    function getTheme() {
      return localStorage.getItem(THEME_KEY) || 'simplebits';
    }

    // Set theme
    function setTheme(themeName) {
      localStorage.setItem(THEME_KEY, themeName);
      document.documentElement.setAttribute('data-theme', themeName);
      render();
    }

    // Apply theme on load
    function applyStoredTheme() {
      const theme = getTheme();
      document.documentElement.setAttribute('data-theme', theme);
    }
    applyStoredTheme();

    // Get current accent color from theme
    function getAccentColor() {
      return getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    }

    // Get theme colors object
    function getThemeColors() {
      const style = getComputedStyle(document.documentElement);
      return {
        accent: style.getPropertyValue('--accent').trim(),
        accentDark: style.getPropertyValue('--accent-dark').trim(),
        accentLight: style.getPropertyValue('--accent-light').trim(),
        bgPrimary: style.getPropertyValue('--bg-primary').trim(),
        bgSecondary: style.getPropertyValue('--bg-secondary').trim(),
        textPrimary: style.getPropertyValue('--text-primary').trim()
      };
    }

    // Update sync status in UI
    function updateSyncStatus(status, message = '') {
      syncStatus = status;
      const indicator = document.getElementById('sync-indicator');
      if (indicator) {
        const colors = {
          idle: 'bg-charcoal/30',
          syncing: 'bg-amber-400 animate-pulse',
          success: 'bg-green-500',
          error: 'bg-red-500'
        };
        const icons = {
          idle: 'â˜ï¸',
          syncing: 'ðŸ”„',
          success: 'âœ“',
          error: 'âœ—'
        };
        indicator.className = `w-2 h-2 rounded-full ${colors[status]}`;
        indicator.title = message || status;
      }
      if (status === 'success') {
        lastSyncTime = new Date();
        setTimeout(() => {
          if (syncStatus === 'success') updateSyncStatus('idle');
        }, 3000);
      }
    }

    // Save data to GitHub
    async function saveToGithub() {
      const token = getGithubToken();
      if (!token) {
        console.log('âš ï¸ No GitHub token configured');
        return false;
      }

      updateSyncStatus('syncing', 'Saving to GitHub...');

      try {
        // Get current file SHA (needed for updates)
        const getResponse = await fetch(
          `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
          { headers: { 'Authorization': `token ${token}` } }
        );

        let sha = null;
        if (getResponse.ok) {
          const fileData = await getResponse.json();
          sha = fileData.sha;
        }

        // Prepare data payload
        const payload = {
          lastUpdated: new Date().toISOString(),
          data: allData,
          weights: WEIGHTS,
          maxScores: MAX_SCORES,
          tasks: tasksData,
          taskCategories: taskCategories,
          taskLabels: taskLabels,
          customPerspectives: customPerspectives
        };

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2))));

        // Update file via GitHub API
        const updateResponse = await fetch(
          `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `token ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Auto-save: ${new Date().toLocaleString()}`,
              content: content,
              sha: sha
            })
          }
        );

        if (updateResponse.ok) {
          updateSyncStatus('success', 'Saved to GitHub');
          console.log('âœ… Saved to GitHub');
          return true;
        } else {
          const error = await updateResponse.json();
          throw new Error(error.message || 'Failed to save');
        }
      } catch (e) {
        updateSyncStatus('error', `Sync failed: ${e.message}`);
        console.error('âŒ GitHub save failed:', e);
        return false;
      }
    }

    // Debounced save (waits 2 seconds after last change)
    function debouncedSaveToGithub() {
      if (syncDebounceTimer) clearTimeout(syncDebounceTimer);
      syncDebounceTimer = setTimeout(() => {
        saveToGithub();
      }, 2000);
    }

    // Load cloud data on startup
    async function loadCloudData() {
      const token = getGithubToken();

      try {
        // Try GitHub API first if token exists
        if (token) {
          const response = await fetch(
            `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
            { headers: { 'Authorization': `token ${token}` } }
          );

          if (response.ok) {
            const fileData = await response.json();
            const cloudData = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));

            if (cloudData.data) {
              // Merge cloud data with local
              const localData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
              Object.keys(cloudData.data).forEach(date => {
                if (!localData[date]) {
                  localData[date] = cloudData.data[date];
                }
              });
              localStorage.setItem(STORAGE_KEY, JSON.stringify(localData));
              allData = localData;
            }
            if (cloudData.weights) {
              WEIGHTS = cloudData.weights;
              localStorage.setItem(WEIGHTS_KEY, JSON.stringify(WEIGHTS));
            }
            if (cloudData.maxScores) {
              MAX_SCORES = cloudData.maxScores;
              localStorage.setItem('maxScores', JSON.stringify(MAX_SCORES));
            }
            if (cloudData.tasks) {
              tasksData = cloudData.tasks;
              localStorage.setItem(TASKS_KEY, JSON.stringify(tasksData));
            }
            if (cloudData.taskCategories) {
              taskCategories = cloudData.taskCategories;
              localStorage.setItem(TASK_CATEGORIES_KEY, JSON.stringify(taskCategories));
            }
            if (cloudData.taskLabels) {
              taskLabels = cloudData.taskLabels;
              localStorage.setItem(TASK_LABELS_KEY, JSON.stringify(taskLabels));
            }
            if (cloudData.customPerspectives) {
              customPerspectives = cloudData.customPerspectives;
              localStorage.setItem(PERSPECTIVES_KEY, JSON.stringify(customPerspectives));
            }
            console.log('âœ… Loaded from GitHub');
            updateSyncStatus('success', 'Loaded from GitHub');
            return;
          }
        }

        // Fallback to static file fetch
        const response = await fetch(DATA_URL + '?t=' + Date.now());
        if (response.ok) {
          const cloudData = await response.json();
          const localData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

          if (cloudData.data) {
            Object.keys(cloudData.data).forEach(date => {
              if (!localData[date]) {
                localData[date] = cloudData.data[date];
              }
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localData));
            allData = localData;
          }
          if (cloudData.weights) {
            WEIGHTS = cloudData.weights;
            localStorage.setItem(WEIGHTS_KEY, JSON.stringify(WEIGHTS));
          }
          console.log('âœ… Cloud data synced (static file)');
        }
      } catch (e) {
        console.log('ðŸ“´ Offline mode - using local data');
      }
    }

    const defaultDayData = {
      prayers: { fajr: '', dhuhr: '', asr: '', maghrib: '', isha: '', quran: 0 },
      glucose: { avg: '', tir: '', insulin: '' },
      whoop: {
        sleepPerf: '', recovery: '', strain: '', whoopAge: ''
      },
      family: { mom: false, dad: false, jana: false, tia: false, ahmed: false, eman: false },
      habits: { exercise: 0, reading: 0, meditation: 0, water: '', vitamins: false, brushTeeth: 0, nop: '' }
    };

    // Consistent scoring framework - base unit = 5 pts
    // Target daily max ~100 pts: Prayer 30, Diabetes 25, Whoop 25, Habits 15, Family 5
    const DEFAULT_WEIGHTS = {
      // PRAYER (max 30): 5 prayers Ã— 5 pts + quran bonus
      prayer: { onTime: 5, late: 2, quran: 5 },

      // DIABETES (max 25): avg 10 + tir 10 + insulin 5
      glucose: { avgMax: 10, tirPerPoint: 0.1, insulinBase: 5, insulinPenalty: -5, insulinThreshold: 40 },

      // FAMILY (max 5): 6 members, ~1 pt each, cap at 5
      family: { mom: 1, dad: 1, jana: 1, tia: 1, ahmed: 1, eman: 1 },

      // HABITS (max 15): distributed across daily habits
      habits: { exercise: 3, reading: 2, meditation: 2, water: 1, vitamins: 2, brushTeeth: 1, nopYes: 2, nopNo: -2 },

      // WHOOP (max 14): Sleep Perf + Recovery + Strain
      whoop: {
        sleepPerfHigh: 7, sleepPerfMid: 4, sleepPerfLow: 2,
        recoveryHigh: 2, recoveryMid: 1, recoveryLow: 0,
        strainMatch: 3, strainHigh: 2
      }
    };

    // Load weights and merge with defaults to ensure new keys are always present
    function loadWeights() {
      const saved = JSON.parse(localStorage.getItem(WEIGHTS_KEY));
      if (!saved) return JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
      // Deep merge: ensure all default keys exist
      const merged = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
      Object.keys(merged).forEach(category => {
        if (saved[category]) {
          Object.keys(merged[category]).forEach(key => {
            if (saved[category][key] !== undefined) merged[category][key] = saved[category][key];
          });
        }
      });
      return merged;
    }
    let WEIGHTS = loadWeights();

    // Max scores for progress bars (what a perfect day looks like)
    // These are configurable in settings
    const DEFAULT_MAX_SCORES = {
      prayer: 35,    // 5 prayers on-time (25) + 2 quran pages (10)
      diabetes: 25,  // avg 105 (10) + TIR 100% (10) + insulin â‰¤40 (5)
      whoop: 14,     // sleepPerf(7)+recovery(2)+strain(5)
      family: 6,     // all 6 family members checked
      habits: 16,    // exercise(3)+reading(2)+meditation(2)+water 2.5L(2.5)+vitamins(2)+brush 2x(2)+nop(2)
      total: 96      // sum of all maxes
    };
    const MAX_SCORES_KEY = 'lifeGamificationMaxScores';

    function loadMaxScores() {
      const saved = JSON.parse(localStorage.getItem(MAX_SCORES_KEY));
      if (!saved) return JSON.parse(JSON.stringify(DEFAULT_MAX_SCORES));
      return { ...DEFAULT_MAX_SCORES, ...saved };
    }
    let MAX_SCORES = loadMaxScores();

    function saveMaxScores() {
      localStorage.setItem(MAX_SCORES_KEY, JSON.stringify(MAX_SCORES));
    }

    function saveWeights() {
      localStorage.setItem(WEIGHTS_KEY, JSON.stringify(WEIGHTS));
    }

    function updateWeight(category, field, value) {
      if (field) {
        WEIGHTS[category][field] = parseFloat(value) || 0;
      } else {
        WEIGHTS[category] = parseFloat(value) || 0;
      }
      saveWeights();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function resetWeights() {
      WEIGHTS = JSON.parse(JSON.stringify(DEFAULT_WEIGHTS));
      saveWeights();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function updateMaxScore(category, value) {
      MAX_SCORES[category] = parseFloat(value) || 0;
      saveMaxScores();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function resetMaxScores() {
      MAX_SCORES = JSON.parse(JSON.stringify(DEFAULT_MAX_SCORES));
      saveMaxScores();
      render();
    }

    // Format numbers with commas for 4+ digits
    function fmt(num) {
      if (num === null || num === undefined || num === '') return 'â€”';
      const n = typeof num === 'string' ? parseFloat(num) : num;
      if (isNaN(n)) return 'â€”';
      return n.toLocaleString('en-US');
    }

    // Pre-populated January 2026 data from habits tracking sheet
    const JANUARY_DATA = {"2026-01-01":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":false,"dad":false,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-02":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-03":{"prayers":{"fajr":"1.1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-04":{"prayers":{"fajr":"1.2","dhuhr":"0.1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":false,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-05":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"0.1","isha":"1","quran":0},"family":{"mom":false,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-06":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-07":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"1","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":true,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-08":{"prayers":{"fajr":"0.1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-09":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":false},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-10":{"prayers":{"fajr":"0.1","dhuhr":"1","asr":"1","maghrib":"1","isha":"1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-11":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-12":{"prayers":{"fajr":"0.1","dhuhr":"","asr":"0.1","maghrib":"0.1","isha":"1","quran":0},"family":{"mom":false,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-13":{"prayers":{"fajr":"0.1","dhuhr":"","asr":"","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-14":{"prayers":{"fajr":"1","dhuhr":"0.1","asr":"0.1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-15":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-16":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-17":{"prayers":{"fajr":"1","dhuhr":"1","asr":"1","maghrib":"0.1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-18":{"prayers":{"fajr":"1","dhuhr":"1","asr":"0.1","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-19":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"1","isha":"0.1","quran":0},"family":{"mom":true,"dad":false,"jana":false,"tia":false,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-20":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-21":{"prayers":{"fajr":"0.1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":false,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}},"2026-01-22":{"prayers":{"fajr":"1","dhuhr":"","asr":"","maghrib":"","isha":"0.1","quran":0},"family":{"mom":true,"dad":true,"jana":true,"tia":true,"ahmed":true,"eman":true},"glucose":{"avg":"","tir":"","insulin":"","nop":""},"whoop":{"sleepHours":"","sleepConsist":"","rhr":"","hrv":"","vo2max":"","steps":"","recovery":"","strain":"","whoopAge":""},"habits":{"exercise":0,"reading":0,"meditation":0,"water":"","vitamins":false,"brushTeeth":0}}};

    // Merge pre-populated data with any existing localStorage data
    let storedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    let allData = { ...JANUARY_DATA, ...storedData };

    // Migration: move NoP from glucose to habits if exists
    let migrated = false;
    Object.keys(allData).forEach(date => {
      const day = allData[date];
      if (day.glucose && day.glucose.nop !== undefined && day.glucose.nop !== '') {
        if (!day.habits) day.habits = {};
        if (day.habits.nop === undefined || day.habits.nop === '') {
          day.habits.nop = day.glucose.nop;
          migrated = true;
        }
        delete day.glucose.nop;
      }
    });
    if (migrated) console.log('âœ… Migrated NoP data from glucose to habits');

    // Save merged data
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));

    let currentDate = new Date().toISOString().split('T')[0];
    let weekChart = null;
    let breakdownChart = null;

    // View state persistence
    const VIEW_STATE_KEY = 'lifeGamificationViewState';
    const savedViewState = JSON.parse(localStorage.getItem(VIEW_STATE_KEY) || '{}');
    let activeTab = savedViewState.activeTab || 'home';
    let activeSubTab = savedViewState.activeSubTab || 'daily'; // For Life tab sub-navigation

    function saveViewState() {
      localStorage.setItem(VIEW_STATE_KEY, JSON.stringify({
        activeTab,
        activeSubTab,
        activePerspective,
        activeFilterType,
        activeCategoryFilter,
        activeLabelFilter,
        activePersonFilter
      }));
    }

    function switchSubTab(subTab) {
      activeSubTab = subTab;
      saveViewState();
      render();
    }

    // Bulk entry state - default to January 2026 where we have data
    let bulkMonth = 0; // January
    let bulkYear = 2026;
    let bulkCategory = 'prayers';

    // ============ TASKS SYSTEM (Things 3 + OmniFocus style) ============
    const TASKS_KEY = 'lifeGamificationTasks';
    const PERSPECTIVES_KEY = 'lifeGamificationPerspectives';
    const TASK_CATEGORIES_KEY = 'lifeGamificationTaskCategories';
    const TASK_LABELS_KEY = 'lifeGamificationTaskLabels';
    const TASK_PEOPLE_KEY = 'lifeGamificationTaskPeople';
    const HOME_WIDGETS_KEY = 'lifeGamificationHomeWidgets';

    // Default home widgets configuration
    const DEFAULT_HOME_WIDGETS = [
      { id: 'quick-stats', type: 'stats', title: 'Quick Stats', size: 'full', order: 0, visible: true },
      { id: 'quick-add', type: 'quick-add', title: 'Quick Add Task', size: 'full', order: 1, visible: true },
      { id: 'today-tasks', type: 'today-tasks', title: 'Today', size: 'half', order: 2, visible: true },
      { id: 'next-tasks', type: 'next-tasks', title: 'Next', size: 'half', order: 3, visible: true },
      { id: 'daily-entry', type: 'daily-entry', title: 'Daily Entry', size: 'full', order: 4, visible: true }
    ];

    // Default categories (Areas)
    const DEFAULT_TASK_CATEGORIES = [
      { id: 'personal', name: 'Personal', color: '#4A90A4' },
      { id: 'work', name: 'Work', color: '#6B8E5A' },
      { id: 'health', name: 'Health', color: '#E5533D' },
      { id: 'family', name: 'Family', color: '#C4943D' },
      { id: 'learning', name: 'Learning', color: '#7C6B8E' }
    ];

    // Default labels (Tags)
    const DEFAULT_TASK_LABELS = [
      { id: 'urgent', name: 'Urgent', color: '#DC2626' },
      { id: 'quick', name: 'Quick Win', color: '#16A34A' },
      { id: 'waiting', name: 'Waiting', color: '#CA8A04' },
      { id: 'blocked', name: 'Blocked', color: '#6B7280' }
    ];

    // Default people
    const DEFAULT_TASK_PEOPLE = [
      { id: 'self', name: 'Self', color: '#4A90A4' }
    ];

    // Things 3 exact SVG icons (filled style matching the app)
    const THINGS3_ICONS = {
      // Home - house icon for homepage
      home: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`,
      // Inbox - filled blue tray
      inbox: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5v-3h3.56c.69 1.19 1.97 2 3.44 2s2.75-.81 3.44-2H19v3zm0-5h-4.99c0 1.1-.9 2-2.01 2s-2-.9-2-2H5V5h14v9z"/></svg>`,
      // Today - filled gold star
      today: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7-6.3-4.6-6.3 4.6 2.3-7-6-4.6h7.6z"/></svg>`,
      // Upcoming - filled calendar with red accent
      upcoming: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/><rect x="7" y="12" width="4" height="4" rx="0.5"/><rect x="13" y="12" width="4" height="4" rx="0.5"/></svg>`,
      // Anytime - teal stacked layers
      anytime: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="18" height="5" rx="1"/><rect x="3" y="10" width="18" height="5" rx="1" opacity="0.7"/><rect x="3" y="17" width="18" height="5" rx="1" opacity="0.4"/></svg>`,
      // Someday - tan/sand archive box
      someday: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v3c0 .55.45 1 1 1h1v11c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8h1c.55 0 1-.45 1-1V4c0-1.1-.9-2-2-2zm-5 12h-6v-2h6v2zm5-7H4V4h16v3z"/></svg>`,
      // Logbook - green rounded square with checkmark
      logbook: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.4-1.4 3.6 3.6 7.6-7.6L19 8l-9 9z"/></svg>`,
      // Trash - gray trash can
      trash: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`,
      // Area - Things 3 style stacked cards icon
      area: `<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>`,
      // Next - forward/play arrow in circle (OmniFocus-style)
      next: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><path d="M10 8l6 4-6 4V8z" fill="white"/></svg>`,
      // Notes - bullet list icon (Tana-style)
      notes: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><circle cx="4" cy="6" r="2"/><circle cx="4" cy="12" r="2"/><circle cx="4" cy="18" r="2"/><rect x="8" y="5" width="14" height="2" rx="1"/><rect x="8" y="11" width="14" height="2" rx="1"/><rect x="8" y="17" width="14" height="2" rx="1"/></svg>`
    };

    // Default perspectives with exact Things 3 colors
    const BUILTIN_PERSPECTIVES = [
      { id: 'home', name: 'Home', icon: THINGS3_ICONS.home, color: '#F97316', filter: { home: true }, builtin: true },
      { id: 'inbox', name: 'Inbox', icon: THINGS3_ICONS.inbox, color: '#5598FE', filter: { status: 'inbox' }, builtin: true },
      { id: 'today', name: 'Today', icon: THINGS3_ICONS.today, color: '#FFCA28', filter: { status: 'today' }, builtin: true },
      { id: 'upcoming', name: 'Upcoming', icon: THINGS3_ICONS.upcoming, color: '#EF5350', filter: { upcoming: true }, builtin: true },
      { id: 'anytime', name: 'Anytime', icon: THINGS3_ICONS.anytime, color: '#26A69A', filter: { status: 'anytime' }, builtin: true },
      { id: 'someday', name: 'Someday', icon: THINGS3_ICONS.someday, color: '#D4A24C', filter: { status: 'someday' }, builtin: true },
      { id: 'logbook', name: 'Logbook', icon: THINGS3_ICONS.logbook, color: '#66BB6A', filter: { completed: true }, builtin: true },
      { id: 'notes', name: 'Notes', icon: THINGS3_ICONS.notes, color: '#8B5CF6', filter: { notes: true }, builtin: true }
    ];

    // Load tasks data
    let tasksData = JSON.parse(localStorage.getItem(TASKS_KEY) || '[]');
    let taskCategories = JSON.parse(localStorage.getItem(TASK_CATEGORIES_KEY) || 'null') || DEFAULT_TASK_CATEGORIES;
    let taskLabels = JSON.parse(localStorage.getItem(TASK_LABELS_KEY) || 'null') || DEFAULT_TASK_LABELS;
    let taskPeople = JSON.parse(localStorage.getItem(TASK_PEOPLE_KEY) || 'null') || DEFAULT_TASK_PEOPLE;
    let customPerspectives = JSON.parse(localStorage.getItem(PERSPECTIVES_KEY) || '[]');
    let homeWidgets = JSON.parse(localStorage.getItem(HOME_WIDGETS_KEY) || 'null') || DEFAULT_HOME_WIDGETS;
    let editingHomeWidgets = false;
    let draggingWidgetId = null;
    let activePerspective = savedViewState.activePerspective || 'home';
    let activeFilterType = savedViewState.activeFilterType || 'perspective';
    let activeCategoryFilter = savedViewState.activeCategoryFilter || null;
    let activeLabelFilter = savedViewState.activeLabelFilter || null;
    let activePersonFilter = savedViewState.activePersonFilter || null;
    let editingTaskId = null;
    let inlineEditingTaskId = null; // For inline title editing
    let newTaskContext = { categoryId: null, labelId: null, personId: null, status: 'inbox' }; // Context for new task
    let showTaskModal = false;
    let showPerspectiveModal = false;
    let showCategoryModal = false;
    let showLabelModal = false;
    let showPersonModal = false;
    let editingCategoryId = null;
    let editingLabelId = null;
    let editingPersonId = null;

    // Inline task title editing
    function startInlineEdit(taskId) {
      inlineEditingTaskId = taskId;
      render();
      // Focus the input after render
      setTimeout(() => {
        const input = document.getElementById('inline-edit-input');
        if (input) {
          input.focus();
          input.select();
        }
      }, 10);
    }

    function saveInlineEdit(taskId) {
      const input = document.getElementById('inline-edit-input');
      if (input) {
        const newTitle = input.value.trim();
        if (newTitle) {
          updateTask(taskId, { title: newTitle });
        }
      }
      inlineEditingTaskId = null;
      render();
    }

    function cancelInlineEdit() {
      inlineEditingTaskId = null;
      render();
    }

    function handleInlineEditKeydown(event, taskId) {
      if (event.key === 'Enter') {
        event.preventDefault();
        saveInlineEdit(taskId);
      } else if (event.key === 'Escape') {
        event.preventDefault();
        cancelInlineEdit();
      }
    }

    // Switch to category view
    function showCategoryTasks(categoryId) {
      activeFilterType = 'category';
      activeCategoryFilter = categoryId;
      activeLabelFilter = null;
      saveViewState();
      render();
    }

    // Switch to label view
    function showLabelTasks(labelId) {
      activeFilterType = 'label';
      activeLabelFilter = labelId;
      activeCategoryFilter = null;
      saveViewState();
      render();
    }

    // Open new task modal with context
    function openNewTaskModal() {
      editingTaskId = null;
      // Set context based on current view
      if (activeFilterType === 'category' && activeCategoryFilter) {
        newTaskContext = { categoryId: activeCategoryFilter, labelId: null, labelIds: null, personId: null, status: 'inbox' };
      } else if (activeFilterType === 'label' && activeLabelFilter) {
        newTaskContext = { categoryId: null, labelId: activeLabelFilter, labelIds: null, personId: null, status: 'inbox' };
      } else if (activeFilterType === 'person' && activePersonFilter) {
        newTaskContext = { categoryId: null, labelId: null, labelIds: null, personId: activePersonFilter, status: 'inbox' };
      } else if (activeFilterType === 'perspective') {
        // Check if it's a custom perspective
        const customPerspective = customPerspectives.find(p => p.id === activePerspective);
        if (customPerspective && customPerspective.filter) {
          // Apply custom perspective filter rules
          newTaskContext = {
            categoryId: customPerspective.filter.categoryId || null,
            labelId: null,
            labelIds: customPerspective.filter.labelIds || null,
            personId: null,
            status: customPerspective.filter.status || 'inbox'
          };
        } else {
          // Built-in perspective - set status based on perspective
          const statusMap = { inbox: 'inbox', today: 'today', anytime: 'anytime', someday: 'someday' };
          newTaskContext = { categoryId: null, labelId: null, labelIds: null, personId: null, status: statusMap[activePerspective] || 'inbox' };
        }
      } else {
        newTaskContext = { categoryId: null, labelId: null, labelIds: null, personId: null, status: 'inbox' };
      }
      showTaskModal = true;
      render();
      // Auto-focus title input after render
      setTimeout(() => {
        const titleInput = document.getElementById('task-title');
        if (titleInput) titleInput.focus();
      }, 50);
    }

    // Quick add task - auto-links to current context (category, label, person, or perspective status)
    function quickAddTask(inputElement) {
      const title = inputElement.value.trim();
      if (!title) return;

      // Build options based on current context
      const options = { status: 'inbox' };

      if (activeFilterType === 'category' && activeCategoryFilter) {
        options.categoryId = activeCategoryFilter;
      } else if (activeFilterType === 'label' && activeLabelFilter) {
        options.labels = [activeLabelFilter];
      } else if (activeFilterType === 'person' && activePersonFilter) {
        options.people = [activePersonFilter];
      } else if (activeFilterType === 'perspective' && activePerspective) {
        // Check if it's the Notes perspective
        if (activePerspective === 'notes') {
          options.isNote = true;
          options.status = 'anytime'; // Notes go to anytime by default
        }
        // Check if it's a custom perspective
        else {
          const customPerspective = customPerspectives.find(p => p.id === activePerspective);
          if (customPerspective && customPerspective.filter) {
            // Apply custom perspective filter rules
            if (customPerspective.filter.status) options.status = customPerspective.filter.status;
            if (customPerspective.filter.categoryId) options.categoryId = customPerspective.filter.categoryId;
            if (customPerspective.filter.labelIds && customPerspective.filter.labelIds.length > 0) {
              options.labels = customPerspective.filter.labelIds;
            }
          } else {
            // Built-in perspective - set status based on perspective
            const statusMap = { inbox: 'inbox', today: 'today', anytime: 'anytime', someday: 'someday' };
            if (statusMap[activePerspective]) {
              options.status = statusMap[activePerspective];
            }
          }
        }
      }

      createTask(title, options);
      inputElement.value = '';
      render();

      // Re-focus the quick-add input after render
      setTimeout(() => {
        const quickInput = document.getElementById('quick-add-input');
        if (quickInput) quickInput.focus();
      }, 50);
    }

    // Handle Enter key in quick-add input
    function handleQuickAddKeydown(event, inputElement) {
      if (event.key === 'Enter') {
        event.preventDefault();
        quickAddTask(inputElement);
      }
    }

    // Switch to perspective view
    function showPerspectiveTasks(perspectiveId) {
      activeFilterType = 'perspective';
      activePerspective = perspectiveId;
      activeCategoryFilter = null;
      activeLabelFilter = null;
      saveViewState();
      render();
    }

    // ============ HOME WIDGET MANAGEMENT ============
    function saveHomeWidgets() {
      localStorage.setItem(HOME_WIDGETS_KEY, JSON.stringify(homeWidgets));
    }

    function toggleWidgetVisibility(widgetId) {
      const widget = homeWidgets.find(w => w.id === widgetId);
      if (widget) {
        widget.visible = !widget.visible;
        saveHomeWidgets();
        render();
      }
    }

    function toggleWidgetSize(widgetId) {
      const widget = homeWidgets.find(w => w.id === widgetId);
      if (widget) {
        // Cycle through sizes: full -> half -> third -> full
        if (widget.size === 'full') widget.size = 'half';
        else if (widget.size === 'half') widget.size = 'third';
        else widget.size = 'full';
        saveHomeWidgets();
        render();
      }
    }

    function moveWidgetUp(widgetId) {
      const idx = homeWidgets.findIndex(w => w.id === widgetId);
      if (idx > 0) {
        [homeWidgets[idx], homeWidgets[idx - 1]] = [homeWidgets[idx - 1], homeWidgets[idx]];
        // Update order numbers
        homeWidgets.forEach((w, i) => w.order = i);
        saveHomeWidgets();
        render();
      }
    }

    function moveWidgetDown(widgetId) {
      const idx = homeWidgets.findIndex(w => w.id === widgetId);
      if (idx < homeWidgets.length - 1) {
        [homeWidgets[idx], homeWidgets[idx + 1]] = [homeWidgets[idx + 1], homeWidgets[idx]];
        // Update order numbers
        homeWidgets.forEach((w, i) => w.order = i);
        saveHomeWidgets();
        render();
      }
    }

    function handleWidgetDragStart(event, widgetId) {
      draggingWidgetId = widgetId;
      event.dataTransfer.effectAllowed = 'move';
      event.target.classList.add('dragging');
    }

    function handleWidgetDragEnd(event) {
      event.target.classList.remove('dragging');
      document.querySelectorAll('.widget-drop-target').forEach(el => el.classList.remove('drag-over'));
      draggingWidgetId = null;
    }

    function handleWidgetDragOver(event, targetWidgetId) {
      event.preventDefault();
      if (draggingWidgetId && draggingWidgetId !== targetWidgetId) {
        event.currentTarget.classList.add('drag-over');
      }
    }

    function handleWidgetDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function handleWidgetDrop(event, targetWidgetId) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');
      if (draggingWidgetId && draggingWidgetId !== targetWidgetId) {
        const dragIdx = homeWidgets.findIndex(w => w.id === draggingWidgetId);
        const targetIdx = homeWidgets.findIndex(w => w.id === targetWidgetId);
        if (dragIdx !== -1 && targetIdx !== -1) {
          const [draggedWidget] = homeWidgets.splice(dragIdx, 1);
          homeWidgets.splice(targetIdx, 0, draggedWidget);
          homeWidgets.forEach((w, i) => w.order = i);
          saveHomeWidgets();
          render();
        }
      }
      draggingWidgetId = null;
    }

    function resetHomeWidgets() {
      if (confirm('Reset home widgets to default layout?')) {
        homeWidgets = JSON.parse(JSON.stringify(DEFAULT_HOME_WIDGETS));
        saveHomeWidgets();
        render();
      }
    }

    function toggleEditHomeWidgets() {
      editingHomeWidgets = !editingHomeWidgets;
      render();
    }

    // Render a single widget based on its type
    function renderHomeWidget(widget, isEditing) {
      const today = new Date().toISOString().split('T')[0];
      const nextLabel = taskLabels.find(l => l.name.toLowerCase() === 'next');

      // Size class mapping
      const sizeClass = widget.size === 'full' ? 'col-span-2' : widget.size === 'half' ? 'col-span-1' : 'col-span-1';

      // Edit controls shown in edit mode
      const editControls = isEditing ? `
        <div class="flex items-center gap-1 ml-auto">
          <button onclick="event.stopPropagation(); toggleWidgetSize('${widget.id}')" class="p-1 text-charcoal/40 hover:text-charcoal rounded transition" title="Change size (${widget.size})">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18M3 9h18"/></svg>
          </button>
          <button onclick="event.stopPropagation(); moveWidgetUp('${widget.id}')" class="p-1 text-charcoal/40 hover:text-charcoal rounded transition" title="Move up">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
          </button>
          <button onclick="event.stopPropagation(); moveWidgetDown('${widget.id}')" class="p-1 text-charcoal/40 hover:text-charcoal rounded transition" title="Move down">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
          </button>
          <button onclick="event.stopPropagation(); toggleWidgetVisibility('${widget.id}')" class="p-1 text-charcoal/40 hover:text-red-500 rounded transition" title="Hide widget">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
      ` : '';

      let content = '';

      switch (widget.type) {
        case 'stats':
          const todayTasksCount = tasksData.filter(t => {
            if (t.completed || t.isNote) return false;
            const isDueToday = t.dueDate === today;
            const isOverdue = t.dueDate && t.dueDate < today;
            return t.status === 'today' || isDueToday || isOverdue;
          }).length;
          const nextTasksCount = nextLabel ? tasksData.filter(t => {
            if (t.completed || t.isNote) return false;
            return (t.labels || []).includes(nextLabel.id);
          }).length : 0;
          const completedToday = tasksData.filter(t => t.completed && t.completedAt && t.completedAt.startsWith(today)).length;
          const inboxCount = tasksData.filter(t => !t.completed && !t.isNote && t.status === 'inbox' && !t.categoryId).length;

          content = `
            <div class="grid grid-cols-4 gap-3">
              <div class="bg-warmgray/30 rounded-lg p-3 text-center cursor-pointer hover:bg-warmgray/50 transition" onclick="showPerspectiveTasks('today')">
                <div class="text-2xl font-bold text-charcoal">${todayTasksCount}</div>
                <div class="text-xs text-charcoal/50 mt-1">Due Today</div>
              </div>
              <div class="bg-warmgray/30 rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-[#8B5CF6]">${nextTasksCount}</div>
                <div class="text-xs text-charcoal/50 mt-1">Tagged Next</div>
              </div>
              <div class="bg-warmgray/30 rounded-lg p-3 text-center">
                <div class="text-2xl font-bold text-green-600">${completedToday}</div>
                <div class="text-xs text-charcoal/50 mt-1">Done Today</div>
              </div>
              <div class="bg-warmgray/30 rounded-lg p-3 text-center cursor-pointer hover:bg-warmgray/50 transition" onclick="showPerspectiveTasks('inbox')">
                <div class="text-2xl font-bold ${inboxCount > 0 ? 'text-blue-500' : 'text-charcoal'}">${inboxCount}</div>
                <div class="text-xs text-charcoal/50 mt-1">In Inbox</div>
              </div>
            </div>
          `;
          break;

        case 'quick-add':
          content = `
            <div class="flex items-center gap-3">
              <div class="w-5 h-5 rounded-full border-2 border-dashed border-charcoal/20 flex-shrink-0"></div>
              <input type="text" id="home-quick-add-input"
                placeholder="Quick add task... (press Enter)"
                onkeydown="if(event.key==='Enter'){event.preventDefault();homeQuickAddTask(this);}"
                class="flex-1 text-[15px] text-charcoal placeholder-charcoal/30 bg-transparent border-0 outline-none focus:ring-0">
              <button onclick="homeQuickAddTask(document.getElementById('home-quick-add-input'))"
                class="text-charcoal/30 hover:text-coral transition p-1" title="Add task">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
              </button>
            </div>
          `;
          break;

        case 'today-tasks':
          const todayTasks = tasksData.filter(t => {
            if (t.completed || t.isNote) return false;
            const isDueToday = t.dueDate === today;
            const isOverdue = t.dueDate && t.dueDate < today;
            return t.status === 'today' || isDueToday || isOverdue;
          }).sort((a, b) => {
            if (a.dueDate && !b.dueDate) return -1;
            if (!a.dueDate && b.dueDate) return 1;
            if (a.dueDate && b.dueDate) return a.dueDate.localeCompare(b.dueDate);
            return 0;
          });

          content = todayTasks.length === 0 ? `
            <div class="py-6 text-center text-charcoal/30 text-sm">No tasks due today</div>
          ` : `
            <div class="space-y-1 max-h-[300px] overflow-y-auto">
              ${todayTasks.slice(0, 8).map(task => renderTaskItem(task, false)).join('')}
              ${todayTasks.length > 8 ? '<div class="px-4 py-2 text-center"><button onclick="showPerspectiveTasks(\'today\')" class="text-sm text-[#147EFB] hover:underline">View all ' + todayTasks.length + ' tasks â†’</button></div>' : ''}
            </div>
          `;
          break;

        case 'next-tasks':
          const nextTasks = nextLabel ? tasksData.filter(t => {
            if (t.completed || t.isNote) return false;
            const isNextTagged = (t.labels || []).includes(nextLabel.id);
            if (!isNextTagged) return false;
            const isDatedTask = t.status === 'today' || t.dueDate === today || (t.dueDate && t.dueDate < today);
            return !isDatedTask;
          }) : [];

          content = nextTasks.length === 0 ? `
            <div class="py-6 text-center text-charcoal/30 text-sm">No tasks tagged "Next"</div>
          ` : `
            <div class="space-y-1 max-h-[300px] overflow-y-auto">
              ${nextTasks.slice(0, 8).map(task => renderTaskItem(task, false)).join('')}
              ${nextTasks.length > 8 ? '<div class="px-4 py-2 text-center"><button onclick="showLabelTasks(\'' + nextLabel.id + '\')" class="text-sm text-[#147EFB] hover:underline">View all ' + nextTasks.length + ' tasks â†’</button></div>' : ''}
            </div>
          `;
          break;

        case 'daily-entry':
          const todayData = allData[today] || {};
          const categories = {
            prayers: { label: 'Prayers', fields: ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha', 'quran'], headers: ['F', 'D', 'A', 'M', 'I', 'Q'], icon: 'ðŸ•Œ' },
            glucose: { label: 'Glucose', fields: ['avg', 'tir', 'insulin'], headers: ['Avg', 'TIR', 'Ins'], icon: 'ðŸ’‰' },
            whoop: { label: 'Whoop', fields: ['sleepPerf', 'recovery', 'strain'], headers: ['Sleep', 'Rec', 'Strain'], icon: 'â±ï¸' },
            habits: { label: 'Habits', fields: ['exercise', 'reading', 'meditation', 'water', 'vitamins'], headers: ['ðŸ‹ï¸', 'ðŸ“š', 'ðŸ§˜', 'ðŸ’§', 'ðŸ’Š'], icon: 'âœ¨' }
          };

          content = `
            <div class="space-y-3">
              ${Object.entries(categories).map(([catKey, cat]) => {
                const catData = todayData[catKey] || {};
                return '<div class="flex items-center gap-2">' +
                  '<span class="text-sm w-20 text-charcoal/70">' + cat.icon + ' ' + cat.label + '</span>' +
                  '<div class="flex gap-1 flex-1">' +
                    cat.fields.map((field, i) => {
                      const value = catData[field] || '';
                      const isChecked = value === true || value === 1 || value === '1';
                      const isNumeric = cat.headers[i].length > 2;
                      if (isNumeric) {
                        return '<div class="flex flex-col items-center">' +
                          '<span class="text-[10px] text-charcoal/40">' + cat.headers[i] + '</span>' +
                          '<input type="number" value="' + (value || '') + '" ' +
                          'onchange="updateDailyField(\'' + catKey + '\', \'' + field + '\', this.value)" ' +
                          'class="w-12 text-center text-sm border border-charcoal/15 rounded px-1 py-0.5 focus:border-coral focus:outline-none">' +
                          '</div>';
                      } else {
                        return '<div class="flex flex-col items-center">' +
                          '<span class="text-[10px] text-charcoal/40">' + cat.headers[i] + '</span>' +
                          '<button onclick="toggleDailyField(\'' + catKey + '\', \'' + field + '\')" ' +
                          'class="w-7 h-7 rounded border transition ' + (isChecked ? 'bg-coral border-coral text-white' : 'border-charcoal/20 hover:border-coral/50') + '">' +
                          (isChecked ? '<svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>' : '') +
                          '</button></div>';
                      }
                    }).join('') +
                  '</div>' +
                '</div>';
              }).join('')}
            </div>
          `;
          break;

        default:
          content = '<div class="py-4 text-center text-charcoal/30">Unknown widget type</div>';
      }

      // Widget icon based on type
      const widgetIcons = {
        'stats': '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>',
        'quick-add': '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>',
        'today-tasks': THINGS3_ICONS.today,
        'next-tasks': THINGS3_ICONS.next,
        'daily-entry': '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>'
      };

      const widgetColors = {
        'stats': '#6B7280',
        'quick-add': '#147EFB',
        'today-tasks': '#FFCA28',
        'next-tasks': '#8B5CF6',
        'daily-entry': '#F97316'
      };

      return `
        <div class="widget ${sizeClass} bg-white rounded-xl shadow-sm border border-charcoal/5 overflow-hidden widget-drop-target ${isEditing ? 'cursor-grab' : ''}"
          ${isEditing ? `draggable="true" ondragstart="handleWidgetDragStart(event, '${widget.id}')" ondragend="handleWidgetDragEnd(event)" ondragover="handleWidgetDragOver(event, '${widget.id}')" ondragleave="handleWidgetDragLeave(event)" ondrop="handleWidgetDrop(event, '${widget.id}')"` : ''}>
          <div class="px-4 py-2 border-b border-charcoal/5 flex items-center gap-2">
            ${isEditing ? '<div class="text-charcoal/30 cursor-grab"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><circle cx="9" cy="5" r="1.5"/><circle cx="15" cy="5" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="19" r="1.5"/><circle cx="15" cy="19" r="1.5"/></svg></div>' : ''}
            <span style="color: ${widgetColors[widget.type] || '#6B7280'}">${widgetIcons[widget.type] || ''}</span>
            <h3 class="text-sm font-medium text-charcoal">${widget.title}</h3>
            ${editControls}
          </div>
          <div class="p-4">
            ${content}
          </div>
        </div>
      `;
    }

    // Home quick add task function
    function homeQuickAddTask(inputElement) {
      const title = inputElement.value.trim();
      if (!title) return;
      createTask(title, { status: 'inbox' });
      inputElement.value = '';
      render();
      setTimeout(() => {
        const input = document.getElementById('home-quick-add-input');
        if (input) input.focus();
      }, 50);
    }

    // Toggle daily field (checkbox style)
    function toggleDailyField(category, field) {
      const today = new Date().toISOString().split('T')[0];
      if (!allData[today]) allData[today] = {};
      if (!allData[today][category]) allData[today][category] = {};
      allData[today][category][field] = !allData[today][category][field];
      saveData();
      debouncedSaveToGithub();
      render();
    }

    // Update daily field (numeric)
    function updateDailyField(category, field, value) {
      const today = new Date().toISOString().split('T')[0];
      if (!allData[today]) allData[today] = {};
      if (!allData[today][category]) allData[today][category] = {};
      allData[today][category][field] = value === '' ? null : parseFloat(value) || value;
      saveData();
      debouncedSaveToGithub();
    }

    // Task helper functions
    function generateTaskId() {
      return 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function saveTasksData() {
      localStorage.setItem(TASKS_KEY, JSON.stringify(tasksData));
      localStorage.setItem(TASK_CATEGORIES_KEY, JSON.stringify(taskCategories));
      localStorage.setItem(TASK_LABELS_KEY, JSON.stringify(taskLabels));
      localStorage.setItem(TASK_PEOPLE_KEY, JSON.stringify(taskPeople));
      localStorage.setItem(PERSPECTIVES_KEY, JSON.stringify(customPerspectives));
      debouncedSaveToGithub();
    }

    // Category CRUD
    function createCategory(name) {
      const category = {
        id: 'cat_' + Date.now(),
        name: name
      };
      taskCategories.push(category);
      saveTasksData();
      return category;
    }

    function updateCategory(categoryId, updates) {
      const idx = taskCategories.findIndex(c => c.id === categoryId);
      if (idx !== -1) {
        taskCategories[idx] = { ...taskCategories[idx], ...updates };
        saveTasksData();
      }
    }

    function deleteCategory(categoryId) {
      taskCategories = taskCategories.filter(c => c.id !== categoryId);
      // Remove category from tasks that use it
      tasksData.forEach(task => {
        if (task.categoryId === categoryId) task.categoryId = null;
      });
      saveTasksData();
    }

    // Label CRUD
    function createLabel(name, color) {
      const label = {
        id: 'label_' + Date.now(),
        name: name,
        color: color || '#6B7280'
      };
      taskLabels.push(label);
      saveTasksData();
      return label;
    }

    function updateLabel(labelId, updates) {
      const idx = taskLabels.findIndex(l => l.id === labelId);
      if (idx !== -1) {
        taskLabels[idx] = { ...taskLabels[idx], ...updates };
        saveTasksData();
      }
    }

    function deleteLabel(labelId) {
      taskLabels = taskLabels.filter(l => l.id !== labelId);
      // Remove label from tasks that use it
      tasksData.forEach(task => {
        if (task.labels) {
          task.labels = task.labels.filter(l => l !== labelId);
        }
      });
      saveTasksData();
    }

    function getLabelById(labelId) {
      return taskLabels.find(l => l.id === labelId);
    }

    // ============ PEOPLE CRUD ============
    function createPerson(name) {
      const person = {
        id: 'person_' + Date.now(),
        name: name
      };
      taskPeople.push(person);
      saveTasksData();
      return person;
    }

    function updatePerson(personId, updates) {
      const idx = taskPeople.findIndex(p => p.id === personId);
      if (idx !== -1) {
        taskPeople[idx] = { ...taskPeople[idx], ...updates };
        saveTasksData();
      }
    }

    function deletePerson(personId) {
      taskPeople = taskPeople.filter(p => p.id !== personId);
      // Remove person from tasks that use it
      tasksData.forEach(task => {
        if (task.people) {
          task.people = task.people.filter(p => p !== personId);
        }
      });
      saveTasksData();
    }

    function getPersonById(personId) {
      return taskPeople.find(p => p.id === personId);
    }

    // ============ SIDEBAR DRAG AND DROP REORDER ============
    let draggedSidebarItem = null;
    let draggedSidebarType = null;
    let sidebarDragPosition = null; // 'top' or 'bottom'

    // Setup sidebar drag and drop using event delegation (called after render)
    function setupSidebarDragDrop() {
      document.querySelectorAll('.draggable-item').forEach(item => {
        item.addEventListener('dragstart', function(e) {
          const id = this.dataset.id;
          const type = this.dataset.type;
          draggedSidebarItem = id;
          draggedSidebarType = type;
          this.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', id);
        });

        item.addEventListener('dragend', function(e) {
          this.classList.remove('dragging');
          document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
            el.classList.remove('drag-over', 'drag-over-bottom');
          });
          draggedSidebarItem = null;
          draggedSidebarType = null;
          sidebarDragPosition = null;
        });

        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          if (this.classList.contains('dragging')) return;

          // Determine if cursor is in top or bottom half
          const rect = this.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          const position = e.clientY < midpoint ? 'top' : 'bottom';

          // Clear previous indicators
          document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
            el.classList.remove('drag-over', 'drag-over-bottom');
          });

          // Add appropriate class
          if (position === 'top') {
            this.classList.add('drag-over');
          } else {
            this.classList.add('drag-over-bottom');
          }
          sidebarDragPosition = position;
        });

        item.addEventListener('dragleave', function(e) {
          this.classList.remove('drag-over', 'drag-over-bottom');
        });

        item.addEventListener('drop', function(e) {
          e.preventDefault();
          const targetId = this.dataset.id;
          const type = this.dataset.type;
          document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
            el.classList.remove('drag-over', 'drag-over-bottom');
          });

          if (!draggedSidebarItem || draggedSidebarType !== type || draggedSidebarItem === targetId) {
            return;
          }

          let arr;
          if (type === 'category') arr = taskCategories;
          else if (type === 'label') arr = taskLabels;
          else if (type === 'person') arr = taskPeople;
          else if (type === 'perspective') arr = customPerspectives;
          else return;

          const fromIdx = arr.findIndex(item => item.id === draggedSidebarItem);
          let toIdx = arr.findIndex(item => item.id === targetId);

          if (fromIdx === -1 || toIdx === -1) return;

          // Adjust target index based on drop position
          if (sidebarDragPosition === 'bottom' && fromIdx < toIdx) {
            // No adjustment needed
          } else if (sidebarDragPosition === 'bottom' && fromIdx > toIdx) {
            toIdx += 1;
          } else if (sidebarDragPosition === 'top' && fromIdx > toIdx) {
            // No adjustment needed
          } else if (sidebarDragPosition === 'top' && fromIdx < toIdx) {
            toIdx -= 1;
          }

          // Remove from old position and insert at new position
          const [removed] = arr.splice(fromIdx, 1);
          arr.splice(toIdx, 0, removed);

          saveTasksData();
          render();
        });
      });
    }

    function getTasksByPerson(personId) {
      return tasksData.filter(task => task.people && task.people.includes(personId) && !task.completed);
    }

    function showPersonTasks(personId) {
      activeFilterType = 'person';
      activePersonFilter = personId;
      activePerspective = null;
      activeCategoryFilter = null;
      activeLabelFilter = null;
      saveViewState();
      render();
    }

    // Inline Tag creation in modal
    let showInlineTagInput = false;
    let showInlinePersonInput = false;

    function toggleInlineTagInput() {
      showInlineTagInput = !showInlineTagInput;
      const container = document.getElementById('inline-tag-form');
      if (container) {
        if (showInlineTagInput) {
          container.innerHTML = `
            <div class="flex items-center gap-2 mt-2 p-2 bg-warmgray/30 rounded-lg">
              <input type="text" id="inline-tag-name" placeholder="Tag name"
                class="flex-1 px-2 py-1.5 text-sm border border-softborder rounded focus:border-coral focus:outline-none"
                onkeydown="if(event.key==='Enter'){event.preventDefault();addInlineTag();}">
              <input type="color" id="inline-tag-color" value="#6B7280" class="w-8 h-8 rounded cursor-pointer border-0">
              <button onclick="addInlineTag()" class="px-3 py-1.5 text-sm bg-coral text-white rounded hover:bg-coralDark">Add</button>
              <button onclick="toggleInlineTagInput()" class="px-2 py-1.5 text-sm text-charcoal/50 hover:text-charcoal">&times;</button>
            </div>
          `;
          setTimeout(() => document.getElementById('inline-tag-name')?.focus(), 50);
        } else {
          container.innerHTML = '';
        }
      }
    }

    function addInlineTag() {
      const name = document.getElementById('inline-tag-name')?.value?.trim();
      const color = document.getElementById('inline-tag-color')?.value || '#6B7280';
      if (name) {
        const newTag = createLabel(name, color);
        showInlineTagInput = false;
        // Re-render the tags section and pre-select the new tag
        const labelsContainer = document.getElementById('task-labels-container');
        if (labelsContainer) {
          // Get currently selected tags
          const selectedTags = Array.from(document.querySelectorAll('.task-label-checkbox:checked')).map(cb => cb.value);
          selectedTags.push(newTag.id); // Add the new tag as selected

          // Re-render tags
          labelsContainer.innerHTML = taskLabels.map(label => {
            const isSelected = selectedTags.includes(label.id);
            return `
              <label class="label-checkbox flex items-center gap-1.5 px-2 py-1 rounded border cursor-pointer transition ${isSelected ? 'bg-warmgray' : 'hover:bg-warmgray/50'}" style="border-color: ${label.color}">
                <input type="checkbox" value="${label.id}" ${isSelected ? 'checked' : ''} class="task-label-checkbox rounded" style="accent-color: ${label.color}">
                <span class="text-sm" style="color: ${label.color}">${label.name}</span>
              </label>
            `;
          }).join('') + `
            <button onclick="toggleInlineTagInput()" class="flex items-center gap-1 px-2 py-1 text-sm text-charcoal/50 hover:text-charcoal hover:bg-warmgray/50 rounded border border-dashed border-charcoal/20">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              New
            </button>
          `;
        }
        document.getElementById('inline-tag-form').innerHTML = '';
      }
    }

    function toggleInlinePersonInput() {
      showInlinePersonInput = !showInlinePersonInput;
      const container = document.getElementById('inline-person-form');
      if (container) {
        if (showInlinePersonInput) {
          container.innerHTML = `
            <div class="flex items-center gap-2 mt-2 p-2 bg-warmgray/30 rounded-lg">
              <input type="text" id="inline-person-name" placeholder="Person name"
                class="flex-1 px-2 py-1.5 text-sm border border-softborder rounded focus:border-coral focus:outline-none"
                onkeydown="if(event.key==='Enter'){event.preventDefault();addInlinePerson();}">
              <button onclick="addInlinePerson()" class="px-3 py-1.5 text-sm bg-coral text-white rounded hover:bg-coralDark">Add</button>
              <button onclick="toggleInlinePersonInput()" class="px-2 py-1.5 text-sm text-charcoal/50 hover:text-charcoal">&times;</button>
            </div>
          `;
          setTimeout(() => document.getElementById('inline-person-name')?.focus(), 50);
        } else {
          container.innerHTML = '';
        }
      }
    }

    function addInlinePerson() {
      const name = document.getElementById('inline-person-name')?.value?.trim();
      if (name) {
        const newPerson = createPerson(name);
        showInlinePersonInput = false;
        // Re-render the people section and pre-select the new person
        const peopleContainer = document.getElementById('task-people-container');
        if (peopleContainer) {
          // Get currently selected people
          const selectedPeople = Array.from(document.querySelectorAll('.task-person-checkbox:checked')).map(cb => cb.value);
          selectedPeople.push(newPerson.id); // Add the new person as selected

          // Re-render people
          peopleContainer.innerHTML = taskPeople.map(person => {
            const isSelected = selectedPeople.includes(person.id);
            return `
              <label class="label-checkbox flex items-center gap-1.5 px-2 py-1 rounded border border-charcoal/20 cursor-pointer transition ${isSelected ? 'bg-warmgray border-charcoal/40' : 'hover:bg-warmgray/50'}">
                <input type="checkbox" value="${person.id}" ${isSelected ? 'checked' : ''} class="task-person-checkbox rounded">
                <span class="text-sm text-charcoal/70">${person.name}</span>
              </label>
            `;
          }).join('') + `
            <button onclick="toggleInlinePersonInput()" class="flex items-center gap-1 px-2 py-1 text-sm text-charcoal/50 hover:text-charcoal hover:bg-warmgray/50 rounded border border-dashed border-charcoal/20">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              New
            </button>
          `;
        }
        document.getElementById('inline-person-form').innerHTML = '';
      }
    }

    function createTask(title, options = {}) {
      const task = {
        id: generateTaskId(),
        title: title,
        notes: options.notes || '',
        status: options.status || 'inbox', // inbox, today, anytime, someday
        completed: false,
        completedAt: null,
        categoryId: options.categoryId || null,
        labels: options.labels || [],
        people: options.people || [],       // Array of person IDs
        deferDate: options.deferDate || null, // When task becomes available
        dueDate: options.dueDate || null,     // Deadline
        repeat: options.repeat || null,       // { type: 'daily'|'weekly'|'monthly'|'yearly', interval: 1, from: 'completion'|'due' }
        isNote: options.isNote || false,      // If true, displays as note (bullet) instead of task (checkbox)
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      tasksData.push(task);
      saveTasksData();
      return task;
    }

    function updateTask(taskId, updates) {
      const idx = tasksData.findIndex(t => t.id === taskId);
      if (idx !== -1) {
        const task = tasksData[idx];
        // Things 3 logic: Assigning Area to Inbox task moves it to Anytime
        if (task.status === 'inbox' && updates.categoryId && !task.categoryId) {
          updates.status = 'anytime';
        }
        tasksData[idx] = { ...task, ...updates, updatedAt: new Date().toISOString() };
        saveTasksData();
      }
    }

    function deleteTask(taskId) {
      tasksData = tasksData.filter(t => t.id !== taskId);
      saveTasksData();
    }

    // Delete task with confirmation
    function confirmDeleteTask(taskId) {
      // Cancel any inline editing first
      inlineEditingTaskId = null;
      if (confirm('Delete this task?')) {
        deleteTask(taskId);
        render();
      }
    }

    function toggleTaskComplete(taskId) {
      const task = tasksData.find(t => t.id === taskId);
      if (task) {
        const wasCompleted = task.completed;
        task.completed = !task.completed;
        task.completedAt = task.completed ? new Date().toISOString() : null;
        task.updatedAt = new Date().toISOString();

        // Handle repeating tasks - create next occurrence when completed
        if (task.completed && task.repeat && task.repeat.type !== 'none') {
          createNextRepeatOccurrence(task);
        }

        saveTasksData();
        render();
      }
    }

    // Calculate next date based on repeat settings
    function calculateNextRepeatDate(baseDate, repeat) {
      const date = new Date(baseDate);
      const interval = repeat.interval || 1;

      switch (repeat.type) {
        case 'daily':
          date.setDate(date.getDate() + interval);
          break;
        case 'weekly':
          date.setDate(date.getDate() + (7 * interval));
          break;
        case 'monthly':
          date.setMonth(date.getMonth() + interval);
          break;
        case 'yearly':
          date.setFullYear(date.getFullYear() + interval);
          break;
      }
      return date.toISOString().split('T')[0];
    }

    // Create the next occurrence of a repeating task
    function createNextRepeatOccurrence(completedTask) {
      const today = new Date().toISOString().split('T')[0];
      const baseDate = completedTask.repeat.from === 'due' && completedTask.dueDate
        ? completedTask.dueDate
        : today;

      // Calculate new defer and due dates
      let newDeferDate = null;
      let newDueDate = null;

      if (completedTask.deferDate) {
        const deferBase = completedTask.repeat.from === 'due' && completedTask.deferDate
          ? completedTask.deferDate
          : today;
        newDeferDate = calculateNextRepeatDate(deferBase, completedTask.repeat);
      }

      if (completedTask.dueDate) {
        newDueDate = calculateNextRepeatDate(baseDate, completedTask.repeat);
      }

      // Create new task with same properties
      createTask(completedTask.title, {
        notes: completedTask.notes,
        status: completedTask.status === 'today' ? 'inbox' : completedTask.status,
        categoryId: completedTask.categoryId,
        labels: [...(completedTask.labels || [])],
        deferDate: newDeferDate,
        dueDate: newDueDate,
        repeat: { ...completedTask.repeat }
      });
    }

    // Get the unit label for repeat type
    function getRepeatUnitLabel(type) {
      const units = { daily: 'day(s)', weekly: 'week(s)', monthly: 'month(s)', yearly: 'year(s)' };
      return units[type] || 'day(s)';
    }

    // Update repeat UI when type changes
    function updateRepeatUI(type) {
      const details = document.getElementById('repeat-details');
      const fromContainer = document.getElementById('repeat-from-container');
      const unitLabel = document.getElementById('repeat-unit-label');

      if (type === 'none') {
        details.style.display = 'none';
        fromContainer.style.display = 'none';
      } else {
        details.style.display = 'flex';
        fromContainer.style.display = 'block';
        unitLabel.textContent = getRepeatUnitLabel(type);
      }
    }

    function moveTaskTo(taskId, status) {
      updateTask(taskId, { status: status });
      render();
    }

    // Drag and drop state
    let draggedTaskId = null;
    let dragOverTaskId = null;
    let dragPosition = null; // 'top' or 'bottom'

    function handleDragStart(e, taskId) {
      draggedTaskId = taskId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', taskId);

      // Add is-dragging class to task list
      const taskList = e.target.closest('.task-list');
      if (taskList) taskList.classList.add('is-dragging');
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');

      // Remove all drag indicators
      document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
        el.classList.remove('drag-over', 'drag-over-bottom');
      });

      const taskList = document.querySelector('.task-list.is-dragging');
      if (taskList) taskList.classList.remove('is-dragging');

      // Perform reorder if valid
      if (draggedTaskId && dragOverTaskId && draggedTaskId !== dragOverTaskId) {
        reorderTasks(draggedTaskId, dragOverTaskId, dragPosition);
      }

      draggedTaskId = null;
      dragOverTaskId = null;
      dragPosition = null;
    }

    function handleDragOver(e, taskId) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';

      if (taskId === draggedTaskId) return;

      const rect = e.target.closest('.task-item').getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      const position = e.clientY < midpoint ? 'top' : 'bottom';

      // Remove previous indicators
      document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(el => {
        el.classList.remove('drag-over', 'drag-over-bottom');
      });

      // Add indicator to current target
      const taskItem = e.target.closest('.task-item');
      if (position === 'top') {
        taskItem.classList.add('drag-over');
      } else {
        taskItem.classList.add('drag-over-bottom');
      }

      dragOverTaskId = taskId;
      dragPosition = position;
    }

    function handleDragLeave(e) {
      // Only remove if leaving the task item entirely
      if (!e.target.closest('.task-item')?.contains(e.relatedTarget)) {
        e.target.closest('.task-item')?.classList.remove('drag-over', 'drag-over-bottom');
      }
    }

    function handleDrop(e, taskId) {
      e.preventDefault();
      // Reorder is handled in dragEnd
    }

    function reorderTasks(draggedId, targetId, position) {
      const draggedTask = tasksData.find(t => t.id === draggedId);
      const targetTask = tasksData.find(t => t.id === targetId);
      if (!draggedTask || !targetTask) return;

      // Get all tasks in current view
      const filteredTasks = getCurrentFilteredTasks();
      const taskIds = filteredTasks.map(t => t.id);

      // Find indices
      const draggedIndex = taskIds.indexOf(draggedId);
      const targetIndex = taskIds.indexOf(targetId);
      if (draggedIndex === -1 || targetIndex === -1) return;

      // Calculate new order values
      let newOrder;
      if (position === 'top') {
        const prevTask = targetIndex > 0 ? filteredTasks[targetIndex - 1] : null;
        const prevOrder = prevTask?.order ?? targetTask.order - 1000;
        newOrder = (prevOrder + targetTask.order) / 2;
      } else {
        const nextTask = targetIndex < filteredTasks.length - 1 ? filteredTasks[targetIndex + 1] : null;
        const nextOrder = nextTask?.order ?? targetTask.order + 1000;
        newOrder = (targetTask.order + nextOrder) / 2;
      }

      // Update dragged task order
      draggedTask.order = newOrder;
      draggedTask.updatedAt = new Date().toISOString();

      // Normalize orders if they get too close (rebalance)
      normalizeTaskOrders();

      saveTasksData();
      render();
    }

    function normalizeTaskOrders() {
      // Group tasks by status and rebalance order values
      const statuses = ['inbox', 'today', 'anytime', 'someday'];
      statuses.forEach(status => {
        const statusTasks = tasksData
          .filter(t => t.status === status && !t.completed)
          .sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

        statusTasks.forEach((task, index) => {
          task.order = (index + 1) * 1000;
        });
      });
    }

    // Initialize task orders if not set
    function initializeTaskOrders() {
      let needsSave = false;
      tasksData.forEach((task, index) => {
        if (task.order === undefined) {
          task.order = (index + 1) * 1000;
          needsSave = true;
        }
      });
      if (needsSave) saveTasksData();
    }
    initializeTaskOrders();

    function getFilteredTasks(perspectiveId) {
      // Notes perspective shows tasks marked as notes
      if (perspectiveId === 'notes') {
        return tasksData.filter(task => task.isNote && !task.completed)
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      }

      const allPerspectives = [...BUILTIN_PERSPECTIVES, ...customPerspectives];
      const perspective = allPerspectives.find(p => p.id === perspectiveId);
      if (!perspective) return [];

      const today = new Date().toISOString().split('T')[0];

      return tasksData.filter(task => {
        // Notes don't appear in regular task perspectives (except logbook which shows all completed)
        if (task.isNote && !perspective.filter.completed) return false;

        // Logbook (completed) shows all completed tasks (including notes)
        if (perspective.filter.completed) {
          return task.completed;
        }
        // Other perspectives show only non-completed tasks
        if (task.completed) return false;

        // Things 3 logic for Today:
        // - Tasks explicitly marked as 'today'
        // - Tasks with today's due date
        // - Overdue tasks (due date in the past)
        // - "Next" tasks: tasks tagged with a "next" label
        if (perspectiveId === 'today') {
          const isDueToday = task.dueDate === today;
          const isOverdue = task.dueDate && task.dueDate < today;
          const isTodayTask = task.status === 'today' || isDueToday || isOverdue;

          // Include tasks tagged with "next" label
          const nextLabel = taskLabels.find(l => l.name.toLowerCase() === 'next');
          const isNextTask = nextLabel && (task.labels || []).includes(nextLabel.id);

          return isTodayTask || isNextTask;
        }

        // Upcoming: Tasks with future due dates (not today, not overdue)
        // Shows tasks from Anytime or Someday that have scheduled due dates
        if (perspectiveId === 'upcoming') {
          if (!task.dueDate) return false;
          return task.dueDate > today;
        }

        // Anytime: Tasks available to do anytime (no specific schedule)
        // Excludes tasks that are in Today or have a future due date
        if (perspectiveId === 'anytime') {
          if (task.status !== 'anytime') return false;
          // If it has a due date in the future, it shows in Upcoming instead
          if (task.dueDate && task.dueDate > today) return false;
          return true;
        }

        // Someday: Tasks for later consideration
        if (perspectiveId === 'someday') {
          return task.status === 'someday';
        }

        // Next: Available tasks without deadlines (OmniFocus-style)
        // Shows tasks you can work on right now with no time pressure
        if (perspectiveId === 'next') {
          // Must be in anytime status (not inbox, someday, or today)
          if (task.status !== 'anytime') return false;
          // Must NOT have a due date (no deadline pressure)
          if (task.dueDate) return false;
          // Must be available now (not deferred to future)
          if (task.deferDate && task.deferDate > today) return false;
          return true;
        }

        // Inbox: Unprocessed tasks (no area assigned)
        // Things 3 logic: Inbox and Areas are mutually exclusive
        if (perspectiveId === 'inbox') {
          return task.status === 'inbox' && !task.categoryId;
        }

        // Custom perspectives
        if (perspective.filter.status && task.status !== perspective.filter.status) return false;
        if (perspective.filter.categoryId && task.categoryId !== perspective.filter.categoryId) return false;
        if (perspective.filter.hasLabel && !(task.labels || []).some(l => l === perspective.filter.hasLabel)) return false;
        if (perspective.filter.labelIds && perspective.filter.labelIds.length > 0) {
          // Task must have at least one of the selected tags
          if (!(task.labels || []).some(l => perspective.filter.labelIds.includes(l))) return false;
        }
        if (perspective.filter.hasDueDate && !task.dueDate) return false;
        if (perspective.filter.dueSoon) {
          if (!task.dueDate) return false;
          const due = new Date(task.dueDate);
          const now = new Date();
          const diffDays = (due - now) / (1000 * 60 * 60 * 24);
          if (diffDays > 7 || diffDays < 0) return false;
        }
        return true;
      }).sort((a, b) => {
        // Sort by manual order first if available
        if (a.order !== undefined && b.order !== undefined) {
          return a.order - b.order;
        }
        // Then by due date
        if (a.dueDate && !b.dueDate) return -1;
        if (!a.dueDate && b.dueDate) return 1;
        if (a.dueDate && b.dueDate && a.dueDate !== b.dueDate) {
          return new Date(a.dueDate) - new Date(b.dueDate);
        }
        // Inbox shows newest first
        if (perspectiveId === 'inbox') return new Date(b.createdAt) - new Date(a.createdAt);
        return new Date(a.createdAt) - new Date(b.createdAt);
      });
    }

    // Group tasks by due date (for Upcoming view)
    function groupTasksByDate(tasks) {
      const groups = {};
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      tasks.forEach(task => {
        if (!task.dueDate) return;
        const date = task.dueDate;
        if (!groups[date]) {
          groups[date] = [];
        }
        groups[date].push(task);
      });

      // Sort dates and return as array of { date, label, tasks }
      return Object.keys(groups).sort().map(date => {
        const d = new Date(date + 'T00:00:00');
        const diffDays = Math.floor((d - today) / (1000 * 60 * 60 * 24));
        let label;
        if (diffDays === 0) label = 'Today';
        else if (diffDays === 1) label = 'Tomorrow';
        else if (diffDays < 7) label = d.toLocaleDateString('en-US', { weekday: 'long' });
        else label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

        return { date, label, tasks: groups[date] };
      });
    }

    // Group tasks by completion date (for Logbook view)
    function groupTasksByCompletionDate(tasks) {
      const groups = {};
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      tasks.forEach(task => {
        if (!task.completedAt) return;
        const date = task.completedAt.split('T')[0];
        if (!groups[date]) {
          groups[date] = [];
        }
        groups[date].push(task);
      });

      // Sort dates descending (most recent first) and return as array of { date, label, tasks }
      return Object.keys(groups).sort().reverse().map(date => {
        const d = new Date(date + 'T00:00:00');
        const diffDays = Math.floor((today - d) / (1000 * 60 * 60 * 24));
        let label;
        if (diffDays === 0) label = 'Today';
        else if (diffDays === 1) label = 'Yesterday';
        else if (diffDays < 7) label = d.toLocaleDateString('en-US', { weekday: 'long' });
        else label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

        return { date, label, tasks: groups[date] };
      });
    }

    // Get tasks by category
    function getTasksByCategory(categoryId) {
      const today = new Date().toISOString().split('T')[0];
      return tasksData.filter(task => task.categoryId === categoryId && !task.completed)
        .sort((a, b) => {
          if (a.dueDate && !b.dueDate) return -1;
          if (!a.dueDate && b.dueDate) return 1;
          if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
          return new Date(a.createdAt) - new Date(b.createdAt);
        });
    }

    // Get tasks by label
    function getTasksByLabel(labelId) {
      return tasksData.filter(task => (task.labels || []).includes(labelId) && !task.completed)
        .sort((a, b) => {
          if (a.dueDate && !b.dueDate) return -1;
          if (!a.dueDate && b.dueDate) return 1;
          if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
          return new Date(a.createdAt) - new Date(b.createdAt);
        });
    }

    // Get current filtered tasks based on active filter type
    function getCurrentFilteredTasks() {
      if (activeFilterType === 'category' && activeCategoryFilter) {
        return getTasksByCategory(activeCategoryFilter);
      } else if (activeFilterType === 'label' && activeLabelFilter) {
        return getTasksByLabel(activeLabelFilter);
      } else if (activeFilterType === 'person' && activePersonFilter) {
        return getTasksByPerson(activePersonFilter);
      } else {
        return getFilteredTasks(activePerspective);
      }
    }

    // Get current view info
    function getCurrentViewInfo() {
      if (activeFilterType === 'category' && activeCategoryFilter) {
        const cat = getCategoryById(activeCategoryFilter);
        return { icon: 'ðŸ“', name: cat?.name || 'Category', color: cat?.color };
      } else if (activeFilterType === 'label' && activeLabelFilter) {
        const label = getLabelById(activeLabelFilter);
        return { icon: 'ðŸ·ï¸', name: label?.name || 'Tag', color: label?.color };
      } else if (activeFilterType === 'person' && activePersonFilter) {
        const person = getPersonById(activePersonFilter);
        return { icon: 'ðŸ‘¤', name: person?.name || 'Person', color: person?.color };
      } else {
        const allPerspectives = [...BUILTIN_PERSPECTIVES, ...customPerspectives];
        const p = allPerspectives.find(p => p.id === activePerspective) || BUILTIN_PERSPECTIVES[0];
        return { icon: p.icon, name: p.name };
      }
    }

    function createPerspective(name, icon, filter) {
      const perspective = {
        id: 'custom_' + Date.now(),
        name: name,
        icon: icon || 'ðŸ“Œ',
        filter: filter,
        builtin: false
      };
      customPerspectives.push(perspective);
      saveTasksData();
      return perspective;
    }

    function deletePerspective(perspectiveId) {
      customPerspectives = customPerspectives.filter(p => p.id !== perspectiveId);
      if (activePerspective === perspectiveId) activePerspective = 'inbox';
      saveTasksData();
    }

    let editingPerspectiveId = null;

    function editCustomPerspective(perspectiveId) {
      editingPerspectiveId = perspectiveId;
      showPerspectiveModal = true;
      render();
      // Pre-fill the form after render
      setTimeout(() => {
        const p = customPerspectives.find(cp => cp.id === perspectiveId);
        if (p) {
          document.getElementById('perspective-name').value = p.name;
          document.getElementById('perspective-icon').value = p.icon;
          if (p.filter.categoryId) document.getElementById('perspective-category').value = p.filter.categoryId;
          if (p.filter.status) document.getElementById('perspective-status').value = p.filter.status;
          if (p.filter.hasDueDate) document.getElementById('perspective-due').checked = true;
          if (p.filter.labelIds) {
            p.filter.labelIds.forEach(lid => {
              const cb = document.querySelector(`.perspective-tag-checkbox[value="${lid}"]`);
              if (cb) cb.checked = true;
            });
          }
        }
      }, 10);
    }

    function getCategoryById(categoryId) {
      return taskCategories.find(c => c.id === categoryId);
    }

    // Personal Bests tracking
    function getPersonalBests() {
      const dates = Object.keys(allData).sort();
      if (dates.length === 0) return null;

      let bests = {
        highestDayScore: { value: 0, date: null },
        highestWeekScore: { value: 0, weekStart: null },
        longestStreak: { value: 0, endDate: null },
        currentStreak: 0,
        bestPrayerDay: { value: 0, date: null },
        bestWhoopDay: { value: 0, date: null },
        mostQuranPages: { value: 0, date: null },
        perfectPrayerDays: 0,
        totalDaysLogged: dates.length
      };

      // Calculate streaks and daily bests
      let currentStreakCount = 0;
      let lastDate = null;

      dates.forEach(date => {
        const dayData = allData[date];
        const scores = calculateScores(dayData);

        // Highest day score
        if (scores.total > bests.highestDayScore.value) {
          bests.highestDayScore = { value: scores.total, date };
        }

        // Best prayer day
        if (scores.prayer > bests.bestPrayerDay.value) {
          bests.bestPrayerDay = { value: scores.prayer, date };
        }

        // Best whoop day
        if (scores.whoop > bests.bestWhoopDay.value) {
          bests.bestWhoopDay = { value: scores.whoop, date };
        }

        // Most Quran pages
        const quranPages = parseInt(dayData.prayers.quran) || 0;
        if (quranPages > bests.mostQuranPages.value) {
          bests.mostQuranPages = { value: quranPages, date };
        }

        // Perfect prayer days (5 on-time prayers)
        let onTimePrayers = 0;
        ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => {
          const { onTime } = parsePrayer(dayData.prayers[p]);
          if (onTime >= 1) onTimePrayers++;
        });
        if (onTimePrayers === 5) bests.perfectPrayerDays++;

        // Streak calculation
        if (lastDate) {
          const lastD = new Date(lastDate);
          const currD = new Date(date);
          const diffDays = Math.round((currD - lastD) / (1000 * 60 * 60 * 24));
          if (diffDays === 1) {
            currentStreakCount++;
          } else {
            currentStreakCount = 1;
          }
        } else {
          currentStreakCount = 1;
        }

        if (currentStreakCount > bests.longestStreak.value) {
          bests.longestStreak = { value: currentStreakCount, endDate: date };
        }

        lastDate = date;
      });

      // Check if current streak is active (last entry was today or yesterday)
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
      if (lastDate === today || lastDate === yesterday) {
        bests.currentStreak = currentStreakCount;
      }

      // Weekly scores
      const weekScores = {};
      dates.forEach(date => {
        const d = new Date(date);
        const weekStart = new Date(d.setDate(d.getDate() - d.getDay())).toISOString().split('T')[0];
        if (!weekScores[weekStart]) weekScores[weekStart] = 0;
        weekScores[weekStart] += calculateScores(allData[date]).total;
      });

      Object.entries(weekScores).forEach(([weekStart, score]) => {
        if (score > bests.highestWeekScore.value) {
          bests.highestWeekScore = { value: Math.round(score), weekStart };
        }
      });

      return bests;
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
      localStorage.setItem('lastUpdated', Date.now().toString());
    }

    function getTodayData() {
      return allData[currentDate] || JSON.parse(JSON.stringify(defaultDayData));
    }

    function updateData(category, field, value) {
      const todayData = getTodayData();
      todayData[category][field] = value;
      allData[currentDate] = todayData;
      saveData();
      debouncedSaveToGithub(); // Auto-save to GitHub
      render();
    }

    function parsePrayer(value) {
      if (!value && value !== 0) return { onTime: 0, late: 0 };
      const num = parseFloat(value) || 0;
      const onTime = Math.floor(num);
      const late = Math.round((num - onTime) * 10);
      return { onTime, late };
    }

    function calcPrayerScore(value) {
      const { onTime, late } = parsePrayer(value);
      return onTime * WEIGHTS.prayer.onTime + late * WEIGHTS.prayer.late;
    }

    function calculateScores(data) {
      // Prayer Score
      let prayerScore = 0;
      let totalOnTime = 0, totalLate = 0;
      ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => {
        const { onTime, late } = parsePrayer(data.prayers[p]);
        totalOnTime += onTime;
        totalLate += late;
        prayerScore += onTime * WEIGHTS.prayer.onTime + late * WEIGHTS.prayer.late;
      });
      // Quran pages
      const quranPages = parseInt(data.prayers.quran) || 0;
      prayerScore += quranPages * WEIGHTS.prayer.quran;

      // Diabetes/Glucose Score
      let diabetesScore = 0;
      const avg = parseFloat(data.glucose.avg) || 0;
      const tir = parseFloat(data.glucose.tir) || 0;
      const insulin = parseFloat(data.glucose.insulin) || 0;

      // Avg glucose scoring - progressive: closer to 105 (midpoint of 70-140) = more points
      // Scale: 105 = max points, decreases as you move away from 105
      if (data.glucose.avg !== '') {
        const target = 105; // ideal midpoint
        const maxPts = WEIGHTS.glucose.avgMax || 20;
        if (avg >= 70 && avg <= 140) {
          // Perfect range: scale from target (full points) to edges (half points)
          const distFromTarget = Math.abs(avg - target);
          const maxDist = 35; // distance from 105 to 70 or 140
          diabetesScore += maxPts * (1 - (distFromTarget / maxDist) * 0.5);
        } else if (avg > 140 && avg <= 180) {
          // Acceptable range: scale down from edge
          const ptsAt140 = maxPts * 0.5;
          const penalty = (avg - 140) * (ptsAt140 / 40); // lose all by 180
          diabetesScore += Math.max(0, ptsAt140 - penalty);
        }
        // Below 70 or above 180 = 0 points
      }

      // TIR scoring - progressive: each % point matters
      // Scale: 0.3 pts per % (so 70% = 21 pts, 100% = 30 pts)
      if (data.glucose.tir !== '' && tir > 0) {
        const ptsPerPercent = WEIGHTS.glucose.tirPerPoint || 0.3;
        diabetesScore += tir * ptsPerPercent;
      }

      // Insulin scoring: base points if â‰¤threshold, flat penalty if >threshold
      const insulinThreshold = WEIGHTS.glucose.insulinThreshold || 40;
      if (data.glucose.insulin !== '' && insulin > 0) {
        if (insulin <= insulinThreshold) {
          diabetesScore += WEIGHTS.glucose.insulinBase;
        } else {
          diabetesScore += WEIGHTS.glucose.insulinPenalty;
        }
      }

      // Whoop Age Score - Based on age-reducing metrics
      let whoopScore = 0;
      const w = data.whoop;
      const ww = WEIGHTS.whoop;

      // Sleep Performance: â‰¥90% optimal
      const sleepPerf = parseFloat(w.sleepPerf) || 0;
      if (w.sleepPerf !== '') {
        if (sleepPerf >= 90) whoopScore += ww.sleepPerfHigh;
        else if (sleepPerf >= 70) whoopScore += ww.sleepPerfMid;
        else if (sleepPerf >= 50) whoopScore += ww.sleepPerfLow;
      }

      // Recovery
      const recovery = parseFloat(w.recovery) || 0;
      if (w.recovery !== '') {
        if (recovery >= 66) whoopScore += ww.recoveryHigh;
        else if (recovery >= 50) whoopScore += ww.recoveryMid;
        else if (recovery >= 33) whoopScore += ww.recoveryLow;
      }

      // Strain - recovery-matched scoring
      // High recovery (â‰¥66%) â†’ reward high strain (14-21)
      // Medium recovery (33-65%) â†’ reward moderate strain (10-14)
      // Low recovery (<33%) â†’ reward rest/light strain (0-10)
      const strain = parseFloat(w.strain) || 0;
      if (w.strain !== '' && w.recovery !== '') {
        let strainMatch = false;
        if (recovery >= 66 && strain >= 14) strainMatch = true;
        else if (recovery >= 33 && recovery < 66 && strain >= 10 && strain < 14) strainMatch = true;
        else if (recovery < 33 && strain < 10) strainMatch = true;

        if (strainMatch) whoopScore += (ww.strainMatch || 10);
        // Bonus for high strain on high recovery days
        if (recovery >= 66 && strain >= 18) whoopScore += (ww.strainHigh || 5);
      }

      // Family Score - individual weights per member
      let familyScore = 0;
      Object.entries(data.family).forEach(([member, checked]) => {
        if (checked) familyScore += WEIGHTS.family[member] || 0;
      });

      // Habit Score
      let habitScore = 0;
      habitScore += (parseInt(data.habits.exercise) || 0) * WEIGHTS.habits.exercise;
      habitScore += (parseInt(data.habits.reading) || 0) * WEIGHTS.habits.reading;
      habitScore += (parseInt(data.habits.meditation) || 0) * WEIGHTS.habits.meditation;
      habitScore += (parseFloat(data.habits.water) || 0) * WEIGHTS.habits.water;
      habitScore += data.habits.vitamins ? WEIGHTS.habits.vitamins : 0;
      habitScore += (parseInt(data.habits.brushTeeth) || 0) * WEIGHTS.habits.brushTeeth;
      // NoP scoring: points if 1, penalty if 0
      const nop = data.habits.nop;
      if (nop !== '' && nop !== null && nop !== undefined) {
        if (parseInt(nop) === 1) habitScore += (WEIGHTS.habits.nopYes || 5);
        else if (parseInt(nop) === 0) habitScore += (WEIGHTS.habits.nopNo || -3);
      }

      return {
        prayer: prayerScore,
        prayerOnTime: totalOnTime,
        prayerLate: totalLate,
        diabetes: Math.round(diabetesScore * 10) / 10,
        whoop: Math.round(whoopScore * 10) / 10,
        family: familyScore,
        habit: habitScore,
        total: Math.round((prayerScore + diabetesScore + whoopScore + familyScore + habitScore) * 10) / 10
      };
    }

    function getLast30DaysData() {
      const days = [];
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const dayData = allData[dateStr] || defaultDayData;
        const dayScores = calculateScores(dayData);
        days.push({
          date: dateStr,
          day: date.getDate(),
          month: date.toLocaleDateString('en-US', { month: 'short' }),
          label: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          ...dayScores
        });
      }
      return days;
    }

    function getLast30DaysStats() {
      let stats = { totalScore: 0, daysLogged: 0, totalOnTimePrayers: 0, totalLatePrayers: 0, totalFamilyCheckins: 0, avgRHR: 0, avgSleep: 0, rhrCount: 0, sleepCount: 0 };

      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        if (allData[dateStr]) {
          stats.daysLogged++;
          const d = allData[dateStr];
          const dayScores = calculateScores(d);
          stats.totalScore += dayScores.total;
          stats.totalOnTimePrayers += dayScores.prayerOnTime;
          stats.totalLatePrayers += dayScores.prayerLate;
          stats.totalFamilyCheckins += Object.values(d.family).filter(Boolean).length;
          if (d.whoop.rhr) { stats.avgRHR += parseFloat(d.whoop.rhr); stats.rhrCount++; }
          if (d.whoop.sleepHours) { stats.avgSleep += parseFloat(d.whoop.sleepHours); stats.sleepCount++; }
        }
      }
      stats.totalScore = Math.round(stats.totalScore);
      stats.avgRHR = stats.rhrCount ? Math.round(stats.avgRHR / stats.rhrCount) : 0;
      stats.avgSleep = stats.sleepCount ? (stats.avgSleep / stats.sleepCount).toFixed(1) : 0;
      stats.avgDaily = stats.daysLogged ? Math.round(stats.totalScore / stats.daysLogged) : 0;
      return stats;
    }

    function createPrayerInput(prayer, label, value) {
      const { onTime, late } = parsePrayer(value);
      const pts = calcPrayerScore(value);
      return `
        <div class="flex-1 text-center">
          <input type="text" value="${value}" placeholder="X.Y"
            class="prayer-input w-full px-3 py-2 border border-softborder rounded text-center font-mono text-lg bg-white mb-1"
            onchange="updateData('prayers', '${prayer}', this.value)">
          <div class="text-xs font-medium text-charcoal/70">${label}</div>
          <div class="text-xs text-charcoal/50 mt-0.5">
            <span class="text-green-600">${onTime}âœ“</span> <span class="text-amber-500">${late}â—</span>
          </div>
          <div class="text-xs font-semibold text-coral mt-0.5">${pts} pts</div>
        </div>
      `;
    }

    function createToggle(label, checked, category, field) {
      return `
        <label class="flex items-center justify-between cursor-pointer py-2 px-1 hover:bg-warmgray rounded transition">
          <span class="text-sm text-charcoal">${label}</span>
          <div class="relative toggle-switch" onclick="updateData('${category}', '${field}', !${checked})">
            <div class="w-10 h-5 rounded-full transition ${checked ? 'toggle-on' : 'toggle-off'}"></div>
            <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow transition" style="transform: translateX(${checked ? '20px' : '0'})"></div>
          </div>
        </label>
      `;
    }

    function createNumberInput(label, value, category, field, placeholder, unit, hint = '', tooltip = '', tooltipPos = 'center') {
      // tooltipPos: 'left', 'center', 'right' to control horizontal alignment
      const posClass = tooltipPos === 'left' ? 'left-0' : tooltipPos === 'right' ? 'right-0' : 'left-1/2 -translate-x-1/2';
      return `
        <div class="flex-1 text-center group relative">
          <input type="number" step="any" value="${value}" placeholder="${placeholder}"
            class="w-full px-2 py-2 border border-softborder rounded text-center text-sm bg-white mb-1"
            onchange="updateData('${category}', '${field}', this.value)">
          <div class="text-xs font-medium text-charcoal/70 flex items-center justify-center gap-1">
            ${label}
            ${tooltip ? `<span class="cursor-help text-charcoal/30 hover:text-coral">â“˜</span>` : ''}
          </div>
          <div class="text-xs text-charcoal/40">${unit}${hint ? ` Â· ${hint}` : ''}</div>
          ${tooltip ? `<div class="absolute ${posClass} top-full mt-1 z-50 hidden group-hover:block bg-charcoal text-white text-xs rounded p-3 w-48 shadow-lg text-left">${tooltip}</div>` : ''}
        </div>
      `;
    }

    function createCounter(label, value, category, field, max = 10) {
      return `
        <div class="flex items-center justify-between py-2">
          <span class="text-sm text-charcoal">${label}</span>
          <div class="flex items-center gap-2">
            <button onclick="updateData('${category}', '${field}', Math.max(0, ${value} - 1))"
              class="w-7 h-7 rounded-full bg-warmgray hover:bg-softborder flex items-center justify-center font-bold text-charcoal/60 transition">âˆ’</button>
            <span class="w-8 text-center font-semibold text-lg text-charcoal">${value}</span>
            <button onclick="updateData('${category}', '${field}', Math.min(${max}, ${value} + 1))"
              class="w-7 h-7 rounded-full bg-coral hover:bg-coralDark text-white flex items-center justify-center font-bold transition">+</button>
          </div>
        </div>
      `;
    }

    function createScoreCard(label, score, max, colorClass) {
      const pct = max ? Math.min((score / max) * 100, 100) : 0;
      // Map old color classes to muted category colors (work with both themes)
      const accentMap = {
        'bg-blue-500': '#4A90A4',
        'bg-green-500': '#6B8E5A',
        'bg-purple-500': '#7C6B8E',
        'bg-amber-500': '#C4943D',
        'bg-slate-500': '#6B7280'
      };
      const accent = accentMap[colorClass] || getAccentColor();
      const pctDisplay = Math.round(pct);
      return `
        <div class="sb-card rounded-lg p-4">
          <div class="flex justify-between items-center mb-1">
            <span class="sb-section-title text-charcoal/60">${label}</span>
            <span class="text-xs text-charcoal/40">${pctDisplay}%</span>
          </div>
          <div class="font-bold text-2xl text-charcoal mb-2">${fmt(score)}</div>
          <div class="h-1.5 bg-charcoal/10 rounded-full overflow-hidden">
            <div class="h-full rounded-full transition-all duration-500" style="width: ${pct}%; background: ${accent}"></div>
          </div>
        </div>
      `;
    }

    function createCard(title, icon, accentColor, content, extraHeader = '') {
      const accent = accentColor || '#6B7280';
      return `
        <div class="sb-card rounded-lg overflow-hidden">
          <div class="px-5 py-3 flex items-center justify-between bg-warmgray" style="border-bottom: 3px solid ${accent}">
            <div class="flex items-center gap-2">
              <span class="text-lg">${icon}</span>
              <h3 class="font-semibold text-charcoal">${title}</h3>
            </div>
            ${extraHeader ? `<span class="text-charcoal/50 text-xs">${extraHeader}</span>` : ''}
          </div>
          <div class="p-5 bg-white">${content}</div>
        </div>
      `;
    }

    // ============ HOME TAB (Customizable Widget Dashboard) ============
    function renderHomeTab() {
      const today = new Date().toISOString().split('T')[0];
      const todayData = allData[today] || {};
      const scores = calculateScores(todayData);

      // Get visible widgets sorted by order
      const visibleWidgets = homeWidgets.filter(w => w.visible).sort((a, b) => a.order - b.order);
      const hiddenWidgets = homeWidgets.filter(w => !w.visible);

      return `
        <div class="space-y-6">
          <!-- Header -->
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold text-charcoal">Good ${new Date().getHours() < 12 ? 'morning' : new Date().getHours() < 18 ? 'afternoon' : 'evening'}, Muhammad</h1>
              <p class="text-charcoal/50 text-sm mt-1">${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
            </div>
            <div class="flex items-center gap-3">
              ${editingHomeWidgets ? `
                <button onclick="resetHomeWidgets()" class="text-sm text-charcoal/50 hover:text-charcoal px-3 py-1.5 rounded-lg hover:bg-charcoal/5 transition">
                  Reset Layout
                </button>
              ` : ''}
              <button onclick="toggleEditHomeWidgets()" class="text-sm px-3 py-1.5 rounded-lg transition ${editingHomeWidgets ? 'bg-coral text-white' : 'text-charcoal/50 hover:text-charcoal hover:bg-charcoal/5'}">
                ${editingHomeWidgets ? 'âœ“ Done' : 'âš™ï¸ Customize'}
              </button>
            </div>
          </div>

          ${editingHomeWidgets && hiddenWidgets.length > 0 ? `
            <!-- Hidden Widgets -->
            <div class="bg-warmgray/30 rounded-xl p-4">
              <div class="flex items-center gap-2 mb-3">
                <svg class="w-4 h-4 text-charcoal/40" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                <span class="text-sm font-medium text-charcoal/50">Hidden Widgets</span>
              </div>
              <div class="flex flex-wrap gap-2">
                ${hiddenWidgets.map(w => `
                  <button onclick="toggleWidgetVisibility('${w.id}')" class="text-sm px-3 py-1.5 rounded-lg border border-dashed border-charcoal/20 text-charcoal/60 hover:border-coral hover:text-coral transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    ${w.title}
                  </button>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Widget Grid -->
          <div class="grid grid-cols-2 gap-4">
            ${visibleWidgets.map(widget => renderHomeWidget(widget, editingHomeWidgets)).join('')}
          </div>

          <!-- Today's Score Summary -->
          <div class="bg-gradient-to-br from-coral to-coralDark rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold opacity-90">Today's Score</h3>
                <p class="text-4xl font-bold mt-1">${scores.total.toFixed(0)} <span class="text-lg font-normal opacity-70">/ ${MAX_SCORES.total}</span></p>
              </div>
              <div class="text-right">
                <div class="text-sm opacity-70">Progress</div>
                <div class="text-2xl font-bold">${Math.round((scores.total / MAX_SCORES.total) * 100)}%</div>
              </div>
            </div>
            <div class="h-2 bg-white/20 rounded-full mt-4 overflow-hidden">
              <div class="h-full bg-white rounded-full transition-all duration-500" style="width: ${Math.min((scores.total / MAX_SCORES.total) * 100, 100)}%"></div>
            </div>
            <div class="grid grid-cols-5 gap-2 mt-4">
              <div class="text-center">
                <div class="text-xs opacity-60">Prayers</div>
                <div class="font-semibold">${scores.prayers.toFixed(0)}</div>
              </div>
              <div class="text-center">
                <div class="text-xs opacity-60">Glucose</div>
                <div class="font-semibold">${scores.glucose.toFixed(0)}</div>
              </div>
              <div class="text-center">
                <div class="text-xs opacity-60">Whoop</div>
                <div class="font-semibold">${scores.whoop.toFixed(0)}</div>
              </div>
              <div class="text-center">
                <div class="text-xs opacity-60">Family</div>
                <div class="font-semibold">${scores.family.toFixed(0)}</div>
              </div>
              <div class="text-center">
                <div class="text-xs opacity-60">Habits</div>
                <div class="font-semibold">${scores.habits.toFixed(0)}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderTrackingTab() {
      const data = getTodayData();
      const scores = calculateScores(data);

      const prayerHelp = `<span class="text-xs text-charcoal/50">X.Y = X on-time + Y late</span>`;
      const prayersContent = `
        <div class="flex gap-2 mb-4">
          ${['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].map(p =>
            createPrayerInput(p, p.charAt(0).toUpperCase() + p.slice(1), data.prayers[p])
          ).join('')}
        </div>
        <div class="border-t border-softborder pt-4">
          <div class="flex items-center justify-center gap-3">
            <span class="text-sm text-charcoal/70">ðŸ“– Quran</span>
            <button onclick="updateData('prayers', 'quran', Math.max(0, ${parseInt(data.prayers.quran) || 0} - 1))"
              class="w-7 h-7 rounded-full bg-warmgray hover:bg-softborder flex items-center justify-center font-bold text-charcoal/60">âˆ’</button>
            <span class="w-8 text-center font-semibold text-lg">${parseInt(data.prayers.quran) || 0}</span>
            <button onclick="updateData('prayers', 'quran', ${parseInt(data.prayers.quran) || 0} + 1)"
              class="w-7 h-7 rounded-full bg-coral hover:bg-coralDark text-white flex items-center justify-center font-bold">+</button>
            <span class="text-xs text-charcoal/50">pages Â· ${(parseInt(data.prayers.quran) || 0) * 5} pts</span>
          </div>
        </div>
      `;

      const insulinThreshold = WEIGHTS.glucose.insulinThreshold || 40;
      const glucoseContent = `
        <div class="flex gap-3">
          ${createNumberInput('Avg Glucose', data.glucose.avg, 'glucose', 'avg', '105', 'mg/dL', '105=10pts')}
          ${createNumberInput('TIR', data.glucose.tir, 'glucose', 'tir', '70+', '%', '0.1pts/%')}
          ${createNumberInput('Insulin', data.glucose.insulin, 'glucose', 'insulin', 'â‰¤' + insulinThreshold, 'units', 'â‰¤' + insulinThreshold + '=+5')}
        </div>
      `;

      const whoopHelp = `<span class="text-xs text-charcoal/50">Hover â“˜ for tips</span>`;
      const whoopContent = `
        <div class="grid grid-cols-3 gap-3">
          ${createNumberInput('Sleep Perf', data.whoop.sleepPerf, 'whoop', 'sleepPerf', 'â‰¥90', '%', 'â‰¥90%', '<b>How to improve:</b><br>â€¢ Consistent bedtime/wake time<br>â€¢ Cool room (65-68Â°F)<br>â€¢ No screens 1h before bed', 'left')}
          ${createNumberInput('Recovery', data.whoop.recovery, 'whoop', 'recovery', 'â‰¥66', '%', 'â‰¥66%', '<b>How to improve recovery:</b><br>â€¢ Prioritize sleep quality<br>â€¢ Hydrate well<br>â€¢ Eat nutritious foods', 'center')}
          ${createNumberInput('Strain', data.whoop.strain, 'whoop', 'strain', '10-14', '/21', 'match', '<b>Recovery-matched:</b><br>â€¢ Green (â‰¥66%) â†’ 14+ strain<br>â€¢ Yellow (33-65%) â†’ 10-14 strain<br>â€¢ Red (<33%) â†’ rest', 'right')}
        </div>
      `;

      const familyContent = ['mom', 'dad', 'jana', 'tia', 'ahmed', 'eman'].map(p =>
        createToggle(p.charAt(0).toUpperCase() + p.slice(1), data.family[p], 'family', p)
      ).join('');

      const habitsContent = `
        <div class="space-y-2">
          ${createCounter('ðŸ‹ï¸ Exercise', data.habits.exercise || 0, 'habits', 'exercise', 5)}
          ${createCounter('ðŸ“š Reading', data.habits.reading || 0, 'habits', 'reading', 5)}
          ${createCounter('ðŸ§˜ Meditation', data.habits.meditation || 0, 'habits', 'meditation', 5)}
          ${createCounter('ðŸ¦· Brush Teeth', data.habits.brushTeeth || 0, 'habits', 'brushTeeth', 3)}
          ${createToggle('ðŸ’Š Vitamins taken', data.habits.vitamins, 'habits', 'vitamins')}
        </div>
        <div class="flex gap-3 mt-3 pt-3 border-t border-softborder">
          <div class="flex-1 text-center">
            <input type="number" step="any" value="${data.habits.water}" placeholder="2.5"
              class="w-full px-2 py-2 border border-softborder rounded text-center text-sm bg-white mb-1"
              onchange="updateData('habits', 'water', this.value)">
            <div class="text-xs font-medium text-charcoal/70">ðŸ’§ Water</div>
            <div class="text-xs text-charcoal/40">L Â· 1pt/L</div>
          </div>
          <div class="flex-1 text-center">
            <input type="number" step="1" value="${data.habits.nop}" placeholder="0-1"
              class="w-full px-2 py-2 border border-softborder rounded text-center text-sm bg-white mb-1"
              onchange="updateData('habits', 'nop', this.value)">
            <div class="text-xs font-medium text-charcoal/70">ðŸ’¤ NoP</div>
            <div class="text-xs text-charcoal/40">1=+2, 0=-2</div>
          </div>
        </div>
      `;

      const summaryContent = `
        <div class="space-y-3">
          <div class="p-3 bg-purple-50 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="font-medium">Whoop Age</span>
              <div class="flex items-center gap-2">
                <input type="number" step="0.1" value="${data.whoop.whoopAge || ''}" placeholder="â€”"
                  class="w-16 px-2 py-1 border border-purple-200 rounded text-center text-sm bg-white font-bold text-purple-600"
                  onchange="updateData('whoop', 'whoopAge', this.value)">
                <span class="text-xs text-purple-400">yrs</span>
              </div>
            </div>
          </div>
          <div class="p-3 bg-blue-50 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="font-medium">Prayers</span>
              <span class="font-bold text-blue-600">${scores.prayer} pts</span>
            </div>
            <div class="text-xs mt-1">
              <span class="inline-block bg-green-100 text-green-700 px-2 py-0.5 rounded mr-1">${scores.prayerOnTime} on-time</span>
              <span class="inline-block bg-amber-100 text-amber-700 px-2 py-0.5 rounded">${scores.prayerLate} late</span>
            </div>
          </div>
          <div class="flex justify-between items-center p-3 bg-amber-50 rounded-lg">
            <span class="font-medium">Family</span>
            <span class="font-bold text-amber-600">${Object.values(data.family).filter(Boolean).length}/6</span>
          </div>
        </div>
      `;

      return `
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
          ${createScoreCard('Prayer', scores.prayer, MAX_SCORES.prayer, 'bg-blue-500')}
          ${createScoreCard('Diabetes', scores.diabetes, MAX_SCORES.diabetes, 'bg-green-500')}
          ${createScoreCard('Whoop', scores.whoop, MAX_SCORES.whoop, 'bg-purple-500')}
          ${createScoreCard('Family', scores.family, MAX_SCORES.family, 'bg-amber-500')}
          ${createScoreCard('Habits', scores.habit, MAX_SCORES.habits, 'bg-slate-500')}
          <div class="sb-card rounded-lg p-4 bg-coral text-white">
            <div class="sb-section-title text-white/80 flex justify-between">
              <span>Total</span>
              <span>${Math.round((scores.total / MAX_SCORES.total) * 100)}%</span>
            </div>
            <div class="text-3xl font-bold mt-1">${fmt(scores.total)}</div>
            <div class="h-1.5 bg-white/30 rounded-full mt-2 overflow-hidden">
              <div class="h-full bg-white rounded-full" style="width: ${Math.min((scores.total / MAX_SCORES.total) * 100, 100)}%"></div>
            </div>
          </div>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5">
          ${createCard('Prayers', 'ðŸ•Œ', '#4A90A4', prayersContent, prayerHelp)}
          ${createCard('Glucose (Libre)', 'ðŸ’‰', '#6B8E5A', glucoseContent)}
          ${createCard('Whoop Age Metrics', 'â±ï¸', '#7C6B8E', whoopContent, whoopHelp)}
          ${createCard('Family Check-ins', 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦', '#C4943D', familyContent)}
          ${createCard('Habits', 'âœ¨', '#6B7280', habitsContent)}
          ${createCard("Today's Summary", 'ðŸ“ˆ', getAccentColor(), summaryContent)}
        </div>
      `;
    }

    function renderDashboardTab() {
      const stats = getLast30DaysStats();
      const last30Data = getLast30DaysData();
      const bests = getPersonalBests();

      setTimeout(() => {
        const weekCtx = document.getElementById('weekChart');
        if (weekCtx) {
          if (weekChart) weekChart.destroy();
          weekChart = new Chart(weekCtx, {
            type: 'bar',
            data: {
              labels: last30Data.map(d => d.label),
              datasets: [{ label: 'Total Score', data: last30Data.map(d => d.total), backgroundColor: getAccentColor(), borderRadius: 4 }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true },
                x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } }
              }
            }
          });
        }

        const breakdownCtx = document.getElementById('breakdownChart');
        if (breakdownCtx) {
          if (breakdownChart) breakdownChart.destroy();
          breakdownChart = new Chart(breakdownCtx, {
            type: 'line',
            data: {
              labels: last30Data.map(d => d.label),
              datasets: [
                { label: 'Prayer', data: last30Data.map(d => d.prayer), borderColor: '#4A90A4', tension: 0.3, pointRadius: 2 },
                { label: 'Whoop', data: last30Data.map(d => d.whoop), borderColor: '#7C6B8E', tension: 0.3, pointRadius: 2 },
                { label: 'Family', data: last30Data.map(d => d.family), borderColor: '#C4943D', tension: 0.3, pointRadius: 2 },
                { label: 'Habit', data: last30Data.map(d => d.habit), borderColor: '#6B7280', tension: 0.3, pointRadius: 2 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom' } },
              scales: {
                y: { beginAtZero: true },
                x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } }
              }
            }
          });
        }
      }, 100);

      return `
        <div class="space-y-8">
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="sb-card rounded-lg p-5 bg-coral text-white">
              <div class="sb-section-title text-white/70">30-Day Score</div>
              <div class="text-3xl font-bold mt-1">${fmt(stats.totalScore)}</div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Days Logged</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${stats.daysLogged}/30</div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Avg RHR</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${fmt(stats.avgRHR)} <span class="text-base font-normal text-charcoal/50">bpm</span></div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Avg Sleep</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${stats.avgSleep} <span class="text-base font-normal text-charcoal/50">hrs</span></div>
            </div>
            <div class="sb-card rounded-lg p-5">
              <div class="sb-section-title text-charcoal/50">Family Check-ins</div>
              <div class="text-3xl font-bold mt-1 text-charcoal">${fmt(stats.totalFamilyCheckins)}</div>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Last 30 Days <span class="text-coral">â†’</span></h3>
            <div class="h-72"><canvas id="weekChart"></canvas></div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Score Breakdown <span class="text-coral">â†’</span></h3>
            <div class="h-72"><canvas id="breakdownChart"></canvas></div>
          </div>

          <!-- Personal Bests Section -->
          ${bests ? `
          <div class="sb-card rounded-lg p-6 bg-warmgray border-2 border-coral/20">
            <h3 class="font-semibold text-charcoal mb-4">Personal Bests <span class="text-coral">â†’</span></h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral">${fmt(bests.highestDayScore.value)}</div>
                <div class="text-sm text-charcoal/70 mt-1">Best Day Score</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.highestDayScore.date ? new Date(bests.highestDayScore.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'â€”'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral">${fmt(bests.highestWeekScore.value)}</div>
                <div class="text-sm text-charcoal/70 mt-1">Best Week Score</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.highestWeekScore.weekStart ? 'Week of ' + new Date(bests.highestWeekScore.weekStart).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'â€”'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral">${fmt(bests.longestStreak.value)}</div>
                <div class="text-sm text-charcoal/70 mt-1">Longest Streak</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.longestStreak.value > 0 ? 'days in a row' : 'â€”'}</div>
              </div>
              <div class="bg-white rounded-lg p-4 border border-softborder">
                <div class="text-3xl font-bold text-coral flex items-center gap-2">${fmt(bests.currentStreak)} ${bests.currentStreak > 0 ? 'ðŸ”¥' : ''}</div>
                <div class="text-sm text-charcoal/70 mt-1">Current Streak</div>
                <div class="text-xs text-charcoal/40 mt-1">${bests.currentStreak > 0 ? 'Keep it going!' : 'Log today to start!'}</div>
              </div>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="sb-card rounded-lg p-6 bg-white">
              <h3 class="font-semibold text-charcoal mb-4">Category Records <span class="text-coral">â†’</span></h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div>
                    <div class="text-sm font-medium text-charcoal">ðŸ•Œ Best Prayer Day</div>
                    <div class="text-xs text-charcoal/50">${bests.bestPrayerDay.date ? new Date(bests.bestPrayerDay.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'â€”'}</div>
                  </div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.bestPrayerDay.value)} pts</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div>
                    <div class="text-sm font-medium text-charcoal">â±ï¸ Best Whoop Day</div>
                    <div class="text-xs text-charcoal/50">${bests.bestWhoopDay.date ? new Date(bests.bestWhoopDay.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'â€”'}</div>
                  </div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.bestWhoopDay.value)} pts</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div>
                    <div class="text-sm font-medium text-charcoal">ðŸ“– Most Quran Pages</div>
                    <div class="text-xs text-charcoal/50">${bests.mostQuranPages.date ? new Date(bests.mostQuranPages.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'â€”'}</div>
                  </div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.mostQuranPages.value)} pages</div>
                </div>
              </div>
            </div>

            <div class="sb-card rounded-lg p-6 bg-white">
              <h3 class="font-semibold text-charcoal mb-4">Lifetime Stats <span class="text-coral">â†’</span></h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div class="text-sm font-medium text-charcoal">Total Days Logged</div>
                  <div class="text-xl font-bold text-charcoal">${fmt(bests.totalDaysLogged)}</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div class="text-sm font-medium text-charcoal">Perfect Prayer Days</div>
                  <div class="text-xl font-bold text-coral">${fmt(bests.perfectPrayerDays)} ðŸŒŸ</div>
                </div>
                <div class="flex items-center justify-between p-3 bg-warmgray rounded border border-softborder">
                  <div class="text-sm font-medium text-charcoal">Perfect Prayer Rate</div>
                  <div class="text-xl font-bold text-coral">${bests.totalDaysLogged > 0 ? Math.round((bests.perfectPrayerDays / bests.totalDaysLogged) * 100) : 0}%</div>
                </div>
              </div>
            </div>
          </div>
          ` : `
          <div class="sb-card rounded-lg p-8 bg-white text-center">
            <div class="text-4xl mb-4">ðŸŽ®</div>
            <h3 class="font-semibold text-charcoal mb-2">Start Your Journey!</h3>
            <p class="text-charcoal/50 text-sm">Log your first day to start tracking personal bests.</p>
          </div>
          `}
        </div>
      `;
    }

    // Helper function to render a single task item
    function renderTaskItem(task, showDueDate = true) {
      const category = getCategoryById(task.categoryId);
      const labels = (task.labels || []).map(lid => getLabelById(lid)).filter(Boolean);
      const today = new Date().toISOString().split('T')[0];
      const isOverdue = task.dueDate && task.dueDate < today && !task.completed;
      const hasMetadata = category || labels.length > 0 || (showDueDate && task.dueDate) || task.deferDate || (task.repeat && task.repeat.type !== 'none') || task.notes;
      const isInlineEditing = inlineEditingTaskId === task.id;

      return `
        <div class="task-item group relative"
          draggable="${isInlineEditing ? 'false' : 'true'}"
          ondragstart="handleDragStart(event, '${task.id}')"
          ondragend="handleDragEnd(event)"
          ondragover="handleDragOver(event, '${task.id}')"
          ondragleave="handleDragLeave(event)"
          ondrop="handleDrop(event, '${task.id}')">
          <div class="flex items-start gap-3 px-4 py-2">
            ${task.isNote ? `
              <div class="mt-1.5 w-2 h-2 rounded-full bg-[#8B5CF6] flex-shrink-0"></div>
            ` : `
              <button onclick="event.stopPropagation(); toggleTaskComplete('${task.id}')"
                class="task-checkbox mt-0.5 w-5 h-5 rounded-full border-2 flex-shrink-0 flex items-center justify-center transition-all ${task.completed ? 'completed bg-coral border-coral text-white' : 'border-charcoal/25 hover:border-coral/50'}">
                ${task.completed ? '<svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>' : ''}
              </button>
            `}
            <div class="flex-1 min-w-0">
              ${isInlineEditing ? `
                <input type="text" id="inline-edit-input" value="${task.title.replace(/"/g, '&quot;')}"
                  onkeydown="handleInlineEditKeydown(event, '${task.id}')"
                  onblur="saveInlineEdit('${task.id}')"
                  class="w-full text-[15px] text-charcoal bg-white border border-coral rounded px-2 py-0.5 outline-none focus:ring-2 focus:ring-coral/20">
              ` : `
                <span ondblclick="event.stopPropagation(); startInlineEdit('${task.id}')"
                  class="text-[15px] ${task.completed ? 'line-through text-charcoal/40' : 'text-charcoal'} leading-snug transition cursor-text">${task.title}</span>
              `}
              ${hasMetadata ? `
                <div class="flex items-center gap-2 mt-1 flex-wrap text-[12px]">
                  ${category ? `<span onclick="event.stopPropagation(); showCategoryTasks('${category.id}')" class="tag-pill px-2 py-0.5 rounded-full cursor-pointer border border-charcoal/15 text-charcoal/50 hover:text-charcoal/70">${category.name}</span>` : ''}
                  ${labels.map(l => `<span onclick="event.stopPropagation(); showLabelTasks('${l.id}')" class="tag-pill px-2 py-0.5 rounded-full cursor-pointer border border-charcoal/15 text-charcoal/50 hover:text-charcoal/70">${l.name}</span>`).join('')}
                  ${task.deferDate ? `<span class="flex items-center gap-1 text-amber-600"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>${new Date(task.deferDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>` : ''}
                  ${showDueDate && task.dueDate ? `<span class="flex items-center gap-1 ${isOverdue ? 'text-red-500 font-medium' : 'text-charcoal/40'}"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>${new Date(task.dueDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>` : ''}
                  ${task.repeat && task.repeat.type !== 'none' ? `<span class="flex items-center gap-0.5 text-coral"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>${task.repeat.interval > 1 ? task.repeat.interval : ''}${task.repeat.type.charAt(0).toUpperCase()}</span>` : ''}
                  ${task.notes ? `<span class="text-charcoal/30 truncate max-w-[150px]">${task.notes}</span>` : ''}
                </div>
              ` : ''}
            </div>
            <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 rounded px-1" onclick="event.stopPropagation()">
              ${!task.completed ? `
                <select onchange="inlineEditingTaskId=null; moveTaskTo('${task.id}', this.value); this.value=''"
                  onclick="event.stopPropagation()"
                  class="text-[11px] px-2 py-0.5 border border-softborder rounded bg-white text-charcoal/60 cursor-pointer hover:border-charcoal/30 transition h-[22px]">
                  <option value="">Move</option>
                  <option value="inbox">Inbox</option>
                  <option value="today">Today</option>
                  <option value="anytime">Anytime</option>
                  <option value="someday">Someday</option>
                </select>
              ` : ''}
              <button onclick="event.stopPropagation(); inlineEditingTaskId=null; editingTaskId='${task.id}'; showTaskModal=true; render()"
                class="p-0.5 text-charcoal/40 hover:text-charcoal hover:bg-charcoal/5 rounded transition" title="Edit">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </button>
              <button onclick="event.stopPropagation(); confirmDeleteTask('${task.id}')"
                class="p-0.5 text-charcoal/40 hover:text-red-500 hover:bg-red-50 rounded transition" title="Delete">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function render() {
      const app = document.getElementById('app');
      const dateDisplay = new Date(currentDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      app.innerHTML = `
        <header class="border-b border-softborder" style="background: var(--bg-primary);">
          <div class="${activeTab === 'tasks' ? 'max-w-6xl' : 'max-w-5xl'} mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <svg class="w-12 h-12 app-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                  <rect x="10" y="10" width="80" height="80" rx="12" style="fill: var(--text-primary)"/>
                  <rect x="24" y="20" width="22" height="22" rx="4" style="fill: var(--bg-primary)"/>
                  <rect x="24" y="46" width="22" height="22" rx="4" style="fill: var(--bg-primary)"/>
                  <rect x="50" y="46" width="22" height="22" rx="4" style="fill: var(--accent)"/>
                  <rect x="24" y="72" width="22" height="10" rx="3" style="fill: var(--bg-primary); opacity: 0.5"/>
                </svg>
                <div>
                  <div class="flex items-center gap-2">
                    <h1 class="text-2xl font-bold tracking-tight text-charcoal">Life Gamification</h1>
                    <span class="text-[10px] font-medium text-charcoal/40 bg-charcoal/5 px-1.5 py-0.5 rounded">v${APP_VERSION}</span>
                  </div>
                  <p class="text-sm text-charcoal/60 mt-0.5">Track habits, diabetes <span class="text-coral">+</span> reduce your biological age</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-warmgray border border-softborder" title="Cloud sync status">
                  <div id="sync-indicator" class="w-2 h-2 rounded-full ${getGithubToken() ? 'bg-green-500' : 'bg-charcoal/30'}"></div>
                  <span class="text-xs text-charcoal/50">${getGithubToken() ? 'Synced' : 'Local'}</span>
                </div>
                <input type="date" id="dateInput" value="${currentDate}"
                  onclick="this.showPicker()"
                  class="px-3 py-2 rounded-lg text-sm border border-softborder bg-white focus:border-coral focus:outline-none">
                <button onclick="setToday()" class="sb-btn px-4 py-2 rounded-lg text-sm font-medium">Today</button>
              </div>
            </div>
            <p class="text-charcoal/50 text-sm mt-2">${dateDisplay}</p>
          </div>
        </header>

        <!-- Main Navigation -->
        <nav class="border-b border-charcoal/10 bg-white/60">
          <div class="${activeTab === 'tasks' || activeTab === 'home' ? 'max-w-6xl' : 'max-w-5xl'} mx-auto px-6">
            <div class="flex gap-0">
              <button onclick="switchTab('home')" class="nav-tab py-3 px-5 text-sm font-medium transition-all border-b-2 ${activeTab === 'home' ? 'border-coral text-charcoal' : 'border-transparent text-charcoal/50 hover:text-charcoal hover:bg-black/[0.04]'}">
                ðŸ  Home
              </button>
              <button onclick="switchTab('life')" class="nav-tab py-3 px-5 text-sm font-medium transition-all border-b-2 ${activeTab === 'life' ? 'border-coral text-charcoal' : 'border-transparent text-charcoal/50 hover:text-charcoal hover:bg-black/[0.04]'}">
                ðŸ“Š Life Score
              </button>
              <button onclick="switchTab('tasks')" class="nav-tab py-3 px-5 text-sm font-medium transition-all border-b-2 ${activeTab === 'tasks' ? 'border-coral text-charcoal' : 'border-transparent text-charcoal/50 hover:text-charcoal hover:bg-black/[0.04]'}">
                âœ“ Tasks
              </button>
              <button onclick="switchTab('settings')" class="nav-tab py-3 px-5 text-sm font-medium transition-all border-b-2 ${activeTab === 'settings' ? 'border-coral text-charcoal' : 'border-transparent text-charcoal/50 hover:text-charcoal hover:bg-black/[0.04]'}">
                âš™ï¸ Settings
              </button>
            </div>
          </div>
        </nav>

        ${activeTab === 'life' ? `
        <!-- Sub Navigation for Life Score -->
        <div class="bg-warmgray/30 border-b border-charcoal/5">
          <div class="max-w-5xl mx-auto px-6">
            <div class="flex gap-1 py-2">
              <button onclick="switchSubTab('daily')" class="px-4 py-1.5 text-sm rounded-lg transition ${activeSubTab === 'daily' ? 'bg-white shadow-sm text-charcoal font-medium' : 'text-charcoal/60 hover:text-charcoal hover:bg-white/50'}">
                Daily Entry
              </button>
              <button onclick="switchSubTab('bulk')" class="px-4 py-1.5 text-sm rounded-lg transition ${activeSubTab === 'bulk' ? 'bg-white shadow-sm text-charcoal font-medium' : 'text-charcoal/60 hover:text-charcoal hover:bg-white/50'}">
                Bulk Entry
              </button>
              <button onclick="switchSubTab('dashboard')" class="px-4 py-1.5 text-sm rounded-lg transition ${activeSubTab === 'dashboard' ? 'bg-white shadow-sm text-charcoal font-medium' : 'text-charcoal/60 hover:text-charcoal hover:bg-white/50'}">
                Dashboard
              </button>
            </div>
          </div>
        </div>
        ` : ''}

        <main class="${activeTab === 'tasks' || activeTab === 'home' ? 'max-w-6xl' : 'max-w-5xl'} mx-auto px-6 py-8">
          ${activeTab === 'home' ? renderHomeTab() :
            activeTab === 'life' ? (activeSubTab === 'daily' ? renderTrackingTab() : activeSubTab === 'bulk' ? renderBulkEntryTab() : renderDashboardTab()) :
            activeTab === 'tasks' ? renderTasksTab() :
            renderSettingsTab()}
        </main>

        <footer class="border-t border-softborder py-8 mt-12">
          <p class="text-center text-charcoal/40 text-sm">${getGithubToken() ? 'Data synced to GitHub' : 'Data saved locally'} <span class="text-coral">â€¢</span> Muhammad's Life Gamification System</p>
        </footer>
      `;

      document.getElementById('dateInput').addEventListener('change', (e) => { currentDate = e.target.value; render(); });

      // Setup sidebar drag and drop after DOM is updated
      if (activeTab === 'tasks') {
        setupSidebarDragDrop();
      }
    }

    function switchTab(tab) { activeTab = tab; saveViewState(); render(); }
    function setToday() { currentDate = new Date().toISOString().split('T')[0]; render(); }

    function setBulkMonth(month, year) {
      bulkMonth = parseInt(month);
      bulkYear = parseInt(year);
      render();
    }

    function setBulkCategory(cat) {
      bulkCategory = cat;
      render();
    }

    function updateBulkData(dateStr, category, field, value) {
      if (!allData[dateStr]) {
        allData[dateStr] = JSON.parse(JSON.stringify(defaultDayData));
      }
      if (category === 'family') {
        allData[dateStr][category][field] = value === '1' || value === true;
      } else {
        allData[dateStr][category][field] = value;
      }
      saveData();
      debouncedSaveToGithub(); // Auto-save to GitHub
      // Update score cell live
      const scoreCell = document.getElementById('score-' + dateStr);
      if (scoreCell) {
        const newScore = calculateScores(allData[dateStr]).total;
        scoreCell.textContent = fmt(newScore);
      }
      // Update summary stats
      updateBulkSummary();
    }

    function updateBulkSummary() {
      const daysInMonth = getDaysInMonth(bulkMonth, bulkYear);
      let totalScore = 0, daysWithData = 0;
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = bulkYear + '-' + String(bulkMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        if (allData[dateStr]) {
          daysWithData++;
          totalScore += calculateScores(allData[dateStr]).total;
        }
      }
      const avgScore = daysWithData > 0 ? Math.round(totalScore / daysWithData) : 0;
      const completionRate = Math.round((daysWithData / daysInMonth) * 100);

      const daysEl = document.getElementById('bulk-days-logged');
      const totalEl = document.getElementById('bulk-total-score');
      const avgEl = document.getElementById('bulk-avg-score');
      const compEl = document.getElementById('bulk-completion');
      if (daysEl) daysEl.textContent = fmt(daysWithData);
      if (totalEl) totalEl.textContent = fmt(totalScore);
      if (avgEl) avgEl.textContent = fmt(avgScore);
      if (compEl) compEl.textContent = completionRate + '%';
    }

    function getDaysInMonth(month, year) {
      return new Date(year, month + 1, 0).getDate();
    }

    function renderBulkEntryTab() {
      const daysInMonth = getDaysInMonth(bulkMonth, bulkYear);
      const monthName = new Date(bulkYear, bulkMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      // Category colors matching Daily tab
      const categoryColors = {
        prayers: '#4A90A4',  // teal
        glucose: '#6B8E5A', // green
        whoop: '#7C6B8E',   // purple
        family: '#C4943D',  // amber
        habits: '#6B7280'   // slate
      };

      const categories = {
        prayers: { label: 'ðŸ•Œ Prayers', fields: ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha', 'quran'], headers: ['F', 'D', 'A', 'M', 'I', 'Q'] },
        glucose: { label: 'ðŸ’‰ Glucose', fields: ['avg', 'tir', 'insulin'], headers: ['Avg', 'TIR', 'Insulin'] },
        whoop: { label: 'â±ï¸ Whoop', fields: ['sleepPerf', 'recovery', 'strain'], headers: ['Sleep%', 'Rec', 'Strain'] },
        family: { label: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family', fields: ['mom', 'dad', 'jana', 'tia', 'ahmed', 'eman'], headers: ['Mom', 'Dad', 'Jana', 'Tia', 'Ahmed', 'Eman'] },
        habits: { label: 'âœ¨ Habits', fields: ['exercise', 'reading', 'meditation', 'water', 'vitamins', 'brushTeeth', 'nop'], headers: ['ðŸ‹ï¸', 'ðŸ“š', 'ðŸ§˜', 'ðŸ’§', 'ðŸ’Š', 'ðŸ¦·', 'ðŸ’¤'] }
      };

      const cat = categories[bulkCategory];

      // Generate month options (2026 and 2027)
      let monthOptions = '';
      [2026, 2027].forEach(function(year) {
        for (let m = 0; m < 12; m++) {
          const label = new Date(year, m).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          const selected = m === bulkMonth && year === bulkYear ? 'selected' : '';
          monthOptions += '<option value="' + m + '-' + year + '" ' + selected + '>' + label + '</option>';
        }
      });

      // Build the table rows
      let tableRows = '';
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = bulkYear + '-' + String(bulkMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        const dayData = allData[dateStr] || JSON.parse(JSON.stringify(defaultDayData));
        const dayOfWeek = new Date(bulkYear, bulkMonth, day).toLocaleDateString('en-US', { weekday: 'short' });
        const isWeekend = [0, 6].includes(new Date(bulkYear, bulkMonth, day).getDay());
        const isToday = dateStr === new Date().toISOString().split('T')[0];
        const scores = calculateScores(dayData);

        let cells = '';
        cat.fields.forEach(field => {
          const value = dayData[bulkCategory][field];

          if (bulkCategory === 'family' || (bulkCategory === 'habits' && field === 'vitamins')) {
            const checked = value ? 'checked' : '';
            cells += '<td class="border border-softborder px-1 py-1 text-center">' +
              '<input type="checkbox" ' + checked +
              ' class="w-5 h-5 rounded border-softborder text-coral focus:ring-coral cursor-pointer"' +
              ' onchange="updateBulkData(\'' + dateStr + '\', \'' + bulkCategory + '\', \'' + field + '\', this.checked ? \'1\' : \'\')">' +
              '</td>';
          } else if (bulkCategory === 'prayers' && field !== 'quran') {
            cells += '<td class="border border-softborder px-1 py-1">' +
              '<input type="text" value="' + (value || '') + '" placeholder="X.Y"' +
              ' class="w-full px-1 py-1 text-center text-sm font-mono border-0 focus:ring-2 focus:ring-coral rounded bg-white"' +
              ' onchange="updateBulkData(\'' + dateStr + '\', \'' + bulkCategory + '\', \'' + field + '\', this.value)">' +
              '</td>';
          } else {
            cells += '<td class="border border-softborder px-1 py-1">' +
              '<input type="number" step="any" value="' + (value || '') + '"' +
              ' class="w-full px-1 py-1 text-center text-sm border-0 focus:ring-2 focus:ring-coral rounded bg-white"' +
              ' onchange="updateBulkData(\'' + dateStr + '\', \'' + bulkCategory + '\', \'' + field + '\', this.value)">' +
              '</td>';
          }
        });

        const rowClass = (isWeekend ? 'bg-warmgray/50 ' : '') + (isToday ? 'bg-coral/10 ' : '') + 'hover:bg-warmgray';
        const dayCellClass = 'border border-softborder px-2 py-1 font-medium text-center text-charcoal sticky left-0 z-10 ' + (isToday ? 'bg-coral/20' : 'bg-white');
        const weekdayCellClass = 'border border-softborder px-2 py-1 text-xs text-charcoal/50 text-center sticky left-10 z-10 ' + (isToday ? 'bg-coral/20' : 'bg-white');

        tableRows += '<tr class="' + rowClass + '">' +
          '<td class="' + dayCellClass + '">' + day + '</td>' +
          '<td class="' + weekdayCellClass + '">' + dayOfWeek + '</td>' +
          cells +
          '<td id="score-' + dateStr + '" class="border border-softborder px-2 py-1 text-center font-semibold text-coral">' + fmt(scores.total) + '</td>' +
          '</tr>';
      }

      // Category buttons with section colors
      let catButtons = '';
      Object.entries(categories).forEach(function([key, val]) {
        const color = categoryColors[key];
        const btnClass = bulkCategory === key
          ? 'text-white'
          : 'bg-warmgray hover:bg-softborder text-charcoal';
        const btnStyle = bulkCategory === key ? 'background-color: ' + color : '';
        catButtons += '<button onclick="setBulkCategory(\'' + key + '\')" class="px-3 py-2 rounded-lg text-sm font-medium transition ' + btnClass + '" style="' + btnStyle + '">' + val.label + '</button>';
      });

      // Header cells with category color
      const catColor = categoryColors[bulkCategory];
      let headerCells = '';
      cat.headers.forEach(function(h) {
        headerCells += '<th class="border px-3 py-3 font-medium" style="border-color: ' + catColor + '">' + h + '</th>';
      });

      // Calculate summary stats
      let totalScore = 0, daysWithData = 0;
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = bulkYear + '-' + String(bulkMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        if (allData[dateStr]) {
          daysWithData++;
          totalScore += calculateScores(allData[dateStr]).total;
        }
      }
      const avgScore = daysWithData > 0 ? Math.round(totalScore / daysWithData) : 0;
      const completionRate = Math.round((daysWithData / daysInMonth) * 100);

      const prayerHint = bulkCategory === 'prayers' ? '<span class="ml-2 text-charcoal/70">â€¢ Use X.Y format: e.g., 1 = on-time, 0.1 = late, 1.2 = 1 on-time + 2 late</span>' : '';
      const familyHint = bulkCategory === 'family' ? '<span class="ml-2 text-charcoal/70">â€¢ Check box if you connected with that person</span>' : '';

      return '<div class="space-y-4">' +
        // Controls card
        '<div class="sb-card rounded-lg overflow-hidden">' +
          '<div class="px-5 py-3 bg-warmgray" style="border-bottom: 3px solid ' + getAccentColor() + '">' +
            '<h3 class="font-semibold text-charcoal">ðŸ“… Bulk Entry</h3>' +
          '</div>' +
          '<div class="p-5 bg-white">' +
            '<div class="flex flex-wrap items-center gap-4">' +
              '<div>' +
                '<label class="text-sm text-charcoal/60 block mb-1">Month</label>' +
                '<select onchange="const [m,y] = this.value.split(\'-\'); setBulkMonth(m, y)" class="px-3 py-2 border border-softborder rounded-lg focus:ring-2 focus:ring-coral outline-none bg-white text-charcoal">' +
                  monthOptions +
                '</select>' +
              '</div>' +
              '<div>' +
                '<label class="text-sm text-charcoal/60 block mb-1">Area</label>' +
                '<div class="flex gap-1 flex-wrap">' + catButtons + '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        // Info hint
        '<div class="rounded-lg p-3 text-sm" style="background-color: ' + catColor + '15; border-left: 3px solid ' + catColor + '">' +
          '<strong class="text-charcoal">' + monthName + '</strong> <span class="text-charcoal/70">' + cat.label + '</span>' + prayerHint + familyHint +
        '</div>' +
        // Data table
        '<div class="sb-card rounded-lg overflow-hidden">' +
          '<div class="overflow-x-auto">' +
            '<table class="w-full text-sm">' +
              '<thead>' +
                '<tr class="text-white" style="background-color: ' + catColor + '">' +
                  '<th class="border px-2 py-3 sticky left-0 z-20" style="border-color: ' + catColor + '; background-color: ' + catColor + '">Day</th>' +
                  '<th class="border px-2 py-3 sticky left-10 z-20" style="border-color: ' + catColor + '; background-color: ' + catColor + '"></th>' +
                  headerCells +
                  '<th class="border px-3 py-3 font-medium" style="border-color: ' + catColor + '">Score</th>' +
                '</tr>' +
              '</thead>' +
              '<tbody>' + tableRows + '</tbody>' +
            '</table>' +
          '</div>' +
        '</div>' +
        // Summary card
        '<div class="sb-card rounded-lg overflow-hidden">' +
          '<div class="px-5 py-3 bg-warmgray" style="border-bottom: 3px solid ' + getAccentColor() + '">' +
            '<h3 class="font-semibold text-charcoal">ðŸ“Š ' + monthName + ' Summary</h3>' +
          '</div>' +
          '<div class="p-5 bg-white">' +
            '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-days-logged" class="text-2xl font-bold text-charcoal">' + fmt(daysWithData) + '</div>' +
                '<div class="text-xs text-charcoal/60">Days Logged</div>' +
              '</div>' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-total-score" class="text-2xl font-bold text-coral">' + fmt(totalScore) + '</div>' +
                '<div class="text-xs text-charcoal/60">Total Score</div>' +
              '</div>' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-avg-score" class="text-2xl font-bold text-charcoal">' + fmt(avgScore) + '</div>' +
                '<div class="text-xs text-charcoal/60">Avg Daily Score</div>' +
              '</div>' +
              '<div class="bg-warmgray rounded-lg p-3 text-center">' +
                '<div id="bulk-completion" class="text-2xl font-bold text-charcoal">' + completionRate + '%</div>' +
                '<div class="text-xs text-charcoal/60">Completion Rate</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function createWeightInput(label, value, category, field = null) {
      return `
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <span class="text-sm text-gray-700">${label}</span>
          <input type="number" step="1" value="${value}"
            class="w-20 px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-blue-500 outline-none"
            onchange="updateWeight('${category}', ${field ? `'${field}'` : 'null'}, this.value)">
        </div>
      `;
    }

    function renderSettingsTab() {
      return `
        <div class="space-y-8">
          <div class="sb-card rounded-lg p-6 bg-white">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold text-charcoal">Scoring Weights <span class="text-coral">â†’</span></h3>
              <button onclick="resetWeights()" class="px-4 py-2 bg-coral/10 text-coral rounded text-sm font-medium hover:bg-coral/20 transition">
                Reset to Defaults
              </button>
            </div>
            <p class="text-sm text-charcoal/50 mb-6">Adjust the point values for each activity. Changes apply immediately.</p>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- 1. Prayer Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">ðŸ•Œ Prayer</h4>
                ${createWeightInput('On-time prayer', WEIGHTS.prayer.onTime, 'prayer', 'onTime')}
                ${createWeightInput('Late prayer', WEIGHTS.prayer.late, 'prayer', 'late')}
                ${createWeightInput('Quran (per page)', WEIGHTS.prayer.quran, 'prayer', 'quran')}
              </div>

              <!-- 2. Diabetes Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">ðŸ’‰ Glucose (Libre)</h4>
                ${createWeightInput('Avg Glucose max pts (at 105)', WEIGHTS.glucose.avgMax, 'glucose', 'avgMax')}
                ${createWeightInput('TIR pts per %', WEIGHTS.glucose.tirPerPoint, 'glucose', 'tirPerPoint')}
                ${createWeightInput('Insulin threshold (units)', WEIGHTS.glucose.insulinThreshold, 'glucose', 'insulinThreshold')}
                ${createWeightInput('Insulin â‰¤threshold bonus', WEIGHTS.glucose.insulinBase, 'glucose', 'insulinBase')}
                ${createWeightInput('Insulin >threshold penalty', WEIGHTS.glucose.insulinPenalty, 'glucose', 'insulinPenalty')}
              </div>

              <!-- 3. Whoop Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">â±ï¸ Whoop</h4>
                <div class="text-xs text-coral font-medium mb-2">Sleep Performance</div>
                ${createWeightInput('Sleep Perf â‰¥90%', WEIGHTS.whoop.sleepPerfHigh, 'whoop', 'sleepPerfHigh')}
                ${createWeightInput('Sleep Perf 70-90%', WEIGHTS.whoop.sleepPerfMid, 'whoop', 'sleepPerfMid')}
                ${createWeightInput('Sleep Perf 50-70%', WEIGHTS.whoop.sleepPerfLow, 'whoop', 'sleepPerfLow')}
                <div class="text-xs text-coral font-medium mb-2 mt-3">Recovery & Strain</div>
                ${createWeightInput('Recovery â‰¥66%', WEIGHTS.whoop.recoveryHigh, 'whoop', 'recoveryHigh')}
                ${createWeightInput('Recovery 50-66%', WEIGHTS.whoop.recoveryMid, 'whoop', 'recoveryMid')}
                ${createWeightInput('Recovery 33-50%', WEIGHTS.whoop.recoveryLow, 'whoop', 'recoveryLow')}
                ${createWeightInput('Strain matches recovery', WEIGHTS.whoop.strainMatch, 'whoop', 'strainMatch')}
                ${createWeightInput('High strain on green day', WEIGHTS.whoop.strainHigh, 'whoop', 'strainHigh')}
              </div>

              <!-- 4. Family Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family</h4>
                ${createWeightInput('Mom', WEIGHTS.family.mom, 'family', 'mom')}
                ${createWeightInput('Dad', WEIGHTS.family.dad, 'family', 'dad')}
                ${createWeightInput('Jana', WEIGHTS.family.jana, 'family', 'jana')}
                ${createWeightInput('Tia', WEIGHTS.family.tia, 'family', 'tia')}
                ${createWeightInput('Ahmed', WEIGHTS.family.ahmed, 'family', 'ahmed')}
                ${createWeightInput('Eman', WEIGHTS.family.eman, 'family', 'eman')}
              </div>

              <!-- 5. Habits Weights -->
              <div class="bg-warmgray rounded-lg p-4 border border-softborder">
                <h4 class="sb-section-title text-charcoal/70 mb-3">âœ¨ Habits</h4>
                ${createWeightInput('Exercise', WEIGHTS.habits.exercise, 'habits', 'exercise')}
                ${createWeightInput('Reading', WEIGHTS.habits.reading, 'habits', 'reading')}
                ${createWeightInput('Meditation', WEIGHTS.habits.meditation, 'habits', 'meditation')}
                ${createWeightInput('Water (per L)', WEIGHTS.habits.water, 'habits', 'water')}
                ${createWeightInput('Vitamins', WEIGHTS.habits.vitamins, 'habits', 'vitamins')}
                ${createWeightInput('Brush Teeth', WEIGHTS.habits.brushTeeth, 'habits', 'brushTeeth')}
                ${createWeightInput('NoP = 1 (bonus)', WEIGHTS.habits.nopYes, 'habits', 'nopYes')}
                ${createWeightInput('NoP = 0 (penalty)', WEIGHTS.habits.nopNo, 'habits', 'nopNo')}
              </div>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold text-charcoal">Perfect Day Targets <span class="text-coral">â†’</span></h3>
              <button onclick="resetMaxScores()" class="px-4 py-2 bg-coral/10 text-coral rounded text-sm font-medium hover:bg-coral/20 transition">
                Reset to Defaults
              </button>
            </div>
            <p class="text-sm text-charcoal/50 mb-6">Define what a "perfect day" looks like for each category. Progress bars show % of these targets.</p>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.prayer}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('prayer', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Prayer</div>
                <div class="text-xs text-charcoal/40">5Ã—5 + quran</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.diabetes}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('diabetes', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Diabetes</div>
                <div class="text-xs text-charcoal/40">avg+tir+ins</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.whoop}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('whoop', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Whoop</div>
                <div class="text-xs text-charcoal/40">all optimal</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.family}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('family', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Family</div>
                <div class="text-xs text-charcoal/40">all checked</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.habits}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1"
                  onchange="updateMaxScore('habits', this.value)">
                <div class="text-xs font-medium text-charcoal/70">Habits</div>
                <div class="text-xs text-charcoal/40">all done</div>
              </div>
              <div class="text-center">
                <input type="number" value="${MAX_SCORES.total}"
                  class="w-full px-3 py-2 border border-softborder rounded text-center text-lg bg-white mb-1 border-coral"
                  onchange="updateMaxScore('total', this.value)">
                <div class="text-xs font-medium text-coral">Total</div>
                <div class="text-xs text-charcoal/40">sum of all</div>
              </div>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Theme <span class="text-coral">â†’</span></h3>
            <p class="text-sm text-charcoal/50 mb-4">Choose your preferred visual style. Changes apply immediately.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              ${Object.entries(THEMES).map(([key, theme]) => `
                <button onclick="setTheme('${key}')"
                  class="p-4 rounded-lg border-2 text-left transition-all ${getTheme() === key ? 'border-coral bg-coral/5' : 'border-softborder hover:border-coral/50'}">
                  <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold text-charcoal">${theme.name}</span>
                    ${getTheme() === key ? '<span class="text-xs bg-coral text-white px-2 py-0.5 rounded-full">Active</span>' : ''}
                  </div>
                  <p class="text-sm text-charcoal/50">${theme.description}</p>
                  <div class="flex gap-2 mt-3">
                    ${key === 'simplebits' ? `
                      <div class="w-6 h-6 rounded-full bg-[#F7F6F4] border border-gray-300" title="Background"></div>
                      <div class="w-6 h-6 rounded-full bg-[#EFEDE8] border border-gray-300" title="Card"></div>
                      <div class="w-6 h-6 rounded-full bg-[#E5533D]" title="Accent"></div>
                      <div class="w-6 h-6 rounded-full bg-[#1a1a1a]" title="Text"></div>
                    ` : `
                      <div class="w-6 h-6 rounded-full bg-[#FFFFFF] border border-gray-300" title="Background"></div>
                      <div class="w-6 h-6 rounded-full bg-[#F5F5F7] border border-gray-300" title="Card"></div>
                      <div class="w-6 h-6 rounded-full bg-[#4A90D9]" title="Accent"></div>
                      <div class="w-6 h-6 rounded-full bg-[#1D1D1F]" title="Text"></div>
                    `}
                  </div>
                </button>
              `).join('')}
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Cloud Sync <span class="text-coral">â†’</span></h3>
            <p class="text-sm text-charcoal/50 mb-4">Enable automatic sync to GitHub. Your data will be saved to the cloud on every change.</p>

            <div class="mb-4">
              <label class="text-sm text-charcoal/70 block mb-2">GitHub Personal Access Token</label>
              <div class="flex gap-2">
                <input type="password" id="github-token-input" value="${getGithubToken()}"
                  placeholder="ghp_xxxx or github_pat_xxxx"
                  class="flex-1 px-3 py-2 border border-softborder rounded text-sm bg-white focus:border-coral focus:outline-none">
                <button onclick="setGithubToken(document.getElementById('github-token-input').value)"
                  class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  Save Token
                </button>
              </div>
              <p class="text-xs text-charcoal/40 mt-2">
                Token needs <code class="bg-warmgray px-1 rounded">repo</code> scope. Create at
                <a href="https://github.com/settings/tokens" target="_blank" class="sb-link">github.com/settings/tokens</a>
              </p>
            </div>

            <div class="flex flex-wrap gap-3 pt-4 border-t border-softborder">
              <button onclick="saveToGithub()" class="px-4 py-2 bg-coral text-white rounded text-sm font-medium hover:bg-coralDark transition ${getGithubToken() ? '' : 'opacity-50 cursor-not-allowed'}" ${getGithubToken() ? '' : 'disabled'}>
                Sync Now
              </button>
              <button onclick="loadCloudData().then(() => render())" class="px-4 py-2 bg-warmgray text-charcoal rounded text-sm font-medium hover:bg-softborder transition">
                Pull from Cloud
              </button>
              <span class="flex items-center text-xs text-charcoal/50">
                ${getGithubToken() ? '<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Connected' : '<span class="w-2 h-2 rounded-full bg-charcoal/30 mr-2"></span> Not connected'}
              </span>
            </div>
          </div>

          <div class="sb-card rounded-lg p-6 bg-white">
            <h3 class="font-semibold text-charcoal mb-4">Data Management <span class="text-coral">â†’</span></h3>
            <div class="flex flex-wrap gap-3">
              <button onclick="exportData()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                Export All Data
              </button>
              <label class="sb-btn px-4 py-2 rounded text-sm font-medium cursor-pointer">
                Import Data
                <input type="file" accept=".json" class="hidden" onchange="importData(event)">
              </label>
            </div>
            <p class="text-xs text-charcoal/40 mt-3">
              Export creates a local backup JSON file. Import merges data from a backup file.
            </p>
          </div>

          <!-- Changelog -->
          <div class="sb-card rounded-xl p-6 bg-white">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h3 class="font-semibold text-charcoal">Changelog <span class="text-coral">â†’</span></h3>
                <p class="text-sm text-charcoal/50 mt-1">Version history and updates</p>
              </div>
              <span class="px-3 py-1 bg-coral text-white text-sm font-semibold rounded-full">v3.2.0</span>
            </div>

            <div class="space-y-6">
              <!-- v3.2.0 -->
              <div class="border-l-2 border-coral pl-4">
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-semibold text-charcoal">v3.2.0</span>
                  <span class="text-xs text-charcoal/40">February 2026</span>
                  <span class="px-2 py-0.5 bg-green-100 text-green-700 text-[11px] font-medium rounded">Latest</span>
                </div>
                <ul class="text-sm text-charcoal/70 space-y-1.5">
                  <li class="flex items-start gap-2"><span class="text-coral mt-0.5">â€¢</span> Mobile-responsive design for iPhone Pro Max</li>
                  <li class="flex items-start gap-2"><span class="text-coral mt-0.5">â€¢</span> Redesigned sidebar with improved alignment & spacing</li>
                  <li class="flex items-start gap-2"><span class="text-coral mt-0.5">â€¢</span> Minimal drag indicator on right side of tasks</li>
                  <li class="flex items-start gap-2"><span class="text-coral mt-0.5">â€¢</span> Cleaner task item design with icon-based actions</li>
                  <li class="flex items-start gap-2"><span class="text-coral mt-0.5">â€¢</span> Header/nav/body width consistency across all tabs</li>
                </ul>
              </div>

              <!-- v3.1.0 -->
              <div class="border-l-2 border-charcoal/20 pl-4">
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-semibold text-charcoal">v3.1.0</span>
                  <span class="text-xs text-charcoal/40">January 2026</span>
                </div>
                <ul class="text-sm text-charcoal/70 space-y-1.5">
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Things 3 exact icons and colors</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Inter font (closest to SF Pro)</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> View state persistence (stays on same page after refresh)</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Renamed Categories to Areas (Things 3 terminology)</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Plus icon buttons instead of "Add" text</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Colored sidebar perspective icons</li>
                </ul>
              </div>

              <!-- v3.0.0 -->
              <div class="border-l-2 border-charcoal/20 pl-4">
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-semibold text-charcoal">v3.0.0</span>
                  <span class="text-xs text-charcoal/40">December 2025</span>
                </div>
                <ul class="text-sm text-charcoal/70 space-y-1.5">
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Complete UI overhaul with Things 3 theme</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Theme switcher (SimpleBits / Things 3)</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Tasks system with perspectives, areas, and labels</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Drag and drop task reordering</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> GitHub cloud sync</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Dashboard with charts and analytics</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Bulk entry tab for quick data input</li>
                </ul>
              </div>

              <!-- v2.0.0 -->
              <div class="border-l-2 border-charcoal/20 pl-4">
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-semibold text-charcoal">v2.0.0</span>
                  <span class="text-xs text-charcoal/40">November 2025</span>
                </div>
                <ul class="text-sm text-charcoal/70 space-y-1.5">
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Gamification system with points and scoring</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Customizable weight settings</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Prayer, glucose, whoop, family, habits tracking</li>
                </ul>
              </div>

              <!-- v1.0.0 -->
              <div class="border-l-2 border-charcoal/20 pl-4">
                <div class="flex items-center gap-3 mb-2">
                  <span class="font-semibold text-charcoal">v1.0.0</span>
                  <span class="text-xs text-charcoal/40">October 2025</span>
                </div>
                <ul class="text-sm text-charcoal/70 space-y-1.5">
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Initial release</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Basic daily tracking interface</li>
                  <li class="flex items-start gap-2"><span class="text-charcoal/30 mt-0.5">â€¢</span> Local storage persistence</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ============ TASKS TAB RENDERING ============
    function renderTasksTab() {
      const allPerspectives = [...BUILTIN_PERSPECTIVES, ...customPerspectives];
      const filteredTasks = getCurrentFilteredTasks();
      const viewInfo = getCurrentViewInfo();

      // Count tasks per perspective
      const taskCounts = {};
      const todayDate = new Date().toISOString().split('T')[0];
      BUILTIN_PERSPECTIVES.forEach(p => {
        if (p.id === 'today') {
          // Today count shows only dated tasks (not Next-tagged tasks)
          taskCounts[p.id] = tasksData.filter(t => {
            if (t.completed) return false;
            const isDueToday = t.dueDate === todayDate;
            const isOverdue = t.dueDate && t.dueDate < todayDate;
            return t.status === 'today' || isDueToday || isOverdue;
          }).length;
        } else if (p.id === 'notes') {
          // Notes count shows tasks marked as notes
          taskCounts[p.id] = tasksData.filter(t => t.isNote && !t.completed).length;
        } else {
          taskCounts[p.id] = getFilteredTasks(p.id).length;
        }
      });
      customPerspectives.forEach(p => {
        taskCounts[p.id] = getFilteredTasks(p.id).length;
      });

      // Count tasks per category
      const categoryCounts = {};
      taskCategories.forEach(cat => {
        categoryCounts[cat.id] = getTasksByCategory(cat.id).length;
      });

      // Count tasks per label
      const labelCounts = {};
      taskLabels.forEach(label => {
        labelCounts[label.id] = getTasksByLabel(label.id).length;
      });

      // Count tasks per person
      const peopleCounts = {};
      taskPeople.forEach(person => {
        peopleCounts[person.id] = getTasksByPerson(person.id).length;
      });

      // Check if perspective is active
      const isPerspectiveActive = (pId) => activeFilterType === 'perspective' && activePerspective === pId;
      const isCategoryActive = (cId) => activeFilterType === 'category' && activeCategoryFilter === cId;
      const isLabelActive = (lId) => activeFilterType === 'label' && activeLabelFilter === lId;
      const isPersonActive = (pId) => activeFilterType === 'person' && activePersonFilter === pId;

      // Build sidebar
      const sidebarHtml = `
        <div class="w-full md:w-64 flex-shrink-0 space-y-2">
          <!-- Perspectives -->
          <div class="bg-white rounded-xl border border-charcoal/[0.06]">
            <div class="py-1.5 px-1.5">
              ${BUILTIN_PERSPECTIVES.map(p => `
                <button onclick="showPerspectiveTasks('${p.id}')"
                  class="sidebar-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg ${isPerspectiveActive(p.id) ? 'active' : ''}">
                  <span class="w-6 h-6 flex items-center justify-center flex-shrink-0" style="color: ${p.color}">${p.icon}</span>
                  <span class="flex-1 text-[14px] ${isPerspectiveActive(p.id) ? 'font-medium text-charcoal' : 'text-charcoal/70'}">${p.name}</span>
                  <span class="count-badge w-6 text-right text-[13px] text-charcoal/35">${taskCounts[p.id] || ''}</span>
                </button>
              `).join('')}
            </div>
          </div>

          <!-- Custom Perspectives -->
          <div class="bg-white rounded-xl">
            <div class="px-4 py-2.5 flex items-center justify-between">
              <h3 class="font-semibold text-charcoal/40 text-[11px] uppercase tracking-wider">Custom Views</h3>
              <button onclick="showPerspectiveModal=true; render()" class="text-charcoal/30 hover:text-charcoal transition p-1.5 -mr-1 rounded-lg hover:bg-charcoal/5">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>
            <div class="py-1.5 px-1.5">
              ${customPerspectives.length > 0 ? customPerspectives.map(p => `
                <button onclick="showPerspectiveTasks('${p.id}')"
                  class="sidebar-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg group relative ${isPerspectiveActive(p.id) ? 'active' : ''}">
                  <span class="w-6 h-6 flex items-center justify-center flex-shrink-0 text-lg text-charcoal/40">${p.icon}</span>
                  <span class="flex-1 text-[14px] ${isPerspectiveActive(p.id) ? 'font-medium text-charcoal' : 'text-charcoal/70'}">${p.name}</span>
                  <span class="w-6 text-right text-[13px] group-hover:opacity-0 transition-opacity text-charcoal/35">${taskCounts[p.id] || ''}</span>
                  <span onclick="event.stopPropagation(); editCustomPerspective('${p.id}')"
                    class="absolute right-3 opacity-0 group-hover:opacity-100 transition-opacity text-[11px] text-charcoal/40 hover:text-charcoal px-1.5 py-0.5 rounded hover:bg-black/5">Edit</span>
                </button>
              `).join('') : `
                <div class="px-3 py-4 text-center text-charcoal/30 text-[13px]">
                  No custom views yet
                </div>
              `}
            </div>
          </div>

          <!-- Areas -->
          <div class="bg-white rounded-xl">
            <div class="px-4 py-2.5 flex items-center justify-between">
              <h3 class="font-semibold text-charcoal/40 text-[11px] uppercase tracking-wider">Areas</h3>
              <button onclick="editingCategoryId=null; showCategoryModal=true; render()" class="text-charcoal/30 hover:text-charcoal transition p-1.5 -mr-1 rounded-lg hover:bg-charcoal/5">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>
            <div class="py-1.5 px-1.5">
              ${taskCategories.map(cat => `
                <div onclick="showCategoryTasks('${cat.id}')"
                  class="sidebar-item draggable-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg group relative cursor-pointer select-none ${isCategoryActive(cat.id) ? 'active' : ''}"
                  draggable="true"
                  data-id="${cat.id}"
                  data-type="category">
                  <span class="w-6 h-6 flex items-center justify-center flex-shrink-0 text-charcoal/40">${THINGS3_ICONS.area}</span>
                  <span class="flex-1 text-[14px] ${isCategoryActive(cat.id) ? 'font-medium text-charcoal' : 'text-charcoal/70'}">${cat.name}</span>
                  <span class="w-6 text-right text-[13px] group-hover:opacity-0 transition-opacity text-charcoal/35">${categoryCounts[cat.id] || ''}</span>
                  <span onclick="event.stopPropagation(); editingCategoryId='${cat.id}'; showCategoryModal=true; render()"
                    class="absolute right-3 opacity-0 group-hover:opacity-100 transition-opacity text-[11px] text-charcoal/40 hover:text-charcoal px-1.5 py-0.5 rounded hover:bg-black/5">Edit</span>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Tags -->
          <div class="bg-white rounded-xl">
            <div class="px-4 py-2.5 flex items-center justify-between">
              <h3 class="font-semibold text-charcoal/40 text-[11px] uppercase tracking-wider">Tags</h3>
              <button onclick="editingLabelId=null; showLabelModal=true; render()" class="text-charcoal/30 hover:text-charcoal transition p-1.5 -mr-1 rounded-lg hover:bg-charcoal/5">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>
            <div class="py-1.5 px-1.5">
              ${taskLabels.map(label => `
                <div onclick="showLabelTasks('${label.id}')"
                  class="sidebar-item draggable-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg group relative cursor-pointer select-none ${isLabelActive(label.id) ? 'active' : ''}"
                  draggable="true"
                  data-id="${label.id}"
                  data-type="label">
                  <span class="w-6 h-6 flex items-center justify-center flex-shrink-0">
                    <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${label.color}"></span>
                  </span>
                  <span class="flex-1 text-[14px] ${isLabelActive(label.id) ? 'font-medium text-charcoal' : 'text-charcoal/70'}">${label.name}</span>
                  <span class="w-6 text-right text-[13px] group-hover:opacity-0 transition-opacity text-charcoal/35">${labelCounts[label.id] || ''}</span>
                  <span onclick="event.stopPropagation(); editingLabelId='${label.id}'; showLabelModal=true; render()"
                    class="absolute right-3 opacity-0 group-hover:opacity-100 transition-opacity text-[11px] text-charcoal/40 hover:text-charcoal px-1.5 py-0.5 rounded hover:bg-black/5">Edit</span>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- People -->
          <div class="bg-white rounded-xl">
            <div class="px-4 py-2.5 flex items-center justify-between">
              <h3 class="font-semibold text-charcoal/40 text-[11px] uppercase tracking-wider">People</h3>
              <button onclick="editingPersonId=null; showPersonModal=true; render()" class="text-charcoal/30 hover:text-charcoal transition p-1.5 -mr-1 rounded-lg hover:bg-charcoal/5">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>
            <div class="py-1.5 px-1.5">
              ${taskPeople.map(person => `
                <div onclick="showPersonTasks('${person.id}')"
                  class="sidebar-item draggable-item w-full px-3 py-2 flex items-center gap-3 text-left rounded-lg group relative cursor-pointer select-none ${isPersonActive(person.id) ? 'active' : ''}"
                  draggable="true"
                  data-id="${person.id}"
                  data-type="person">
                  <span class="w-6 h-6 flex items-center justify-center flex-shrink-0 text-charcoal/40">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                  </span>
                  <span class="flex-1 text-[14px] ${isPersonActive(person.id) ? 'font-medium text-charcoal' : 'text-charcoal/70'}">${person.name}</span>
                  <span class="w-6 text-right text-[13px] group-hover:opacity-0 transition-opacity text-charcoal/35">${peopleCounts[person.id] || ''}</span>
                  <span onclick="event.stopPropagation(); editingPersonId='${person.id}'; showPersonModal=true; render()"
                    class="absolute right-3 opacity-0 group-hover:opacity-100 transition-opacity text-[11px] text-charcoal/40 hover:text-charcoal px-1.5 py-0.5 rounded hover:bg-black/5">Edit</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      // Build task list
      const taskListHtml = `
        <div class="flex-1">
          <div class="bg-white rounded-xl">
            <div class="px-5 py-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-2xl" ${viewInfo.color ? `style="color: ${viewInfo.color}"` : ''}>${viewInfo.icon}</span>
                <h2 class="text-xl font-semibold text-charcoal">${viewInfo.name}</h2>
              </div>
              <button onclick="openNewTaskModal()"
                class="w-8 h-8 rounded-full bg-[#147EFB] text-white flex items-center justify-center hover:bg-[#0E6AD8] transition shadow-sm" title="${activePerspective === 'notes' ? 'Add Note' : 'Add Task'}">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>

            ${activePerspective !== 'upcoming' && activePerspective !== 'home' ? `
            <!-- Quick Add Input -->
            <div class="px-4 py-3">
              <div class="flex items-center gap-3">
                ${activePerspective === 'notes' ? `
                  <div class="w-2 h-2 rounded-full border-2 border-dashed border-[#8B5CF6]/40 flex-shrink-0 ml-1.5"></div>
                ` : `
                  <div class="w-5 h-5 rounded-full border-2 border-dashed border-charcoal/20 flex-shrink-0"></div>
                `}
                <input type="text" id="quick-add-input"
                  placeholder="${activePerspective === 'notes' ? 'Add a note... (press Enter)' : 'Quick add to ' + viewInfo.name + '... (press Enter)'}"
                  onkeydown="handleQuickAddKeydown(event, this)"
                  class="flex-1 text-[15px] text-charcoal placeholder-charcoal/30 bg-transparent border-0 outline-none focus:ring-0">
                <button onclick="quickAddTask(document.getElementById('quick-add-input'))"
                  class="text-charcoal/30 hover:text-coral transition p-1" title="${activePerspective === 'notes' ? 'Add Note' : 'Add to ' + viewInfo.name}">
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
              </div>
            </div>
            ` : ''}

            <div class="min-h-[400px] task-list">
              ${activePerspective === 'home' ? `
                <!-- Widget-based Home Dashboard -->
                <div class="p-4">
                  <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                      ${editingHomeWidgets ? `
                        <span class="text-sm text-coral font-medium">Editing Dashboard</span>
                      ` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                      ${editingHomeWidgets ? `
                        <button onclick="resetHomeWidgets()" class="text-xs text-charcoal/50 hover:text-charcoal px-2 py-1 rounded hover:bg-charcoal/5 transition">Reset Layout</button>
                        <!-- Show hidden widgets -->
                        ${homeWidgets.filter(w => !w.visible).length > 0 ? `
                          <div class="flex items-center gap-1">
                            <span class="text-xs text-charcoal/40">Hidden:</span>
                            ${homeWidgets.filter(w => !w.visible).map(w => `
                              <button onclick="toggleWidgetVisibility('${w.id}')" class="text-xs px-2 py-1 rounded border border-dashed border-charcoal/20 text-charcoal/50 hover:border-coral hover:text-coral transition">${w.title}</button>
                            `).join('')}
                          </div>
                        ` : ''}
                      ` : ''}
                      <button onclick="toggleEditHomeWidgets()" class="text-xs text-charcoal/50 hover:text-charcoal px-2 py-1 rounded ${editingHomeWidgets ? 'bg-coral text-white hover:text-white' : 'hover:bg-charcoal/5'} transition">
                        ${editingHomeWidgets ? 'Done' : 'Customize'}
                      </button>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    ${homeWidgets.filter(w => w.visible).sort((a, b) => a.order - b.order).map(widget => renderHomeWidget(widget, editingHomeWidgets)).join('')}
                  </div>
                </div>
              ` : (filteredTasks.length === 0 ? `
                <div class="empty-state flex flex-col items-center justify-center py-20 text-charcoal/30">
                  <div class="w-16 h-16 mb-4 flex items-center justify-center opacity-50">${viewInfo.icon}</div>
                  <p class="text-[15px] font-medium">No tasks in ${viewInfo.name}</p>
                  ${activePerspective === 'inbox' ? '<p class="text-[13px] mt-1 text-charcoal/25">Add a task to get started</p>' : ''}
                </div>
              ` : (activePerspective === 'upcoming' ? `
                <!-- Upcoming view grouped by date -->
                <div class="task-list">
                  ${groupTasksByDate(filteredTasks).map(group => `
                    <div class="date-group mb-6">
                      <div class="px-5 py-2 sticky top-0 bg-white">
                        <span class="text-[13px] font-semibold text-charcoal/50">${group.label}</span>
                      </div>
                      <div>
                        ${group.tasks.map(task => renderTaskItem(task, false)).join('')}
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : (activePerspective === 'logbook' ? `
                <!-- Logbook view grouped by completion date -->
                <div class="task-list">
                  ${groupTasksByCompletionDate(filteredTasks).map(group => `
                    <div class="date-group mb-6">
                      <div class="px-5 py-2 sticky top-0 bg-white">
                        <span class="text-[13px] font-semibold text-charcoal/50">${group.label}</span>
                      </div>
                      <div>
                        ${group.tasks.map(task => renderTaskItem(task, false)).join('')}
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : (activePerspective === 'today' ? (() => {
                // Today view: Split into dated tasks and Next-tagged tasks
                const today = new Date().toISOString().split('T')[0];
                const nextLabel = taskLabels.find(l => l.name.toLowerCase() === 'next');

                // Dated tasks: tasks with status 'today', due today, or overdue
                const datedTasks = filteredTasks.filter(t => {
                  const isDueToday = t.dueDate === today;
                  const isOverdue = t.dueDate && t.dueDate < today;
                  return t.status === 'today' || isDueToday || isOverdue;
                });

                // Next tasks: tasks tagged with "next" label (not already in dated)
                const nextTasks = nextLabel ? filteredTasks.filter(t => {
                  const isNextTagged = (t.labels || []).includes(nextLabel.id);
                  const isDatedTask = t.status === 'today' || t.dueDate === today || (t.dueDate && t.dueDate < today);
                  return isNextTagged && !isDatedTask;
                }) : [];

                return `
                <div class="task-list">
                  ${datedTasks.length > 0 ? `
                    <div class="dated-tasks-section">
                      ${datedTasks.map(task => renderTaskItem(task)).join('')}
                    </div>
                  ` : ''}
                  ${nextTasks.length > 0 ? `
                    <div class="next-tasks-section mt-4">
                      <div class="px-5 py-2 sticky top-0 bg-white">
                        <div class="flex items-center gap-2">
                          <span class="text-[#8B5CF6]">${THINGS3_ICONS.next}</span>
                          <span class="text-[13px] font-semibold text-charcoal/50 uppercase tracking-wider">Next</span>
                          <span class="text-xs text-charcoal/30">${nextTasks.length}</span>
                        </div>
                      </div>
                      ${nextTasks.map(task => renderTaskItem(task)).join('')}
                    </div>
                  ` : ''}
                  ${datedTasks.length === 0 && nextTasks.length === 0 ? `
                    <div class="empty-state flex flex-col items-center justify-center py-20 text-charcoal/30">
                      <div class="w-16 h-16 mb-4 flex items-center justify-center opacity-50">${viewInfo.icon}</div>
                      <p class="text-[15px] font-medium">No tasks in ${viewInfo.name}</p>
                    </div>
                  ` : ''}
                </div>
              `;
              })() : `
                <!-- Regular task list -->
                <div class="task-list">
                  ${filteredTasks.map(task => renderTaskItem(task)).join('')}
                </div>
              `))))}
            </div>
          </div>
        </div>
      `;

      // Task Modal
      const editingTask = editingTaskId ? tasksData.find(t => t.id === editingTaskId) : null;
      const taskModalHtml = showTaskModal ? `
        <div class="modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target===this){showTaskModal=false; editingTaskId=null; render()}" onkeydown="if(event.key==='Escape'){showTaskModal=false; editingTaskId=null; render();}">
          <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-lg mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal">${editingTask ? 'Edit Task' : 'New Task'}</h3>
              <button onclick="showTaskModal=false; editingTaskId=null; render()" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <!-- Type Toggle: Task vs Note -->
              <div class="flex items-center gap-4 pb-3 border-b border-softborder">
                <span class="text-sm text-charcoal/70">Type:</span>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="task-type" value="task" ${!editingTask?.isNote && activePerspective !== 'notes' ? 'checked' : ''} class="accent-coral">
                  <span class="text-sm text-charcoal">Task</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="task-type" value="note" ${editingTask?.isNote || activePerspective === 'notes' ? 'checked' : ''} class="accent-[#8B5CF6]">
                  <span class="text-sm text-charcoal">Note</span>
                </label>
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Title</label>
                <input type="text" id="task-title" value="${editingTask ? editingTask.title : ''}"
                  placeholder="${editingTask?.isNote || activePerspective === 'notes' ? 'What do you want to capture?' : 'What needs to be done?'}" autofocus
                  onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();saveTaskFromModal();}"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Details</label>
                <textarea id="task-notes" rows="3" placeholder="Add details..."
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none resize-none">${editingTask ? editingTask.notes : ''}</textarea>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-charcoal/70 block mb-1">When</label>
                  <select id="task-status" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
                    <option value="inbox" ${(editingTask?.status || newTaskContext.status) === 'inbox' ? 'selected' : ''}>Inbox</option>
                    <option value="today" ${(editingTask?.status || newTaskContext.status) === 'today' ? 'selected' : ''}>Today</option>
                    <option value="anytime" ${(editingTask?.status || newTaskContext.status) === 'anytime' ? 'selected' : ''}>Anytime</option>
                    <option value="someday" ${(editingTask?.status || newTaskContext.status) === 'someday' ? 'selected' : ''}>Someday</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm text-charcoal/70 block mb-1">Area</label>
                  <select id="task-category" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
                    <option value="">None</option>
                    ${taskCategories.map(cat => `
                      <option value="${cat.id}" ${(editingTask?.categoryId || newTaskContext.categoryId) === cat.id ? 'selected' : ''}>${cat.name}</option>
                    `).join('')}
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-charcoal/70 block mb-1">Defer Until</label>
                  <input type="date" id="task-defer" value="${editingTask?.deferDate || ''}"
                    onclick="this.showPicker()"
                    class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none text-sm">
                  <p class="text-[11px] text-charcoal/40 mt-1">Task hidden until this date</p>
                </div>
                <div>
                  <label class="text-sm text-charcoal/70 block mb-1">Due Date</label>
                  <input type="date" id="task-due" value="${editingTask?.dueDate || ''}"
                    onclick="this.showPicker()"
                    class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none text-sm">
                  <p class="text-[11px] text-charcoal/40 mt-1">Deadline for completion</p>
                </div>
              </div>

              <!-- Repeat Settings (OmniFocus style) -->
              <div class="border border-softborder rounded-lg p-4 bg-warmgray/30">
                <label class="text-sm text-charcoal/70 block mb-3 font-medium">Repeat</label>
                <div class="grid grid-cols-3 gap-3">
                  <div>
                    <select id="task-repeat-type" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none text-sm bg-white"
                      onchange="updateRepeatUI(this.value)">
                      <option value="none" ${!editingTask?.repeat || editingTask?.repeat?.type === 'none' ? 'selected' : ''}>No repeat</option>
                      <option value="daily" ${editingTask?.repeat?.type === 'daily' ? 'selected' : ''}>Daily</option>
                      <option value="weekly" ${editingTask?.repeat?.type === 'weekly' ? 'selected' : ''}>Weekly</option>
                      <option value="monthly" ${editingTask?.repeat?.type === 'monthly' ? 'selected' : ''}>Monthly</option>
                      <option value="yearly" ${editingTask?.repeat?.type === 'yearly' ? 'selected' : ''}>Yearly</option>
                    </select>
                  </div>
                  <div id="repeat-details" class="${editingTask?.repeat && editingTask?.repeat?.type !== 'none' ? 'flex' : 'hidden'} col-span-2 items-center gap-2">
                    <span class="text-sm text-charcoal/60">every</span>
                    <input type="number" id="task-repeat-interval" min="1" value="${editingTask?.repeat?.interval || 1}"
                      class="w-16 px-2 py-2 border border-softborder rounded focus:border-coral focus:outline-none text-sm text-center bg-white">
                    <span class="text-sm text-charcoal/60" id="repeat-unit-label">${getRepeatUnitLabel(editingTask?.repeat?.type)}</span>
                  </div>
                </div>
                <div id="repeat-from-container" class="${editingTask?.repeat && editingTask?.repeat?.type !== 'none' ? 'block' : 'hidden'} mt-3 pt-3 border-t border-softborder/50">
                  <label class="text-sm text-charcoal/60 block mb-2">Repeat from:</label>
                  <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="repeat-from" value="completion" ${!editingTask?.repeat?.from || editingTask?.repeat?.from === 'completion' ? 'checked' : ''} class="accent-coral">
                      <span class="text-sm text-charcoal/70">Completion date</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="repeat-from" value="due" ${editingTask?.repeat?.from === 'due' ? 'checked' : ''} class="accent-coral">
                      <span class="text-sm text-charcoal/70">Due date</span>
                    </label>
                  </div>
                </div>
              </div>

              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Tags</label>
                <div class="flex flex-wrap gap-2" id="task-labels-container">
                  ${taskLabels.map(label => {
                    const isSelected = editingTask?.labels?.includes(label.id) ||
                      (!editingTask && newTaskContext.labelId === label.id) ||
                      (!editingTask && newTaskContext.labelIds && newTaskContext.labelIds.includes(label.id));
                    return `
                      <label class="label-checkbox flex items-center gap-1.5 px-2 py-1 rounded border cursor-pointer transition ${isSelected ? 'bg-warmgray' : 'hover:bg-warmgray/50'}" style="border-color: ${label.color}">
                        <input type="checkbox" value="${label.id}" ${isSelected ? 'checked' : ''} class="task-label-checkbox rounded" style="accent-color: ${label.color}">
                        <span class="text-sm" style="color: ${label.color}">${label.name}</span>
                      </label>
                    `;
                  }).join('')}
                  <button onclick="toggleInlineTagInput()" class="flex items-center gap-1 px-2 py-1 text-sm text-charcoal/50 hover:text-charcoal hover:bg-warmgray/50 rounded border border-dashed border-charcoal/20">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    New
                  </button>
                </div>
                <div id="inline-tag-form"></div>
              </div>

              <div>
                <label class="text-sm text-charcoal/70 block mb-1">People</label>
                <div class="flex flex-wrap gap-2" id="task-people-container">
                  ${taskPeople.map(person => {
                    const isSelected = editingTask?.people?.includes(person.id) || (!editingTask && newTaskContext.personId === person.id);
                    return `
                      <label class="label-checkbox flex items-center gap-1.5 px-2 py-1 rounded border border-charcoal/20 cursor-pointer transition ${isSelected ? 'bg-warmgray border-charcoal/40' : 'hover:bg-warmgray/50'}">
                        <input type="checkbox" value="${person.id}" ${isSelected ? 'checked' : ''} class="task-person-checkbox rounded">
                        <span class="text-sm text-charcoal/70">${person.name}</span>
                      </label>
                    `;
                  }).join('')}
                  <button onclick="toggleInlinePersonInput()" class="flex items-center gap-1 px-2 py-1 text-sm text-charcoal/50 hover:text-charcoal hover:bg-warmgray/50 rounded border border-dashed border-charcoal/20">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    New
                  </button>
                </div>
                <div id="inline-person-form"></div>
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-end gap-3">
              <button onclick="showTaskModal=false; editingTaskId=null; render()"
                class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
              <button onclick="saveTaskFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                ${editingTask ? 'Save Changes' : 'Add Task'}
              </button>
            </div>
          </div>
        </div>
      ` : '';

      // Perspective Modal
      const editingPerspective = editingPerspectiveId ? customPerspectives.find(p => p.id === editingPerspectiveId) : null;
      const perspectiveModalHtml = showPerspectiveModal ? `
        <div class="modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target===this){showPerspectiveModal=false; editingPerspectiveId=null; render()}" onkeydown="if(event.key==='Escape'){showPerspectiveModal=false; editingPerspectiveId=null; render();}">
          <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-md mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal">${editingPerspective ? 'Edit Custom View' : 'New Custom View'}</h3>
              <button onclick="showPerspectiveModal=false; editingPerspectiveId=null; render()" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="perspective-name" placeholder="e.g., Work Projects" autofocus
                  onkeydown="if(event.key==='Enter'){event.preventDefault();savePerspectiveFromModal();}"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Icon (emoji)</label>
                <input type="text" id="perspective-icon" value="ðŸ“Œ" maxlength="2"
                  class="w-20 px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none text-center text-xl">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Filter by Area</label>
                <select id="perspective-category" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
                  <option value="">Any category</option>
                  ${taskCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Filter by Status</label>
                <select id="perspective-status" class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
                  <option value="">Any status</option>
                  <option value="inbox">Inbox</option>
                  <option value="today">Today</option>
                  <option value="anytime">Anytime</option>
                  <option value="someday">Someday</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Filter by Tags</label>
                <div class="border border-softborder rounded p-2 max-h-32 overflow-y-auto space-y-1">
                  ${taskLabels.length > 0 ? taskLabels.map(label => `
                    <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-warmgray cursor-pointer">
                      <input type="checkbox" class="perspective-tag-checkbox rounded border-softborder" value="${label.id}">
                      <span class="w-2 h-2 rounded-full" style="background-color: ${label.color}"></span>
                      <span class="text-sm text-charcoal/80">${label.name}</span>
                    </label>
                  `).join('') : '<p class="text-sm text-charcoal/40 text-center py-2">No tags created yet</p>'}
                </div>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="perspective-due" class="rounded border-softborder">
                <label for="perspective-due" class="text-sm text-charcoal/70">Only show tasks with due dates</label>
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-between">
              ${editingPerspective ? `
                <button onclick="if(confirm('Delete this custom view?')){deletePerspective('${editingPerspective.id}'); showPerspectiveModal=false; editingPerspectiveId=null; render();}"
                  class="px-4 py-2 text-sm text-red-500 hover:text-red-700">Delete</button>
              ` : '<div></div>'}
              <div class="flex gap-3">
                <button onclick="showPerspectiveModal=false; editingPerspectiveId=null; render()"
                  class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
                <button onclick="savePerspectiveFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  ${editingPerspective ? 'Save' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      // Category Modal
      const editingCategory = editingCategoryId ? taskCategories.find(c => c.id === editingCategoryId) : null;
      const categoryModalHtml = showCategoryModal ? `
        <div class="modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target===this){showCategoryModal=false; editingCategoryId=null; render()}" onkeydown="if(event.key==='Escape'){showCategoryModal=false; editingCategoryId=null; render();}">
          <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal">${editingCategory ? 'Edit Area' : 'New Area'}</h3>
              <button onclick="showCategoryModal=false; editingCategoryId=null; render()" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="category-name" value="${editingCategory?.name || ''}"
                  placeholder="e.g., Work, Personal, Health" autofocus
                  onkeydown="if(event.key==='Enter'){event.preventDefault();saveCategoryFromModal();}"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-between">
              ${editingCategory ? `
                <button onclick="if(confirm('Delete this area?')){deleteCategory('${editingCategory.id}'); showCategoryModal=false; editingCategoryId=null; render();}"
                  class="px-4 py-2 text-sm text-red-500 hover:text-red-700">Delete</button>
              ` : '<div></div>'}
              <div class="flex gap-3">
                <button onclick="showCategoryModal=false; editingCategoryId=null; render()"
                  class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
                <button onclick="saveCategoryFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  ${editingCategory ? 'Save' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      // Tag Modal (formerly Label)
      const editingLabel = editingLabelId ? taskLabels.find(l => l.id === editingLabelId) : null;
      const labelModalHtml = showLabelModal ? `
        <div class="modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target===this){showLabelModal=false; editingLabelId=null; render()}" onkeydown="if(event.key==='Escape'){showLabelModal=false; editingLabelId=null; render();}">
          <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal">${editingLabel ? 'Edit Tag' : 'New Tag'}</h3>
              <button onclick="showLabelModal=false; editingLabelId=null; render()" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="label-name" value="${editingLabel?.name || ''}"
                  placeholder="e.g., Important" autofocus
                  onkeydown="if(event.key==='Enter'){event.preventDefault();saveLabelFromModal();}"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Color</label>
                <input type="color" id="label-color" value="${editingLabel?.color || '#6B7280'}"
                  class="w-full h-10 rounded border border-softborder cursor-pointer">
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-between">
              ${editingLabel ? `
                <button onclick="if(confirm('Delete this tag?')){deleteLabel('${editingLabel.id}'); showLabelModal=false; editingLabelId=null; render();}"
                  class="px-4 py-2 text-sm text-red-500 hover:text-red-700">Delete</button>
              ` : '<div></div>'}
              <div class="flex gap-3">
                <button onclick="showLabelModal=false; editingLabelId=null; render()"
                  class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
                <button onclick="saveLabelFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  ${editingLabel ? 'Save' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      // Person Modal
      const editingPerson = editingPersonId ? taskPeople.find(p => p.id === editingPersonId) : null;
      const personModalHtml = showPersonModal ? `
        <div class="modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="if(event.target===this){showPersonModal=false; editingPersonId=null; render()}" onkeydown="if(event.key==='Escape'){showPersonModal=false; editingPersonId=null; render();}">
          <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-softborder flex items-center justify-between">
              <h3 class="font-semibold text-charcoal">${editingPerson ? 'Edit Person' : 'New Person'}</h3>
              <button onclick="showPersonModal=false; editingPersonId=null; render()" class="text-charcoal/50 hover:text-charcoal text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-sm text-charcoal/70 block mb-1">Name</label>
                <input type="text" id="person-name" value="${editingPerson?.name || ''}"
                  placeholder="e.g., John Doe" autofocus
                  onkeydown="if(event.key==='Enter'){event.preventDefault();savePersonFromModal();}"
                  class="w-full px-3 py-2 border border-softborder rounded focus:border-coral focus:outline-none">
              </div>
            </div>
            <div class="px-6 py-4 border-t border-softborder flex justify-between">
              ${editingPerson ? `
                <button onclick="if(confirm('Delete this person?')){deletePerson('${editingPerson.id}'); showPersonModal=false; editingPersonId=null; render();}"
                  class="px-4 py-2 text-sm text-red-500 hover:text-red-700">Delete</button>
              ` : '<div></div>'}
              <div class="flex gap-3">
                <button onclick="showPersonModal=false; editingPersonId=null; render()"
                  class="px-4 py-2 text-sm text-charcoal/70 hover:text-charcoal">Cancel</button>
                <button onclick="savePersonFromModal()" class="sb-btn px-4 py-2 rounded text-sm font-medium">
                  ${editingPerson ? 'Save' : 'Create'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ` : '';

      return `
        <div class="flex flex-col md:flex-row gap-6">
          ${sidebarHtml}
          ${taskListHtml}
        </div>
        ${taskModalHtml}
        ${perspectiveModalHtml}
        ${categoryModalHtml}
        ${labelModalHtml}
        ${personModalHtml}
      `;
    }

    // Save category from modal
    function saveCategoryFromModal() {
      const name = document.getElementById('category-name').value.trim();
      if (!name) {
        alert('Please enter an area name');
        return;
      }

      if (editingCategoryId) {
        updateCategory(editingCategoryId, { name });
      } else {
        createCategory(name);
      }
      showCategoryModal = false;
      editingCategoryId = null;
      render();
    }

    // Save label from modal
    function saveLabelFromModal() {
      const name = document.getElementById('label-name').value.trim();
      if (!name) {
        alert('Please enter a tag name');
        return;
      }
      const color = document.getElementById('label-color').value;

      if (editingLabelId) {
        updateLabel(editingLabelId, { name, color });
      } else {
        createLabel(name, color);
      }
      showLabelModal = false;
      editingLabelId = null;
      render();
    }

    // Save person from modal
    function savePersonFromModal() {
      const name = document.getElementById('person-name').value.trim();
      if (!name) {
        alert('Please enter a name');
        return;
      }

      if (editingPersonId) {
        updatePerson(editingPersonId, { name });
      } else {
        createPerson(name);
      }
      showPersonModal = false;
      editingPersonId = null;
      render();
    }

    // Save task from modal
    function saveTaskFromModal() {
      const title = document.getElementById('task-title').value.trim();
      if (!title) {
        alert('Please enter a task title');
        return;
      }

      // Get selected labels (tags)
      const labelCheckboxes = document.querySelectorAll('.task-label-checkbox:checked');
      const selectedLabels = Array.from(labelCheckboxes).map(cb => cb.value);

      // Get selected people
      const personCheckboxes = document.querySelectorAll('.task-person-checkbox:checked');
      const selectedPeople = Array.from(personCheckboxes).map(cb => cb.value);

      // Get repeat settings
      const repeatType = document.getElementById('task-repeat-type').value;
      let repeat = null;
      if (repeatType !== 'none') {
        const repeatFrom = document.querySelector('input[name="repeat-from"]:checked')?.value || 'completion';
        repeat = {
          type: repeatType,
          interval: parseInt(document.getElementById('task-repeat-interval').value) || 1,
          from: repeatFrom
        };
      }

      // Get task type (task vs note)
      const isNote = document.querySelector('input[name="task-type"]:checked')?.value === 'note';

      const taskData = {
        title: title,
        notes: document.getElementById('task-notes').value.trim(),
        status: document.getElementById('task-status').value,
        categoryId: document.getElementById('task-category').value || null,
        deferDate: document.getElementById('task-defer').value || null,
        dueDate: document.getElementById('task-due').value || null,
        repeat: repeat,
        labels: selectedLabels,
        people: selectedPeople,
        isNote: isNote
      };

      // Things 3 logic: Assigning an Area to an Inbox task moves it to Anytime (not for notes)
      if (!isNote && taskData.status === 'inbox' && taskData.categoryId) {
        taskData.status = 'anytime';
      }

      if (editingTaskId) {
        updateTask(editingTaskId, taskData);
      } else {
        createTask(title, taskData);
      }

      showTaskModal = false;
      editingTaskId = null;
      render();
    }

    // Save perspective from modal
    function savePerspectiveFromModal() {
      const name = document.getElementById('perspective-name').value.trim();
      if (!name) {
        alert('Please enter a perspective name');
        return;
      }

      const icon = document.getElementById('perspective-icon').value || 'ðŸ“Œ';
      const filter = {};

      const categoryId = document.getElementById('perspective-category').value;
      if (categoryId) filter.categoryId = categoryId;

      const status = document.getElementById('perspective-status').value;
      if (status) filter.status = status;

      // Collect selected tags
      const selectedTags = Array.from(document.querySelectorAll('.perspective-tag-checkbox:checked')).map(cb => cb.value);
      if (selectedTags.length > 0) filter.labelIds = selectedTags;

      if (document.getElementById('perspective-due').checked) {
        filter.hasDueDate = true;
      }

      if (editingPerspectiveId) {
        // Update existing perspective
        const idx = customPerspectives.findIndex(p => p.id === editingPerspectiveId);
        if (idx !== -1) {
          customPerspectives[idx] = { ...customPerspectives[idx], name, icon, filter };
          saveTasksData();
        }
        activePerspective = editingPerspectiveId;
      } else {
        createPerspective(name, icon, filter);
        activePerspective = customPerspectives[customPerspectives.length - 1].id;
      }
      showPerspectiveModal = false;
      editingPerspectiveId = null;
      render();
    }

    function exportData() {
      const exportObj = {
        data: allData,
        weights: WEIGHTS,
        tasks: tasksData,
        taskCategories: taskCategories,
        taskLabels: taskLabels,
        customPerspectives: customPerspectives,
        lastUpdated: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'life-gamification-backup-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }


    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (imported.data) {
            allData = imported.data;
            saveData();
          }
          if (imported.weights) {
            WEIGHTS = imported.weights;
            saveWeights();
          }
          if (imported.tasks) {
            tasksData = imported.tasks;
            localStorage.setItem(TASKS_KEY, JSON.stringify(tasksData));
          }
          if (imported.taskCategories) {
            taskCategories = imported.taskCategories;
            localStorage.setItem(TASK_CATEGORIES_KEY, JSON.stringify(taskCategories));
          }
          if (imported.taskLabels) {
            taskLabels = imported.taskLabels;
            localStorage.setItem(TASK_LABELS_KEY, JSON.stringify(taskLabels));
          }
          if (imported.customPerspectives) {
            customPerspectives = imported.customPerspectives;
            localStorage.setItem(PERSPECTIVES_KEY, JSON.stringify(customPerspectives));
          }
          alert('Data imported successfully!');
          debouncedSaveToGithub();
          render();
        } catch (err) {
          alert('Error importing data: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // Initialize: load cloud data then render
    loadCloudData().then(() => render());
  </script>
</body>
</html>
